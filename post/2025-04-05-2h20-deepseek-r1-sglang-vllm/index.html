<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:site_name" content="漫步远方，心荡神往"><meta property="og:type" content="article"><meta property="og:image" content="https://tanjunchen.github.io/img/home.webp"><meta property="twitter:image" content="https://tanjunchen.github.io/img/home.webp"><meta name=title content="双机2*H20(8*96GiB)部署满血DeepSeek-R1(fp8)验证过程"><meta property="og:title" content="双机2*H20(8*96GiB)部署满血DeepSeek-R1(fp8)验证过程"><meta property="twitter:title" content="双机2*H20(8*96GiB)部署满血DeepSeek-R1(fp8)验证过程"><meta name=description content="陈谭军，软件工程师, 开源爱好者, 互联网, 云原生, 容器, 微服务, Web, PaaS, Istio, Kubernetes, Microservice"><meta property="og:description" content="陈谭军，软件工程师, 开源爱好者, 互联网, 云原生, 容器, 微服务, Web, PaaS, Istio, Kubernetes, Microservice"><meta property="twitter:description" content="陈谭军，软件工程师, 开源爱好者, 互联网, 云原生, 容器, 微服务, Web, PaaS, Istio, Kubernetes, Microservice"><meta property="twitter:card" content="summary"><meta name=keyword content="陈谭军, 互联网, 云原生, 容器, 微服务, Web, PaaS, Istio, Kubernetes, Microservice"><link rel="shortcut icon" href=/img/favicon.ico><title>双机2*H20(8*96GiB)部署满血DeepSeek-R1(fp8)验证过程 | 陈谭军的博客 | tanjunchen Blog</title><link rel=canonical href=/post/2025-04-05-2h20-deepseek-r1-sglang-vllm/><link rel=stylesheet href=/css/bootstrap.min.css><link rel=stylesheet href=/css/hugo-theme-cleanwhite.min.css><link rel=stylesheet href=/css/zanshang.css><link rel=stylesheet href=/css/font-awesome.all.min.css><script src=/js/jquery.min.js></script>
<script src=/js/bootstrap.min.js></script>
<script src=/js/hux-blog.min.js></script>
<script src=/js/lazysizes.min.js></script></head><nav class="navbar navbar-default navbar-custom navbar-fixed-top"><div class=container-fluid><div class="navbar-header page-scroll"><button type=button class=navbar-toggle>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span></button>
<a class=navbar-brand href=/>漫步远方，心荡神往</a></div><div id=huxblog_navbar><div class=navbar-collapse><ul class="nav navbar-nav navbar-right"><li><a href=/>All Posts</a></li><li><a href=/categories/technology/>technology</a></li><li><a href=/categories/think/>think</a></li><li><a href=/learning/>LEARNING</a></li><li><a href=/archive/>ARCHIVE</a></li><li><a href=/about/>ABOUT</a></li><li><a href=/search><i class="fa fa-search"></i></a></li></ul></div></div></div></nav><script>var $body=document.body,$toggle=document.querySelector(".navbar-toggle"),$navbar=document.querySelector("#huxblog_navbar"),$collapse=document.querySelector(".navbar-collapse");$toggle.addEventListener("click",handleMagic);function handleMagic(){$navbar.className.indexOf("in")>0?($navbar.className=" ",setTimeout(function(){$navbar.className.indexOf("in")<0&&($collapse.style.height="0px")},400)):($collapse.style.height="auto",$navbar.className+=" in")}</script><style type=text/css>header.intro-header{background-image:url(/img/home.webp)}</style><header class=intro-header><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><div class=tags><a class=tag href=/tags/ai title=AI>AI</a>
<a class=tag href=/tags/%E5%A4%A7%E6%A8%A1%E5%9E%8B title=大模型>大模型</a>
<a class=tag href=/tags/deepseek title=DeepSeek>DeepSeek</a>
<a class=tag href=/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E6%8E%A8%E7%90%86 title=分布式推理>分布式推理</a></div><h1>双机2*H20(8*96GiB)部署满血DeepSeek-R1(fp8)验证过程</h1><h2 class=subheading>双机2*H20(8*96GiB)部署满血DeepSeek-R1(fp8)验证过程、vllm 与 sglang 双机测试与性能对比</h2><span class=meta>Posted by
陈谭军
on
Saturday, April 5, 2025
<span id=busuanzi_container_page_pv>|<span id=busuanzi_value_page_pv></span><span>
<span id=/post/2025-04-05-2h20-deepseek-r1-sglang-vllm/ class="leancloud_visitors meta_data_item" data-flag-title><span class=post-meta-item-icon><span class="octicon octicon-eye"></span></span>
<i class="fa fa-eye"></i>
<span class=old-visitors-count style=display:none></span>
<span class=leancloud-visitors-count></span></span>
<script src=https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js></script>
<script>AV.initialize("","")</script><script type=text/javascript>function showTime(e){var n=new AV.Query(e),t=[],s=$(".leancloud_visitors");s.each(function(){t.push($(this).attr("id").trim())}),n.containedIn("url",t),n.find().done(function(e){for(var s,o,i,a,r,c,l=".leancloud-visitors-count",d=".old-visitors-count",n=0;n<e.length;n++)a=e[n],i=a.get("url"),c=a.get("time"),s=document.getElementById(i),$(s).find(l).text(c);for(n=0;n<t.length;n++)i=t[n],s=document.getElementById(i),o=$(s).find(l),o.text()==""&&(r=$(s).find(d).text(),r!=""?o.text(0+parseInt(r)):o.text(0))}).fail(function(e,t){console.log("Error: "+t.code+" "+t.message)})}function addCount(e){var n=$(".leancloud_visitors"),t=n.attr("id").trim(),o=n.attr("data-flag-title").trim(),s=new AV.Query(e);s.equalTo("url",t),s.find({success:function(n){if(n.length>0){var s,i,r,c,l,a=n[0];a.fetchWhenSave(!0),a.increment("time"),a.save(null,{success:function(e){var n=$(document.getElementById(t));n.find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to save Visitor num, with error message: "+t.message)}})}else s=new e,i=new AV.ACL,i.setPublicReadAccess(!0),i.setPublicWriteAccess(!0),s.setACL(i),s.set("title",o),s.set("url",t),c=".old-visitors-count",l=$(document.getElementById(t)),r=l.find(c).text(),r!=""?s.set("time",parseInt(r)+1):s.set("time",1),s.save(null,{success:function(e){var n=$(document.getElementById(t));n.find(".leancloud-visitors-count").text(e.get("time"))},error:function(){console.log("Failed to create")}})},error:function(e){console.log("Error:"+e.code+" "+e.message)}})}$(function(){var e=AV.Object.extend("Counter");$(".leancloud_visitors").length==1?addCount(e):showTime(e)})</script>阅读 </span></span>|<span class=post-date>共 3817 字</span>，阅读约 <span class=more-meta>8 分钟</span></span></div></div></div></div></header><article><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
post-container"><h1 id=环境信息>环境信息</h1><h2 id=机器配置>机器配置</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>OS：CentOS Linux release 7.6 <span style=color:#ff79c6>(</span>Final<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>Kernel：4.19.0-1.0.0.9
</span></span><span style=display:flex><span>驱动： Driver Version: 535.216.03   CUDA Version: 12.2
</span></span><span style=display:flex><span>GPU：NVIDIA  H20
</span></span><span style=display:flex><span>vLLM：https://docs.vllm.ai/en/stable/
</span></span><span style=display:flex><span>Docker：v1.5.4
</span></span><span style=display:flex><span>nvidia-container-runtime：1.0.2-dev
</span></span><span style=display:flex><span>vllm 测试镜像：vllm/vllm-openai:v0.8.2
</span></span><span style=display:flex><span>sglang 测试镜像：lmsysorg/sglang:ea52b45be1a7 
</span></span><span style=display:flex><span>配置与模型根目录  /mnt/models
</span></span></code></pre></div><p>RDMA 网络配置：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ff79c6>[</span>root@node01 models<span style=color:#ff79c6>]</span><span style=color:#6272a4># ibdev2netdev</span>
</span></span><span style=display:flex><span>mlx5_0 port <span style=color:#8be9fd;font-style:italic>1</span> <span style=color:#ff79c6>==</span>&gt; xgbe0 <span style=color:#ff79c6>(</span>Up<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>mlx5_1 port <span style=color:#8be9fd;font-style:italic>1</span> <span style=color:#ff79c6>==</span>&gt; xgbe1 <span style=color:#ff79c6>(</span>Up<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>mlx5_2 port <span style=color:#8be9fd;font-style:italic>1</span> <span style=color:#ff79c6>==</span>&gt; xgbe2 <span style=color:#ff79c6>(</span>Up<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>mlx5_3 port <span style=color:#8be9fd;font-style:italic>1</span> <span style=color:#ff79c6>==</span>&gt; xgbe3 <span style=color:#ff79c6>(</span>Up<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>mlx5_4 port <span style=color:#8be9fd;font-style:italic>1</span> <span style=color:#ff79c6>==</span>&gt; xgbe4 <span style=color:#ff79c6>(</span>Up<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>mlx5_5 port <span style=color:#8be9fd;font-style:italic>1</span> <span style=color:#ff79c6>==</span>&gt; xgbe5 <span style=color:#ff79c6>(</span>Up<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>mlx5_6 port <span style=color:#8be9fd;font-style:italic>1</span> <span style=color:#ff79c6>==</span>&gt; xgbe6 <span style=color:#ff79c6>(</span>Up<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>mlx5_7 port <span style=color:#8be9fd;font-style:italic>1</span> <span style=color:#ff79c6>==</span>&gt; xgbe7 <span style=color:#ff79c6>(</span>Up<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>mlx5_8 port <span style=color:#8be9fd;font-style:italic>1</span> <span style=color:#ff79c6>==</span>&gt; xgbe8 <span style=color:#ff79c6>(</span>Up<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>root@node01 models<span style=color:#ff79c6>]</span><span style=color:#6272a4># show_gids</span>
</span></span><span style=display:flex><span>DEV     PORT    INDEX   GID                                     IPv4            VER     DEV
</span></span><span style=display:flex><span>---     ----    -----   ---                                     ------------    ---     ---
</span></span><span style=display:flex><span>mlx5_0  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>0</span>       fe80:0000:0000:0000:bae9:24ff:fef9:56e0                 v1      xgbe0
</span></span><span style=display:flex><span>mlx5_0  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>1</span>       fe80:0000:0000:0000:bae9:24ff:fef9:56e0                 v2      xgbe0
</span></span><span style=display:flex><span>mlx5_0  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>2</span>       0000:0000:0000:0000:0000:ffff:0a3f:41cf 10.63.65.207    v1      xgbe0
</span></span><span style=display:flex><span>mlx5_0  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>3</span>       0000:0000:0000:0000:0000:ffff:0a3f:41cf 10.63.65.207    v2      xgbe0
</span></span><span style=display:flex><span>mlx5_1  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>0</span>       fe80:0000:0000:0000:a288:c2ff:fe59:b8f8                 v1      xgbe1
</span></span><span style=display:flex><span>mlx5_1  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>1</span>       fe80:0000:0000:0000:a288:c2ff:fe59:b8f8                 v2      xgbe1
</span></span><span style=display:flex><span>mlx5_1  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>2</span>       0000:0000:0000:0000:0000:ffff:2102:a00f 33.2.160.15     v1      xgbe1
</span></span><span style=display:flex><span>mlx5_1  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>3</span>       0000:0000:0000:0000:0000:ffff:2102:a00f 33.2.160.15     v2      xgbe1
</span></span><span style=display:flex><span>mlx5_2  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>0</span>       fe80:0000:0000:0000:a288:c2ff:fe59:f360                 v1      xgbe2
</span></span><span style=display:flex><span>mlx5_2  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>1</span>       fe80:0000:0000:0000:a288:c2ff:fe59:f360                 v2      xgbe2
</span></span><span style=display:flex><span>mlx5_2  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>2</span>       0000:0000:0000:0000:0000:ffff:2102:a08f 33.2.160.143    v1      xgbe2
</span></span><span style=display:flex><span>mlx5_2  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>3</span>       0000:0000:0000:0000:0000:ffff:2102:a08f 33.2.160.143    v2      xgbe2
</span></span><span style=display:flex><span>mlx5_3  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>0</span>       fe80:0000:0000:0000:a288:c2ff:fe59:a6a8                 v1      xgbe3
</span></span><span style=display:flex><span>mlx5_3  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>1</span>       fe80:0000:0000:0000:a288:c2ff:fe59:a6a8                 v2      xgbe3
</span></span><span style=display:flex><span>mlx5_3  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>2</span>       0000:0000:0000:0000:0000:ffff:2102:a10f 33.2.161.15     v1      xgbe3
</span></span><span style=display:flex><span>mlx5_3  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>3</span>       0000:0000:0000:0000:0000:ffff:2102:a10f 33.2.161.15     v2      xgbe3
</span></span><span style=display:flex><span>mlx5_4  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>0</span>       fe80:0000:0000:0000:a288:c2ff:fe59:bc70                 v1      xgbe4
</span></span><span style=display:flex><span>mlx5_4  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>1</span>       fe80:0000:0000:0000:a288:c2ff:fe59:bc70                 v2      xgbe4
</span></span><span style=display:flex><span>mlx5_4  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>2</span>       0000:0000:0000:0000:0000:ffff:2102:a18f 33.2.161.143    v1      xgbe4
</span></span><span style=display:flex><span>mlx5_4  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>3</span>       0000:0000:0000:0000:0000:ffff:2102:a18f 33.2.161.143    v2      xgbe4
</span></span><span style=display:flex><span>mlx5_5  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>0</span>       fe80:0000:0000:0000:a288:c2ff:fe59:b9a0                 v1      xgbe5
</span></span><span style=display:flex><span>mlx5_5  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>1</span>       fe80:0000:0000:0000:a288:c2ff:fe59:b9a0                 v2      xgbe5
</span></span><span style=display:flex><span>mlx5_5  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>2</span>       0000:0000:0000:0000:0000:ffff:2102:a20f 33.2.162.15     v1      xgbe5
</span></span><span style=display:flex><span>mlx5_5  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>3</span>       0000:0000:0000:0000:0000:ffff:2102:a20f 33.2.162.15     v2      xgbe5
</span></span><span style=display:flex><span>mlx5_6  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>0</span>       fe80:0000:0000:0000:a288:c2ff:fe59:baf8                 v1      xgbe6
</span></span><span style=display:flex><span>mlx5_6  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>1</span>       fe80:0000:0000:0000:a288:c2ff:fe59:baf8                 v2      xgbe6
</span></span><span style=display:flex><span>mlx5_6  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>2</span>       0000:0000:0000:0000:0000:ffff:2102:a28f 33.2.162.143    v1      xgbe6
</span></span><span style=display:flex><span>mlx5_6  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>3</span>       0000:0000:0000:0000:0000:ffff:2102:a28f 33.2.162.143    v2      xgbe6
</span></span><span style=display:flex><span>mlx5_7  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>0</span>       fe80:0000:0000:0000:a288:c2ff:fe59:f118                 v1      xgbe7
</span></span><span style=display:flex><span>mlx5_7  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>1</span>       fe80:0000:0000:0000:a288:c2ff:fe59:f118                 v2      xgbe7
</span></span><span style=display:flex><span>mlx5_7  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>2</span>       0000:0000:0000:0000:0000:ffff:2102:a30f 33.2.163.15     v1      xgbe7
</span></span><span style=display:flex><span>mlx5_7  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>3</span>       0000:0000:0000:0000:0000:ffff:2102:a30f 33.2.163.15     v2      xgbe7
</span></span><span style=display:flex><span>mlx5_8  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>0</span>       fe80:0000:0000:0000:a288:c2ff:fe59:c800                 v1      xgbe8
</span></span><span style=display:flex><span>mlx5_8  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>1</span>       fe80:0000:0000:0000:a288:c2ff:fe59:c800                 v2      xgbe8
</span></span><span style=display:flex><span>mlx5_8  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>2</span>       0000:0000:0000:0000:0000:ffff:2102:a38f 33.2.163.143    v1      xgbe8
</span></span><span style=display:flex><span>mlx5_8  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>3</span>       0000:0000:0000:0000:0000:ffff:2102:a38f 33.2.163.143    v2      xgbe8
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>root@node02 models<span style=color:#ff79c6>]</span><span style=color:#6272a4># ibdev2netdev </span>
</span></span><span style=display:flex><span>mlx5_0 port <span style=color:#8be9fd;font-style:italic>1</span> <span style=color:#ff79c6>==</span>&gt; xgbe0 <span style=color:#ff79c6>(</span>Up<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>mlx5_1 port <span style=color:#8be9fd;font-style:italic>1</span> <span style=color:#ff79c6>==</span>&gt; xgbe1 <span style=color:#ff79c6>(</span>Up<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>mlx5_2 port <span style=color:#8be9fd;font-style:italic>1</span> <span style=color:#ff79c6>==</span>&gt; xgbe2 <span style=color:#ff79c6>(</span>Up<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>mlx5_3 port <span style=color:#8be9fd;font-style:italic>1</span> <span style=color:#ff79c6>==</span>&gt; xgbe3 <span style=color:#ff79c6>(</span>Up<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>mlx5_4 port <span style=color:#8be9fd;font-style:italic>1</span> <span style=color:#ff79c6>==</span>&gt; xgbe4 <span style=color:#ff79c6>(</span>Up<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>mlx5_5 port <span style=color:#8be9fd;font-style:italic>1</span> <span style=color:#ff79c6>==</span>&gt; xgbe5 <span style=color:#ff79c6>(</span>Up<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>mlx5_6 port <span style=color:#8be9fd;font-style:italic>1</span> <span style=color:#ff79c6>==</span>&gt; xgbe6 <span style=color:#ff79c6>(</span>Up<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>mlx5_7 port <span style=color:#8be9fd;font-style:italic>1</span> <span style=color:#ff79c6>==</span>&gt; xgbe7 <span style=color:#ff79c6>(</span>Up<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>mlx5_8 port <span style=color:#8be9fd;font-style:italic>1</span> <span style=color:#ff79c6>==</span>&gt; xgbe8 <span style=color:#ff79c6>(</span>Up<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>root@node02 models<span style=color:#ff79c6>]</span><span style=color:#6272a4># show_gids</span>
</span></span><span style=display:flex><span>DEV     PORT    INDEX   GID                                     IPv4            VER     DEV
</span></span><span style=display:flex><span>---     ----    -----   ---                                     ------------    ---     ---
</span></span><span style=display:flex><span>mlx5_0  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>0</span>       fe80:0000:0000:0000:e29d:73ff:fe25:effc                 v1      xgbe0
</span></span><span style=display:flex><span>mlx5_0  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>1</span>       fe80:0000:0000:0000:e29d:73ff:fe25:effc                 v2      xgbe0
</span></span><span style=display:flex><span>mlx5_0  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>2</span>       0000:0000:0000:0000:0000:ffff:0a3f:41d0 10.63.65.208    v1      xgbe0
</span></span><span style=display:flex><span>mlx5_0  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>3</span>       0000:0000:0000:0000:0000:ffff:0a3f:41d0 10.63.65.208    v2      xgbe0
</span></span><span style=display:flex><span>mlx5_1  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>0</span>       fe80:0000:0000:0000:a288:c2ff:fe59:d868                 v1      xgbe1
</span></span><span style=display:flex><span>mlx5_1  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>1</span>       fe80:0000:0000:0000:a288:c2ff:fe59:d868                 v2      xgbe1
</span></span><span style=display:flex><span>mlx5_1  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>2</span>       0000:0000:0000:0000:0000:ffff:2102:a010 33.2.160.16     v1      xgbe1
</span></span><span style=display:flex><span>mlx5_1  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>3</span>       0000:0000:0000:0000:0000:ffff:2102:a010 33.2.160.16     v2      xgbe1
</span></span><span style=display:flex><span>mlx5_2  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>0</span>       fe80:0000:0000:0000:a288:c2ff:fe59:f710                 v1      xgbe2
</span></span><span style=display:flex><span>mlx5_2  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>1</span>       fe80:0000:0000:0000:a288:c2ff:fe59:f710                 v2      xgbe2
</span></span><span style=display:flex><span>mlx5_2  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>2</span>       0000:0000:0000:0000:0000:ffff:2102:a090 33.2.160.144    v1      xgbe2
</span></span><span style=display:flex><span>mlx5_2  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>3</span>       0000:0000:0000:0000:0000:ffff:2102:a090 33.2.160.144    v2      xgbe2
</span></span><span style=display:flex><span>mlx5_3  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>0</span>       fe80:0000:0000:0000:a288:c2ff:fe59:ee30                 v1      xgbe3
</span></span><span style=display:flex><span>mlx5_3  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>1</span>       fe80:0000:0000:0000:a288:c2ff:fe59:ee30                 v2      xgbe3
</span></span><span style=display:flex><span>mlx5_3  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>2</span>       0000:0000:0000:0000:0000:ffff:2102:a110 33.2.161.16     v1      xgbe3
</span></span><span style=display:flex><span>mlx5_3  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>3</span>       0000:0000:0000:0000:0000:ffff:2102:a110 33.2.161.16     v2      xgbe3
</span></span><span style=display:flex><span>mlx5_4  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>0</span>       fe80:0000:0000:0000:a288:c2ff:fe59:c850                 v1      xgbe4
</span></span><span style=display:flex><span>mlx5_4  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>1</span>       fe80:0000:0000:0000:a288:c2ff:fe59:c850                 v2      xgbe4
</span></span><span style=display:flex><span>mlx5_4  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>2</span>       0000:0000:0000:0000:0000:ffff:2102:a190 33.2.161.144    v1      xgbe4
</span></span><span style=display:flex><span>mlx5_4  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>3</span>       0000:0000:0000:0000:0000:ffff:2102:a190 33.2.161.144    v2      xgbe4
</span></span><span style=display:flex><span>mlx5_5  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>0</span>       fe80:0000:0000:0000:a288:c2ff:fe59:ef38                 v1      xgbe5
</span></span><span style=display:flex><span>mlx5_5  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>1</span>       fe80:0000:0000:0000:a288:c2ff:fe59:ef38                 v2      xgbe5
</span></span><span style=display:flex><span>mlx5_5  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>2</span>       0000:0000:0000:0000:0000:ffff:2102:a210 33.2.162.16     v1      xgbe5
</span></span><span style=display:flex><span>mlx5_5  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>3</span>       0000:0000:0000:0000:0000:ffff:2102:a210 33.2.162.16     v2      xgbe5
</span></span><span style=display:flex><span>mlx5_6  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>0</span>       fe80:0000:0000:0000:a288:c2ff:fe59:c7e8                 v1      xgbe6
</span></span><span style=display:flex><span>mlx5_6  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>1</span>       fe80:0000:0000:0000:a288:c2ff:fe59:c7e8                 v2      xgbe6
</span></span><span style=display:flex><span>mlx5_6  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>2</span>       0000:0000:0000:0000:0000:ffff:2102:a290 33.2.162.144    v1      xgbe6
</span></span><span style=display:flex><span>mlx5_6  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>3</span>       0000:0000:0000:0000:0000:ffff:2102:a290 33.2.162.144    v2      xgbe6
</span></span><span style=display:flex><span>mlx5_7  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>0</span>       fe80:0000:0000:0000:a288:c2ff:fe59:b580                 v1      xgbe7
</span></span><span style=display:flex><span>mlx5_7  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>1</span>       fe80:0000:0000:0000:a288:c2ff:fe59:b580                 v2      xgbe7
</span></span><span style=display:flex><span>mlx5_7  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>2</span>       0000:0000:0000:0000:0000:ffff:2102:a310 33.2.163.16     v1      xgbe7
</span></span><span style=display:flex><span>mlx5_7  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>3</span>       0000:0000:0000:0000:0000:ffff:2102:a310 33.2.163.16     v2      xgbe7
</span></span><span style=display:flex><span>mlx5_8  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>0</span>       fe80:0000:0000:0000:a288:c2ff:fe59:b908                 v1      xgbe8
</span></span><span style=display:flex><span>mlx5_8  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>1</span>       fe80:0000:0000:0000:a288:c2ff:fe59:b908                 v2      xgbe8
</span></span><span style=display:flex><span>mlx5_8  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>2</span>       0000:0000:0000:0000:0000:ffff:2102:a390 33.2.163.144    v1      xgbe8
</span></span><span style=display:flex><span>mlx5_8  <span style=color:#bd93f9>1</span>       <span style=color:#bd93f9>3</span>       0000:0000:0000:0000:0000:ffff:2102:a390 33.2.163.144    v2      xgbe8
</span></span></code></pre></div><p><span style=color:red>⚠️ 注意：模型文件可能分为多个部分，一定要验证所有文件的完整性，避免因文件损坏导致的启动失败</span></p><h2 id=下载权重>下载权重</h2><p>从 <a href=https://huggingface.co/deepseek-ai/DeepSeek-R1>DeepSeek-R1</a> 下载 DeepSeek-R1 FP8 模型文件；</p><h1 id=vllm-双机测试>vllm 双机测试</h1><h2 id=测试脚本>测试脚本</h2><p>在主节点 head 机器启动前确保 8379 端口没有占用。</p><p>启动 ray 集群的脚本如下所示：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ff79c6>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#ff79c6></span>
</span></span><span style=display:flex><span><span style=color:#6272a4># Check for minimum number of required arguments</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>if</span> <span style=color:#ff79c6>[</span> <span style=color:#8be9fd;font-style:italic>$#</span> -lt <span style=color:#bd93f9>4</span> <span style=color:#ff79c6>]</span>; <span style=color:#ff79c6>then</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;Usage: </span><span style=color:#8be9fd;font-style:italic>$0</span><span style=color:#f1fa8c> docker_image head_node_address --head|--worker path_to_hf_home [additional_args...]&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>exit</span> <span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># Assign the first three arguments and shift them away</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>DOCKER_IMAGE</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$1</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>HEAD_NODE_ADDRESS</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$2</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>NODE_TYPE</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$3</span><span style=color:#f1fa8c>&#34;</span>  <span style=color:#6272a4># Should be --head or --worker</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>PATH_TO_HF_HOME</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$4</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>NODE_NAME</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$5</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>shift</span> <span style=color:#bd93f9>5</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># Additional arguments are passed directly to the Docker command</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>ADDITIONAL_ARGS</span><span style=color:#ff79c6>=(</span><span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$@</span><span style=color:#f1fa8c>&#34;</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># Validate node type</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>if</span> <span style=color:#ff79c6>[</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>NODE_TYPE</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span> !<span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;--head&#34;</span> <span style=color:#ff79c6>]</span> <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>[</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>NODE_TYPE</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span> !<span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;--worker&#34;</span> <span style=color:#ff79c6>]</span>; <span style=color:#ff79c6>then</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;Error: Node type must be --head or --worker&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>exit</span> <span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># Define a function to cleanup on EXIT signal</span>
</span></span><span style=display:flex><span>cleanup<span style=color:#ff79c6>()</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    docker stop <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>NODE_NAME</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>    docker rm <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>NODE_NAME</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>trap</span> cleanup EXIT
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># Command setup for head or worker node</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>RAY_START_CMD</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;ray start --block&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>if</span> <span style=color:#ff79c6>[</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>NODE_TYPE</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span> <span style=color:#ff79c6>==</span> <span style=color:#f1fa8c>&#34;--head&#34;</span> <span style=color:#ff79c6>]</span>; <span style=color:#ff79c6>then</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>RAY_START_CMD</span><span style=color:#ff79c6>+=</span><span style=color:#f1fa8c>&#34; --head --port=8379 --dashboard-host=0.0.0.0&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>else</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>RAY_START_CMD</span><span style=color:#ff79c6>+=</span><span style=color:#f1fa8c>&#34; --address=</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>HEAD_NODE_ADDRESS</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>:8379&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># Run the docker command with the user specified parameters and additional arguments</span>
</span></span><span style=display:flex><span>docker run <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --entrypoint /bin/bash <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --privileged <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --network host <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --ipc host <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --name <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>NODE_NAME</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --shm-size 128G <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --gpus all <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    -v <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>PATH_TO_HF_HOME</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>:/mnt/models&#34;</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>ADDITIONAL_ARGS</span>[@]<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>DOCKER_IMAGE</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span> -c <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>RAY_START_CMD</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span>
</span></span></code></pre></div><p>在每个节点执行如下所示：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#6272a4># 主节点 IP</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>IP_OF_HEAD_NODE</span><span style=color:#ff79c6>=</span>10.63.65.207
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>MODEL_PATH</span><span style=color:#ff79c6>=</span>/ssd1/models
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>VLLM_HOST_IP</span><span style=color:#ff79c6>=</span><span style=color:#ff79c6>$(</span>hostname -I | awk <span style=color:#f1fa8c>&#39;{print $1}&#39;</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>HOST_IP</span><span style=color:#ff79c6>=</span><span style=color:#ff79c6>$(</span>hostname -I | awk <span style=color:#f1fa8c>&#39;{print $1}&#39;</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>GLOO_SOCKET_IFNAME</span><span style=color:#ff79c6>=</span>xgbe0
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>TP_SOCKET_IFNAME</span><span style=color:#ff79c6>=</span>xgbe0
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>NCCL_SOCKET_IFNAME</span><span style=color:#ff79c6>=</span>xgbe0
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>NCCL_DEBUG</span><span style=color:#ff79c6>=</span>INFO
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>NCCL_IB_HCA</span><span style=color:#ff79c6>=</span>mlx5_1:1,mlx5_2:1,mlx5_3:1,mlx5_4:1,mlx5_5:1,mlx5_6:1,mlx5_7:1,mlx5_8:1 
</span></span><span style=display:flex><span><span style=color:#6272a4># 以下配置也可</span>
</span></span><span style=display:flex><span><span style=color:#6272a4>#export NCCL_IB_HCA=xgbe1,xgbe2,xgbe3,xgbe4,xgbe5,xgbe6,xgbe7,xgbe8</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>NCCL_IB_GID_INDEX</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>3</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>NCCL_IB_DISABLE</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>0</span>
</span></span></code></pre></div><h2 id=启动-head-节点>启动 head 节点</h2><p>启动主节点 head：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nohup bash run_cluster.sh  vllm/vllm-openai:v0.7.2 <span style=color:#8be9fd;font-style:italic>$IP_OF_HEAD_NODE</span> --head <span style=color:#8be9fd;font-style:italic>$MODEL_PATH</span>  ray-node-head -e  <span style=color:#8be9fd;font-style:italic>NCCL_SOCKET_IFNAME</span><span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>$NCCL_SOCKET_IFNAME</span> -e <span style=color:#8be9fd;font-style:italic>NCCL_DEBUG</span><span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>$NCCL_DEBUG</span> -e <span style=color:#8be9fd;font-style:italic>NCCL_IB_DISABLE</span><span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>$NCCL_IB_DISABLE</span> -e <span style=color:#8be9fd;font-style:italic>NCCL_IB_HCA</span><span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>$NCCL_IB_HCA</span> -e  <span style=color:#8be9fd;font-style:italic>NCCL_IB_GID_INDEX</span><span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>$NCCL_IB_GID_INDEX</span> -e <span style=color:#8be9fd;font-style:italic>VLLM_HOST_IP</span><span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>$VLLM_HOST_IP</span>  -e <span style=color:#8be9fd;font-style:italic>HOST_IP</span><span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>$HOST_IP</span> &gt; nohup-head.log 2&gt;&amp;<span style=color:#bd93f9>1</span> &amp; 
</span></span></code></pre></div><h2 id=启动-worker-节点>启动 worker 节点</h2><p>启动从节点 worker：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nohup bash run_cluster.sh  vllm/vllm-openai:v0.7.2 <span style=color:#8be9fd;font-style:italic>$IP_OF_HEAD_NODE</span> --worker <span style=color:#8be9fd;font-style:italic>$MODEL_PATH</span>  ray-node-worker -e <span style=color:#8be9fd;font-style:italic>NCCL_SOCKET_IFNAME</span><span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>$NCCL_SOCKET_IFNAME</span> -e <span style=color:#8be9fd;font-style:italic>NCCL_DEBUG</span><span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>$NCCL_DEBUG</span> -e <span style=color:#8be9fd;font-style:italic>NCCL_IB_DISABLE</span><span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>$NCCL_IB_DISABLE</span> -e <span style=color:#8be9fd;font-style:italic>NCCL_IB_HCA</span><span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>$NCCL_IB_HCA</span> -e  <span style=color:#8be9fd;font-style:italic>NCCL_IB_GID_INDEX</span><span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>$NCCL_IB_GID_INDEX</span> -e <span style=color:#8be9fd;font-style:italic>VLLM_HOST_IP</span><span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>$VLLM_HOST_IP</span>  -e <span style=color:#8be9fd;font-style:italic>HOST_IP</span><span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>$HOST_IP</span> &gt; nohup-worker.log 2&gt;&amp;<span style=color:#bd93f9>1</span> &amp; 
</span></span></code></pre></div><h2 id=启动-deepseek-r1-模型>启动 deepseek r1 模型</h2><p><span style=color:red>注：如果机器开启ipv6双栈网络，强烈建议配置该参数；</span></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>VLLM_HOST_IP</span><span style=color:#ff79c6>=</span><span style=color:#ff79c6>$(</span>hostname -I | awk <span style=color:#f1fa8c>&#39;{print $1}&#39;</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>HOST_IP</span><span style=color:#ff79c6>=</span><span style=color:#ff79c6>$(</span>hostname -I | awk <span style=color:#f1fa8c>&#39;{print $1}&#39;</span><span style=color:#ff79c6>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>python3 -m vllm.entrypoints.openai.api_server --model /mnt/models/DeepSeek-R1 --gpu-memory-utilization 0.90 --tensor-parallel-size <span style=color:#bd93f9>16</span> --host 0.0.0.0 --trust-remote-code --port <span style=color:#bd93f9>8000</span>  --max_num_seqs <span style=color:#bd93f9>256</span>  --max-num-batched-tokens <span style=color:#bd93f9>16384</span>  --max_model_len <span style=color:#bd93f9>16384</span>  --max_seq_len_to_capture <span style=color:#bd93f9>16384</span>   --tokenizer-mode auto  --enable-chunked-prefill<span style=color:#ff79c6>=</span>False  --enable-reasoning --reasoning-parser deepseek_r1  --enforce-eager 
</span></span></code></pre></div><p>参数说明：</p><ul><li>&ndash;model 模型路径，加载 /workspace/DeepSeek-R1 目录下的模型。</li><li>&ndash;host 0.0.0.0监听所有网络接口的请求（允许外部访问）。</li><li>&ndash;port 服务端口号设为 8000。</li><li>&ndash;tokenizer-mode auto 自动选择分词器模式（优先使用 HuggingFace 的 auto 配置）。</li><li>&ndash;gpu-memory-utilization 0.90 GPU 显存利用率上限设为 90%（避免 OOM）。如果高并发服务运行异常，建议调低此值。</li><li>&ndash;tensor-parallel-size 16 使用 16 路张量并行（需 GPU 数量支持，适合超大模型）。</li><li>&ndash;enforce-eager 强制启用 PyTorch 的 eager 模式（可能牺牲性能以提升兼容性）。</li><li>&ndash;max_num_seqs 256 单次批处理的最大序列数（并发请求数上限）。vLLM 会动态调整，一般默认值设置为256。</li><li>&ndash;max-num-batched-tokens 16384 批处理的最大总 token 数（影响吞吐量）。最大输入长度要小于这个数值。</li><li>&ndash;max_model_len 16384 模型支持的最大上下文长度（16K tokens）。</li><li>&ndash;max_seq_len_to_capture 16384 捕获的序列最大长度（用于优化 CUDA 内核）。框架默认超参，当前版本需要与 max_model_len 保持一致。</li><li>&ndash;enable-chunked-prefill=False 禁用分块预填充（可能减少延迟但增加显存压力）。</li><li>&ndash;enable-reasoning 启用推理模式（需配合 &ndash;reasoning-parser）。</li><li>&ndash;reasoning-parser deepseek_r1 指定推理解析器为 deepseek_r1（自定义逻辑）。</li><li>&ndash;trust-remote-code 允许加载远程代码（如自定义模型或分词器）。</li></ul><p>如果 NET/IB 出现如下字段表示双机 RDMA 通信正常：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>NET/TB: Using ..... OOB xgbe0:10.63.65.208&lt;0&gt;
</span></span></code></pre></div><p>如果出现如下文字，则表示 DeepSeek R1 启动成功：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Starting vLLM API server on http://0.0.0.0:8000
</span></span></code></pre></div><p>测试服务是否启动成功：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>root@node01 curl http://localhost:8000/v1/models -H <span style=color:#f1fa8c>&#34;Content-Type: application/json&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>{</span><span style=color:#f1fa8c>&#34;object&#34;</span>:<span style=color:#f1fa8c>&#34;list&#34;</span>,<span style=color:#f1fa8c>&#34;data&#34;</span>:<span style=color:#ff79c6>[{</span><span style=color:#f1fa8c>&#34;id&#34;</span>:<span style=color:#f1fa8c>&#34;/mnt/models/DeepSeek-R1&#34;</span>,<span style=color:#f1fa8c>&#34;object&#34;</span>:<span style=color:#f1fa8c>&#34;model&#34;</span>,<span style=color:#f1fa8c>&#34;created&#34;</span>:1743226823,<span style=color:#f1fa8c>&#34;owned_by&#34;</span>:<span style=color:#f1fa8c>&#34;vllm&#34;</span>,<span style=color:#f1fa8c>&#34;root&#34;</span>:<span style=color:#f1fa8c>&#34;/mnt/models/DeepSeek-R1&#34;</span>,<span style=color:#f1fa8c>&#34;parent&#34;</span>:null,<span style=color:#f1fa8c>&#34;max_model_len&#34;</span>:16384,<span style=color:#f1fa8c>&#34;permission&#34;</span>:<span style=color:#ff79c6>[{</span><span style=color:#f1fa8c>&#34;id&#34;</span>:<span style=color:#f1fa8c>&#34;modelperm-84fad4c5fa5748aeaf39e39fbe56236e&#34;</span>,<span style=color:#f1fa8c>&#34;object&#34;</span>:<span style=color:#f1fa8c>&#34;model_permission&#34;</span>,<span style=color:#f1fa8c>&#34;created&#34;</span>:1743226823,<span style=color:#f1fa8c>&#34;allow_create_engine&#34;</span>:false,<span style=color:#f1fa8c>&#34;allow_sampling&#34;</span>:true,<span style=color:#f1fa8c>&#34;allow_logprobs&#34;</span>:true,<span style=color:#f1fa8c>&#34;allow_search_indices&#34;</span>:false,<span style=color:#f1fa8c>&#34;allow_view&#34;</span>:true,<span style=color:#f1fa8c>&#34;allow_fine_tuning&#34;</span>:false,<span style=color:#f1fa8c>&#34;organization&#34;</span>:<span style=color:#f1fa8c>&#34;*&#34;</span>,<span style=color:#f1fa8c>&#34;group&#34;</span>:null,<span style=color:#f1fa8c>&#34;is_blocking&#34;</span>:false<span style=color:#ff79c6>}]}]}</span>
</span></span></code></pre></div><h2 id=参考>参考</h2><ul><li><a href=https://docs.vllm.ai/en/latest/serving/distributed_serving.html>https://docs.vllm.ai/en/latest/serving/distributed_serving.html</a></li><li><a href=https://github.com/vllm-project/vllm/blob/main/examples/online_serving/run_cluster.sh>https://github.com/vllm-project/vllm/blob/main/examples/online_serving/run_cluster.sh</a></li><li><a href=https://github.com/vllm-project/vllm/issues/1363>https://github.com/vllm-project/vllm/issues/1363</a></li></ul><h1 id=sglang-双机测试>sglang 双机测试</h1><h2 id=配置环境>配置环境</h2><p>启动节点 node1：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run --gpus all <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --network<span style=color:#ff79c6>=</span>host <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --ipc<span style=color:#ff79c6>=</span>host <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --security-opt<span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>seccomp</span><span style=color:#ff79c6>=</span>unconfined <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --cap-add<span style=color:#ff79c6>=</span>SYS_PTRACE <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --ulimit<span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>memlock</span><span style=color:#ff79c6>=</span>-1 --ulimit<span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>nofile</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>120000</span> --ulimit<span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>stack</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>67108864</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --shm-size<span style=color:#ff79c6>=</span>128G <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --privileged <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    -v /ssd1/models:/mnt/models <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --name sglang_node1 <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    -itd <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    lmsysorg/sglang:481f2edc18b5
</span></span></code></pre></div><p>启动节点 node2：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run --gpus all <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --network<span style=color:#ff79c6>=</span>host <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --ipc<span style=color:#ff79c6>=</span>host <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --security-opt<span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>seccomp</span><span style=color:#ff79c6>=</span>unconfined <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --cap-add<span style=color:#ff79c6>=</span>SYS_PTRACE <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --ulimit<span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>memlock</span><span style=color:#ff79c6>=</span>-1 --ulimit<span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>nofile</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>120000</span> --ulimit<span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>stack</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>67108864</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --shm-size<span style=color:#ff79c6>=</span>128G <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --privileged <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    -v /ssd1/models:/mnt/models <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --name sglang_node2 <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    -itd <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --ipc<span style=color:#ff79c6>=</span>host <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    lmsysorg/sglang:481f2edc18b5
</span></span></code></pre></div><h2 id=构建-sglang-双机环境>构建 sglang 双机环境</h2><p>在主节点 node1 服务启动前确保机器 30000 端口没有被占用。</p><p>在每个节点的容器里面执行以下操作：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#6272a4># 主节点 IP</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>IP_OF_HEAD_NODE</span><span style=color:#ff79c6>=</span>10.63.65.207
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>SGLANG_HOST_IP</span><span style=color:#ff79c6>=</span><span style=color:#ff79c6>$(</span>hostname -I | awk <span style=color:#f1fa8c>&#39;{print $1}&#39;</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>HOST_IP</span><span style=color:#ff79c6>=</span><span style=color:#ff79c6>$(</span>hostname -I | awk <span style=color:#f1fa8c>&#39;{print $1}&#39;</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>GLOO_SOCKET_IFNAME</span><span style=color:#ff79c6>=</span>xgbe0
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>TP_SOCKET_IFNAME</span><span style=color:#ff79c6>=</span>xgbe0
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>NCCL_SOCKET_IFNAME</span><span style=color:#ff79c6>=</span>xgbe0
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>NCCL_DEBUG</span><span style=color:#ff79c6>=</span>INFO
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>NCCL_IB_HCA</span><span style=color:#ff79c6>=</span>mlx5_1:1,mlx5_2:1,mlx5_3:1,mlx5_4:1,mlx5_5:1,mlx5_6:1,mlx5_7:1,mlx5_8:1 
</span></span><span style=display:flex><span><span style=color:#6272a4># 以下配置也可以</span>
</span></span><span style=display:flex><span><span style=color:#6272a4>#export NCCL_IB_HCA=xgbe1,xgbe2,xgbe3,xgbe4,xgbe5,xgbe6,xgbe7,xgbe8</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>NCCL_IB_GID_INDEX</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>3</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>NCCL_IB_DISABLE</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>0</span>
</span></span></code></pre></div><p><span style=color:red>注：如果机器开启ipv6双栈网络，并且 ipv6 网络不通，强烈建议配置该参数；</span></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>SGLANG_HOST_IP</span><span style=color:#ff79c6>=</span><span style=color:#ff79c6>$(</span>hostname -I | awk <span style=color:#f1fa8c>&#39;{print $1}&#39;</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>HOST_IP</span><span style=color:#ff79c6>=</span><span style=color:#ff79c6>$(</span>hostname -I | awk <span style=color:#f1fa8c>&#39;{print $1}&#39;</span><span style=color:#ff79c6>)</span>
</span></span></code></pre></div><p>这个地方非常非常非常非常有点坑，详见代码 <a href=https://github.com/sgl-project/sglang/blob/main/python/sglang/srt/utils.py#L1601>https://github.com/sgl-project/sglang/blob/main/python/sglang/srt/utils.py#L1601</a>。</p><p><img src=/images/2025-04-05-2h20-deepseek-r1-sglang-vllm/1.png alt></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker <span style=color:#8be9fd;font-style:italic>exec</span> -it sglang_node1 bash
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># 节点1</span>
</span></span><span style=display:flex><span>python3 -m sglang.launch_server <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --model-path /mnt/models/DeepSeek-R1 <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --dist-init-addr <span style=color:#8be9fd;font-style:italic>$IP_OF_HEAD_NODE</span>:30000 <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --nnodes <span style=color:#bd93f9>2</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --node-rank <span style=color:#bd93f9>0</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --tp <span style=color:#bd93f9>16</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --trust-remote-code <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --mem-fraction-static 0.90 <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --tokenizer-mode auto <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --chunked-prefill-size  <span style=color:#bd93f9>4096</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --context-length  <span style=color:#bd93f9>65536</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --quantization fp8  <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --reasoning-parser deepseek-r1 <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --host 0.0.0.0 <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --port <span style=color:#bd93f9>8000</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker <span style=color:#8be9fd;font-style:italic>exec</span> -it sglang_node2 bash
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># 节点2</span>
</span></span><span style=display:flex><span>python3 -m sglang.launch_server <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --model-path /mnt/models/DeepSeek-R1 <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --dist-init-addr <span style=color:#8be9fd;font-style:italic>$IP_OF_HEAD_NODE</span>:30000 <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --nnodes <span style=color:#bd93f9>2</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --node-rank <span style=color:#bd93f9>1</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --tp <span style=color:#bd93f9>16</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --trust-remote-code <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --mem-fraction-static 0.90 <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --tokenizer-mode auto <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --chunked-prefill-size  <span style=color:#bd93f9>4096</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --context-length  <span style=color:#bd93f9>65536</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --quantization fp8  <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --reasoning-parser deepseek-r1 <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --host 0.0.0.0 <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --port <span style=color:#bd93f9>8000</span> 
</span></span></code></pre></div><p>参数说明</p><ul><li>&ndash;model-path 模型路径，加载 /mnt/models/DeepSeek-R1 目录下的模型。</li><li>&ndash;host 0.0.0.0监听所有网络接口的请求（允许外部访问）。</li><li>&ndash;port 服务端口号设为 8000。</li><li>&ndash;tokenizer-mode auto 自动选择分词器模式（优先使用 HuggingFace 的 auto 配置）。</li><li>&ndash;tp 16 使用 16 路张量并行（需 GPU 数量支持，适合超大模型）。</li><li>&ndash;reasoning-parser deepseek-r1 指定推理解析器为 deepseek-r1（自定义逻辑）。</li><li>&ndash;trust-remote-code 允许加载远程代码（如自定义模型或分词器）。</li></ul><h2 id=启动-deepseek-r1-模型-1>启动 deepseek r1 模型</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker <span style=color:#8be9fd;font-style:italic>exec</span> -it sglang_node1 bash
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># 节点1</span>
</span></span><span style=display:flex><span>python3 -m sglang.launch_server <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --model-path /mnt/models/DeepSeek-R1 <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --dist-init-addr <span style=color:#8be9fd;font-style:italic>$IP_OF_HEAD_NODE</span>:30000 <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --nnodes <span style=color:#bd93f9>2</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --node-rank <span style=color:#bd93f9>0</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --tp <span style=color:#bd93f9>16</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --trust-remote-code <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --mem-fraction-static 0.90 <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --tokenizer-mode auto <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --chunked-prefill-size  <span style=color:#bd93f9>4096</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --context-length  <span style=color:#bd93f9>65536</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --quantization fp8  <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --reasoning-parser deepseek-r1 <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --host 0.0.0.0 <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --port <span style=color:#bd93f9>8000</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker <span style=color:#8be9fd;font-style:italic>exec</span> -it sglang_node2 bash
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># 节点2</span>
</span></span><span style=display:flex><span>python3 -m sglang.launch_server <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --model-path /mnt/models/DeepSeek-R1 <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --dist-init-addr <span style=color:#8be9fd;font-style:italic>$IP_OF_HEAD_NODE</span>:30000 <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --nnodes <span style=color:#bd93f9>2</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --node-rank <span style=color:#bd93f9>1</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --tp <span style=color:#bd93f9>16</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --trust-remote-code <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --mem-fraction-static 0.90 <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --tokenizer-mode auto <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --chunked-prefill-size  <span style=color:#bd93f9>4096</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --context-length  <span style=color:#bd93f9>65536</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --quantization fp8  <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --reasoning-parser deepseek-r1 <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --host 0.0.0.0 <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --port <span style=color:#bd93f9>8000</span> 
</span></span></code></pre></div><p>如果 NET/IB 出现如下字段表示双机 RDMA 通信正常：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>NET/TB: Using ..... OOB xgbe0:10.63.65.208
</span></span></code></pre></div><p>如果出现如下文字，则表示 DeepSeek R1 启动成功：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>The server is fired up and ready to roll!
</span></span></code></pre></div><p>测试服务是否启动成功：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>root@node01 curl http://localhost:8000/v1/models -H <span style=color:#f1fa8c>&#34;Content-Type: application/json&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>{</span><span style=color:#f1fa8c>&#34;object&#34;</span>:<span style=color:#f1fa8c>&#34;list&#34;</span>,<span style=color:#f1fa8c>&#34;data&#34;</span>:<span style=color:#ff79c6>[{</span><span style=color:#f1fa8c>&#34;id&#34;</span>:<span style=color:#f1fa8c>&#34;/mnt/models/DeepSeek-R1&#34;</span>,<span style=color:#f1fa8c>&#34;object&#34;</span>:<span style=color:#f1fa8c>&#34;model&#34;</span>,<span style=color:#f1fa8c>&#34;created&#34;</span>:1743226823,<span style=color:#f1fa8c>&#34;owned_by&#34;</span>:<span style=color:#f1fa8c>&#34;vllm&#34;</span>,<span style=color:#f1fa8c>&#34;root&#34;</span>:<span style=color:#f1fa8c>&#34;/mnt/models/DeepSeek-R1&#34;</span>,<span style=color:#f1fa8c>&#34;parent&#34;</span>:null,<span style=color:#f1fa8c>&#34;max_model_len&#34;</span>:16384,<span style=color:#f1fa8c>&#34;permission&#34;</span>:<span style=color:#ff79c6>[{</span><span style=color:#f1fa8c>&#34;id&#34;</span>:<span style=color:#f1fa8c>&#34;modelperm-84fad4c5fa5748aeaf39e39fbe56236e&#34;</span>,<span style=color:#f1fa8c>&#34;object&#34;</span>:<span style=color:#f1fa8c>&#34;model_permission&#34;</span>,<span style=color:#f1fa8c>&#34;created&#34;</span>:1743226823,<span style=color:#f1fa8c>&#34;allow_create_engine&#34;</span>:false,<span style=color:#f1fa8c>&#34;allow_sampling&#34;</span>:true,<span style=color:#f1fa8c>&#34;allow_logprobs&#34;</span>:true,<span style=color:#f1fa8c>&#34;allow_search_indices&#34;</span>:false,<span style=color:#f1fa8c>&#34;allow_view&#34;</span>:true,<span style=color:#f1fa8c>&#34;allow_fine_tuning&#34;</span>:false,<span style=color:#f1fa8c>&#34;organization&#34;</span>:<span style=color:#f1fa8c>&#34;*&#34;</span>,<span style=color:#f1fa8c>&#34;group&#34;</span>:null,<span style=color:#f1fa8c>&#34;is_blocking&#34;</span>:false<span style=color:#ff79c6>}]}]}</span>
</span></span></code></pre></div><ul><li>性能优化选项：默认已启用 MLA（内存布局优化）加速。以下为可选优化项，可按需开启：</li><li>数据并行注意力（Data Parallelism Attention）：适用于高 QPS（每秒查询量）场景，添加 <code>--enable-dp-attention</code> 参数可显著提升吞吐量。</li><li>Torch.compile 优化：添加 <code>--enable-torch-compile</code> 参数以启用。服务启动时将消耗额外时间进行编译。可通过 <code>--torch-compile-max-bs</code> 控制优化后的最大批处理大小，建议设为 1 至 8 之间（例如：<code>--torch-compile-max-bs 8</code>）。</li></ul><p>开启 <code>--enable-torch-compile --torch-compile-max-bs 8</code> 参数后启动耗时比较长，大约需要 20 多分钟；</p><h2 id=参考-1>参考</h2><ul><li><a href=https://github.com/sgl-project/sglang/tree/main/benchmark/deepseek_v3#example-serving-with-2-h208>https://github.com/sgl-project/sglang/tree/main/benchmark/deepseek_v3#example-serving-with-2-h208</a></li></ul><h1 id=构建-sglang-双机环境默认参数>构建 sglang 双机环境（默认参数）</h1><h2 id=构建环境>构建环境</h2><p>在主节点 node1 服务启动前确保机器 30000 端口没有被占用</p><p>启动节点 node1：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run --gpus all <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --network<span style=color:#ff79c6>=</span>host <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --ipc<span style=color:#ff79c6>=</span>host <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --security-opt<span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>seccomp</span><span style=color:#ff79c6>=</span>unconfined <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --cap-add<span style=color:#ff79c6>=</span>SYS_PTRACE <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --ulimit<span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>memlock</span><span style=color:#ff79c6>=</span>-1 --ulimit<span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>nofile</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>120000</span> --ulimit<span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>stack</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>67108864</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --shm-size<span style=color:#ff79c6>=</span>128G <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --privileged <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    -v /ssd1/models:/mnt/models <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --name sglang_node1 <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    -itd <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    lmsysorg/sglang:ea52b45be1a7
</span></span></code></pre></div><p>启动节点 node2：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run --gpus all <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --network<span style=color:#ff79c6>=</span>host <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --ipc<span style=color:#ff79c6>=</span>host <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --security-opt<span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>seccomp</span><span style=color:#ff79c6>=</span>unconfined <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --cap-add<span style=color:#ff79c6>=</span>SYS_PTRACE <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --ulimit<span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>memlock</span><span style=color:#ff79c6>=</span>-1 --ulimit<span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>nofile</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>120000</span> --ulimit<span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>stack</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>67108864</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --shm-size<span style=color:#ff79c6>=</span>128G <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --privileged <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    -v /ssd1/models:/mnt/models <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --name sglang_node2 <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    -itd <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --ipc<span style=color:#ff79c6>=</span>host <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    lmsysorg/sglang:ea52b45be1a7
</span></span></code></pre></div><p>启动 deepseek r1 服务，在每个节点的容器里面执行以下操作：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#6272a4># 主节点 IP</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>IP_OF_HEAD_NODE</span><span style=color:#ff79c6>=</span>10.63.65.207
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>SGLANG_HOST_IP</span><span style=color:#ff79c6>=</span><span style=color:#ff79c6>$(</span>hostname -I | awk <span style=color:#f1fa8c>&#39;{print $1}&#39;</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>HOST_IP</span><span style=color:#ff79c6>=</span><span style=color:#ff79c6>$(</span>hostname -I | awk <span style=color:#f1fa8c>&#39;{print $1}&#39;</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>GLOO_SOCKET_IFNAME</span><span style=color:#ff79c6>=</span>xgbe0
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>TP_SOCKET_IFNAME</span><span style=color:#ff79c6>=</span>xgbe0
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>NCCL_SOCKET_IFNAME</span><span style=color:#ff79c6>=</span>xgbe0
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>NCCL_DEBUG</span><span style=color:#ff79c6>=</span>INFO
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>NCCL_IB_HCA</span><span style=color:#ff79c6>=</span>xgbe1,xgbe2,xgbe3,xgbe4,xgbe5,xgbe6,xgbe7,xgbe8
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>NCCL_IB_GID_INDEX</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>3</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>NCCL_IB_DISABLE</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>0</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker <span style=color:#8be9fd;font-style:italic>exec</span> -it sglang_node1 bash
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>python3 -m sglang.launch_server --model-path /mnt/models/DeepSeek-R1 --tp <span style=color:#bd93f9>16</span> --dist-init-addr <span style=color:#8be9fd;font-style:italic>$IP_OF_HEAD_NODE</span>:30000 --nnodes <span style=color:#bd93f9>2</span> --node-rank <span style=color:#bd93f9>0</span> --trust-remote-code --host 0.0.0.0 --port <span style=color:#bd93f9>8000</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker <span style=color:#8be9fd;font-style:italic>exec</span> -it sglang_node2 bash
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>python3 -m sglang.launch_server --model-path /mnt/models/DeepSeek-R1 --tp <span style=color:#bd93f9>16</span> --dist-init-addr <span style=color:#8be9fd;font-style:italic>$IP_OF_HEAD_NODE</span>:30000 --nnodes <span style=color:#bd93f9>2</span> --node-rank <span style=color:#bd93f9>1</span> --trust-remote-code --host 0.0.0.0 --port <span style=color:#bd93f9>8000</span>
</span></span></code></pre></div><p>如果启动成功，则出现如下日志：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>The server is fired up and ready to roll!
</span></span></code></pre></div><h2 id=性能测试>性能测试</h2><p>测试脚本：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ff79c6>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#ff79c6></span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>output_dir</span><span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>$1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>declare</span> -A <span style=color:#8be9fd;font-style:italic>test_cases</span><span style=color:#ff79c6>=(</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4># 格式: &#34;输入长度 输出长度 numprt&#34;=&#34;描述&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#34;128 128 1&#34;</span><span style=color:#ff79c6>]=</span><span style=color:#f1fa8c>&#34;128&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#34;128 128 2&#34;</span><span style=color:#ff79c6>]=</span><span style=color:#f1fa8c>&#34;128&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#34;128 128 4&#34;</span><span style=color:#ff79c6>]=</span><span style=color:#f1fa8c>&#34;128&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#34;128 128 8&#34;</span><span style=color:#ff79c6>]=</span><span style=color:#f1fa8c>&#34;128&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#34;128 128 16&#34;</span><span style=color:#ff79c6>]=</span><span style=color:#f1fa8c>&#34;128&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#34;128 128 32&#34;</span><span style=color:#ff79c6>]=</span><span style=color:#f1fa8c>&#34;128&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#34;128 128 64&#34;</span><span style=color:#ff79c6>]=</span><span style=color:#f1fa8c>&#34;128&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#34;128 128 128&#34;</span><span style=color:#ff79c6>]=</span><span style=color:#f1fa8c>&#34;128&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#34;128 128 256&#34;</span><span style=color:#ff79c6>]=</span><span style=color:#f1fa8c>&#34;128&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#34;128 128 512&#34;</span><span style=color:#ff79c6>]=</span><span style=color:#f1fa8c>&#34;128&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#34;128 128 1024&#34;</span><span style=color:#ff79c6>]=</span><span style=color:#f1fa8c>&#34;128&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#34;256 256 1&#34;</span><span style=color:#ff79c6>]=</span><span style=color:#f1fa8c>&#34;256&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#34;256 256 2&#34;</span><span style=color:#ff79c6>]=</span><span style=color:#f1fa8c>&#34;256&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#34;256 256 4&#34;</span><span style=color:#ff79c6>]=</span><span style=color:#f1fa8c>&#34;256&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#34;256 256 8&#34;</span><span style=color:#ff79c6>]=</span><span style=color:#f1fa8c>&#34;256&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#34;256 256 16&#34;</span><span style=color:#ff79c6>]=</span><span style=color:#f1fa8c>&#34;256&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#34;256 256 32&#34;</span><span style=color:#ff79c6>]=</span><span style=color:#f1fa8c>&#34;256&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#34;256 256 64&#34;</span><span style=color:#ff79c6>]=</span><span style=color:#f1fa8c>&#34;256&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#34;256 256 128&#34;</span><span style=color:#ff79c6>]=</span><span style=color:#f1fa8c>&#34;256&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#34;256 256 256&#34;</span><span style=color:#ff79c6>]=</span><span style=color:#f1fa8c>&#34;256&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#34;256 256 512&#34;</span><span style=color:#ff79c6>]=</span><span style=color:#f1fa8c>&#34;256&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#34;256 256 1024&#34;</span><span style=color:#ff79c6>]=</span><span style=color:#f1fa8c>&#34;256&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>random_range_ratios</span><span style=color:#ff79c6>=(</span>1.0<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># 循环遍历所有测试用例</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>for</span> <span style=color:#ff79c6>case</span> in <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span>!test_cases[@]<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span>; <span style=color:#ff79c6>do</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4># 分割输入长度、输出长度和numprt</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>IFS</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#39; &#39;</span> <span style=color:#8be9fd;font-style:italic>read</span> inlen outlen numprt <span style=color:#ff79c6>&lt;&lt;&lt;</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>case</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#6272a4># 构建日志文件名和结果文件名</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>result_file</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>output_dir</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>/serving_benchmark_</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>numprt</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>_</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>inlen</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>_</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>outlen</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>.json&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     <span style=color:#ff79c6>for</span> ratio in <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>random_range_ratios</span>[@]<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>do</span>
</span></span><span style=display:flex><span>            python3 -m sglang.bench_serving <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>                --backend sglang <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>                --dataset-name random <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>                --dataset-path /mnt/models/sglang-perf/datasets/ShareGPT_V3_unfiltered_cleaned_split.json <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>                --model /mnt/models/DeepSeek-R1 <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>                --random-input <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>inlen</span><span style=color:#f1fa8c>}</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>                --random-output <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>outlen</span><span style=color:#f1fa8c>}</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>                --random-range-ratio <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>ratio</span><span style=color:#f1fa8c>}</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>                --num-prompts <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>numprt</span><span style=color:#f1fa8c>}</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>                --host 0.0.0.0 <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>                --port <span style=color:#bd93f9>8000</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>                --output-file <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$result_file</span><span style=color:#f1fa8c>&#34;</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>                --max-concurrency <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>numprt</span><span style=color:#f1fa8c>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>done</span>
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;Executed command for num-prompts=</span><span style=color:#8be9fd;font-style:italic>$numprt</span><span style=color:#f1fa8c>, inlen=</span><span style=color:#8be9fd;font-style:italic>$input_len</span><span style=color:#f1fa8c>, outlen=</span><span style=color:#8be9fd;font-style:italic>$output_len</span><span style=color:#f1fa8c>. Output saved to </span><span style=color:#8be9fd;font-style:italic>$result_file</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>done</span>
</span></span></code></pre></div><p>收集测试结果脚本：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>import json
</span></span><span style=display:flex><span>import os
</span></span><span style=display:flex><span>import csv
</span></span><span style=display:flex><span>import re
</span></span><span style=display:flex><span>import argparse
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4>#fieldnames = [&#34;tp&#34;, &#34;concurrency&#34;, &#34;mean TTFT(ms)&#34;, &#34;p90_tpot_ms&#34;, </span>
</span></span><span style=display:flex><span><span style=color:#6272a4>#              &#34;output_throughput(tokens/s)&#34;, &#34;total_throughput(tokens/s)&#34;, </span>
</span></span><span style=display:flex><span><span style=color:#6272a4>#              &#34;mean TPOT(ms)&#34;, &#34;mean e2e(ms)&#34;, &#34;mean_input_len&#34;, &#34;mean_output_len&#34;]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>fieldnames</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#34;concurrency&#34;</span>, <span style=color:#f1fa8c>&#34;mean TTFT(ms)&#34;</span>, <span style=color:#f1fa8c>&#34;input_throughput(tokens/s)&#34;</span>, 
</span></span><span style=display:flex><span>              <span style=color:#f1fa8c>&#34;output_throughput(tokens/s)&#34;</span>, <span style=color:#f1fa8c>&#34;mean TPOT(ms)&#34;</span>, <span style=color:#f1fa8c>&#34;mean_input_len&#34;</span>, 
</span></span><span style=display:flex><span>              <span style=color:#f1fa8c>&#34;mean_output_len&#34;</span><span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>def main<span style=color:#ff79c6>(</span>args<span style=color:#ff79c6>)</span>:
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>data</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>[]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>for</span> _, _, files in os.walk<span style=color:#ff79c6>(</span>args.dir<span style=color:#ff79c6>)</span>:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>for</span> file in files:
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> file.endswith<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;.json&#34;</span><span style=color:#ff79c6>)</span>:
</span></span><span style=display:flex><span>                <span style=color:#6272a4># tp${TENSOR_PARALLEL}_CON${i}_in${INPUT_LENGTH}_out${OUTPUT_LENGTH}.json</span>
</span></span><span style=display:flex><span>                <span style=color:#6272a4># pattern = r&#39;tp(\d+)_CON(\d+)_in(\d+)_out(\d+)\.json&#39;</span>
</span></span><span style=display:flex><span>                <span style=color:#8be9fd;font-style:italic>pattern</span> <span style=color:#ff79c6>=</span> r<span style=color:#f1fa8c>&#39;serving_benchmark_(\d+)_(\d+)_(\d+).json&#39;</span>
</span></span><span style=display:flex><span>                <span style=color:#6272a4># 使用正则表达式匹配文件名</span>
</span></span><span style=display:flex><span>                <span style=color:#8be9fd;font-style:italic>match</span> <span style=color:#ff79c6>=</span> re.match<span style=color:#ff79c6>(</span>pattern, file<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>if</span> match:
</span></span><span style=display:flex><span>                    <span style=color:#6272a4># tp = int(match.group(1))</span>
</span></span><span style=display:flex><span>                    <span style=color:#6272a4># con = int(match.group(2))</span>
</span></span><span style=display:flex><span>                    <span style=color:#6272a4># input_length = int(match.group(3))</span>
</span></span><span style=display:flex><span>                    <span style=color:#6272a4># output_length = int(match.group(4))</span>
</span></span><span style=display:flex><span>                    <span style=color:#8be9fd;font-style:italic>con</span> <span style=color:#ff79c6>=</span> int<span style=color:#ff79c6>(</span>match.group<span style=color:#ff79c6>(</span>1<span style=color:#ff79c6>))</span>
</span></span><span style=display:flex><span>                    <span style=color:#8be9fd;font-style:italic>input_length</span> <span style=color:#ff79c6>=</span> int<span style=color:#ff79c6>(</span>match.group<span style=color:#ff79c6>(</span>2<span style=color:#ff79c6>))</span>
</span></span><span style=display:flex><span>                    <span style=color:#8be9fd;font-style:italic>output_length</span> <span style=color:#ff79c6>=</span> int<span style=color:#ff79c6>(</span>match.group<span style=color:#ff79c6>(</span>3<span style=color:#ff79c6>))</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>else</span>:
</span></span><span style=display:flex><span>                    print<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;not match&#34;</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                with open<span style=color:#ff79c6>(</span>os.path.join<span style=color:#ff79c6>(</span>args.dir, file<span style=color:#ff79c6>)</span>, <span style=color:#f1fa8c>&#39;r&#39;</span><span style=color:#ff79c6>)</span> as f:
</span></span><span style=display:flex><span>                    <span style=color:#8be9fd;font-style:italic>result</span> <span style=color:#ff79c6>=</span> json.load<span style=color:#ff79c6>(</span>f<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>                    data.append<span style=color:#ff79c6>(</span>
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                            <span style=color:#6272a4># &#34;tp&#34;: tp, </span>
</span></span><span style=display:flex><span>                            <span style=color:#f1fa8c>&#34;concurrency&#34;</span>: con, 
</span></span><span style=display:flex><span>                            <span style=color:#f1fa8c>&#34;mean TTFT(ms)&#34;</span>: result<span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#39;mean_ttft_ms&#39;</span><span style=color:#ff79c6>]</span>,
</span></span><span style=display:flex><span>                            <span style=color:#6272a4># &#34;p90_tpot_ms&#34;: result[&#34;p90_tpot_ms&#34;],</span>
</span></span><span style=display:flex><span>                            <span style=color:#f1fa8c>&#34;input_throughput(tokens/s)&#34;</span>: result<span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#34;input_throughput&#34;</span><span style=color:#ff79c6>]</span>,
</span></span><span style=display:flex><span>                            <span style=color:#f1fa8c>&#34;output_throughput(tokens/s)&#34;</span>: result<span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#39;output_throughput&#39;</span><span style=color:#ff79c6>]</span>,
</span></span><span style=display:flex><span>                            <span style=color:#6272a4># &#34;total_throughput(tokens/s)&#34;: result[&#34;total_token_throughput&#34;],</span>
</span></span><span style=display:flex><span>                            <span style=color:#f1fa8c>&#34;mean TPOT(ms)&#34;</span>: result<span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#39;mean_tpot_ms&#39;</span><span style=color:#ff79c6>]</span>,
</span></span><span style=display:flex><span>                            <span style=color:#6272a4># &#34;mean e2e(ms)&#34;: result[&#39;mean_e2el_ms&#39;],</span>
</span></span><span style=display:flex><span>                            <span style=color:#f1fa8c>&#34;mean_input_len&#34;</span>: sum<span style=color:#ff79c6>(</span>result<span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#39;input_lens&#39;</span><span style=color:#ff79c6>])</span> / len<span style=color:#ff79c6>(</span>result<span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#39;input_lens&#39;</span><span style=color:#ff79c6>])</span>,
</span></span><span style=display:flex><span>                            <span style=color:#f1fa8c>&#34;mean_output_len&#34;</span>: sum<span style=color:#ff79c6>(</span>result<span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#39;output_lens&#39;</span><span style=color:#ff79c6>])</span> / len<span style=color:#ff79c6>(</span>result<span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#39;output_lens&#39;</span><span style=color:#ff79c6>])</span>
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    with open<span style=color:#ff79c6>(</span>os.path.join<span style=color:#ff79c6>(</span>args.dir, <span style=color:#f1fa8c>&#39;summary.csv&#39;</span><span style=color:#ff79c6>)</span>, <span style=color:#f1fa8c>&#39;w&#39;</span><span style=color:#ff79c6>)</span> as f:
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>writer</span> <span style=color:#ff79c6>=</span> csv.DictWriter<span style=color:#ff79c6>(</span>f, <span style=color:#8be9fd;font-style:italic>fieldnames</span><span style=color:#ff79c6>=</span>fieldnames<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>        writer.writeheader<span style=color:#ff79c6>()</span>
</span></span><span style=display:flex><span>        writer.writerows<span style=color:#ff79c6>(</span>data<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>if</span> <span style=color:#8be9fd;font-style:italic>__name__</span> <span style=color:#ff79c6>==</span> <span style=color:#f1fa8c>&#34;__main__&#34;</span>:
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>parser</span> <span style=color:#ff79c6>=</span> argparse.ArgumentParser<span style=color:#ff79c6>()</span>
</span></span><span style=display:flex><span>    parser.add_argument<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;--dir&#34;</span>, <span style=color:#8be9fd;font-style:italic>type</span><span style=color:#ff79c6>=</span>str, <span style=color:#8be9fd;font-style:italic>help</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;&#34;</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>args</span> <span style=color:#ff79c6>=</span> parser.parse_args<span style=color:#ff79c6>()</span>
</span></span><span style=display:flex><span>    main<span style=color:#ff79c6>(</span>args<span style=color:#ff79c6>)</span>
</span></span></code></pre></div><h2 id=测试结果>测试结果</h2><table><thead><tr><th>Concurrency</th><th>Mean TTFT (ms)</th><th>Input Throughput (tokens/s)</th><th>Output Throughput (tokens/s)</th><th>Mean TPOT (ms)</th><th>Mean Input Len</th><th>Mean Output Len</th></tr></thead><tbody><tr><td>1</td><td>316.52</td><td>17.20</td><td>17.20</td><td>57.14</td><td>256</td><td>256</td></tr><tr><td>1</td><td>285.84</td><td>17.42</td><td>17.42</td><td>55.60</td><td>128</td><td>128</td></tr><tr><td>2</td><td>1126.91</td><td>31.78</td><td>31.78</td><td>58.76</td><td>256</td><td>256</td></tr><tr><td>2</td><td>321.56</td><td>33.03</td><td>33.03</td><td>58.49</td><td>128</td><td>128</td></tr><tr><td>4</td><td>342.96</td><td>59.24</td><td>59.24</td><td>66.44</td><td>256</td><td>256</td></tr><tr><td>4</td><td>454.82</td><td>59.35</td><td>59.35</td><td>64.34</td><td>128</td><td>128</td></tr><tr><td>8</td><td>631.93</td><td>89.40</td><td>89.40</td><td>85.20</td><td>128</td><td>128</td></tr><tr><td>8</td><td>1349.76</td><td>91.14</td><td>91.14</td><td>82.82</td><td>256</td><td>256</td></tr><tr><td>16</td><td>681.99</td><td>137.47</td><td>137.47</td><td>114.16</td><td>256</td><td>256</td></tr><tr><td>16</td><td>608.29</td><td>136.20</td><td>136.20</td><td>113.59</td><td>128</td><td>128</td></tr><tr><td>32</td><td>501.92</td><td>219.70</td><td>219.70</td><td>144.24</td><td>256</td><td>256</td></tr><tr><td>32</td><td>838.25</td><td>198.94</td><td>198.94</td><td>155.46</td><td>128</td><td>128</td></tr><tr><td>64</td><td>1062.61</td><td>290.74</td><td>290.74</td><td>213.41</td><td>128</td><td>128</td></tr><tr><td>64</td><td>1046.21</td><td>291.33</td><td>291.33</td><td>216.41</td><td>256</td><td>256</td></tr><tr><td>100</td><td>1008.45</td><td>413.92</td><td>413.92</td><td>238.54</td><td>256</td><td>256</td></tr><tr><td>100</td><td>1441.36</td><td>435.11</td><td>435.11</td><td>220.18</td><td>128</td><td>128</td></tr><tr><td>128</td><td>1263.11</td><td>506.19</td><td>506.19</td><td>244.77</td><td>128</td><td>128</td></tr><tr><td>128</td><td>1205.51</td><td>505.17</td><td>505.17</td><td>249.58</td><td>256</td><td>256</td></tr><tr><td>200</td><td>2316.10</td><td>357.58</td><td>357.58</td><td>552.32</td><td>256</td><td>256</td></tr><tr><td>200</td><td>1395.16</td><td>436.23</td><td>436.23</td><td>450.87</td><td>128</td><td>128</td></tr><tr><td>256</td><td>1695.48</td><td>378.55</td><td>378.55</td><td>672.14</td><td>256</td><td>256</td></tr><tr><td>256</td><td>1991.52</td><td>375.48</td><td>375.48</td><td>671.24</td><td>128</td><td>128</td></tr><tr><td>512</td><td>4446.39</td><td>459.66</td><td>459.66</td><td>1100.49</td><td>256</td><td>256</td></tr><tr><td>512</td><td>3023.79</td><td>436.38</td><td>436.38</td><td>1158.17</td><td>128</td><td>128</td></tr><tr><td>1024</td><td>3088.61</td><td>1092.91</td><td>1092.91</td><td>918.67</td><td>128</td><td>128</td></tr><tr><td>1024</td><td>2798.73</td><td>1090.29</td><td>1090.29</td><td>931.18</td><td>256</td><td>256</td></tr></tbody></table><h2 id=参考-2>参考</h2><ul><li><a href=https://github.com/sgl-project/sglang/tree/main/benchmark/deepseek_v3#example-serving-with-2-h208>https://github.com/sgl-project/sglang/tree/main/benchmark/deepseek_v3#example-serving-with-2-h208</a></li></ul><h1 id=总结>总结</h1><ul><li>与 vllm 单机相比，vllm 双机性能存在下降，推测双机通信存在瓶颈，双机之间的通讯开销较大。</li><li>与 sglang 单机相比，sglang 双机性能存在下降，推测双机通信存在瓶颈，双机之间的通讯开销较大。</li></ul><hr><ul class=pager><li class=previous><a href=/post/2025-04-04-h20-deepseek-r1-sglang-vllm/ data-toggle=tooltip data-placement=top title=单机H20(8*96GiB)部署满血DeepSeek-R1(fp8)验证过程>&larr;
Previous Post</a></li><li class=next><a href=/post/2025-05-07-llm-01/ data-toggle=tooltip data-placement=top title=科普开源大模型基础知识>Next
Post &rarr;</a></li></ul></div><div class="col-lg-2 col-lg-offset-0
visible-lg-block
sidebar-container
catalog-container"><div class=side-catalog><hr class="hidden-sm hidden-xs"><h5><a class=catalog-toggle href=#>CATALOG</a></h5><ul class=catalog-body></ul></div></div><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
sidebar-container"></div></div></div></article><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"><li><a href=mailto:tanjunchen20@gmail.com><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=/img/wechat.jpg><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-weixin fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://github.com/tanjunchen><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="copyright text-muted">Copyright &copy; 陈谭军 2025</p></div></div></div></footer><script>function loadAsync(e,t){var s=document,o="script",n=s.createElement(o),i=s.getElementsByTagName(o)[0];n.src=e,t&&n.addEventListener("load",function(e){t(null,e)},!1),i.parentNode.insertBefore(n,i)}</script><script>$("#tag_cloud").length!==0&&loadAsync("/js/jquery.tagcloud.js",function(){$.fn.tagcloud.defaults={color:{start:"#bbbbee",end:"#0085a1"}},$("#tag_cloud a").tagcloud()})</script><script>loadAsync("https://cdn.jsdelivr.net/npm/fastclick@1.0.6/lib/fastclick.min.js",function(){var e=document.querySelector("nav");e&&FastClick.attach(e)})</script><script type=text/javascript>function generateCatalog(e){_containerSelector="div.post-container";var t,n,s,o,i,r=$(_containerSelector),a=r.find("h1,h2,h3,h4,h5,h6");return $(e).html(""),a.each(function(){n=$(this).prop("tagName").toLowerCase(),i="#"+$(this).prop("id"),s=$(this).text(),t=$('<a href="'+i+'" rel="nofollow">'+s+"</a>"),o=$('<li class="'+n+'_nav"></li>').append(t),$(e).append(o)}),!0}generateCatalog(".catalog-body"),$(".catalog-toggle").click(function(e){e.preventDefault(),$(".side-catalog").toggleClass("fold")}),loadAsync("/js/jquery.nav.js",function(){$(".catalog-body").onePageNav({currentClass:"active",changeHash:!1,easing:"swing",filter:"",scrollSpeed:700,scrollOffset:0,scrollThreshold:.2,begin:null,end:null,scrollChange:null,padding:80})})</script></body></html>