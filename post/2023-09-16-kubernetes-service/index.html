<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:site_name" content="漫步远方，心荡神往"><meta property="og:type" content="article"><meta property="og:image" content="https://tanjunchen.github.io/img/home.webp"><meta property="twitter:image" content="https://tanjunchen.github.io/img/home.webp"><meta name=title content="深入研究 Kubernetes 集群中的 Service 通信机制"><meta property="og:title" content="深入研究 Kubernetes 集群中的 Service 通信机制"><meta property="twitter:title" content="深入研究 Kubernetes 集群中的 Service 通信机制"><meta name=description content="在我们的学习过程中，首先我们探讨了在 Docker Swarm 集群模式下，服务之间是如何进行通信的。我们了解到，Docker Swarm 使用内置的服务发现和负载均衡机制来实现服务间的通信。然后，我们转向 Kubernetes，研究了在 kube-proxy、Istio Service Mesh 和 Cilium 三种模式下服务到服务的通信机制。在 kube-proxy 模式下，我们了解到它使用 Iptables 或者 IPVS 来实现服务的负载均衡。而在 Istio Service Mesh 模式下，服务间的通信是通过 Envoy 代理来实现的，它提供了丰富的流量控制和安全策略。最后，在 Cilium 模式下，我们学习了它是如何利用 BPF（Berkeley Packet Filter）来实现服务通信的。这三种模式各有特点，为我们提供了丰富的选择来满足不同的服务通信需求。"><meta property="og:description" content="在我们的学习过程中，首先我们探讨了在 Docker Swarm 集群模式下，服务之间是如何进行通信的。我们了解到，Docker Swarm 使用内置的服务发现和负载均衡机制来实现服务间的通信。然后，我们转向 Kubernetes，研究了在 kube-proxy、Istio Service Mesh 和 Cilium 三种模式下服务到服务的通信机制。在 kube-proxy 模式下，我们了解到它使用 Iptables 或者 IPVS 来实现服务的负载均衡。而在 Istio Service Mesh 模式下，服务间的通信是通过 Envoy 代理来实现的，它提供了丰富的流量控制和安全策略。最后，在 Cilium 模式下，我们学习了它是如何利用 BPF（Berkeley Packet Filter）来实现服务通信的。这三种模式各有特点，为我们提供了丰富的选择来满足不同的服务通信需求。"><meta property="twitter:description" content="在我们的学习过程中，首先我们探讨了在 Docker Swarm 集群模式下，服务之间是如何进行通信的。我们了解到，Docker Swarm 使用内置的服务发现和负载均衡机制来实现服务间的通信。然后，我们转向 Kubernetes，研究了在 kube-proxy、Istio Service Mesh 和 Cilium 三种模式下服务到服务的通信机制。在 kube-proxy 模式下，我们了解到它使用 Iptables 或者 IPVS 来实现服务的负载均衡。而在 Istio Service Mesh 模式下，服务间的通信是通过 Envoy 代理来实现的，它提供了丰富的流量控制和安全策略。最后，在 Cilium 模式下，我们学习了它是如何利用 BPF（Berkeley Packet Filter）来实现服务通信的。这三种模式各有特点，为我们提供了丰富的选择来满足不同的服务通信需求。"><meta property="twitter:card" content="summary"><meta name=keyword content="陈谭军, 互联网, 云原生, 容器, 微服务, Web, PaaS, Istio, Kubernetes, Microservice"><link rel="shortcut icon" href=/img/favicon.ico><title>深入研究 Kubernetes 集群中的 Service 通信机制 | 陈谭军的博客 | tanjunchen Blog</title><link rel=canonical href=/post/2023-09-16-kubernetes-service/><link rel=stylesheet href=/css/bootstrap.min.css><link rel=stylesheet href=/css/hugo-theme-cleanwhite.min.css><link rel=stylesheet href=/css/zanshang.css><link rel=stylesheet href=/css/font-awesome.all.min.css><script src=/js/jquery.min.js></script>
<script src=/js/bootstrap.min.js></script>
<script src=/js/hux-blog.min.js></script>
<script src=/js/lazysizes.min.js></script></head><nav class="navbar navbar-default navbar-custom navbar-fixed-top"><div class=container-fluid><div class="navbar-header page-scroll"><button type=button class=navbar-toggle>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span></button>
<a class=navbar-brand href=/>漫步远方，心荡神往</a></div><div id=huxblog_navbar><div class=navbar-collapse><ul class="nav navbar-nav navbar-right"><li><a href=/>All Posts</a></li><li><a href=/categories/technology/>technology</a></li><li><a href=/categories/think/>think</a></li><li><a href=/learning/>LEARNING</a></li><li><a href=/archive/>ARCHIVE</a></li><li><a href=/about/>ABOUT</a></li><li><a href=/search><i class="fa fa-search"></i></a></li></ul></div></div></div></nav><script>var $body=document.body,$toggle=document.querySelector(".navbar-toggle"),$navbar=document.querySelector("#huxblog_navbar"),$collapse=document.querySelector(".navbar-collapse");$toggle.addEventListener("click",handleMagic);function handleMagic(){$navbar.className.indexOf("in")>0?($navbar.className=" ",setTimeout(function(){$navbar.className.indexOf("in")<0&&($collapse.style.height="0px")},400)):($collapse.style.height="auto",$navbar.className+=" in")}</script><style type=text/css>header.intro-header{background-image:url(/img/home.webp)}</style><header class=intro-header><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><div class=tags><a class=tag href=/tags/kubernetes title=kubernetes>kubernetes</a>
<a class=tag href=/tags/istio title=istio>istio</a>
<a class=tag href=/tags/cilium title=cilium>cilium</a>
<a class=tag href=/tags/cni title=cni>cni</a></div><h1>深入研究 Kubernetes 集群中的 Service 通信机制</h1><h2 class=subheading>Kubernetes 中的服务是一种简单的抽象，但与任何抽象层类似，它增加了系统的复杂性，并使故障排除变得更具挑战性。本文我们来研究下在 Kubernetes 集群中，Service 之间是如何通信的。</h2><span class=meta>Posted by
陈谭军
on
Saturday, September 16, 2023
<span id=busuanzi_container_page_pv>|<span id=busuanzi_value_page_pv></span><span>
<span id=/post/2023-09-16-kubernetes-service/ class="leancloud_visitors meta_data_item" data-flag-title><span class=post-meta-item-icon><span class="octicon octicon-eye"></span></span>
<i class="fa fa-eye"></i>
<span class=old-visitors-count style=display:none></span>
<span class=leancloud-visitors-count></span></span>
<script src=https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js></script>
<script>AV.initialize("","")</script><script type=text/javascript>function showTime(e){var n=new AV.Query(e),t=[],s=$(".leancloud_visitors");s.each(function(){t.push($(this).attr("id").trim())}),n.containedIn("url",t),n.find().done(function(e){for(var s,o,i,a,r,c,l=".leancloud-visitors-count",d=".old-visitors-count",n=0;n<e.length;n++)a=e[n],i=a.get("url"),c=a.get("time"),s=document.getElementById(i),$(s).find(l).text(c);for(n=0;n<t.length;n++)i=t[n],s=document.getElementById(i),o=$(s).find(l),o.text()==""&&(r=$(s).find(d).text(),r!=""?o.text(0+parseInt(r)):o.text(0))}).fail(function(e,t){console.log("Error: "+t.code+" "+t.message)})}function addCount(e){var n=$(".leancloud_visitors"),t=n.attr("id").trim(),o=n.attr("data-flag-title").trim(),s=new AV.Query(e);s.equalTo("url",t),s.find({success:function(n){if(n.length>0){var s,i,r,c,l,a=n[0];a.fetchWhenSave(!0),a.increment("time"),a.save(null,{success:function(e){var n=$(document.getElementById(t));n.find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to save Visitor num, with error message: "+t.message)}})}else s=new e,i=new AV.ACL,i.setPublicReadAccess(!0),i.setPublicWriteAccess(!0),s.setACL(i),s.set("title",o),s.set("url",t),c=".old-visitors-count",l=$(document.getElementById(t)),r=l.find(c).text(),r!=""?s.set("time",parseInt(r)+1):s.set("time",1),s.save(null,{success:function(e){var n=$(document.getElementById(t));n.find(".leancloud-visitors-count").text(e.get("time"))},error:function(){console.log("Failed to create")}})},error:function(e){console.log("Error:"+e.code+" "+e.message)}})}$(function(){var e=AV.Object.extend("Counter");$(".leancloud_visitors").length==1?addCount(e):showTime(e)})</script>阅读 </span></span>|<span class=post-date>共 3138 字</span>，阅读约 <span class=more-meta>7 分钟</span></span></div></div></div></div></header><article><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
post-container"><p>我们将应用程序部署到 Kubernetes 集群时，比较重要的一步是创建 Service，它允许集群内的应用程序或外部客户端通过 Service 访问。
Kubernetes 中的服务是一种简单的抽象，但与任何抽象层类似，它增加了系统的复杂性，并使故障排除变得更具挑战性。本文我们来研究下在 Kubernetes 集群中，Service 之间是如何通信的。</p><h1 id=目标>目标</h1><p>集群中的服务是如何通信的？在本文中，我们将使用以下示例来深入了解与学习 Kubernetes Service 通信的工作原理。</p><h1 id=序言>序言</h1><p>在我们开始研究 Kubernetes 集群中的 Service 通信原理之前，先简单了解与学习 Docker Swarm 模式下的 Service 是如何通信的？让我们探索一下服务到服务通信是如何在 Docker Swarm 集群中工作的！！！
通过应用下述配置，Docker 创建一组容器并建立包含负载均衡器的 <a href=https://docs.docker.com/network/drivers/overlay/>overlay network</a>。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>version</span>: <span style=color:#f1fa8c>&#34;3.8&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>nginx</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>image</span>: nginx
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ff79c6>target</span>: <span style=color:#bd93f9>80</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>published</span>: <span style=color:#bd93f9>80</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>protocol</span>: tcp
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>deploy</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>mode</span>: replicated
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>replicas</span>: <span style=color:#bd93f9>2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>client</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>image</span>: arunvelsriram/utils:latest
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>command</span>: [<span style=color:#f1fa8c>&#39;sleep&#39;</span>, <span style=color:#f1fa8c>&#39;100500&#39;</span>]
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>deploy</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>mode</span>: replicated
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>replicas</span>: <span style=color:#bd93f9>1</span>
</span></span></code></pre></div><p>基本信息如下所示：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>root@instance-00qqerhq:~/learn-k8s-service#
</span></span><span style=display:flex><span>root@instance-00qqerhq:~/learn-k8s-service# docker stack deploy -c demo.yaml demo
</span></span><span style=display:flex><span>Updating service demo_client <span style=color:#ff79c6>(</span>id: b8e7l5ji49ernu82ztn1nbo3z<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>Updating service demo_nginx <span style=color:#ff79c6>(</span>id: s5ipvpa1ba5beb30upotdne76<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>root@instance-00qqerhq:~/learn-k8s-service# docker ps
</span></span><span style=display:flex><span>CONTAINER ID   IMAGE                        COMMAND                  CREATED          STATUS          PORTS     NAMES
</span></span><span style=display:flex><span>26941a6b9e4d   nginx:latest                 <span style=color:#f1fa8c>&#34;/docker-entrypoint.…&#34;</span>   <span style=color:#bd93f9>31</span> seconds ago   Up <span style=color:#bd93f9>29</span> seconds   80/tcp    demo_nginx.1.kob19ablrceyzwhq1f1nf5aoi
</span></span><span style=display:flex><span>ffe0d8ceee5c   nginx:latest                 <span style=color:#f1fa8c>&#34;/docker-entrypoint.…&#34;</span>   <span style=color:#bd93f9>31</span> seconds ago   Up <span style=color:#bd93f9>29</span> seconds   80/tcp    demo_nginx.2.rhlsd9qk0e28jomsu06pbgql0
</span></span><span style=display:flex><span>0306c3860864   arunvelsriram/utils:latest:latest   <span style=color:#f1fa8c>&#34;sleep 100500&#34;</span>           <span style=color:#bd93f9>46</span> seconds ago   Up <span style=color:#bd93f9>43</span> seconds             demo_client.1.dgjvk7xvktsocf91mme1uport
</span></span><span style=display:flex><span>root@instance-00qqerhq:~/learn-k8s-service# docker network inspect demo_default
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;Name&#34;</span>: <span style=color:#f1fa8c>&#34;demo_default&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;Id&#34;</span>: <span style=color:#f1fa8c>&#34;12uyuotr1nedpuelmtmktli9h&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;Created&#34;</span>: <span style=color:#f1fa8c>&#34;2023-09-20T13:47:11.65538148+08:00&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;Scope&#34;</span>: <span style=color:#f1fa8c>&#34;swarm&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;Driver&#34;</span>: <span style=color:#f1fa8c>&#34;overlay&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;EnableIPv6&#34;</span>: false,
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;IPAM&#34;</span>: <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>            <span style=color:#f1fa8c>&#34;Driver&#34;</span>: <span style=color:#f1fa8c>&#34;default&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f1fa8c>&#34;Options&#34;</span>: null,
</span></span><span style=display:flex><span>            <span style=color:#f1fa8c>&#34;Config&#34;</span>: <span style=color:#ff79c6>[</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#f1fa8c>&#34;Subnet&#34;</span>: <span style=color:#f1fa8c>&#34;10.0.1.0/24&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#f1fa8c>&#34;Gateway&#34;</span>: <span style=color:#f1fa8c>&#34;10.0.1.1&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;Internal&#34;</span>: false,
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;Attachable&#34;</span>: false,
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;Ingress&#34;</span>: false,
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;ConfigFrom&#34;</span>: <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>            <span style=color:#f1fa8c>&#34;Network&#34;</span>: <span style=color:#f1fa8c>&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;ConfigOnly&#34;</span>: false,
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;Containers&#34;</span>: <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>            <span style=color:#f1fa8c>&#34;0306c386086416765907d4c42d345c4d18c725af921bc5eca751f6c10f4829a1&#34;</span>: <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;Name&#34;</span>: <span style=color:#f1fa8c>&#34;demo_client.1.dgjvk7xvktsocf91mme1uport&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;EndpointID&#34;</span>: <span style=color:#f1fa8c>&#34;e86cef54cd8d7e5ec2473536da48cd34e29f57d30b2e8824294869cf06e40054&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;MacAddress&#34;</span>: <span style=color:#f1fa8c>&#34;02:42:0a:00:01:03&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;IPv4Address&#34;</span>: <span style=color:#f1fa8c>&#34;10.0.1.3/24&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;IPv6Address&#34;</span>: <span style=color:#f1fa8c>&#34;&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>            <span style=color:#f1fa8c>&#34;26941a6b9e4d7247f63b47a6a82dd1f69248f2e548b5ee8ebf01b201b497854c&#34;</span>: <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;Name&#34;</span>: <span style=color:#f1fa8c>&#34;demo_nginx.1.kob19ablrceyzwhq1f1nf5aoi&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;EndpointID&#34;</span>: <span style=color:#f1fa8c>&#34;51f57e98bb2b63c5524b65e6d32b0bd86fbc04f3c444d34a4a24e5b276931be8&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;MacAddress&#34;</span>: <span style=color:#f1fa8c>&#34;02:42:0a:00:01:06&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;IPv4Address&#34;</span>: <span style=color:#f1fa8c>&#34;10.0.1.6/24&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;IPv6Address&#34;</span>: <span style=color:#f1fa8c>&#34;&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>            <span style=color:#f1fa8c>&#34;ffe0d8ceee5ce02c703a3bc6fff3682920417c3811169dc6a1f960b8caaa89f5&#34;</span>: <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;Name&#34;</span>: <span style=color:#f1fa8c>&#34;demo_nginx.2.rhlsd9qk0e28jomsu06pbgql0&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;EndpointID&#34;</span>: <span style=color:#f1fa8c>&#34;1e01ead7205062ae98dc1ac1800ef08be34b468c332c73a7c62795c88d8a081d&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;MacAddress&#34;</span>: <span style=color:#f1fa8c>&#34;02:42:0a:00:01:07&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;IPv4Address&#34;</span>: <span style=color:#f1fa8c>&#34;10.0.1.7/24&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;IPv6Address&#34;</span>: <span style=color:#f1fa8c>&#34;&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>            <span style=color:#f1fa8c>&#34;lb-demo_default&#34;</span>: <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;Name&#34;</span>: <span style=color:#f1fa8c>&#34;demo_default-endpoint&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;EndpointID&#34;</span>: <span style=color:#f1fa8c>&#34;2b7573d673d6096d8273af928164565465d9ca8e39c3808a9969749b037e0a89&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;MacAddress&#34;</span>: <span style=color:#f1fa8c>&#34;02:42:0a:00:01:04&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;IPv4Address&#34;</span>: <span style=color:#f1fa8c>&#34;10.0.1.4/24&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;IPv6Address&#34;</span>: <span style=color:#f1fa8c>&#34;&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;Options&#34;</span>: <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>            <span style=color:#f1fa8c>&#34;com.docker.network.driver.overlay.vxlanid_list&#34;</span>: <span style=color:#f1fa8c>&#34;4097&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;Labels&#34;</span>: <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>            <span style=color:#f1fa8c>&#34;com.docker.stack.namespace&#34;</span>: <span style=color:#f1fa8c>&#34;demo&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;Peers&#34;</span>: <span style=color:#ff79c6>[</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;Name&#34;</span>: <span style=color:#f1fa8c>&#34;39709c0a8f2e&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;IP&#34;</span>: <span style=color:#f1fa8c>&#34;192.168.0.2&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>]</span>
</span></span></code></pre></div><p>负载均衡器 (lb-demo_default) 是一个专用网络命名空间，使用 <a href=https://en.wikipedia.org/wiki/IP_Virtual_Server>IPVS</a> 在容器之间分配流量，整体的网络架构如下所示：</p><p><img src=/images/2023-09-16-kubernetes-service/1.svg alt></p><p>其中，上图中的 IP 地址 10.0.1.5 是分配给负载均衡器网络命名空间的，现在我们从客户端容器运行 telnet 到 nginx 服务命令，如下所示：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>root@instance-00qqerhq:~/learn-k8s-service# docker ps
</span></span><span style=display:flex><span>CONTAINER ID   IMAGE                        COMMAND                  CREATED              STATUS              PORTS     NAMES
</span></span><span style=display:flex><span>26941a6b9e4d   nginx:latest                 <span style=color:#f1fa8c>&#34;/docker-entrypoint.…&#34;</span>   About a minute ago   Up About a minute   80/tcp    demo_nginx.1.kob19ablrceyzwhq1f1nf5aoi
</span></span><span style=display:flex><span>ffe0d8ceee5c   nginx:latest                 <span style=color:#f1fa8c>&#34;/docker-entrypoint.…&#34;</span>   About a minute ago   Up About a minute   80/tcp    demo_nginx.2.rhlsd9qk0e28jomsu06pbgql0
</span></span><span style=display:flex><span>0306c3860864   arunvelsriram/utils:latest   <span style=color:#f1fa8c>&#34;sleep 100500&#34;</span>           About a minute ago   Up About a minute             demo_client.1.dgjvk7xvktsocf91mme1uport
</span></span><span style=display:flex><span>root@instance-00qqerhq:~/learn-k8s-service# docker <span style=color:#8be9fd;font-style:italic>exec</span> -it demo_client.1.dgjvk7xvktsocf91mme1uport  telnet nginx <span style=color:#bd93f9>80</span>
</span></span><span style=display:flex><span>Trying 10.0.1.5...
</span></span><span style=display:flex><span>Connected to nginx.
</span></span><span style=display:flex><span>Escape character is <span style=color:#f1fa8c>&#39;^]&#39;</span>.
</span></span><span style=display:flex><span>^CConnection closed by foreign host.
</span></span><span style=display:flex><span>root@instance-00qqerhq:~/learn-k8s-service# nsenter --net<span style=color:#ff79c6>=</span>/run/docker/netns/lb_12uyuotr1  ip a l
</span></span><span style=display:flex><span>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span style=color:#bd93f9>65536</span> qdisc noqueue state UNKNOWN group default qlen <span style=color:#bd93f9>1000</span>
</span></span><span style=display:flex><span>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span></span><span style=display:flex><span>    inet 127.0.0.1/8 scope host lo
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span><span style=display:flex><span>25: eth0@if26: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style=color:#bd93f9>1450</span> qdisc noqueue state UP group default
</span></span><span style=display:flex><span>    link/ether 02:42:0a:00:01:04 brd ff:ff:ff:ff:ff:ff link-netnsid <span style=color:#bd93f9>0</span>
</span></span><span style=display:flex><span>    inet 10.0.1.4/24 brd 10.0.1.255 scope global eth0
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span><span style=display:flex><span>    inet 10.0.1.2/32 scope global eth0
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span><span style=display:flex><span>    inet 10.0.1.5/32 scope global eth0
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span></code></pre></div><p>在某个终端中使用命令 docker exec -it demo_client.1.dgjvk7xvktsocf91mme1uport telnet nginx 80 从 client 访问 nginx service 服务，同时在另一个终端监听 TCP 已经建立的连接，如下所示：</p><p><img src=/images/2023-09-16-kubernetes-service/2.png alt></p><p>由于 IPVS 还在 conntrack 表中维护连接状态，因此我们可以在 conntrack 表中找到连接的实际目的地址，如下所示：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#6272a4># one terminal</span>
</span></span><span style=display:flex><span>root@instance-00qqerhq:~/learn-k8s-service# docker <span style=color:#8be9fd;font-style:italic>exec</span> -it demo_client.1.dgjvk7xvktsocf91mme1uport  telnet nginx <span style=color:#bd93f9>80</span>
</span></span><span style=display:flex><span>Trying 10.0.1.5...
</span></span><span style=display:flex><span>Connected to nginx.
</span></span><span style=display:flex><span>Escape character is <span style=color:#f1fa8c>&#39;^]&#39;</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># another terminal</span>
</span></span><span style=display:flex><span>root@instance-00qqerhq:~/learn-k8s-service# ls /run/docker/netns/
</span></span><span style=display:flex><span>1-12uyuotr1n  1ee4c32438f9  1-vjce63xv8u  2ceed1c3dd11  d9fb8bb00f1a  ingress_sbox  lb_12uyuotr1
</span></span><span style=display:flex><span>root@instance-00qqerhq:~/learn-k8s-service# nsenter -t <span style=color:#bd93f9>262318</span> -n netstat -an |grep EST
</span></span><span style=display:flex><span>tcp        <span style=color:#bd93f9>0</span>      <span style=color:#bd93f9>0</span> 10.0.1.3:60744          10.0.1.5:80             ESTABLISHED
</span></span><span style=display:flex><span>root@instance-00qqerhq:~/learn-k8s-service# nsenter --net<span style=color:#ff79c6>=</span>/run/docker/netns/lb_12uyuotr1 conntrack -L |grep <span style=color:#bd93f9>60744</span>
</span></span><span style=display:flex><span>conntrack v1.4.5 <span style=color:#ff79c6>(</span>conntrack-tools<span style=color:#ff79c6>)</span>: <span style=color:#bd93f9>2</span> flow entries have been shown.
</span></span><span style=display:flex><span>tcp      <span style=color:#bd93f9>6</span> <span style=color:#bd93f9>431990</span> ESTABLISHED <span style=color:#8be9fd;font-style:italic>src</span><span style=color:#ff79c6>=</span>10.0.1.3 <span style=color:#8be9fd;font-style:italic>dst</span><span style=color:#ff79c6>=</span>10.0.1.5 <span style=color:#8be9fd;font-style:italic>sport</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>60744</span> <span style=color:#8be9fd;font-style:italic>dport</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>80</span> <span style=color:#8be9fd;font-style:italic>src</span><span style=color:#ff79c6>=</span>10.0.1.7 <span style=color:#8be9fd;font-style:italic>dst</span><span style=color:#ff79c6>=</span>10.0.1.4 <span style=color:#8be9fd;font-style:italic>sport</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>80</span> <span style=color:#8be9fd;font-style:italic>dport</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>60744</span> <span style=color:#ff79c6>[</span>ASSURED<span style=color:#ff79c6>]</span> <span style=color:#8be9fd;font-style:italic>mark</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>0</span> <span style=color:#8be9fd;font-style:italic>use</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>1</span>
</span></span></code></pre></div><p><img src=/images/2023-09-16-kubernetes-service/3.png alt></p><p>在上图中，telnet 连接到的是 10.0.1.7:80 (nginx-2)。
上述实现原理是首先为每个容器识别特定的 overlay 网络，然后找到负载均衡器网络命名空间。然后，它在 conntrack 表中查找最终要连接的实际目标地址。</p><h1 id=kubernetes-kube-proxy>Kubernetes Kube Proxy</h1><p>搭建 Kubernetes 集群，如下所示：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kind create cluster  --image<span style=color:#ff79c6>=</span>kindest/node:v1.22.17 --name  tanjunchen
</span></span></code></pre></div><p>部署 nginx 应用与服务，如下所示：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>root@instance-00qqerhq:~/learn-k8s-service# kubectl create deployment nginx --image<span style=color:#ff79c6>=</span>nginx --replicas<span style=color:#ff79c6>=</span><span style=color:#bd93f9>2</span>
</span></span><span style=display:flex><span>root@instance-00qqerhq:~/learn-k8s-service# kubectl expose deployment nginx --port<span style=color:#ff79c6>=</span><span style=color:#bd93f9>80</span>
</span></span><span style=display:flex><span>root@instance-00qqerhq:~/learn-k8s-service# kubectl get pods -l <span style=color:#8be9fd;font-style:italic>app</span><span style=color:#ff79c6>=</span>nginx -o wide
</span></span><span style=display:flex><span>NAME                     READY   STATUS    RESTARTS   AGE   IP           NODE                       NOMINATED NODE   READINESS GATES
</span></span><span style=display:flex><span>nginx-6799fc88d8-jzpgb   1/1     Running   <span style=color:#bd93f9>0</span>          94s   10.244.0.6   tanjunchen-control-plane   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>nginx-6799fc88d8-xddbz   1/1     Running   <span style=color:#bd93f9>0</span>          94s   10.244.0.5   tanjunchen-control-plane   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>root@instance-00qqerhq:~/learn-k8s-service# kubectl get services -l <span style=color:#8be9fd;font-style:italic>app</span><span style=color:#ff79c6>=</span>nginx
</span></span><span style=display:flex><span>NAME    TYPE        CLUSTER-IP    EXTERNAL-IP   PORT<span style=color:#ff79c6>(</span>S<span style=color:#ff79c6>)</span>   AGE
</span></span><span style=display:flex><span>nginx   ClusterIP   10.96.72.53   &lt;none&gt;        80/TCP    44s
</span></span><span style=display:flex><span>root@instance-00qqerhq:~/learn-k8s-service#  kubectl get endpoints -l <span style=color:#8be9fd;font-style:italic>app</span><span style=color:#ff79c6>=</span>nginx
</span></span><span style=display:flex><span>NAME    ENDPOINTS                     AGE
</span></span><span style=display:flex><span>nginx   10.244.0.5:80,10.244.0.6:80   49s
</span></span></code></pre></div><p>运行另一个 pod 并通过 telnet 调用 nginx，如下所示：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>root@instance-00qqerhq:~/learn-k8s-service# kubectl run --rm client -it --image arunvelsriram/utils sh
</span></span><span style=display:flex><span>If you don<span style=color:#f1fa8c>&#39;t see a command prompt, try pressing enter.
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>telnet nginx 80
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>Trying 10.96.72.53...
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>Connected to nginx.default.svc.cluster.local.
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>Escape character is &#39;</span>^<span style=color:#ff79c6>]</span>&#39;.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>root@instance-00qqerhq:~/learn-k8s-service# kubectl <span style=color:#8be9fd;font-style:italic>exec</span> -it client --  netstat -an |grep EST
</span></span><span style=display:flex><span>tcp        <span style=color:#bd93f9>0</span>      <span style=color:#bd93f9>0</span> 10.244.0.11:35408       10.96.72.53:80          ESTABLISHED
</span></span></code></pre></div><p>从客户端 Pod 的角度来看，它连接到 10.96.72.53:80。客户端实际上连接到我们的某个 nginx pod。然而问题来了：这是怎么发生的，我们如何确定客户端连接到的具体 nginx pod？
创建服务时，Kubernetes（特别是 kube-proxy）建立了 iptables 规则，便于流量导向到具体的 nginx pod，这些规则将传入流量的目标 IP 地址更改为某个 nginx pod 的 Pod IP 地址，整体的网络架构如下所示：</p><p><img src=/images/2023-09-16-kubernetes-service/4.svg alt></p><p>因此，我们可以在 node 节点上 root 网络命名空间内的 conntrack 表中识别连接的转换地址，如下所示：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>root@instance-00qqerhq:~/learn-k8s-service# kubectl <span style=color:#8be9fd;font-style:italic>exec</span> -it client --  netstat -an |grep EST
</span></span><span style=display:flex><span>tcp        <span style=color:#bd93f9>0</span>      <span style=color:#bd93f9>0</span> 10.244.0.13:52372       10.96.72.53:80          ESTABLISHED
</span></span><span style=display:flex><span>root@tanjunchen-control-plane:/# conntrack -L | grep <span style=color:#bd93f9>52372</span>
</span></span><span style=display:flex><span>tcp      <span style=color:#bd93f9>6</span> <span style=color:#bd93f9>86374</span> ESTABLISHED <span style=color:#8be9fd;font-style:italic>src</span><span style=color:#ff79c6>=</span>10.244.0.13 <span style=color:#8be9fd;font-style:italic>dst</span><span style=color:#ff79c6>=</span>10.96.72.53 <span style=color:#8be9fd;font-style:italic>sport</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>52372</span> <span style=color:#8be9fd;font-style:italic>dport</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>80</span> <span style=color:#8be9fd;font-style:italic>src</span><span style=color:#ff79c6>=</span>10.244.0.6 <span style=color:#8be9fd;font-style:italic>dst</span><span style=color:#ff79c6>=</span>10.244.0.13 <span style=color:#8be9fd;font-style:italic>sport</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>80</span> <span style=color:#8be9fd;font-style:italic>dport</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>52372</span> <span style=color:#ff79c6>[</span>ASSURED<span style=color:#ff79c6>]</span> <span style=color:#8be9fd;font-style:italic>mark</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>0</span> <span style=color:#8be9fd;font-style:italic>use</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span>conntrack v1.4.6 <span style=color:#ff79c6>(</span>conntrack-tools<span style=color:#ff79c6>)</span>: <span style=color:#bd93f9>194</span> flow entries have been shown.
</span></span></code></pre></div><p>当数据包从服务器传输到客户端时，Linux 内核会在 conntrack 表中查找相应的连接，这就是 conntrack 表中第二个 IP:PORT 以相反顺序出现的原因。在本场景中，client 已建立到 10.244.0.6:80 (nginx-pod-2) 的连接。</p><h1 id=istio-service-mesh>Istio Service Mesh</h1><p>现在让我们看看相同的场景，在 Istio Service Mesh 下 client 访问 nginx service 是如何通信的。安装 istio，具体安装教程可参考 <a href=https://istio.io/latest/docs/setup/getting-started/>istio-install</a>。</p><p>nginx 服务注入 sidecar，环境如下所示：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>root@instance-00qqerhq:~/learn-k8s-service# kubectl label namespace default istio-injection<span style=color:#ff79c6>=</span>enabled --overwrite
</span></span><span style=display:flex><span>namespace/default not labeled
</span></span><span style=display:flex><span>root@instance-00qqerhq:~/learn-k8s-service# kubectl get pod -owide
</span></span><span style=display:flex><span>NAME                     READY   STATUS        RESTARTS   AGE     IP            NODE                       NOMINATED NODE   READINESS GATES
</span></span><span style=display:flex><span>client                   2/2     Running       <span style=color:#bd93f9>0</span>          5m20s   10.244.0.20   tanjunchen-control-plane   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>nginx-6799fc88d8-8cqzc   2/2     Running       <span style=color:#bd93f9>0</span>          10m     10.244.0.17   tanjunchen-control-plane   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>nginx-6799fc88d8-gslqf   2/2     Running       <span style=color:#bd93f9>0</span>          10m     10.244.0.18   tanjunchen-control-plane   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>node-shell-debug-7fld8   1/1     Running       <span style=color:#bd93f9>0</span>          10m     172.18.0.2    tanjunchen-control-plane   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>root@instance-00qqerhq:~/learn-k8s-service# kubectl get svc
</span></span><span style=display:flex><span>NAME         TYPE        CLUSTER-IP    EXTERNAL-IP   PORT<span style=color:#ff79c6>(</span>S<span style=color:#ff79c6>)</span>   AGE
</span></span><span style=display:flex><span>kubernetes   ClusterIP   10.96.0.1     &lt;none&gt;        443/TCP   50m
</span></span><span style=display:flex><span>nginx        ClusterIP   10.96.72.53   &lt;none&gt;        80/TCP    48m
</span></span></code></pre></div><p>现在让我们运行一个客户端 pod 并连接到 nginx 服务，如下所示：</p><p><img src=/images/2023-09-16-kubernetes-service/5.png alt></p><p>从 client 的角度来看，一切都没有改变，和之前一样连接到 nginx 服务 IP。iptables 规则继续存在于 Node 上的 root 网络命名空间中，但是 conntrack 表中不再有相关记录，这是因为来自客户端的出站数据包现在直接在 Pod 的当前网络命名空间内被拦截，整体的网络架构如下所示：</p><p><img src=/images/2023-09-16-kubernetes-service/6.svg alt></p><p>Istio 会将 sidecar 代理注入 pod，其组件 Pilot-agent 会配置 iptables 并将所有出站流量重定向到同一网络命名空间内的 Envoy 代理，以进行进一步处理。如上述测试得知，我们可以在客户端 Pod 的网络命名空间中查找相关的 conntrack 表条目，我们实际看到的连接目的地是 127.0.0.1:15001（envoy），如下图所示：</p><p><img src=/images/2023-09-16-kubernetes-service/7.png alt></p><h1 id=cilium>Cilium</h1><p>Cilium 是 Kubernetes 最强大的 CNI 网络插件之一，它不仅提供基本的网络和安全功能，还提供基于 eBPF 替代 Kubernetes 的 kube-proxy 实现 Service通信功能。搭建 Cilium 环境，更多详情参考 <a href=https://docs.cilium.io/en/stable/gettingstarted/k8s-install-default/#k8s-install-quick>cilium-install</a>。</p><p>搭建 Kubernetes 集群（没有 CNI 与 kube-proxy 组件），如下所示：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kind create cluster --config - <span style=color:#f1fa8c>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>kind: Cluster
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>apiVersion: kind.x-k8s.io/v1alpha4
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>networking:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  disableDefaultCNI: true   # do not install kindnet
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  kubeProxyMode: none       # do not run kube-proxy
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>nodes:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>- role: control-plane
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>- role: worker
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>- role: worker
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>- role: worker
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>EOF</span>
</span></span></code></pre></div><p><img src=/images/2023-09-16-kubernetes-service/8.png alt></p><p>查看 k8s 集群中的 kube-apiserver 的地址，如下所示：</p><p><img src=/images/2023-09-16-kubernetes-service/9.png alt></p><p>安装 Cilium。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>helm repo add cilium https://helm.cilium.io/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>helm repo update
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>helm install cilium cilium/cilium <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>  --set <span style=color:#8be9fd;font-style:italic>k8sServiceHost</span><span style=color:#ff79c6>=</span>172.18.0.5 <span style=color:#f1fa8c>\ </span><span style=color:#6272a4># k8s api-server 地址</span>
</span></span><span style=display:flex><span>  --set <span style=color:#8be9fd;font-style:italic>k8sServicePort</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>6443</span> <span style=color:#f1fa8c>\ </span> <span style=color:#6272a4># k8s api-server 端口</span>
</span></span><span style=display:flex><span>  --set global.kubeProxyReplacement<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;strict&#34;</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>  --namespace kube-system
</span></span></code></pre></div><p><img src=/images/2023-09-16-kubernetes-service/10.png alt></p><p><img src=/images/2023-09-16-kubernetes-service/11.png alt></p><p>现在，我们再次使用 nginx 服务和 telnet 命令进行测试。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#6272a4># one terminal</span>
</span></span><span style=display:flex><span>root@instance-00qqerhq:~/learn-k8s-service# kubectl run --rm client -it --image arunvelsriram/utils sh
</span></span><span style=display:flex><span>$ telnet nginx <span style=color:#bd93f9>80</span>
</span></span><span style=display:flex><span>Trying 10.96.43.209...
</span></span><span style=display:flex><span>Connected to nginx.default.svc.cluster.local.
</span></span><span style=display:flex><span>Escape character is <span style=color:#f1fa8c>&#39;^]&#39;</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># another terminal</span>
</span></span><span style=display:flex><span>root@instance-00qqerhq:~/learn-k8s-service# kubectl <span style=color:#8be9fd;font-style:italic>exec</span> -it client --  netstat -an|grep EST
</span></span><span style=display:flex><span>tcp        <span style=color:#bd93f9>0</span>      <span style=color:#bd93f9>0</span> 10.0.1.90:59668         10.96.43.209:80         ESTABLISHED
</span></span><span style=display:flex><span>root@instance-00qqerhq:~/learn-k8s-service# kubectl  <span style=color:#8be9fd;font-style:italic>exec</span> -ti cilium-bb22l  -n kube-system -- cilium bpf ct list global|grep <span style=color:#bd93f9>59668</span>
</span></span><span style=display:flex><span>Defaulted container <span style=color:#f1fa8c>&#34;cilium-agent&#34;</span> out of: cilium-agent, config <span style=color:#ff79c6>(</span>init<span style=color:#ff79c6>)</span>, mount-cgroup <span style=color:#ff79c6>(</span>init<span style=color:#ff79c6>)</span>, apply-sysctl-overwrites <span style=color:#ff79c6>(</span>init<span style=color:#ff79c6>)</span>, mount-bpf-fs <span style=color:#ff79c6>(</span>init<span style=color:#ff79c6>)</span>, clean-cilium-state <span style=color:#ff79c6>(</span>init<span style=color:#ff79c6>)</span>, install-cni-binaries <span style=color:#ff79c6>(</span>init<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>TCP OUT 10.96.43.209:80 -&gt; 10.0.1.90:59668 service <span style=color:#8be9fd;font-style:italic>expires</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>475561</span> <span style=color:#8be9fd;font-style:italic>RxPackets</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>0</span> <span style=color:#8be9fd;font-style:italic>RxBytes</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>7</span> <span style=color:#8be9fd;font-style:italic>RxFlagsSeen</span><span style=color:#ff79c6>=</span>0x00 <span style=color:#8be9fd;font-style:italic>LastRxReport</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>0</span> <span style=color:#8be9fd;font-style:italic>TxPackets</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>0</span> <span style=color:#8be9fd;font-style:italic>TxBytes</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>0</span> <span style=color:#8be9fd;font-style:italic>TxFlagsSeen</span><span style=color:#ff79c6>=</span>0x12 <span style=color:#8be9fd;font-style:italic>LastTxReport</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>453961</span> <span style=color:#8be9fd;font-style:italic>Flags</span><span style=color:#ff79c6>=</span>0x0010 <span style=color:#ff79c6>[</span> SeenNonSyn <span style=color:#ff79c6>]</span> <span style=color:#8be9fd;font-style:italic>RevNAT</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>5</span> <span style=color:#8be9fd;font-style:italic>SourceSecurityID</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>0</span> <span style=color:#8be9fd;font-style:italic>IfIndex</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>0</span>
</span></span><span style=display:flex><span>TCP IN 10.0.1.90:59668 -&gt; 10.0.1.108:80 <span style=color:#8be9fd;font-style:italic>expires</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>475561</span> <span style=color:#8be9fd;font-style:italic>RxPackets</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>2</span> <span style=color:#8be9fd;font-style:italic>RxBytes</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>140</span> <span style=color:#8be9fd;font-style:italic>RxFlagsSeen</span><span style=color:#ff79c6>=</span>0x12 <span style=color:#8be9fd;font-style:italic>LastRxReport</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>453961</span> <span style=color:#8be9fd;font-style:italic>TxPackets</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>1</span> <span style=color:#8be9fd;font-style:italic>TxBytes</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>74</span> <span style=color:#8be9fd;font-style:italic>TxFlagsSeen</span><span style=color:#ff79c6>=</span>0x12 <span style=color:#8be9fd;font-style:italic>LastTxReport</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>453961</span> <span style=color:#8be9fd;font-style:italic>Flags</span><span style=color:#ff79c6>=</span>0x0010 <span style=color:#ff79c6>[</span> SeenNonSyn <span style=color:#ff79c6>]</span> <span style=color:#8be9fd;font-style:italic>RevNAT</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>0</span> <span style=color:#8be9fd;font-style:italic>SourceSecurityID</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>27453</span> <span style=color:#8be9fd;font-style:italic>IfIndex</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>0</span>
</span></span><span style=display:flex><span>TCP OUT 10.0.1.90:59668 -&gt; 10.0.1.108:80 <span style=color:#8be9fd;font-style:italic>expires</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>475561</span> <span style=color:#8be9fd;font-style:italic>RxPackets</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>1</span> <span style=color:#8be9fd;font-style:italic>RxBytes</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>74</span> <span style=color:#8be9fd;font-style:italic>RxFlagsSeen</span><span style=color:#ff79c6>=</span>0x12 <span style=color:#8be9fd;font-style:italic>LastRxReport</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>453961</span> <span style=color:#8be9fd;font-style:italic>TxPackets</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>2</span> <span style=color:#8be9fd;font-style:italic>TxBytes</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>140</span> <span style=color:#8be9fd;font-style:italic>TxFlagsSeen</span><span style=color:#ff79c6>=</span>0x12 <span style=color:#8be9fd;font-style:italic>LastTxReport</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>453961</span> <span style=color:#8be9fd;font-style:italic>Flags</span><span style=color:#ff79c6>=</span>0x0010 <span style=color:#ff79c6>[</span> SeenNonSyn <span style=color:#ff79c6>]</span> <span style=color:#8be9fd;font-style:italic>RevNAT</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>5</span> <span style=color:#8be9fd;font-style:italic>SourceSecurityID</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>27453</span> <span style=color:#8be9fd;font-style:italic>IfIndex</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>0</span>
</span></span><span style=display:flex><span>root@instance-00qqerhq:~/learn-k8s-service# kubectl get pod -owide
</span></span><span style=display:flex><span>NAME                    READY   STATUS    RESTARTS   AGE     IP           NODE           NOMINATED NODE   READINESS GATES
</span></span><span style=display:flex><span>client                  1/1     Running   <span style=color:#bd93f9>0</span>          3m30s   10.0.1.90    kind-worker2   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>nginx-76d6c9b8c-6d6fz   1/1     Running   <span style=color:#bd93f9>0</span>          14m     10.0.3.202   kind-worker3   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>nginx-76d6c9b8c-84qkd   1/1     Running   <span style=color:#bd93f9>0</span>          14m     10.0.1.108   kind-worker2   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>root@instance-00qqerhq:~/learn-k8s-service# kubectl get svc
</span></span><span style=display:flex><span>NAME         TYPE        CLUSTER-IP     EXTERNAL-IP   PORT<span style=color:#ff79c6>(</span>S<span style=color:#ff79c6>)</span>   AGE
</span></span><span style=display:flex><span>kubernetes   ClusterIP   10.96.0.1      &lt;none&gt;        443/TCP   34m
</span></span><span style=display:flex><span>nginx        ClusterIP   10.96.43.209   &lt;none&gt;        80/TCP    15m
</span></span></code></pre></div><p>从 client 的角度来看，一切都没有改变，和之前一样连接到服务 IP。由于我们搭建的 Kubernetes 集群没有安装 kube-proxy，因此 conntrack 表中没有与此连接相关的条目，整体的网络架构如下所示：</p><p><img src=/images/2023-09-16-kubernetes-service/12.svg alt></p><p>Cilium 拦截所有请求 nginx 服务 IP 的流量，并将其转发到 eBPF Map 中对应的 pod IP。为了执行反向网络地址转换功能，Cilium 在 eBPF Map 上维护自己的连接跟踪表。检查此表，我们可以使用 cilium pod 中的 cilium CLI 工具，如下所示：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>root@instance-00qqerhq:~/learn-k8s-service# kubectl  <span style=color:#8be9fd;font-style:italic>exec</span> -ti cilium-bb22l  -n kube-system -- cilium bpf ct list global |  grep <span style=color:#bd93f9>59668</span>
</span></span><span style=display:flex><span>Defaulted container <span style=color:#f1fa8c>&#34;cilium-agent&#34;</span> out of: cilium-agent, config <span style=color:#ff79c6>(</span>init<span style=color:#ff79c6>)</span>, mount-cgroup <span style=color:#ff79c6>(</span>init<span style=color:#ff79c6>)</span>, apply-sysctl-overwrites <span style=color:#ff79c6>(</span>init<span style=color:#ff79c6>)</span>, mount-bpf-fs <span style=color:#ff79c6>(</span>init<span style=color:#ff79c6>)</span>, clean-cilium-state <span style=color:#ff79c6>(</span>init<span style=color:#ff79c6>)</span>, install-cni-binaries <span style=color:#ff79c6>(</span>init<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>TCP OUT 10.96.43.209:80 -&gt; 10.0.1.90:59668 service <span style=color:#8be9fd;font-style:italic>expires</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>475561</span> <span style=color:#8be9fd;font-style:italic>RxPackets</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>0</span> <span style=color:#8be9fd;font-style:italic>RxBytes</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>7</span> <span style=color:#8be9fd;font-style:italic>RxFlagsSeen</span><span style=color:#ff79c6>=</span>0x00 <span style=color:#8be9fd;font-style:italic>LastRxReport</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>0</span> <span style=color:#8be9fd;font-style:italic>TxPackets</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>0</span> <span style=color:#8be9fd;font-style:italic>TxBytes</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>0</span> <span style=color:#8be9fd;font-style:italic>TxFlagsSeen</span><span style=color:#ff79c6>=</span>0x12 <span style=color:#8be9fd;font-style:italic>LastTxReport</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>453961</span> <span style=color:#8be9fd;font-style:italic>Flags</span><span style=color:#ff79c6>=</span>0x0010 <span style=color:#ff79c6>[</span> SeenNonSyn <span style=color:#ff79c6>]</span> <span style=color:#8be9fd;font-style:italic>RevNAT</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>5</span> <span style=color:#8be9fd;font-style:italic>SourceSecurityID</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>0</span> <span style=color:#8be9fd;font-style:italic>IfIndex</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>0</span>
</span></span><span style=display:flex><span>TCP IN 10.0.1.90:59668 -&gt; 10.0.1.108:80 <span style=color:#8be9fd;font-style:italic>expires</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>475561</span> <span style=color:#8be9fd;font-style:italic>RxPackets</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>2</span> <span style=color:#8be9fd;font-style:italic>RxBytes</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>140</span> <span style=color:#8be9fd;font-style:italic>RxFlagsSeen</span><span style=color:#ff79c6>=</span>0x12 <span style=color:#8be9fd;font-style:italic>LastRxReport</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>453961</span> <span style=color:#8be9fd;font-style:italic>TxPackets</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>1</span> <span style=color:#8be9fd;font-style:italic>TxBytes</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>74</span> <span style=color:#8be9fd;font-style:italic>TxFlagsSeen</span><span style=color:#ff79c6>=</span>0x12 <span style=color:#8be9fd;font-style:italic>LastTxReport</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>453961</span> <span style=color:#8be9fd;font-style:italic>Flags</span><span style=color:#ff79c6>=</span>0x0010 <span style=color:#ff79c6>[</span> SeenNonSyn <span style=color:#ff79c6>]</span> <span style=color:#8be9fd;font-style:italic>RevNAT</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>0</span> <span style=color:#8be9fd;font-style:italic>SourceSecurityID</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>27453</span> <span style=color:#8be9fd;font-style:italic>IfIndex</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>0</span>
</span></span><span style=display:flex><span>TCP OUT 10.0.1.90:59668 -&gt; 10.0.1.108:80 <span style=color:#8be9fd;font-style:italic>expires</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>475561</span> <span style=color:#8be9fd;font-style:italic>RxPackets</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>1</span> <span style=color:#8be9fd;font-style:italic>RxBytes</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>74</span> <span style=color:#8be9fd;font-style:italic>RxFlagsSeen</span><span style=color:#ff79c6>=</span>0x12 <span style=color:#8be9fd;font-style:italic>LastRxReport</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>453961</span> <span style=color:#8be9fd;font-style:italic>TxPackets</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>2</span> <span style=color:#8be9fd;font-style:italic>TxBytes</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>140</span> <span style=color:#8be9fd;font-style:italic>TxFlagsSeen</span><span style=color:#ff79c6>=</span>0x12 <span style=color:#8be9fd;font-style:italic>LastTxReport</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>453961</span> <span style=color:#8be9fd;font-style:italic>Flags</span><span style=color:#ff79c6>=</span>0x0010 <span style=color:#ff79c6>[</span> SeenNonSyn <span style=color:#ff79c6>]</span> <span style=color:#8be9fd;font-style:italic>RevNAT</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>5</span> <span style=color:#8be9fd;font-style:italic>SourceSecurityID</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>27453</span> <span style=color:#8be9fd;font-style:italic>IfIndex</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>0</span>
</span></span></code></pre></div><p>如图所示，客户端 client pod 连接到 10.0.1.108:80 (nginx-pod-2)。</p><h1 id=总结>总结</h1><p>在我们的学习过程中，首先我们探讨了在 Docker Swarm 集群模式下，服务之间是如何进行通信的。我们了解到，Docker Swarm 使用内置的服务发现和负载均衡机制来实现服务间的通信。然后，我们转向 Kubernetes，研究了在 kube-proxy、Istio Service Mesh 和 Cilium 三种模式下服务到服务的通信机制。在 kube-proxy 模式下，我们了解到它使用 Iptables 或者 IPVS 来实现服务的负载均衡。而在 Istio Service Mesh 模式下，服务间的通信是通过 Envoy 代理来实现的，它提供了丰富的流量控制和安全策略。最后，在 Cilium 模式下，我们学习了它是如何利用 BPF（Berkeley Packet Filter）来实现服务通信的。这三种模式各有特点，为我们提供了丰富的选择来满足不同的服务通信需求。</p><h1 id=参考>参考</h1><ol><li><a href=https://docs.docker.com/network/drivers/overlay/>https://docs.docker.com/network/drivers/overlay/</a></li><li><a href=https://istio.io/latest/docs/setup/getting-started/>https://istio.io/latest/docs/setup/getting-started/</a></li><li><a href=https://cilium.io/>https://cilium.io/</a></li></ol><hr><ul class=pager><li class=previous><a href=/post/2023-09-02-ambient-mesh-learn-first/ data-toggle=tooltip data-placement=top title="初识 Istio Ambient Mesh 新模式">&larr;
Previous Post</a></li><li class=next><a href=/post/2023-10-05-ebpf-coroot/ data-toggle=tooltip data-placement=top title="使用 coroot 实现 Kubernetes 服务可观测性（2）">Next
Post &rarr;</a></li></ul></div><div class="col-lg-2 col-lg-offset-0
visible-lg-block
sidebar-container
catalog-container"><div class=side-catalog><hr class="hidden-sm hidden-xs"><h5><a class=catalog-toggle href=#>CATALOG</a></h5><ul class=catalog-body></ul></div></div><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
sidebar-container"></div></div></div></article><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"><li><a href=mailto:tanjunchen20@gmail.com><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=/img/wechat.jpg><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-weixin fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://github.com/tanjunchen><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="copyright text-muted">Copyright &copy; 陈谭军 2024</p></div></div></div></footer><script>function loadAsync(e,t){var s=document,o="script",n=s.createElement(o),i=s.getElementsByTagName(o)[0];n.src=e,t&&n.addEventListener("load",function(e){t(null,e)},!1),i.parentNode.insertBefore(n,i)}</script><script>$("#tag_cloud").length!==0&&loadAsync("/js/jquery.tagcloud.js",function(){$.fn.tagcloud.defaults={color:{start:"#bbbbee",end:"#0085a1"}},$("#tag_cloud a").tagcloud()})</script><script>loadAsync("https://cdn.jsdelivr.net/npm/fastclick@1.0.6/lib/fastclick.min.js",function(){var e=document.querySelector("nav");e&&FastClick.attach(e)})</script><script type=text/javascript>function generateCatalog(e){_containerSelector="div.post-container";var t,n,s,o,i,r=$(_containerSelector),a=r.find("h1,h2,h3,h4,h5,h6");return $(e).html(""),a.each(function(){n=$(this).prop("tagName").toLowerCase(),i="#"+$(this).prop("id"),s=$(this).text(),t=$('<a href="'+i+'" rel="nofollow">'+s+"</a>"),o=$('<li class="'+n+'_nav"></li>').append(t),$(e).append(o)}),!0}generateCatalog(".catalog-body"),$(".catalog-toggle").click(function(e){e.preventDefault(),$(".side-catalog").toggleClass("fold")}),loadAsync("/js/jquery.nav.js",function(){$(".catalog-body").onePageNav({currentClass:"active",changeHash:!1,easing:"swing",filter:"",scrollSpeed:700,scrollOffset:0,scrollThreshold:.2,begin:null,end:null,scrollChange:null,padding:80})})</script></body></html>