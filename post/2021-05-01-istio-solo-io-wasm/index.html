<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:site_name" content="漫步远方，心荡神往"><meta property="og:type" content="article"><meta property="og:image" content="https://tanjunchen.github.io/img/home.webp"><meta property="twitter:image" content="https://tanjunchen.github.io/img/home.webp"><meta name=title content="使用 wasm 拓展 istio-proxy 数据面"><meta property="og:title" content="使用 wasm 拓展 istio-proxy 数据面"><meta property="twitter:title" content="使用 wasm 拓展 istio-proxy 数据面"><meta name=description content="Solo.io 团队发布了 WebAssembly Hub，这是一套为 Envoy 和 Istio 准备的，用于构建、部署、共享和发现 Envoy Proxy WASM 扩展的工具和仓库。"><meta property="og:description" content="Solo.io 团队发布了 WebAssembly Hub，这是一套为 Envoy 和 Istio 准备的，用于构建、部署、共享和发现 Envoy Proxy WASM 扩展的工具和仓库。"><meta property="twitter:description" content="Solo.io 团队发布了 WebAssembly Hub，这是一套为 Envoy 和 Istio 准备的，用于构建、部署、共享和发现 Envoy Proxy WASM 扩展的工具和仓库。"><meta property="twitter:card" content="summary"><meta name=keyword content="陈谭军, 互联网, 云原生, 容器, 微服务, Web, PaaS, Istio, Kubernetes, Microservice"><link rel="shortcut icon" href=/img/favicon.ico><title>使用 wasm 拓展 istio-proxy 数据面 | 陈谭军的博客 | tanjunchen Blog</title><link rel=canonical href=/post/2021-05-01-istio-solo-io-wasm/><link rel=stylesheet href=/css/bootstrap.min.css><link rel=stylesheet href=/css/hugo-theme-cleanwhite.min.css><link rel=stylesheet href=/css/zanshang.css><link rel=stylesheet href=/css/font-awesome.all.min.css><script src=/js/jquery.min.js></script>
<script src=/js/bootstrap.min.js></script>
<script src=/js/hux-blog.min.js></script>
<script src=/js/lazysizes.min.js></script></head><nav class="navbar navbar-default navbar-custom navbar-fixed-top"><div class=container-fluid><div class="navbar-header page-scroll"><button type=button class=navbar-toggle>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span></button>
<a class=navbar-brand href=/>漫步远方，心荡神往</a></div><div id=huxblog_navbar><div class=navbar-collapse><ul class="nav navbar-nav navbar-right"><li><a href=/>All Posts</a></li><li><a href=/categories/technology/>technology</a></li><li><a href=/categories/think/>think</a></li><li><a href=/learning/>LEARNING</a></li><li><a href=/archive/>ARCHIVE</a></li><li><a href=/about/>ABOUT</a></li><li><a href=/search><i class="fa fa-search"></i></a></li></ul></div></div></div></nav><script>var $body=document.body,$toggle=document.querySelector(".navbar-toggle"),$navbar=document.querySelector("#huxblog_navbar"),$collapse=document.querySelector(".navbar-collapse");$toggle.addEventListener("click",handleMagic);function handleMagic(){$navbar.className.indexOf("in")>0?($navbar.className=" ",setTimeout(function(){$navbar.className.indexOf("in")<0&&($collapse.style.height="0px")},400)):($collapse.style.height="auto",$navbar.className+=" in")}</script><style type=text/css>header.intro-header{background-image:url(/img/home.webp)}</style><header class=intro-header><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><div class=tags><a class=tag href=/tags/istio title=istio>istio</a></div><h1>使用 wasm 拓展 istio-proxy 数据面</h1><h2 class=subheading></h2><span class=meta>Posted by
陈谭军
on
Saturday, May 1, 2021
<span id=busuanzi_container_page_pv>|<span id=busuanzi_value_page_pv></span><span>
<span id=/post/2021-05-01-istio-solo-io-wasm/ class="leancloud_visitors meta_data_item" data-flag-title><span class=post-meta-item-icon><span class="octicon octicon-eye"></span></span>
<i class="fa fa-eye"></i>
<span class=old-visitors-count style=display:none></span>
<span class=leancloud-visitors-count></span></span>
<script src=https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js></script>
<script>AV.initialize("","")</script><script type=text/javascript>function showTime(e){var n=new AV.Query(e),t=[],s=$(".leancloud_visitors");s.each(function(){t.push($(this).attr("id").trim())}),n.containedIn("url",t),n.find().done(function(e){for(var s,o,i,a,r,c,l=".leancloud-visitors-count",d=".old-visitors-count",n=0;n<e.length;n++)a=e[n],i=a.get("url"),c=a.get("time"),s=document.getElementById(i),$(s).find(l).text(c);for(n=0;n<t.length;n++)i=t[n],s=document.getElementById(i),o=$(s).find(l),o.text()==""&&(r=$(s).find(d).text(),r!=""?o.text(0+parseInt(r)):o.text(0))}).fail(function(e,t){console.log("Error: "+t.code+" "+t.message)})}function addCount(e){var n=$(".leancloud_visitors"),t=n.attr("id").trim(),o=n.attr("data-flag-title").trim(),s=new AV.Query(e);s.equalTo("url",t),s.find({success:function(n){if(n.length>0){var s,i,r,c,l,a=n[0];a.fetchWhenSave(!0),a.increment("time"),a.save(null,{success:function(e){var n=$(document.getElementById(t));n.find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to save Visitor num, with error message: "+t.message)}})}else s=new e,i=new AV.ACL,i.setPublicReadAccess(!0),i.setPublicWriteAccess(!0),s.setACL(i),s.set("title",o),s.set("url",t),c=".old-visitors-count",l=$(document.getElementById(t)),r=l.find(c).text(),r!=""?s.set("time",parseInt(r)+1):s.set("time",1),s.save(null,{success:function(e){var n=$(document.getElementById(t));n.find(".leancloud-visitors-count").text(e.get("time"))},error:function(){console.log("Failed to create")}})},error:function(e){console.log("Error:"+e.code+" "+e.message)}})}$(function(){var e=AV.Object.extend("Counter");$(".leancloud_visitors").length==1?addCount(e):showTime(e)})</script>阅读 </span></span>|<span class=post-date>共 1517 字</span>，阅读约 <span class=more-meta>4 分钟</span></span></div></div></div></div></header><article><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
post-container"><p><a href=https://www.solo.io/>Solo.io</a> 团队发布了 WebAssembly Hub，这是一套为 Envoy 和 Istio 准备的，用于构建、部署、共享和发现 Envoy Proxy WASM 扩展的工具和仓库。</p><p><strong>使用 wasme 拓展 istio-proxy 数据平面</strong></p><p>安装 wasme 构建工具</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -sL https://run.solo.io/wasme/install | sh
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>PATH</span><span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>$HOME</span>/.wasme/bin:<span style=color:#8be9fd;font-style:italic>$PATH</span>
</span></span></code></pre></div><p>查看版本号</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>wasme --version
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>root@dev-10 ~<span style=color:#ff79c6>]</span><span style=color:#6272a4># wasme --version</span>
</span></span><span style=display:flex><span>wasme version 0.0.33
</span></span></code></pre></div><p>如果出现网络原因，安装脚本不太好用。则可以到 solo.io/wasm 官网下载镜像包，以及配置环境即可。</p><p>创建一个 cpp filter 项目</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>wasme init ./new-filter
</span></span><span style=display:flex><span>  cpp
</span></span><span style=display:flex><span>  rust
</span></span><span style=display:flex><span>▸ assemblyscript
</span></span><span style=display:flex><span>  tinygo
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>✔ assemblyscript
</span></span><span style=display:flex><span>✔ gloo:1.3.x, gloo:1.5.x, gloo:1.6.x, istio:1.5.x, istio:1.6.x, istio:1.7.x, istio:1.8.x, istio:1.9.x
</span></span></code></pre></div><p>filter 增加 header (最新 0.0.33 版本增加了默认 header 值)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>onResponseHeaders<span style=color:#ff79c6>(</span>a: u32<span style=color:#ff79c6>)</span>: FilterHeadersStatusValues <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>const <span style=color:#8be9fd;font-style:italic>root_context</span> <span style=color:#ff79c6>=</span> this.root_context;
</span></span><span style=display:flex><span><span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>root_context.configuration <span style=color:#ff79c6>==</span> <span style=color:#f1fa8c>&#34;&#34;</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    stream_context.headers.response.add<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;hello&#34;</span>, <span style=color:#f1fa8c>&#34;world!&#34;</span><span style=color:#ff79c6>)</span>;
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span> <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    stream_context.headers.response.add<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;hello&#34;</span>, root_context.configuration<span style=color:#ff79c6>)</span>;
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>return</span> FilterHeadersStatusValues.Continue;
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>编译 filter</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>wasme build cpp -t webassemblyhub.io/tanjunchen20/add-header:v0.1 .
</span></span></code></pre></div><p>查看本地的 filter 镜像</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ff79c6>[</span>root@mesh-10-20-11-190 wasme<span style=color:#ff79c6>]</span><span style=color:#6272a4># wasme list</span>
</span></span><span style=display:flex><span>NAME                                      TAG  SIZE    SHA      UPDATED
</span></span><span style=display:flex><span>webassemblyhub.io/tanjunchen20/add-header v0.1 12.6 kB 0295d929 <span style=color:#bd93f9>02</span> Apr <span style=color:#bd93f9>21</span> 13:06 CST
</span></span></code></pre></div><p>推送到 <code>WebAssembly hub</code>，<code>wasme login -u $YOUR_USERNAME -p $YOUR_PASSWORD</code>，推送镜像 <code>wasme push webassemblyhub.io/tanjunchen20/add-header:v0.1</code>。</p><p>查找我的远程镜像</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>wasme list --search <span style=color:#8be9fd;font-style:italic>$YOUR_USERNAME</span>
</span></span></code></pre></div><p>安装 istio</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -L https://istio.io/downloadIstio | <span style=color:#8be9fd;font-style:italic>ISTIO_VERSION</span><span style=color:#ff79c6>=</span>1.8.1 sh -
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>cd</span> istio-1.8.1
</span></span><span style=display:flex><span>istioctl install --set <span style=color:#8be9fd;font-style:italic>profile</span><span style=color:#ff79c6>=</span>demo
</span></span></code></pre></div><p>部署应用</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl create ns bookinfo
</span></span><span style=display:flex><span>kubectl label namespace bookinfo istio-injection<span style=color:#ff79c6>=</span>enabled --overwrite
</span></span><span style=display:flex><span>kubectl apply -n bookinfo -f samples/bookinfo/platform/kube/bookinfo.yaml 
</span></span></code></pre></div><p>部署 WASM filter 到 istio 中的应用</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>wasme deploy istio webassemblyhub.io/tanjunchen20/add-header:v0.1
</span></span><span style=display:flex><span>--id<span style=color:#ff79c6>=</span>myfilter
</span></span><span style=display:flex><span>--namespace bookinfo
</span></span><span style=display:flex><span>--config <span style=color:#f1fa8c>&#39;tanjunchen20&#39;</span>
</span></span><span style=display:flex><span>INFO<span style=color:#ff79c6>[</span>0000<span style=color:#ff79c6>]</span> cache namespace created                       <span style=color:#8be9fd;font-style:italic>cache</span><span style=color:#ff79c6>=</span>wasme-cache.wasme <span style=color:#8be9fd;font-style:italic>image</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;quay.io/solo-io/wasme:0.0.33&#34;</span>
</span></span><span style=display:flex><span>INFO<span style=color:#ff79c6>[</span>0000<span style=color:#ff79c6>]</span> cache configmap created                       <span style=color:#8be9fd;font-style:italic>cache</span><span style=color:#ff79c6>=</span>wasme-cache.wasme <span style=color:#8be9fd;font-style:italic>image</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;quay.io/solo-io/wasme:0.0.33&#34;</span>
</span></span><span style=display:flex><span>INFO<span style=color:#ff79c6>[</span>0000<span style=color:#ff79c6>]</span> cache service account created                 <span style=color:#8be9fd;font-style:italic>cache</span><span style=color:#ff79c6>=</span>wasme-cache.wasme <span style=color:#8be9fd;font-style:italic>image</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;quay.io/solo-io/wasme:0.0.33&#34;</span>
</span></span><span style=display:flex><span>INFO<span style=color:#ff79c6>[</span>0000<span style=color:#ff79c6>]</span> cache role created                            <span style=color:#8be9fd;font-style:italic>cache</span><span style=color:#ff79c6>=</span>wasme-cache.wasme <span style=color:#8be9fd;font-style:italic>image</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;quay.io/solo-io/wasme:0.0.33&#34;</span>
</span></span><span style=display:flex><span>INFO<span style=color:#ff79c6>[</span>0000<span style=color:#ff79c6>]</span> cache rolebinding created                     <span style=color:#8be9fd;font-style:italic>cache</span><span style=color:#ff79c6>=</span>wasme-cache.wasme <span style=color:#8be9fd;font-style:italic>image</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;quay.io/solo-io/wasme:0.0.33&#34;</span>
</span></span><span style=display:flex><span>INFO<span style=color:#ff79c6>[</span>0000<span style=color:#ff79c6>]</span> cache daemonset created                       <span style=color:#8be9fd;font-style:italic>cache</span><span style=color:#ff79c6>=</span>wasme-cache.wasme <span style=color:#8be9fd;font-style:italic>image</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;quay.io/solo-io/wasme:0.0.33&#34;</span>
</span></span><span style=display:flex><span>INFO<span style=color:#ff79c6>[</span>0006<span style=color:#ff79c6>]</span> added image to cache config...                <span style=color:#8be9fd;font-style:italic>cache</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;{wasme-cache wasme}&#34;</span> <span style=color:#8be9fd;font-style:italic>image</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;webassemblyhub.io/tanjunchen20/add-header:v0.1&#34;</span>
</span></span><span style=display:flex><span>INFO<span style=color:#ff79c6>[</span>0006<span style=color:#ff79c6>]</span> waiting <span style=color:#ff79c6>for</span> event with timeout 1m0s          
</span></span><span style=display:flex><span>WARN<span style=color:#ff79c6>[</span>0007<span style=color:#ff79c6>]</span> event err: expected <span style=color:#bd93f9>1</span> image-ready events <span style=color:#ff79c6>for</span> image webassemblyhub.io/tanjunchen20/add-header:v0.1, only found map<span style=color:#ff79c6>[]</span> 
</span></span><span style=display:flex><span>WARN<span style=color:#ff79c6>[</span>0008<span style=color:#ff79c6>]</span> event err: expected <span style=color:#bd93f9>1</span> image-ready events <span style=color:#ff79c6>for</span> image webassemblyhub.io/tanjunchen20/add-header:v0.1, only found map<span style=color:#ff79c6>[]</span> 
</span></span><span style=display:flex><span>WARN<span style=color:#ff79c6>[</span>0009<span style=color:#ff79c6>]</span> event err: expected <span style=color:#bd93f9>1</span> image-ready events <span style=color:#ff79c6>for</span> image webassemblyhub.io/tanjunchen20/add-header:v0.1, only found map<span style=color:#ff79c6>[]</span> 
</span></span><span style=display:flex><span>WARN<span style=color:#ff79c6>[</span>0010<span style=color:#ff79c6>]</span> event err: expected <span style=color:#bd93f9>1</span> image-ready events <span style=color:#ff79c6>for</span> image webassemblyhub.io/tanjunchen20/add-header:v0.1, only found map<span style=color:#ff79c6>[]</span> 
</span></span><span style=display:flex><span>WARN<span style=color:#ff79c6>[</span>0011<span style=color:#ff79c6>]</span> event err: expected <span style=color:#bd93f9>1</span> image-ready events <span style=color:#ff79c6>for</span> image webassemblyhub.io/tanjunchen20/add-header:v0.1, only found map<span style=color:#ff79c6>[]</span> 
</span></span><span style=display:flex><span>INFO<span style=color:#ff79c6>[</span>0012<span style=color:#ff79c6>]</span> cleaning up cache events <span style=color:#ff79c6>for</span> image webassemblyhub.io/tanjunchen20/add-header:v0.1 
</span></span><span style=display:flex><span>INFO<span style=color:#ff79c6>[</span>0012<span style=color:#ff79c6>]</span> updated workload sidecar annotations          <span style=color:#8be9fd;font-style:italic>filter</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;id:\&#34;myfilter\&#34; image:\&#34;webassemblyhub.io/tanjunchen20/add-header:v0.1\&#34; config:&lt;type_url:\&#34;type.googleapis.com/google.protobuf.StringValue\&#34; value:\&#34;\\n\\014tanjunchen20\&#34; &gt; rootID:\&#34;add_header\&#34; patchContext:\&#34;inbound\&#34; &#34;</span> <span style=color:#8be9fd;font-style:italic>workload</span><span style=color:#ff79c6>=</span>details-v1
</span></span><span style=display:flex><span>INFO<span style=color:#ff79c6>[</span>0012<span style=color:#ff79c6>]</span> created Istio EnvoyFilter resource            <span style=color:#8be9fd;font-style:italic>envoy_filter_resource</span><span style=color:#ff79c6>=</span>details-v1-myfilter.bookinfo <span style=color:#8be9fd;font-style:italic>filter</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;id:\&#34;myfilter\&#34; image:\&#34;webassemblyhub.io/tanjunchen20/add-header:v0.1\&#34; config:&lt;type_url:\&#34;type.googleapis.com/google.protobuf.StringValue\&#34; value:\&#34;\\n\\014tanjunchen20\&#34; &gt; rootID:\&#34;add_header\&#34; patchContext:\&#34;inbound\&#34; &#34;</span> <span style=color:#8be9fd;font-style:italic>workload</span><span style=color:#ff79c6>=</span>details-v1
</span></span><span style=display:flex><span>INFO<span style=color:#ff79c6>[</span>0012<span style=color:#ff79c6>]</span> updated workload sidecar annotations          <span style=color:#8be9fd;font-style:italic>filter</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;id:\&#34;myfilter\&#34; image:\&#34;webassemblyhub.io/tanjunchen20/add-header:v0.1\&#34; config:&lt;type_url:\&#34;type.googleapis.com/google.protobuf.StringValue\&#34; value:\&#34;\\n\\014tanjunchen20\&#34; &gt; rootID:\&#34;add_header\&#34; patchContext:\&#34;inbound\&#34; &#34;</span> <span style=color:#8be9fd;font-style:italic>workload</span><span style=color:#ff79c6>=</span>productpage-v1
</span></span><span style=display:flex><span>INFO<span style=color:#ff79c6>[</span>0012<span style=color:#ff79c6>]</span> created Istio EnvoyFilter resource            <span style=color:#8be9fd;font-style:italic>envoy_filter_resource</span><span style=color:#ff79c6>=</span>productpage-v1-myfilter.bookinfo <span style=color:#8be9fd;font-style:italic>filter</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;id:\&#34;myfilter\&#34; image:\&#34;webassemblyhub.io/tanjunchen20/add-header:v0.1\&#34; config:&lt;type_url:\&#34;type.googleapis.com/google.protobuf.StringValue\&#34; value:\&#34;\\n\\014tanjunchen20\&#34; &gt; rootID:\&#34;add_header\&#34; patchContext:\&#34;inbound\&#34; &#34;</span> <span style=color:#8be9fd;font-style:italic>workload</span><span style=color:#ff79c6>=</span>productpage-v1
</span></span><span style=display:flex><span>INFO<span style=color:#ff79c6>[</span>0012<span style=color:#ff79c6>]</span> updated workload sidecar annotations          <span style=color:#8be9fd;font-style:italic>filter</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;id:\&#34;myfilter\&#34; image:\&#34;webassemblyhub.io/tanjunchen20/add-header:v0.1\&#34; config:&lt;type_url:\&#34;type.googleapis.com/google.protobuf.StringValue\&#34; value:\&#34;\\n\\014tanjunchen20\&#34; &gt; rootID:\&#34;add_header\&#34; patchContext:\&#34;inbound\&#34; &#34;</span> <span style=color:#8be9fd;font-style:italic>workload</span><span style=color:#ff79c6>=</span>ratings-v1
</span></span><span style=display:flex><span>INFO<span style=color:#ff79c6>[</span>0013<span style=color:#ff79c6>]</span> created Istio EnvoyFilter resource            <span style=color:#8be9fd;font-style:italic>envoy_filter_resource</span><span style=color:#ff79c6>=</span>ratings-v1-myfilter.bookinfo <span style=color:#8be9fd;font-style:italic>filter</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;id:\&#34;myfilter\&#34; image:\&#34;webassemblyhub.io/tanjunchen20/add-header:v0.1\&#34; config:&lt;type_url:\&#34;type.googleapis.com/google.protobuf.StringValue\&#34; value:\&#34;\\n\\014tanjunchen20\&#34; &gt; rootID:\&#34;add_header\&#34; patchContext:\&#34;inbound\&#34; &#34;</span> <span style=color:#8be9fd;font-style:italic>workload</span><span style=color:#ff79c6>=</span>ratings-v1
</span></span><span style=display:flex><span>INFO<span style=color:#ff79c6>[</span>0013<span style=color:#ff79c6>]</span> updated workload sidecar annotations          <span style=color:#8be9fd;font-style:italic>filter</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;id:\&#34;myfilter\&#34; image:\&#34;webassemblyhub.io/tanjunchen20/add-header:v0.1\&#34; config:&lt;type_url:\&#34;type.googleapis.com/google.protobuf.StringValue\&#34; value:\&#34;\\n\\014tanjunchen20\&#34; &gt; rootID:\&#34;add_header\&#34; patchContext:\&#34;inbound\&#34; &#34;</span> <span style=color:#8be9fd;font-style:italic>workload</span><span style=color:#ff79c6>=</span>reviews-v1
</span></span><span style=display:flex><span>INFO<span style=color:#ff79c6>[</span>0013<span style=color:#ff79c6>]</span> created Istio EnvoyFilter resource            <span style=color:#8be9fd;font-style:italic>envoy_filter_resource</span><span style=color:#ff79c6>=</span>reviews-v1-myfilter.bookinfo <span style=color:#8be9fd;font-style:italic>filter</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;id:\&#34;myfilter\&#34; image:\&#34;webassemblyhub.io/tanjunchen20/add-header:v0.1\&#34; config:&lt;type_url:\&#34;type.googleapis.com/google.protobuf.StringValue\&#34; value:\&#34;\\n\\014tanjunchen20\&#34; &gt; rootID:\&#34;add_header\&#34; patchContext:\&#34;inbound\&#34; &#34;</span> <span style=color:#8be9fd;font-style:italic>workload</span><span style=color:#ff79c6>=</span>reviews-v1
</span></span><span style=display:flex><span>INFO<span style=color:#ff79c6>[</span>0013<span style=color:#ff79c6>]</span> updated workload sidecar annotations          <span style=color:#8be9fd;font-style:italic>filter</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;id:\&#34;myfilter\&#34; image:\&#34;webassemblyhub.io/tanjunchen20/add-header:v0.1\&#34; config:&lt;type_url:\&#34;type.googleapis.com/google.protobuf.StringValue\&#34; value:\&#34;\\n\\014tanjunchen20\&#34; &gt; rootID:\&#34;add_header\&#34; patchContext:\&#34;inbound\&#34; &#34;</span> <span style=color:#8be9fd;font-style:italic>workload</span><span style=color:#ff79c6>=</span>reviews-v2
</span></span><span style=display:flex><span>INFO<span style=color:#ff79c6>[</span>0013<span style=color:#ff79c6>]</span> created Istio EnvoyFilter resource            <span style=color:#8be9fd;font-style:italic>envoy_filter_resource</span><span style=color:#ff79c6>=</span>reviews-v2-myfilter.bookinfo <span style=color:#8be9fd;font-style:italic>filter</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;id:\&#34;myfilter\&#34; image:\&#34;webassemblyhub.io/tanjunchen20/add-header:v0.1\&#34; config:&lt;type_url:\&#34;type.googleapis.com/google.protobuf.StringValue\&#34; value:\&#34;\\n\\014tanjunchen20\&#34; &gt; rootID:\&#34;add_header\&#34; patchContext:\&#34;inbound\&#34; &#34;</span> <span style=color:#8be9fd;font-style:italic>workload</span><span style=color:#ff79c6>=</span>reviews-v2
</span></span><span style=display:flex><span>INFO<span style=color:#ff79c6>[</span>0013<span style=color:#ff79c6>]</span> updated workload sidecar annotations          <span style=color:#8be9fd;font-style:italic>filter</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;id:\&#34;myfilter\&#34; image:\&#34;webassemblyhub.io/tanjunchen20/add-header:v0.1\&#34; config:&lt;type_url:\&#34;type.googleapis.com/google.protobuf.StringValue\&#34; value:\&#34;\\n\\014tanjunchen20\&#34; &gt; rootID:\&#34;add_header\&#34; patchContext:\&#34;inbound\&#34; &#34;</span> <span style=color:#8be9fd;font-style:italic>workload</span><span style=color:#ff79c6>=</span>reviews-v3
</span></span><span style=display:flex><span>INFO<span style=color:#ff79c6>[</span>0014<span style=color:#ff79c6>]</span> created Istio EnvoyFilter resource            <span style=color:#8be9fd;font-style:italic>envoy_filter_resource</span><span style=color:#ff79c6>=</span>reviews-v3-myfilter.bookinfo <span style=color:#8be9fd;font-style:italic>filter</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;id:\&#34;myfilter\&#34; image:\&#34;webassemblyhub.io/tanjunchen20/add-header:v0.1\&#34; config:&lt;type_url:\&#34;type.googleapis.com/google.protobuf.StringValue\&#34; value:\&#34;\\n\\014tanjunchen20\&#34; &gt; rootID:\&#34;add_header\&#34; patchContext:\&#34;inbound\&#34; &#34;</span> <span style=color:#8be9fd;font-style:italic>workload</span><span style=color:#ff79c6>=</span>reviews-v3
</span></span></code></pre></div><p>我在测试镜像 <code>webassemblyhub.io/tanjunchen20/add-header:v0.1</code> 添加了 <code>header tanjunchen: tanjunchen20</code>，所以，响应的 header 中会有 <code>tanjunchen: tanjunchen20</code>。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ff79c6>[</span>root@mesh-10-20-11-190 istio-1.8.1<span style=color:#ff79c6>]</span><span style=color:#6272a4># kubectl exec -ti -n bookinfo deploy/productpage-v1 -c istio-proxy -- curl -v http://details.bookinfo:9080/details/123</span>
</span></span><span style=display:flex><span>*   Trying 10.108.222.151...
</span></span><span style=display:flex><span>* TCP_NODELAY <span style=color:#8be9fd;font-style:italic>set</span>
</span></span><span style=display:flex><span>* Connected to details.bookinfo <span style=color:#ff79c6>(</span>10.108.222.151<span style=color:#ff79c6>)</span> port <span style=color:#bd93f9>9080</span> <span style=color:#ff79c6>(</span><span style=color:#6272a4>#0)</span>
</span></span><span style=display:flex><span>&gt; GET /details/123 HTTP/1.1
</span></span><span style=display:flex><span>&gt; Host: details.bookinfo:9080
</span></span><span style=display:flex><span>&gt; User-Agent: curl/7.58.0
</span></span><span style=display:flex><span>&gt; Accept: */*
</span></span><span style=display:flex><span>&gt; 
</span></span><span style=display:flex><span>&lt; HTTP/1.1 <span style=color:#bd93f9>200</span> OK
</span></span><span style=display:flex><span>&lt; content-type: application/json
</span></span><span style=display:flex><span>&lt; server: istio-envoy
</span></span><span style=display:flex><span>&lt; date: Sat, <span style=color:#bd93f9>03</span> Apr <span style=color:#bd93f9>2021</span> 09:30:56 GMT
</span></span><span style=display:flex><span>&lt; content-length: <span style=color:#bd93f9>180</span>
</span></span><span style=display:flex><span>&lt; x-envoy-upstream-service-time: <span style=color:#bd93f9>2</span>
</span></span><span style=display:flex><span>&lt; tanjunchen: tanjunchen20
</span></span><span style=display:flex><span>&lt; x-envoy-decorator-operation: details.bookinfo.svc.cluster.local:9080/*
</span></span><span style=display:flex><span>&lt; 
</span></span><span style=display:flex><span><span style=color:#ff79c6>{</span><span style=color:#f1fa8c>&#34;id&#34;</span>:123,<span style=color:#f1fa8c>&#34;author&#34;</span>:<span style=color:#f1fa8c>&#34;William Shakespeare&#34;</span>,<span style=color:#f1fa8c>&#34;year&#34;</span>:1595,<span style=color:#f1fa8c>&#34;type&#34;</span>:<span style=color:#f1fa8c>&#34;paperback&#34;</span>,<span style=color:#f1fa8c>&#34;pages&#34;</span>:200,<span style=color:#f1fa8c>&#34;publisher&#34;</span>:<span style=color:#f1fa8c>&#34;PublisherA&#34;</span>,<span style=color:#f1fa8c>&#34;language&#34;</span>:<span style=color:#f1fa8c>&#34;English&#34;</span>,<span style=color:#f1fa8c>&#34;ISBN-10&#34;</span>:<span style=color:#f1fa8c>&#34;1234567890&#34;</span>,<span style=color:#f1fa8c>&#34;ISBN-13&#34;</span>:<span style=color:#f1fa8c>&#34;123-1234567890&#34;</span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>移除 wasm filter 链</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>wasme undeploy istio --id myfilter --namespace bookinfo
</span></span><span style=display:flex><span>INFO<span style=color:#ff79c6>[</span>0000<span style=color:#ff79c6>]</span> removing filter from one or more workloads...  <span style=color:#8be9fd;font-style:italic>filter</span><span style=color:#ff79c6>=</span>myfilter <span style=color:#8be9fd;font-style:italic>params</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;{map[] bookinfo deployment}&#34;</span>
</span></span><span style=display:flex><span>INFO<span style=color:#ff79c6>[</span>0000<span style=color:#ff79c6>]</span> removing sidecar annotations from workload    <span style=color:#8be9fd;font-style:italic>filter</span><span style=color:#ff79c6>=</span>myfilter <span style=color:#8be9fd;font-style:italic>workload</span><span style=color:#ff79c6>=</span>details-v1
</span></span><span style=display:flex><span>INFO<span style=color:#ff79c6>[</span>0000<span style=color:#ff79c6>]</span> removing sidecar annotations from workload    <span style=color:#8be9fd;font-style:italic>filter</span><span style=color:#ff79c6>=</span>myfilter <span style=color:#8be9fd;font-style:italic>workload</span><span style=color:#ff79c6>=</span>productpage-v1
</span></span><span style=display:flex><span>INFO<span style=color:#ff79c6>[</span>0000<span style=color:#ff79c6>]</span> removing sidecar annotations from workload    <span style=color:#8be9fd;font-style:italic>filter</span><span style=color:#ff79c6>=</span>myfilter <span style=color:#8be9fd;font-style:italic>workload</span><span style=color:#ff79c6>=</span>ratings-v1
</span></span><span style=display:flex><span>INFO<span style=color:#ff79c6>[</span>0000<span style=color:#ff79c6>]</span> removing sidecar annotations from workload    <span style=color:#8be9fd;font-style:italic>filter</span><span style=color:#ff79c6>=</span>myfilter <span style=color:#8be9fd;font-style:italic>workload</span><span style=color:#ff79c6>=</span>reviews-v1
</span></span><span style=display:flex><span>INFO<span style=color:#ff79c6>[</span>0000<span style=color:#ff79c6>]</span> removing sidecar annotations from workload    <span style=color:#8be9fd;font-style:italic>filter</span><span style=color:#ff79c6>=</span>myfilter <span style=color:#8be9fd;font-style:italic>workload</span><span style=color:#ff79c6>=</span>reviews-v2
</span></span><span style=display:flex><span>INFO<span style=color:#ff79c6>[</span>0000<span style=color:#ff79c6>]</span> removing sidecar annotations from workload    <span style=color:#8be9fd;font-style:italic>filter</span><span style=color:#ff79c6>=</span>myfilter <span style=color:#8be9fd;font-style:italic>workload</span><span style=color:#ff79c6>=</span>reviews-v3
</span></span><span style=display:flex><span>INFO<span style=color:#ff79c6>[</span>0000<span style=color:#ff79c6>]</span> deleted Istio EnvoyFilter resource            <span style=color:#8be9fd;font-style:italic>filter</span><span style=color:#ff79c6>=</span>details-v1-myfilter
</span></span><span style=display:flex><span>INFO<span style=color:#ff79c6>[</span>0001<span style=color:#ff79c6>]</span> deleted Istio EnvoyFilter resource            <span style=color:#8be9fd;font-style:italic>filter</span><span style=color:#ff79c6>=</span>productpage-v1-myfilter
</span></span><span style=display:flex><span>INFO<span style=color:#ff79c6>[</span>0001<span style=color:#ff79c6>]</span> deleted Istio EnvoyFilter resource            <span style=color:#8be9fd;font-style:italic>filter</span><span style=color:#ff79c6>=</span>ratings-v1-myfilter
</span></span><span style=display:flex><span>INFO<span style=color:#ff79c6>[</span>0002<span style=color:#ff79c6>]</span> deleted Istio EnvoyFilter resource            <span style=color:#8be9fd;font-style:italic>filter</span><span style=color:#ff79c6>=</span>reviews-v1-myfilter
</span></span><span style=display:flex><span>INFO<span style=color:#ff79c6>[</span>0002<span style=color:#ff79c6>]</span> deleted Istio EnvoyFilter resource            <span style=color:#8be9fd;font-style:italic>filter</span><span style=color:#ff79c6>=</span>reviews-v2-myfilter
</span></span><span style=display:flex><span>INFO<span style=color:#ff79c6>[</span>0002<span style=color:#ff79c6>]</span> deleted Istio EnvoyFilter resource            <span style=color:#8be9fd;font-style:italic>filter</span><span style=color:#ff79c6>=</span>reviews-v3-myfilter
</span></span><span style=display:flex><span>如果使用了 revision 字段安装的 istio, 部署 webassembly 时需要增加 istiod-name 参数即可。
</span></span><span style=display:flex><span>wasme deploy istio webassemblyhub.io/tanjunchen20/add-header:v0.1 --id<span style=color:#ff79c6>=</span>myfilter --namespace bookinfo --config <span style=color:#f1fa8c>&#39;tanjunchen20&#39;</span> --istiod-name istiod的 deployment 名称
</span></span></code></pre></div><p><strong>使用 Wasme Operator 拓展 istio-proxy 数据面</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f https://github.com/solo-io/wasm/releases/latest/download/wasme.io_v1_crds.yaml
</span></span><span style=display:flex><span><span style=color:#6272a4># Code generated by skv2. DO NOT EDIT.</span>
</span></span><span style=display:flex><span>apiVersion: apiextensions.k8s.io/v1beta1
</span></span><span style=display:flex><span>kind: CustomResourceDefinition
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  labels:
</span></span><span style=display:flex><span>    app: wasme
</span></span><span style=display:flex><span>    app.kubernetes.io/name: wasme
</span></span><span style=display:flex><span>  name: filterdeployments.wasme.io
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  group: wasme.io
</span></span><span style=display:flex><span>  names:
</span></span><span style=display:flex><span>    kind: FilterDeployment
</span></span><span style=display:flex><span>    listKind: FilterDeploymentList
</span></span><span style=display:flex><span>    plural: filterdeployments
</span></span><span style=display:flex><span>    singular: filterdeployment
</span></span><span style=display:flex><span>  scope: Namespaced
</span></span><span style=display:flex><span>  subresources:
</span></span><span style=display:flex><span>    status: <span style=color:#ff79c6>{}</span>
</span></span><span style=display:flex><span>  versions:
</span></span><span style=display:flex><span>  - name: v1
</span></span><span style=display:flex><span>    served: <span style=color:#8be9fd;font-style:italic>true</span>
</span></span><span style=display:flex><span>    storage: <span style=color:#8be9fd;font-style:italic>true</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f https://github.com/solo-io/wasm/releases/latest/download/wasme-default.yaml
</span></span></code></pre></div><p>部署 bookinfo 案例</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl create ns bookinfo
</span></span><span style=display:flex><span>kubectl label namespace bookinfo istio-injection<span style=color:#ff79c6>=</span>enabled --overwrite
</span></span><span style=display:flex><span>kubectl apply -n bookinfo -f https://raw.githubusercontent.com/solo-io/wasm/master/tools/wasme/cli/test/e2e/operator/bookinfo.yaml
</span></span></code></pre></div><p>创建 filterdeployment 实例</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat <span style=color:#f1fa8c>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>apiVersion: wasme.io/v1
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>kind: FilterDeployment
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>metadata:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  name: bookinfo-custom-filter
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  namespace: bookinfo
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>spec:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  deployment:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    istio:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>      kind: Deployment
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  filter:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    config:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>      &#39;@type&#39;: type.googleapis.com/google.protobuf.StringValue
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>      value: world
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    image: webassemblyhub.io/sodman/istio-1-7:v0.3
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>EOF</span>
</span></span><span style=display:flex><span>kubectl get filterdeployments.wasme.io -n bookinfo -o yaml bookinfo-custom-filter
</span></span></code></pre></div><p>更新 filterdeployment 实例中 header 中的值</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat <span style=color:#f1fa8c>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>apiVersion: wasme.io/v1
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>kind: FilterDeployment
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>metadata:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  name: bookinfo-custom-filter
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  namespace: bookinfo
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>spec:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  deployment:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    istio:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>      kind: Deployment
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  filter:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    config:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>      &#39;@type&#39;: type.googleapis.com/google.protobuf.StringValue
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>      value: goodbye
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    image: webassemblyhub.io/sodman/istio-1-7:v0.3
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>EOF</span>
</span></span></code></pre></div><p>可以查看相应的 envoyfilter 值已经更改</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>apiVersion: networking.istio.io/v1alpha3
</span></span><span style=display:flex><span>kind: EnvoyFilter
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  creationTimestamp: <span style=color:#f1fa8c>&#34;2021-04-03T14:12:16Z&#34;</span>
</span></span><span style=display:flex><span>  generation: <span style=color:#bd93f9>2</span>
</span></span><span style=display:flex><span>  name: details-v1-bookinfo-custom-filter.bookinfo
</span></span><span style=display:flex><span>  namespace: bookinfo
</span></span><span style=display:flex><span>  ownerReferences:
</span></span><span style=display:flex><span>  - apiVersion: wasme.io/v1
</span></span><span style=display:flex><span>    blockOwnerDeletion: <span style=color:#8be9fd;font-style:italic>true</span>
</span></span><span style=display:flex><span>    controller: <span style=color:#8be9fd;font-style:italic>true</span>
</span></span><span style=display:flex><span>    kind: FilterDeployment
</span></span><span style=display:flex><span>    name: bookinfo-custom-filter
</span></span><span style=display:flex><span>    uid: 64f08103-3492-4e1b-a463-668e398204f6
</span></span><span style=display:flex><span>  resourceVersion: <span style=color:#f1fa8c>&#34;7768328&#34;</span>
</span></span><span style=display:flex><span>  selfLink: /apis/networking.istio.io/v1alpha3/namespaces/bookinfo/envoyfilters/details-v1-bookinfo-custom-filter.bookinfo
</span></span><span style=display:flex><span>  uid: c749b91c-02d6-491c-8314-b7f6faf02f8b
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  configPatches:
</span></span><span style=display:flex><span>  - applyTo: HTTP_FILTER
</span></span><span style=display:flex><span>    match:
</span></span><span style=display:flex><span>      context: SIDECAR_INBOUND
</span></span><span style=display:flex><span>      listener:
</span></span><span style=display:flex><span>        filterChain:
</span></span><span style=display:flex><span>          filter:
</span></span><span style=display:flex><span>            name: envoy.http_connection_manager
</span></span><span style=display:flex><span>            subFilter:
</span></span><span style=display:flex><span>              name: envoy.router
</span></span><span style=display:flex><span>    patch:
</span></span><span style=display:flex><span>      operation: INSERT_BEFORE
</span></span><span style=display:flex><span>      value:
</span></span><span style=display:flex><span>        name: envoy.filters.http.wasm
</span></span><span style=display:flex><span>        typedConfig:
</span></span><span style=display:flex><span>          <span style=color:#f1fa8c>&#39;@type&#39;</span>: type.googleapis.com/udpa.type.v1.TypedStruct
</span></span><span style=display:flex><span>          typeUrl: type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm
</span></span><span style=display:flex><span>          value:
</span></span><span style=display:flex><span>            config:
</span></span><span style=display:flex><span>              configuration:
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#39;@type&#39;</span>: type.googleapis.com/google.protobuf.StringValue
</span></span><span style=display:flex><span>                value: goodbye
</span></span><span style=display:flex><span>              name: bookinfo-custom-filter.bookinfo
</span></span><span style=display:flex><span>              rootId: add_header_root_id
</span></span><span style=display:flex><span>              vmConfig:
</span></span><span style=display:flex><span>                code:
</span></span><span style=display:flex><span>                  local:
</span></span><span style=display:flex><span>                    filename: /var/local/lib/wasme-cache/d2bc5bea58499684981fda875101ac18a69923cea4a4153958dad08065aa1e74
</span></span><span style=display:flex><span>                runtime: envoy.wasm.runtime.v8
</span></span><span style=display:flex><span>                vmId: bookinfo-custom-filter.bookinfo
</span></span><span style=display:flex><span>  workloadSelector:
</span></span><span style=display:flex><span>    labels:
</span></span><span style=display:flex><span>      app: details
</span></span><span style=display:flex><span>      version: v1
</span></span></code></pre></div><p>测试验证 header 是否有新增值，如下所示，我们在 response 中找到了 <code>hello: goodbye</code>。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl <span style=color:#8be9fd;font-style:italic>exec</span> -ti -n bookinfo deploy/productpage-v1 -c istio-proxy -- curl -v http://details.bookinfo:9080/details/123
</span></span><span style=display:flex><span>*   Trying 10.102.94.69...
</span></span><span style=display:flex><span>* TCP_NODELAY <span style=color:#8be9fd;font-style:italic>set</span>
</span></span><span style=display:flex><span>* Connected to details.bookinfo <span style=color:#ff79c6>(</span>10.102.94.69<span style=color:#ff79c6>)</span> port <span style=color:#bd93f9>9080</span> <span style=color:#ff79c6>(</span><span style=color:#6272a4>#0)</span>
</span></span><span style=display:flex><span>&gt; GET /details/123 HTTP/1.1
</span></span><span style=display:flex><span>&gt; Host: details.bookinfo:9080
</span></span><span style=display:flex><span>&gt; User-Agent: curl/7.58.0
</span></span><span style=display:flex><span>&gt; Accept: */*
</span></span><span style=display:flex><span>&gt; 
</span></span><span style=display:flex><span>&lt; HTTP/1.1 <span style=color:#bd93f9>200</span> OK
</span></span><span style=display:flex><span>&lt; content-type: application/json
</span></span><span style=display:flex><span>&lt; server: istio-envoy
</span></span><span style=display:flex><span>&lt; date: Sat, <span style=color:#bd93f9>03</span> Apr <span style=color:#bd93f9>2021</span> 14:49:32 GMT
</span></span><span style=display:flex><span>&lt; content-length: <span style=color:#bd93f9>180</span>
</span></span><span style=display:flex><span>&lt; x-envoy-upstream-service-time: <span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span>&lt; hello: goodbye
</span></span><span style=display:flex><span>&lt; location: envoy-wasm
</span></span><span style=display:flex><span>&lt; x-envoy-decorator-operation: details.bookinfo.svc.cluster.local:9080/*
</span></span><span style=display:flex><span>Connection <span style=color:#6272a4>#0 to host details.bookinfo left intact</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>{</span><span style=color:#f1fa8c>&#34;id&#34;</span>:123,<span style=color:#f1fa8c>&#34;author&#34;</span>:<span style=color:#f1fa8c>&#34;William Shakespeare&#34;</span>,<span style=color:#f1fa8c>&#34;year&#34;</span>:1595,<span style=color:#f1fa8c>&#34;type&#34;</span>:<span style=color:#f1fa8c>&#34;paperback&#34;</span>,<span style=color:#f1fa8c>&#34;pages&#34;</span>:200,<span style=color:#f1fa8c>&#34;publisher&#34;</span>:<span style=color:#f1fa8c>&#34;PublisherA&#34;</span>,<span style=color:#f1fa8c>&#34;language&#34;</span>:<span style=color:#f1fa8c>&#34;English&#34;</span>,<span style=color:#f1fa8c>&#34;ISBN-10&#34;</span>:<span style=color:#f1fa8c>&#34;1234567890&#34;</span>,<span style=color:#f1fa8c>&#34;ISBN-13&#34;</span>:<span style=color:#f1fa8c>&#34;123-1234567890&#34;</span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p><strong>FAQ</strong></p><p>如果在部署测试的过程中遇到了 pod 中的 istio-proxy 出现以下这种日志：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Internal:Error adding/updating listener<span style=color:#ff79c6>(</span>s<span style=color:#ff79c6>)</span> virtualInbound: Invalid path: /var/local/lib/wasme-cache/0295d929353976266ab721389ec859b2fe012d63ce2e58815469ab85c123b510
</span></span></code></pre></div><p>原因：可能是由于 /var/local/lib/wasme-cache/ 不存在这个文件。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>/var/local/lib/wasme-cache/
</span></span><span style=display:flex><span>├── 0295d929353976266ab721389ec859b2fe012d63ce2e58815469ab85c123b510
</span></span><span style=display:flex><span>└── a515a5d244b021c753f2e36c744e03a109cff6f5988e34714dbe725c904fa917
</span></span></code></pre></div><p>需要在 wasme 命名空间下删除 wasme pod ，这个应该是由于 <code>webassemblyhub.io/tanjunchen20/add-header:v0.1`` 镜像变更了 SHA，但是在 </code>/var/local/lib/wasme-cache/` 目录下没有生成相应的二进制文件导致的。</p><p><strong>总结</strong></p><p>通过使用 WebAssembly，可以在 Istio 数据平面中实现动态的、基于自定义逻辑的功能增强，提升灵活性、安全性和性能。</p><hr><ul class=pager><li class=previous><a href=/post/2020-11-30-istio-support-vm/ data-toggle=tooltip data-placement=top title="istio 1.8.0 支持 VM 虚拟机验证">&larr;
Previous Post</a></li><li class=next><a href=/post/2021-07-01-istio-1.9/ data-toggle=tooltip data-placement=top title="istio 1.9.0 解读报告 - day2 操作">Next
Post &rarr;</a></li></ul></div><div class="col-lg-2 col-lg-offset-0
visible-lg-block
sidebar-container
catalog-container"><div class=side-catalog><hr class="hidden-sm hidden-xs"><h5><a class=catalog-toggle href=#>CATALOG</a></h5><ul class=catalog-body></ul></div></div><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
sidebar-container"></div></div></div></article><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"><li><a href=mailto:tanjunchen20@gmail.com><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=/img/wechat.jpg><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-weixin fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://github.com/tanjunchen><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="copyright text-muted">Copyright &copy; 陈谭军 2023<br><a href=https://themes.gohugo.io/hugo-theme-cleanwhite>CleanWhite Hugo Theme</a> by <a href=https://github.com/tanjunchen>tanjunchen</a> |
<iframe style=margin-left:2px;margin-bottom:-5px frameborder=0 scrolling=0 width=100px height=20px src="https://ghbtns.com/github-btn.html?user=zhaohuabing&repo=hugo-theme-cleanwhite&type=star&count=true"></iframe></p></div></div></div></footer><script>function loadAsync(e,t){var s=document,o="script",n=s.createElement(o),i=s.getElementsByTagName(o)[0];n.src=e,t&&n.addEventListener("load",function(e){t(null,e)},!1),i.parentNode.insertBefore(n,i)}</script><script>$("#tag_cloud").length!==0&&loadAsync("/js/jquery.tagcloud.js",function(){$.fn.tagcloud.defaults={color:{start:"#bbbbee",end:"#0085a1"}},$("#tag_cloud a").tagcloud()})</script><script>loadAsync("https://cdn.jsdelivr.net/npm/fastclick@1.0.6/lib/fastclick.min.js",function(){var e=document.querySelector("nav");e&&FastClick.attach(e)})</script><script type=text/javascript>function generateCatalog(e){_containerSelector="div.post-container";var t,n,s,o,i,r=$(_containerSelector),a=r.find("h1,h2,h3,h4,h5,h6");return $(e).html(""),a.each(function(){n=$(this).prop("tagName").toLowerCase(),i="#"+$(this).prop("id"),s=$(this).text(),t=$('<a href="'+i+'" rel="nofollow">'+s+"</a>"),o=$('<li class="'+n+'_nav"></li>').append(t),$(e).append(o)}),!0}generateCatalog(".catalog-body"),$(".catalog-toggle").click(function(e){e.preventDefault(),$(".side-catalog").toggleClass("fold")}),loadAsync("/js/jquery.nav.js",function(){$(".catalog-body").onePageNav({currentClass:"active",changeHash:!1,easing:"swing",filter:"",scrollSpeed:700,scrollOffset:0,scrollThreshold:.2,begin:null,end:null,scrollChange:null,padding:80})})</script></body></html>