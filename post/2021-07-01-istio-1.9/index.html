<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:site_name" content="漫步远方，心荡神往"><meta property="og:type" content="article"><meta property="og:image" content="https://tanjunchen.github.io/img/home.webp"><meta property="twitter:image" content="https://tanjunchen.github.io/img/home.webp"><meta name=title content="istio 1.9.0 解读报告 - day2 操作"><meta property="og:title" content="istio 1.9.0 解读报告 - day2 操作"><meta property="twitter:title" content="istio 1.9.0 解读报告 - day2 操作"><meta name=description content="1.9.0 的重点在于改善用户在生产中运行Istio的day 2操作，改善用户使用istio的稳定性，确保Istio核心API与功能的稳定，使用户放心与安全地使用。"><meta property="og:description" content="1.9.0 的重点在于改善用户在生产中运行Istio的day 2操作，改善用户使用istio的稳定性，确保Istio核心API与功能的稳定，使用户放心与安全地使用。"><meta property="twitter:description" content="1.9.0 的重点在于改善用户在生产中运行Istio的day 2操作，改善用户使用istio的稳定性，确保Istio核心API与功能的稳定，使用户放心与安全地使用。"><meta property="twitter:card" content="summary"><meta name=keyword content="陈谭军, 互联网, 云原生, 容器, 微服务, Web, PaaS, Istio, Kubernetes, Microservice"><link rel="shortcut icon" href=/img/favicon.ico><title>istio 1.9.0 解读报告 - day2 操作 | 陈谭军的博客 | tanjunchen Blog</title><link rel=canonical href=/post/2021-07-01-istio-1.9/><link rel=stylesheet href=/css/bootstrap.min.css><link rel=stylesheet href=/css/hugo-theme-cleanwhite.min.css><link rel=stylesheet href=/css/zanshang.css><link rel=stylesheet href=/css/font-awesome.all.min.css><script src=/js/jquery.min.js></script>
<script src=/js/bootstrap.min.js></script>
<script src=/js/hux-blog.min.js></script>
<script src=/js/lazysizes.min.js></script></head><nav class="navbar navbar-default navbar-custom navbar-fixed-top"><div class=container-fluid><div class="navbar-header page-scroll"><button type=button class=navbar-toggle>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span></button>
<a class=navbar-brand href=/>漫步远方，心荡神往</a></div><div id=huxblog_navbar><div class=navbar-collapse><ul class="nav navbar-nav navbar-right"><li><a href=/>All Posts</a></li><li><a href=/categories/technology/>technology</a></li><li><a href=/categories/think/>think</a></li><li><a href=/learning/>LEARNING</a></li><li><a href=/archive/>ARCHIVE</a></li><li><a href=/about/>ABOUT</a></li><li><a href=/search><i class="fa fa-search"></i></a></li></ul></div></div></div></nav><script>var $body=document.body,$toggle=document.querySelector(".navbar-toggle"),$navbar=document.querySelector("#huxblog_navbar"),$collapse=document.querySelector(".navbar-collapse");$toggle.addEventListener("click",handleMagic);function handleMagic(){$navbar.className.indexOf("in")>0?($navbar.className=" ",setTimeout(function(){$navbar.className.indexOf("in")<0&&($collapse.style.height="0px")},400)):($collapse.style.height="auto",$navbar.className+=" in")}</script><style type=text/css>header.intro-header{background-image:url(/img/home.webp)}</style><header class=intro-header><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><div class=tags><a class=tag href=/tags/istio title=istio>istio</a></div><h1>istio 1.9.0 解读报告 - day2 操作</h1><h2 class=subheading></h2><span class=meta>Posted by
陈谭军
on
Thursday, July 1, 2021
<span id=busuanzi_container_page_pv>|<span id=busuanzi_value_page_pv></span><span>
<span id=/post/2021-07-01-istio-1.9/ class="leancloud_visitors meta_data_item" data-flag-title><span class=post-meta-item-icon><span class="octicon octicon-eye"></span></span>
<i class="fa fa-eye"></i>
<span class=old-visitors-count style=display:none></span>
<span class=leancloud-visitors-count></span></span>
<script src=https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js></script>
<script>AV.initialize("","")</script><script type=text/javascript>function showTime(e){var n=new AV.Query(e),t=[],s=$(".leancloud_visitors");s.each(function(){t.push($(this).attr("id").trim())}),n.containedIn("url",t),n.find().done(function(e){for(var s,o,i,a,r,c,l=".leancloud-visitors-count",d=".old-visitors-count",n=0;n<e.length;n++)a=e[n],i=a.get("url"),c=a.get("time"),s=document.getElementById(i),$(s).find(l).text(c);for(n=0;n<t.length;n++)i=t[n],s=document.getElementById(i),o=$(s).find(l),o.text()==""&&(r=$(s).find(d).text(),r!=""?o.text(0+parseInt(r)):o.text(0))}).fail(function(e,t){console.log("Error: "+t.code+" "+t.message)})}function addCount(e){var n=$(".leancloud_visitors"),t=n.attr("id").trim(),o=n.attr("data-flag-title").trim(),s=new AV.Query(e);s.equalTo("url",t),s.find({success:function(n){if(n.length>0){var s,i,r,c,l,a=n[0];a.fetchWhenSave(!0),a.increment("time"),a.save(null,{success:function(e){var n=$(document.getElementById(t));n.find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to save Visitor num, with error message: "+t.message)}})}else s=new e,i=new AV.ACL,i.setPublicReadAccess(!0),i.setPublicWriteAccess(!0),s.setACL(i),s.set("title",o),s.set("url",t),c=".old-visitors-count",l=$(document.getElementById(t)),r=l.find(c).text(),r!=""?s.set("time",parseInt(r)+1):s.set("time",1),s.save(null,{success:function(e){var n=$(document.getElementById(t));n.find(".leancloud-visitors-count").text(e.get("time"))},error:function(){console.log("Failed to create")}})},error:function(e){console.log("Error:"+e.code+" "+e.message)}})}$(function(){var e=AV.Object.extend("Counter");$(".leancloud_visitors").length==1?addCount(e):showTime(e)})</script>阅读 </span></span>|<span class=post-date>共 2675 字</span>，阅读约 <span class=more-meta>6 分钟</span></span></div></div></div></div></header><article><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
post-container"><p>1.9.0 的重点在于改善用户在生产中运行Istio的day 2操作，改善用户使用istio的稳定性，确保Istio核心API与功能的稳定，使用户放心与安全地使用。</p><h1 id=istio-190-解读报告---day2-操作>istio 1.9.0 解读报告 - day2 操作</h1><h2 id=虚拟机服务>虚拟机服务</h2><p>虚拟机服务提升到 Beta 版本。虚拟机中的工作负载进一步成为Istio服务网格的一部分，能够应用一致的策略，并跨容器和虚拟机收集遥测数据。VM集成的稳定性、测试和文档得到进一步的完善与支持。虚拟机的架构请参考：https://istio.io/latest/docs/ops/deployment/vm-architecture/。</p><h2 id=请求分类request-classification>请求分类(Request Classification)</h2><p>服务的监控、请求分类上升为 Beta 版本。通过 EnvoyFilter 进一步细化mesh调用的请求与响应的相关指标，此功能使用户可以更精确地了解和监视其服务网格中的流量。</p><h2 id=kubernetes-service-api-支持>Kubernetes Service API 支持</h2><p>Kubernetes Service API 的支持提升到 Alpha 版本。
详情可见 <a href=https://istio.io/latest/docs/tasks/traffic-management/ingress/service-apis/>https://istio.io/latest/docs/tasks/traffic-management/ingress/service-apis/</a></p><h2 id=与外部授权系统集成>与外部授权系统集成</h2><p>授权策略现在支持 CUSTOM 动作的实验性功能，允许用户更容易地与外部授权系统（如 OPA、OAuth2 等）集成。</p><h2 id=远程获取和加载webassemblywasm-http-filter实验性>远程获取和加载WebAssembly(Wasm) HTTP Filter(实验性)</h2><p>现在，Istio支持一项实验功能，可以从远程仓库中获取WebAssembly模块并动态(重新)加载它们，而无需重新启动服务网格中的代理。可以将自定义C++ 代码注入到服务网格中处理Istio API之外的使用场景。</p><h2 id=镜像-gcrio-上的-image>镜像 gcr.io 上的 image</h2><p>为了防止用户受到 Docker Hub 限速政策的影响，我们现在将所有的镜像发布在gcr.io/istio-release上。我们在安装步骤中选择性地将hub设置为 gcr.io/istio-release，以绕过与Docker hub下载镜像失败相关的问题。请注意，Docker hub仍然是Istio安装的默认 hub。</p><h2 id=istioctl-命令行工具>istioctl 命令行工具</h2><p>新增加的verify-install命令，告知用户是否存在安装配置错误。analyze 子命令可以检查是否使用了不建议使用的注释或Alpha级别的注释。</p><h2 id=总结>总结</h2><p>istio 1.9.0 istiocoredns 已被废弃。</p><h2 id=对比>对比</h2><table><thead><tr><th>功能</th><th>Istio 1.8.1</th><th>Istio 1.9.0</th></tr></thead><tbody><tr><td>安装</td><td>1. 提升外部控制面安装提升到 alpha 功能</br>2. 升级 kiali 到1.26</br>3. 修改 sidecar 注入 securityPolicy.fsGroup(Kubernetes 1.19+支持)</br>4. 弃用 values.global.meshExpansion.enabled(VM 使用)，转而使用 values.gateways.istio-ingressgateway.meshExpansionPorts。</br>5. 弃用 istioctl 安装第三方遥测功能。Prometheus、 Grafana、Zipkin、Jaeger、Kiali</td><td>1. 在 istioctl 安装或 istioctl 升级中使用 &ndash;verify 选项。增加了控制平面运行状况的安装后/就地升级验证。</br>2. 添加 pprof 端点到 pilot-agent。</br>3. base 中添加了 enableIstioConfigCRD 参数，使用户确认是否安装某个 Istio CRD。</br>4. 添加 Istio 1.9 支持 Kubernetes 版本 1.17 至 1.20 版本说明。</br>5. 增加了对通过 Sidecar API 绑定到其 pod IP 地址而不是通配符或本地主机地址的应用程序的支持。</br>6. 当显式指定 hpa 的 helm 值时，修复 HPA 不生效的 bug。</br>7. 增强了 sidecar 注入，以便更好地利用 pod label 来确定是否需要 sidecar 注入。在此版本中，默认情况下未启用此功能，但可以使用 &ndash;set values.sidecarInjectorWebhook.useLegacySelectors=false 进行测试。</br>8. 将 Kiali 组件升级为最新版本 v1.29。</td></tr><tr><td>流量管理</td><td>1. 在 istio-agent中默认为VM新增DNS 嗅探，istioctl x workload entry configure</br>2. 为了指定Envoy配置的HTTP_ROUTE规范的顺序，新的INSERT_FIRST，INSERT_BEFORE，INSERT_AFTER操作已添加到EnvoyFilter API。为了能够覆盖HTTP和网络过滤器，在EnvoyFilter API中添加了新的REPLACE操作。</br>3. 新增Istio resource 资源状态</br>4. 当Node节点具有多个IP地址（例如，扩展场景中的VM）时，Istio Proxy现在会将inbound listener绑定到列表中的第一个适用地址（新行为），而不是最后一个（以前的行为）</br>5. 网关从Istiod获取证书。如果必要可以设置 ISTIOD_ENABLE_SDS_SERVER=false</td><td>1. 已将添加 pprof端点添加到pilot-agent。</br>2. 添加了允许使用–log_output_level启用gRPC日志记录。</br>3. 添加了新的实验性代理选项DNS_AUTO_ALLOCATE，以控制ServiceEntry地址的自动分配。以前，此选项绑定到DNS_CAPTURE。现在，无需启用自动分配即可启用DNS_CAPTURE。有关更多信息，请参见智能DNS代理。</br>4. 如果网关Pod没有足够的权限，则固定istiod将不再为特权网关端口（&lt;1024）生成侦听器。修复了很多的ServiceEntries导致占用大量内存的问题。删除了通过 MCP读取Istio配置的支持。</td></tr><tr><td>安全</td><td>1. 基于请求的原始源IP地址来允许/拒绝请求使用X-Forwarded-For或代理协议请更新AuthorizationPolicy资源以使用新的 remoteIpBlocks/notRemoteIpBlocks</br>2. AuthorizationPolicy 支持嵌套的jwt 功能、AUDIT 审计功能。备注：不用使用 remoteIpBlocks、remote_ip(对于非http协议),等待新的release发布。</td><td>1. 添加了选项，以允许用户为其XDS流启用令牌交换，该交换将k8s令牌交换为可以由其XDS服务器进行身份验证的令牌.</br>2. 添加了同时支持JWKS-URI和OIDC发现的OIDC JWT身份验证器。 通过JWT_RULE env变量配置时，将使用OIDC JWT身份验证器。</br>3. 通过过滤器链增加了对PeerAuthentication端口级别配置的支持。</br>4. 在AuthorizationPolicy中添加了实验性的CUSTOM操作，以与外部授权系统（如OPA，OAuth2等）集成。</td></tr><tr><td>遥测</td><td>1. Control Plane Dashboard 和 Performance Dashboard使用 container_memory_working_set_bytes 指标可视化内存</br>2. 对于Grafana 新增 datasource 参数</br>3. 当Envoy中设置了ResponseFlag，新增Listener Access Logs</br>4. 新增对OpenCensusAgent格式的 Trace Export的支持，并带有可配置的跟踪上下文Header</br>5. 新增代理配置用于控制Envoy统计信息的生成</br>6. 对于 Grafana新增 Istio Wasm Extension</br>7. 对于 prometheus新增proxy grpcistio_request_messages_total、istio_response_messages_total 指标</br>8. 正式已移除Mixer 相关特性与功能</td><td>1. 在Envoy生成的跟踪范围中添加了规范服务标签</br>2. 更新了Prometheus指标，默认情况下所有方案都包括source_cluster和destination_cluster标签</br>3. 更新了默认访问日志，包括代理版本> = 1.9的RESPONSE_CODE_DETAILS和CONNECTION_TERMINATION_DETAILS</td></tr><tr><td>数据面拓展性</td><td>Wasm</td><td>使用IstioAgent添加了可靠的Wasm模块远程加载方式。</td></tr></tbody></table><hr><ul class=pager><li class=previous><a href=/post/2021-05-01-istio-solo-io-wasm/ data-toggle=tooltip data-placement=top title="使用 wasm 拓展 istio-proxy 数据面">&larr;
Previous Post</a></li><li class=next><a href=/post/2021-11-22-os-something/ data-toggle=tooltip data-placement=top title=科普操作系统与芯片那些事儿>Next
Post &rarr;</a></li></ul></div><div class="col-lg-2 col-lg-offset-0
visible-lg-block
sidebar-container
catalog-container"><div class=side-catalog><hr class="hidden-sm hidden-xs"><h5><a class=catalog-toggle href=#>CATALOG</a></h5><ul class=catalog-body></ul></div></div><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
sidebar-container"></div></div></div></article><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"><li><a href=mailto:tanjunchen20@gmail.com><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=/img/wechat.jpg><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-weixin fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://github.com/tanjunchen><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="copyright text-muted">Copyright &copy; 陈谭军 2023<br><a href=https://themes.gohugo.io/hugo-theme-cleanwhite>CleanWhite Hugo Theme</a> by <a href=https://github.com/tanjunchen>tanjunchen</a></p></div></div></div></footer><script>function loadAsync(e,t){var s=document,o="script",n=s.createElement(o),i=s.getElementsByTagName(o)[0];n.src=e,t&&n.addEventListener("load",function(e){t(null,e)},!1),i.parentNode.insertBefore(n,i)}</script><script>$("#tag_cloud").length!==0&&loadAsync("/js/jquery.tagcloud.js",function(){$.fn.tagcloud.defaults={color:{start:"#bbbbee",end:"#0085a1"}},$("#tag_cloud a").tagcloud()})</script><script>loadAsync("https://cdn.jsdelivr.net/npm/fastclick@1.0.6/lib/fastclick.min.js",function(){var e=document.querySelector("nav");e&&FastClick.attach(e)})</script><script type=text/javascript>function generateCatalog(e){_containerSelector="div.post-container";var t,n,s,o,i,r=$(_containerSelector),a=r.find("h1,h2,h3,h4,h5,h6");return $(e).html(""),a.each(function(){n=$(this).prop("tagName").toLowerCase(),i="#"+$(this).prop("id"),s=$(this).text(),t=$('<a href="'+i+'" rel="nofollow">'+s+"</a>"),o=$('<li class="'+n+'_nav"></li>').append(t),$(e).append(o)}),!0}generateCatalog(".catalog-body"),$(".catalog-toggle").click(function(e){e.preventDefault(),$(".side-catalog").toggleClass("fold")}),loadAsync("/js/jquery.nav.js",function(){$(".catalog-body").onePageNav({currentClass:"active",changeHash:!1,easing:"swing",filter:"",scrollSpeed:700,scrollOffset:0,scrollThreshold:.2,begin:null,end:null,scrollChange:null,padding:80})})</script></body></html>