<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:site_name" content="漫步远方，心荡神往"><meta property="og:type" content="article"><meta property="og:image" content="https://tanjunchen.github.io/img/home.webp"><meta property="twitter:image" content="https://tanjunchen.github.io/img/home.webp"><meta name=title content="编译与构建 istio-1.6.14 镜像"><meta property="og:title" content="编译与构建 istio-1.6.14 镜像"><meta property="twitter:title" content="编译与构建 istio-1.6.14 镜像"><meta name=description content="根据 istio 文档可知，编译 istio 源码分为两种方式，一种是直接在 linux 机器上编译源码，另外一种是通过 docker 镜像包编译。"><meta property="og:description" content="根据 istio 文档可知，编译 istio 源码分为两种方式，一种是直接在 linux 机器上编译源码，另外一种是通过 docker 镜像包编译。"><meta property="twitter:description" content="根据 istio 文档可知，编译 istio 源码分为两种方式，一种是直接在 linux 机器上编译源码，另外一种是通过 docker 镜像包编译。"><meta property="twitter:card" content="summary"><meta name=keyword content="陈谭军, 互联网, 云原生, 容器, 微服务, Web, PaaS, Istio, Kubernetes, Microservice"><link rel="shortcut icon" href=/img/favicon.ico><title>编译与构建 istio-1.6.14 镜像 | 陈谭军的博客 | tanjunchen Blog</title><link rel=canonical href=/post/2020-05-01-istio-1.6-compile/><link rel=stylesheet href=/css/bootstrap.min.css><link rel=stylesheet href=/css/hugo-theme-cleanwhite.min.css><link rel=stylesheet href=/css/zanshang.css><link rel=stylesheet href=/css/font-awesome.all.min.css><script src=/js/jquery.min.js></script>
<script src=/js/bootstrap.min.js></script>
<script src=/js/hux-blog.min.js></script>
<script src=/js/lazysizes.min.js></script></head><nav class="navbar navbar-default navbar-custom navbar-fixed-top"><div class=container-fluid><div class="navbar-header page-scroll"><button type=button class=navbar-toggle>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span></button>
<a class=navbar-brand href=/>漫步远方，心荡神往</a></div><div id=huxblog_navbar><div class=navbar-collapse><ul class="nav navbar-nav navbar-right"><li><a href=/>All Posts</a></li><li><a href=/categories/technology/>technology</a></li><li><a href=/categories/think/>think</a></li><li><a href=/learning/>LEARNING</a></li><li><a href=/archive/>ARCHIVE</a></li><li><a href=/about/>ABOUT</a></li><li><a href=/search><i class="fa fa-search"></i></a></li></ul></div></div></div></nav><script>var $body=document.body,$toggle=document.querySelector(".navbar-toggle"),$navbar=document.querySelector("#huxblog_navbar"),$collapse=document.querySelector(".navbar-collapse");$toggle.addEventListener("click",handleMagic);function handleMagic(){$navbar.className.indexOf("in")>0?($navbar.className=" ",setTimeout(function(){$navbar.className.indexOf("in")<0&&($collapse.style.height="0px")},400)):($collapse.style.height="auto",$navbar.className+=" in")}</script><style type=text/css>header.intro-header{background-image:url(/img/home.webp)}</style><header class=intro-header><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><div class=tags><a class=tag href=/tags/istio title=istio>istio</a></div><h1>编译与构建 istio-1.6.14 镜像</h1><h2 class=subheading></h2><span class=meta>Posted by
陈谭军
on
Friday, May 1, 2020
<span id=busuanzi_container_page_pv>|<span id=busuanzi_value_page_pv></span><span>
<span id=/post/2020-05-01-istio-1.6-compile/ class="leancloud_visitors meta_data_item" data-flag-title><span class=post-meta-item-icon><span class="octicon octicon-eye"></span></span>
<i class="fa fa-eye"></i>
<span class=old-visitors-count style=display:none></span>
<span class=leancloud-visitors-count></span></span>
<script src=https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js></script>
<script>AV.initialize("","")</script><script type=text/javascript>function showTime(e){var n=new AV.Query(e),t=[],s=$(".leancloud_visitors");s.each(function(){t.push($(this).attr("id").trim())}),n.containedIn("url",t),n.find().done(function(e){for(var s,o,i,a,r,c,l=".leancloud-visitors-count",d=".old-visitors-count",n=0;n<e.length;n++)a=e[n],i=a.get("url"),c=a.get("time"),s=document.getElementById(i),$(s).find(l).text(c);for(n=0;n<t.length;n++)i=t[n],s=document.getElementById(i),o=$(s).find(l),o.text()==""&&(r=$(s).find(d).text(),r!=""?o.text(0+parseInt(r)):o.text(0))}).fail(function(e,t){console.log("Error: "+t.code+" "+t.message)})}function addCount(e){var n=$(".leancloud_visitors"),t=n.attr("id").trim(),o=n.attr("data-flag-title").trim(),s=new AV.Query(e);s.equalTo("url",t),s.find({success:function(n){if(n.length>0){var s,i,r,c,l,a=n[0];a.fetchWhenSave(!0),a.increment("time"),a.save(null,{success:function(e){var n=$(document.getElementById(t));n.find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to save Visitor num, with error message: "+t.message)}})}else s=new e,i=new AV.ACL,i.setPublicReadAccess(!0),i.setPublicWriteAccess(!0),s.setACL(i),s.set("title",o),s.set("url",t),c=".old-visitors-count",l=$(document.getElementById(t)),r=l.find(c).text(),r!=""?s.set("time",parseInt(r)+1):s.set("time",1),s.save(null,{success:function(e){var n=$(document.getElementById(t));n.find(".leancloud-visitors-count").text(e.get("time"))},error:function(){console.log("Failed to create")}})},error:function(e){console.log("Error:"+e.code+" "+e.message)}})}$(function(){var e=AV.Object.extend("Counter");$(".leancloud_visitors").length==1?addCount(e):showTime(e)})</script>阅读 </span></span>|<span class=post-date>共 2089 字</span>，阅读约 <span class=more-meta>5 分钟</span></span></div></div></div></div></header><article><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
post-container"><p>根据 <a href=https://github.com/istio/istio/wiki/Preparing-for-Development>istio 文档</a> 可知，编译 istio 源码分为两种方式，一种是直接在 linux 机器上编译源码，另外一种是通过 docker 镜像工具包编译与构建。</p><p><strong>编译 istio 1.6.14 centos 7 rpm 依赖包</strong></p><p>istio 1.6.x 系列版本是没有提供 centos 7 物理机的 envoy rpm 依赖包的，我们通过编译 istio 源码来产生 1.6.14 版本的 rpm 依赖包。在 <code>/root/go/src/istio.io</code> 上克隆 istio 镜像仓库 <code>git clone https://github.com/istio/istio.git && cd istio</code>，切换到 1.6.14 分支，<code>git checkout -b 1.6.14 1.6.14</code>。</p><p><em>备注：尽量最好请先自行解决网络问题，解决翻墙问题，需要下载镜像 <code>gcr.io/istio-testing/build-tools:release-1.6-2020-11-13T15-30-50</code></em></p><p>执行 <code>make VERSION=1.6.14 rpm/builder-image</code>，如果编译镜像出现以下错误，目前是注释了 <code>tools/packaging/rpm/Dockerfile.build</code> 中的 <code>/usr/bin/ninja-build /usr/bin/ninja</code> 软链接操作即可。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Step 5/11 : RUN curl -o /usr/local/bin/bazel -L https://github.com/bazelbuild/bazelisk/releases/download/v1.1.0/bazelisk-linux-amd64 <span style=color:#ff79c6>&amp;&amp;</span> chmod +x /usr/local/bin/bazel
</span></span><span style=display:flex><span>---&gt; Using cache
</span></span><span style=display:flex><span>---&gt; e59b3bc8b8ca
</span></span><span style=display:flex><span>Step 6/11 : RUN ln -s /usr/bin/cmake3 /usr/bin/cmake <span style=color:#ff79c6>&amp;&amp;</span> ln -s /usr/bin/ninja-build /usr/bin/ninja
</span></span><span style=display:flex><span>---&gt; Running in c46f7d52d3f5
</span></span><span style=display:flex><span>ln: failed to create symbolic link <span style=color:#f1fa8c>&#39;/usr/bin/ninja&#39;</span>: File exists
</span></span><span style=display:flex><span>The <span style=color:#8be9fd;font-style:italic>command</span> <span style=color:#f1fa8c>&#39;/bin/sh -c ln -s /usr/bin/cmake3 /usr/bin/cmake &amp;&amp; ln -s /usr/bin/ninja-build /usr/bin/ninja&#39;</span> returned a non-zero code: <span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span>tools/packaging/rpm/rpm.mk:32: recipe <span style=color:#ff79c6>for</span> target <span style=color:#f1fa8c>&#39;rpm/builder-image&#39;</span> failed
</span></span><span style=display:flex><span>make<span style=color:#ff79c6>[</span>1<span style=color:#ff79c6>]</span>: *** <span style=color:#ff79c6>[</span>rpm/builder-image<span style=color:#ff79c6>]</span> Error <span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span>make: *** <span style=color:#ff79c6>[</span>Makefile:46: rpm/builder-image<span style=color:#ff79c6>]</span> Error <span style=color:#bd93f9>2</span>
</span></span></code></pre></div><p>编译镜像成功，如下所示：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ff79c6>[</span>root@mesh-10-20-11-190 istio<span style=color:#ff79c6>]</span><span style=color:#6272a4># make VERSION=1.6.14 rpm/builder-image</span>
</span></span><span style=display:flex><span>docker build -t istio-rpm-builder -f /work/tools/packaging/rpm/Dockerfile.build /work/tools/packaging/rpm
</span></span><span style=display:flex><span>Sending build context to Docker daemon  27.14kB
</span></span><span style=display:flex><span>Step 1/11 : FROM centos:7
</span></span><span style=display:flex><span> ---&gt; 8652b9f0cb4c
</span></span><span style=display:flex><span>Step 2/11 : RUN yum install -y centos-release-scl epel-release <span style=color:#ff79c6>&amp;&amp;</span>     yum update -y <span style=color:#ff79c6>&amp;&amp;</span>     yum install -y fedpkg sudo devtoolset-7-gcc devtoolset-7-gcc-c++                    devtoolset-7-binutils java-1.8.0-openjdk-headless rsync                    rh-git218 wget unzip which make cmake3 patch ninja-build                    devtoolset-7-libatomic-devel openssl python27 libtool autoconf <span style=color:#ff79c6>&amp;&amp;</span>     yum clean all
</span></span><span style=display:flex><span> ---&gt; Using cache
</span></span><span style=display:flex><span> ---&gt; 8fb1d6dd0c17
</span></span><span style=display:flex><span>Step 3/11 : RUN curl -o /root/go.tar.gz https://dl.google.com/go/go1.13.4.linux-amd64.tar.gz <span style=color:#ff79c6>&amp;&amp;</span>     tar zxf /root/go.tar.gz -C /usr/local
</span></span><span style=display:flex><span> ---&gt; Using cache
</span></span><span style=display:flex><span> ---&gt; a27dac7c7d03
</span></span><span style=display:flex><span>Step 4/11 : ENV <span style=color:#8be9fd;font-style:italic>GOROOT</span><span style=color:#ff79c6>=</span>/usr/local/go     <span style=color:#8be9fd;font-style:italic>PATH</span><span style=color:#ff79c6>=</span>/usr/local/go/bin:/opt/rh/rh-git218/root/usr/bin:/opt/rh/devtoolset-7/root/usr/bin:/opt/llvm/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>PATH</span><span style=color:#f1fa8c>}</span>
</span></span><span style=display:flex><span> ---&gt; Using cache
</span></span><span style=display:flex><span> ---&gt; 34db8194bcaa
</span></span><span style=display:flex><span>Step 5/11 : RUN curl -o /usr/local/bin/bazel -L https://github.com/bazelbuild/bazelisk/releases/download/v1.1.0/bazelisk-linux-amd64 <span style=color:#ff79c6>&amp;&amp;</span>     chmod +x /usr/local/bin/bazel
</span></span><span style=display:flex><span> ---&gt; Using cache
</span></span><span style=display:flex><span> ---&gt; e59b3bc8b8ca
</span></span><span style=display:flex><span>Step 6/11 : RUN ln -s /usr/bin/cmake3 /usr/bin/cmake
</span></span><span style=display:flex><span> ---&gt; Using cache
</span></span><span style=display:flex><span> ---&gt; 88a0535d8d22
</span></span><span style=display:flex><span>Step 7/11 : RUN <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;/opt/rh/httpd24/root/usr/lib64&#34;</span> &gt; /etc/ld.so.conf.d/httpd24.conf <span style=color:#ff79c6>&amp;&amp;</span>     ldconfig
</span></span><span style=display:flex><span> ---&gt; Using cache
</span></span><span style=display:flex><span> ---&gt; 05ec9f46546b
</span></span><span style=display:flex><span>Step 8/11 : ENV <span style=color:#8be9fd;font-style:italic>LLVM_VERSION</span><span style=color:#ff79c6>=</span>9.0.0
</span></span><span style=display:flex><span> ---&gt; Using cache
</span></span><span style=display:flex><span> ---&gt; 4b2748bd32c5
</span></span><span style=display:flex><span>Step 9/11 : ENV <span style=color:#8be9fd;font-style:italic>LLVM_DISTRO</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;x86_64-linux-sles11.3&#34;</span>
</span></span><span style=display:flex><span> ---&gt; Using cache
</span></span><span style=display:flex><span> ---&gt; ab821fe0a7d6
</span></span><span style=display:flex><span>Step 10/11 : ENV <span style=color:#8be9fd;font-style:italic>LLVM_RELEASE</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;clang+llvm-</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>LLVM_VERSION</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>-</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>LLVM_DISTRO</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span> ---&gt; Using cache
</span></span><span style=display:flex><span> ---&gt; 8b092c276236
</span></span><span style=display:flex><span>Step 11/11 : RUN curl -fsSL --output <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>LLVM_RELEASE</span><span style=color:#f1fa8c>}</span>.tar.xz https://releases.llvm.org/<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>LLVM_VERSION</span><span style=color:#f1fa8c>}</span>/<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>LLVM_RELEASE</span><span style=color:#f1fa8c>}</span>.tar.xz <span style=color:#ff79c6>&amp;&amp;</span>     tar Jxf <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>LLVM_RELEASE</span><span style=color:#f1fa8c>}</span>.tar.xz <span style=color:#ff79c6>&amp;&amp;</span>     mv ./<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>LLVM_RELEASE</span><span style=color:#f1fa8c>}</span> /opt/llvm <span style=color:#ff79c6>&amp;&amp;</span>     chown -R root:root /opt/llvm <span style=color:#ff79c6>&amp;&amp;</span>     rm ./<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>LLVM_RELEASE</span><span style=color:#f1fa8c>}</span>.tar.xz <span style=color:#ff79c6>&amp;&amp;</span>     <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;/opt/llvm/lib&#34;</span> &gt; /etc/ld.so.conf.d/llvm.conf <span style=color:#ff79c6>&amp;&amp;</span>     ldconfig
</span></span><span style=display:flex><span> ---&gt; Running in 266cf6894400
</span></span><span style=display:flex><span>/usr/bin/ninja-build /usr/bin/ninjaRemoving intermediate container 266cf6894400
</span></span><span style=display:flex><span> ---&gt; 5a26ceb0e73d
</span></span><span style=display:flex><span>Successfully built 5a26ceb0e73d
</span></span><span style=display:flex><span>Successfully tagged istio-rpm-builder:latest
</span></span></code></pre></div><p>执行 <code>make VERSION=1.6.14 rpm/proxy</code>，执行命令的过程中，如果出现以下错误：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run --rm -it <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>        -v /go:/go <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>			-w /builder <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>        -e <span style=color:#8be9fd;font-style:italic>USER</span><span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>			-e <span style=color:#8be9fd;font-style:italic>ISTIO_ENVOY_VERSION</span><span style=color:#ff79c6>=</span>1ef6cb53abbb057185f4bcb60e28cf92c3a174ad <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>			-e <span style=color:#8be9fd;font-style:italic>ISTIO_GO</span><span style=color:#ff79c6>=</span>/work <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>			-e <span style=color:#8be9fd;font-style:italic>ISTIO_OUT</span><span style=color:#ff79c6>=</span>/work/out/linux_amd64 <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>			-e <span style=color:#8be9fd;font-style:italic>PACKAGE_VERSION</span><span style=color:#ff79c6>=</span>1.6.14 <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>			-e <span style=color:#8be9fd;font-style:italic>USER_ID</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>0</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>			-e <span style=color:#8be9fd;font-style:italic>GROUP_ID</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>994</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>			istio-rpm-builder <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>			/work/tools/packaging/rpm/build-proxy-rpm.sh
</span></span><span style=display:flex><span>docker: Error response from daemon: OCI runtime create failed: container_linux.go:367: starting container process caused: exec: <span style=color:#f1fa8c>&#34;/work/tools/packaging/rpm/build-proxy-rpm.sh&#34;</span>: stat /work/tools/packaging/rpm/build-proxy-rpm.sh: no such file or directory: unknown.
</span></span><span style=display:flex><span>ERRO<span style=color:#ff79c6>[</span>0003<span style=color:#ff79c6>]</span> error waiting <span style=color:#ff79c6>for</span> container: context canceled 
</span></span><span style=display:flex><span>tools/packaging/rpm/rpm.mk:18: recipe <span style=color:#ff79c6>for</span> target <span style=color:#f1fa8c>&#39;rpm/proxy&#39;</span> failed
</span></span></code></pre></div><p>需要更改 <code>tools/packaging/rpm/rpm.mk</code> 下的 docker 运行命令，将 <code>-v /root/go/src/istio.io/istio:/work</code> 挂载在容器中即可。需要注意的是挂载的目录需要与 istio 项目所在的文件夹的位置一致。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>rpm/proxy:
</span></span><span style=display:flex><span>	docker run --rm -it <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>        -v <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>GO_TOP</span><span style=color:#f1fa8c>}</span>:<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>GO_TOP</span><span style=color:#f1fa8c>}</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>        -v /root/go/src/istio.io/istio:/work <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>				-w /builder <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>        -e <span style=color:#8be9fd;font-style:italic>USER</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>USER</span><span style=color:#f1fa8c>}</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>				-e <span style=color:#8be9fd;font-style:italic>ISTIO_ENVOY_VERSION</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>ISTIO_ENVOY_VERSION</span><span style=color:#f1fa8c>}</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>				-e <span style=color:#8be9fd;font-style:italic>ISTIO_GO</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>ISTIO_GO</span><span style=color:#f1fa8c>}</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>				-e <span style=color:#8be9fd;font-style:italic>ISTIO_OUT</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>ISTIO_OUT</span><span style=color:#f1fa8c>}</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>				-e <span style=color:#8be9fd;font-style:italic>PACKAGE_VERSION</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>PACKAGE_VERSION</span><span style=color:#f1fa8c>}</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>				-e <span style=color:#8be9fd;font-style:italic>USER_ID</span><span style=color:#ff79c6>=</span><span style=color:#ff79c6>$(</span>shell id -u<span style=color:#ff79c6>)</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>				-e <span style=color:#8be9fd;font-style:italic>GROUP_ID</span><span style=color:#ff79c6>=</span><span style=color:#ff79c6>$(</span>shell id -g<span style=color:#ff79c6>)</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>				istio-rpm-builder <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>				<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>PWD</span><span style=color:#f1fa8c>}</span>/tools/packaging/rpm/build-proxy-rpm.sh
</span></span></code></pre></div><p>如果 istio/proxy 仓库克隆不下来，则可以执行以下操作。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#6272a4>#git clone  https://github.com/istio/proxy.git istio-proxy</span>
</span></span><span style=display:flex><span>git clone  https://github.com.cnpmjs.org/istio/proxy.git istio-proxy
</span></span></code></pre></div><p>等待上述过程即可，编译的过程耗时较长，推荐使用 8c16G(包含以及以上) 的机器配置，可能耗费数小时。你可以使用 top 命令查看，物理机器 8c cpu 接近全部被打满。在 <code>out/linux_amd64/rpm</code> 目录下会生成 <code>istio-proxy-1.6.14-1.el7.x86_64 rpm</code> 依赖包。</p><p><strong>编译 istio 镜像并推送到自己的私有仓库</strong></p><p>在 <code>/root/go/src/istio.io</code> 上克隆 istio 镜像仓库，<code>git clone https://github.com/istio/istio.git && cd istio</code>，</p><pre tabindex=0><code>export USER=&#34;tanjunchen&#34;
export HUB=&#34;registry.cn-hangzhou.aliyuncs.com/$USER&#34;
export TAG=&#34;dev-tanjunchen&#34;
</code></pre><p>需要自行登录私有仓库镜像的地址，此次以 master 分支，commitId 为 7cc1bb6eb59faa36b73cb64e40d50b588c1153e2 的 istio 提交记录作为构建与编译案例。<code>make build</code> 此操作将会拉取 <code>gcr.io/istio-testing/build-tools:master-2021-04-12T17-40-14</code> 镜像，<em>需要翻墙拉取，并且镜像分支版本可能会不一样</em>。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#6272a4># 编译二进制文件</span>
</span></span><span style=display:flex><span>make build
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>root@tanjunchen:~/go/src/istio.io/istio# make build
</span></span><span style=display:flex><span>useradd: UID <span style=color:#bd93f9>0</span> is not unique
</span></span><span style=display:flex><span>mkdir -p /work/out/linux_amd64/logs
</span></span><span style=display:flex><span>mkdir -p /work/out/linux_amd64/release
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>GOOS</span><span style=color:#ff79c6>=</span>linux <span style=color:#8be9fd;font-style:italic>GOARCH</span><span style=color:#ff79c6>=</span>amd64 <span style=color:#8be9fd;font-style:italic>LDFLAGS</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#39;-extldflags -static -s -w&#39;</span> common/scripts/gobuild.sh /work/out/linux_amd64/ ./istioctl/cmd/istioctl ./pilot/cmd/pilot-discovery ./pkg/test/echo/cmd/client ./pkg/test/echo/cmd/server ./operator/cmd/operator ./cni/cmd/istio-cni ./cni/cmd/istio-cni-repair ./cni/cmd/istio-cni-taint ./cni/cmd/install-cni ./tools/istio-iptables ./tools/bug-report
</span></span><span style=display:flex><span>go: downloading golang.org/x/text v0.3.5
</span></span><span style=display:flex><span>go: downloading sigs.k8s.io/gateway-api v0.3.0
</span></span><span style=display:flex><span>go: downloading sigs.k8s.io/mcs-api v0.1.0
</span></span><span style=display:flex><span>go: downloading github.com/pierrec/lz4 v2.0.5+incompatible
</span></span><span style=display:flex><span>go: downloading github.com/aws/aws-sdk-go v1.38.3
</span></span><span style=display:flex><span>go: downloading github.com/pierrec/lz4/v4 v4.0.3
</span></span><span style=display:flex><span>go: downloading github.com/jmespath/go-jmespath v0.4.0
</span></span><span style=display:flex><span>real	10m28.431s
</span></span><span style=display:flex><span>user	12m8.419s
</span></span><span style=display:flex><span>sys	1m18.972s
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>GOOS</span><span style=color:#ff79c6>=</span>linux <span style=color:#8be9fd;font-style:italic>GOARCH</span><span style=color:#ff79c6>=</span>amd64 <span style=color:#8be9fd;font-style:italic>LDFLAGS</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#39;-extldflags -static -s -w&#39;</span> common/scripts/gobuild.sh /work/out/linux_amd64/ -tags<span style=color:#ff79c6>=</span>agent ./pilot/cmd/pilot-agent
</span></span><span style=display:flex><span>real	0m9.745s
</span></span><span style=display:flex><span>user	0m29.966s
</span></span><span style=display:flex><span>sys	0m3.806s
</span></span><span style=display:flex><span>root@tanjunchen:~/go/src/istio.io/istio# ls
</span></span><span style=display:flex><span>bin                           CODEOWNERS     CONTRIBUTING.md  go.mod    istio.deps  logo              Makefile.overrides.mk  out    prow       releasenotes  SUPPORT.md
</span></span><span style=display:flex><span>BUGS-AND-FEATURE-REQUESTS.md  common         docker           go.sum    LICENSE     Makefile          manifests              pilot  README.md  samples       tests
</span></span><span style=display:flex><span>cni                           common-protos  galley           istioctl  licenses    Makefile.core.mk  operator               pkg    release    security      tools
</span></span><span style=display:flex><span>root@tanjunchen:~/go/src/istio.io/istio# tree out/
</span></span><span style=display:flex><span>out/
</span></span><span style=display:flex><span>└── linux_amd64
</span></span><span style=display:flex><span>    ├── bug-report
</span></span><span style=display:flex><span>    ├── client
</span></span><span style=display:flex><span>    ├── envoy
</span></span><span style=display:flex><span>    ├── envoy-centos
</span></span><span style=display:flex><span>    ├── install-cni
</span></span><span style=display:flex><span>    ├── istio-cni
</span></span><span style=display:flex><span>    ├── istio-cni-repair
</span></span><span style=display:flex><span>    ├── istio-cni-taint
</span></span><span style=display:flex><span>    ├── istioctl
</span></span><span style=display:flex><span>    ├── istio-iptables
</span></span><span style=display:flex><span>    ├── istio_is_init
</span></span><span style=display:flex><span>    ├── logs
</span></span><span style=display:flex><span>    ├── operator
</span></span><span style=display:flex><span>    ├── pilot-agent
</span></span><span style=display:flex><span>    ├── pilot-discovery
</span></span><span style=display:flex><span>    ├── release
</span></span><span style=display:flex><span>    │   ├── envoy
</span></span><span style=display:flex><span>    │   ├── envoy-759e940a5aee8d8973ffb4d9dad6773e9d605adf
</span></span><span style=display:flex><span>    │   ├── envoy-centos
</span></span><span style=display:flex><span>    │   ├── envoy-centos-759e940a5aee8d8973ffb4d9dad6773e9d605adf
</span></span><span style=display:flex><span>    │   ├── metadata_exchange-759e940a5aee8d8973ffb4d9dad6773e9d605adf.compiled.wasm
</span></span><span style=display:flex><span>    │   ├── metadata_exchange-759e940a5aee8d8973ffb4d9dad6773e9d605adf.wasm
</span></span><span style=display:flex><span>    │   ├── metadata-exchange-filter.compiled.wasm
</span></span><span style=display:flex><span>    │   ├── metadata-exchange-filter.wasm
</span></span><span style=display:flex><span>    │   ├── stats-759e940a5aee8d8973ffb4d9dad6773e9d605adf.compiled.wasm
</span></span><span style=display:flex><span>    │   ├── stats-759e940a5aee8d8973ffb4d9dad6773e9d605adf.wasm
</span></span><span style=display:flex><span>    │   ├── stats-filter.compiled.wasm
</span></span><span style=display:flex><span>    │   └── stats-filter.wasm
</span></span><span style=display:flex><span>    └── server
</span></span></code></pre></div><p>编译 istio docker 镜像，<code>make docker build</code> 详细流程如下所示：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir -p /work/out/linux_amd64/logs
</span></span><span style=display:flex><span>mkdir -p /work/out/linux_amd64/release
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>GOOS</span><span style=color:#ff79c6>=</span>linux <span style=color:#8be9fd;font-style:italic>GOARCH</span><span style=color:#ff79c6>=</span>amd64 <span style=color:#8be9fd;font-style:italic>LDFLAGS</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#39;-extldflags -static -s -w&#39;</span> common/scripts/gobuild.sh /work/out/linux_amd64/ ./istioctl/cmd/istioctl ./pilot/cmd/pilot-discovery ./pkg/test/echo/cmd/client ./pkg/test/echo/cmd/server ./operator/cmd/operator ./cni/cmd/istio-cni ./cni/cmd/istio-cni-repair ./cni/cmd/istio-cni-taint ./cni/cmd/install-cni ./tools/istio-iptables ./tools/bug-report
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>GOOS</span><span style=color:#ff79c6>=</span>linux <span style=color:#8be9fd;font-style:italic>GOARCH</span><span style=color:#ff79c6>=</span>amd64 <span style=color:#8be9fd;font-style:italic>LDFLAGS</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#39;-extldflags -static -s -w&#39;</span> common/scripts/gobuild.sh /work/out/linux_amd64/ -tags<span style=color:#ff79c6>=</span>agent ./pilot/cmd/pilot-agent
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>time</span> <span style=color:#ff79c6>(</span>mkdir -p /work/out/linux_amd64/docker_build/docker.pilot <span style=color:#ff79c6>&amp;&amp;</span> cp -rp pilot/docker/Dockerfile.pilot /work/out/linux_amd64/pilot-discovery /work/out/linux_amd64/docker_build/docker.pilot <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#8be9fd;font-style:italic>cd</span> /work/out/linux_amd64/docker_build/docker.pilot <span style=color:#ff79c6>&amp;&amp;</span> chmod <span style=color:#bd93f9>755</span> pilot-discovery <span style=color:#ff79c6>&amp;&amp;</span> docker build --build-arg <span style=color:#8be9fd;font-style:italic>BASE_VERSION</span><span style=color:#ff79c6>=</span>1.10-dev.1 --build-arg <span style=color:#8be9fd;font-style:italic>BASE_DISTRIBUTION</span><span style=color:#ff79c6>=</span>default -t registry.cn-hangzhou.aliyuncs.com/tanjunchen/pilot:dev-tanjunchen -f Dockerfile.pilot . <span style=color:#ff79c6>)</span>; 
</span></span><span style=display:flex><span>Sending build context to Docker daemon  91.11MB
</span></span><span style=display:flex><span>Step 1/8 : ARG <span style=color:#8be9fd;font-style:italic>BASE_DISTRIBUTION</span><span style=color:#ff79c6>=</span>default
</span></span><span style=display:flex><span>Step 2/8 : ARG <span style=color:#8be9fd;font-style:italic>BASE_VERSION</span><span style=color:#ff79c6>=</span>latest
</span></span><span style=display:flex><span>Step 3/8 : FROM gcr.io/istio-release/base:<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>BASE_VERSION</span><span style=color:#f1fa8c>}</span> as default
</span></span><span style=display:flex><span> ---&gt; d1542e974449
</span></span><span style=display:flex><span>Step 4/8 : FROM gcr.io/istio-release/distroless:<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>BASE_VERSION</span><span style=color:#f1fa8c>}</span> as distroless
</span></span><span style=display:flex><span> ---&gt; e4794e4d4bb6
</span></span><span style=display:flex><span>Step 5/8 : FROM <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>BASE_DISTRIBUTION</span><span style=color:#f1fa8c>}</span>
</span></span><span style=display:flex><span> ---&gt; d1542e974449
</span></span><span style=display:flex><span>Step 6/8 : COPY pilot-discovery /usr/local/bin/
</span></span><span style=display:flex><span> ---&gt; Using cache
</span></span><span style=display:flex><span> ---&gt; dd929463e8ec
</span></span><span style=display:flex><span>Step 7/8 : USER 1337:1337
</span></span><span style=display:flex><span> ---&gt; Using cache
</span></span><span style=display:flex><span> ---&gt; c1582e1824ad
</span></span><span style=display:flex><span>Step 8/8 : ENTRYPOINT <span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#34;/usr/local/bin/pilot-discovery&#34;</span><span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span> ---&gt; Using cache
</span></span><span style=display:flex><span> ---&gt; 109a5ab0ba4b
</span></span><span style=display:flex><span>Successfully built 109a5ab0ba4b
</span></span><span style=display:flex><span>Successfully tagged registry.cn-hangzhou.aliyuncs.com/tanjunchen/pilot:dev-tanjunchen
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>time</span> <span style=color:#ff79c6>(</span>mkdir -p /work/out/linux_amd64/docker_build/docker.proxyv2 <span style=color:#ff79c6>&amp;&amp;</span> cp -rp /work/out/linux_amd64/release/metadata-exchange-filter.compiled.wasm /work/tools/packaging/common//envoy_bootstrap.json /work/tools/packaging/common//gcp_envoy_bootstrap.json /work/out/linux_amd64/release/envoy /work/out/linux_amd64/pilot-agent pilot/docker/Dockerfile.proxyv2 /work/out/linux_amd64/release/stats-filter.wasm /work/out/linux_amd64/release/stats-filter.compiled.wasm /work/out/linux_amd64/release/metadata-exchange-filter.wasm /work/out/linux_amd64/docker_build/docker.proxyv2 <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#8be9fd;font-style:italic>cd</span> /work/out/linux_amd64/docker_build/docker.proxyv2 <span style=color:#ff79c6>&amp;&amp;</span> chmod <span style=color:#bd93f9>755</span> envoy pilot-agent <span style=color:#ff79c6>&amp;&amp;</span> chmod <span style=color:#bd93f9>644</span> envoy_bootstrap.json gcp_envoy_bootstrap.json <span style=color:#ff79c6>&amp;&amp;</span> docker build --build-arg <span style=color:#8be9fd;font-style:italic>proxy_version</span><span style=color:#ff79c6>=</span>istio-proxy:759e940a5aee8d8973ffb4d9dad6773e9d605adf --build-arg <span style=color:#8be9fd;font-style:italic>istio_version</span><span style=color:#ff79c6>=</span>1.10-dev --build-arg <span style=color:#8be9fd;font-style:italic>BASE_VERSION</span><span style=color:#ff79c6>=</span>1.10-dev.1 --build-arg <span style=color:#8be9fd;font-style:italic>SIDECAR</span><span style=color:#ff79c6>=</span>envoy --build-arg <span style=color:#8be9fd;font-style:italic>BASE_DISTRIBUTION</span><span style=color:#ff79c6>=</span>default -t registry.cn-hangzhou.aliyuncs.com/tanjunchen/proxyv2:dev-tanjunchen -f Dockerfile.proxyv2 . <span style=color:#ff79c6>)</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Sending build context to Docker daemon  148.4MB
</span></span><span style=display:flex><span>Step 1/20 : ARG <span style=color:#8be9fd;font-style:italic>BASE_DISTRIBUTION</span><span style=color:#ff79c6>=</span>default
</span></span><span style=display:flex><span>Step 2/20 : ARG <span style=color:#8be9fd;font-style:italic>BASE_VERSION</span><span style=color:#ff79c6>=</span>latest
</span></span><span style=display:flex><span>Step 3/20 : FROM gcr.io/istio-release/base:<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>BASE_VERSION</span><span style=color:#f1fa8c>}</span> as default
</span></span><span style=display:flex><span> ---&gt; d1542e974449
</span></span><span style=display:flex><span>Step 4/20 : FROM gcr.io/istio-release/iptables@sha256:8601b3cb13984e375d9a9a85687f23c88bc798e4f2ec9a80cca5e6abda66c6f9 as distroless
</span></span><span style=display:flex><span> ---&gt; aa9db1ff07ce
</span></span><span style=display:flex><span>Step 5/20 : FROM <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>BASE_DISTRIBUTION</span><span style=color:#f1fa8c>}</span>
</span></span><span style=display:flex><span> ---&gt; d1542e974449
</span></span><span style=display:flex><span>Step 6/20 : WORKDIR /
</span></span><span style=display:flex><span> ---&gt; Using cache
</span></span><span style=display:flex><span> ---&gt; 7921fae2382b
</span></span><span style=display:flex><span>Step 7/20 : ARG proxy_version
</span></span><span style=display:flex><span> ---&gt; Using cache
</span></span><span style=display:flex><span> ---&gt; 57c7b2876f47
</span></span><span style=display:flex><span>Step 8/20 : ARG istio_version
</span></span><span style=display:flex><span> ---&gt; Using cache
</span></span><span style=display:flex><span> ---&gt; d63eff22462b
</span></span><span style=display:flex><span>Step 9/20 : ARG <span style=color:#8be9fd;font-style:italic>SIDECAR</span><span style=color:#ff79c6>=</span>envoy
</span></span><span style=display:flex><span> ---&gt; Using cache
</span></span><span style=display:flex><span> ---&gt; c2b6be0c50e0
</span></span><span style=display:flex><span>Step 10/20 : COPY envoy_bootstrap.json /var/lib/istio/envoy/envoy_bootstrap_tmpl.json
</span></span><span style=display:flex><span> ---&gt; Using cache
</span></span><span style=display:flex><span> ---&gt; 13d79f257ec7
</span></span><span style=display:flex><span>Step 11/20 : COPY gcp_envoy_bootstrap.json /var/lib/istio/envoy/gcp_envoy_bootstrap_tmpl.json
</span></span><span style=display:flex><span> ---&gt; Using cache
</span></span><span style=display:flex><span> ---&gt; 14bd9b60c532
</span></span><span style=display:flex><span>Step 12/20 : COPY <span style=color:#8be9fd;font-style:italic>$SIDECAR</span> /usr/local/bin/<span style=color:#8be9fd;font-style:italic>$SIDECAR</span>
</span></span><span style=display:flex><span> ---&gt; Using cache
</span></span><span style=display:flex><span> ---&gt; 9214168d067c
</span></span><span style=display:flex><span>Step 13/20 : ENV ISTIO_META_ISTIO_PROXY_SHA <span style=color:#8be9fd;font-style:italic>$proxy_version</span>
</span></span><span style=display:flex><span> ---&gt; Using cache
</span></span><span style=display:flex><span> ---&gt; c9c7916e2dc7
</span></span><span style=display:flex><span>Step 14/20 : ENV ISTIO_META_ISTIO_VERSION <span style=color:#8be9fd;font-style:italic>$istio_version</span>
</span></span><span style=display:flex><span> ---&gt; Using cache
</span></span><span style=display:flex><span> ---&gt; 54c30796e3ac
</span></span><span style=display:flex><span>Step 15/20 : COPY pilot-agent /usr/local/bin/pilot-agent
</span></span><span style=display:flex><span> ---&gt; Using cache
</span></span><span style=display:flex><span> ---&gt; 6b97155022dc
</span></span><span style=display:flex><span>Step 16/20 : COPY stats-filter.wasm /etc/istio/extensions/stats-filter.wasm
</span></span><span style=display:flex><span> ---&gt; Using cache
</span></span><span style=display:flex><span> ---&gt; 4cba90d741d8
</span></span><span style=display:flex><span>Step 17/20 : COPY stats-filter.compiled.wasm /etc/istio/extensions/stats-filter.compiled.wasm
</span></span><span style=display:flex><span> ---&gt; Using cache
</span></span><span style=display:flex><span> ---&gt; 599db691bef0
</span></span><span style=display:flex><span>Step 18/20 : COPY metadata-exchange-filter.wasm /etc/istio/extensions/metadata-exchange-filter.wasm
</span></span><span style=display:flex><span> ---&gt; Using cache
</span></span><span style=display:flex><span> ---&gt; e6c764e8cc57
</span></span><span style=display:flex><span>Step 19/20 : COPY metadata-exchange-filter.compiled.wasm /etc/istio/extensions/metadata-exchange-filter.compiled.wasm
</span></span><span style=display:flex><span> ---&gt; Using cache
</span></span><span style=display:flex><span> ---&gt; d867f4f5bf10
</span></span><span style=display:flex><span>Step 20/20 : ENTRYPOINT <span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#34;/usr/local/bin/pilot-agent&#34;</span><span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span> ---&gt; Using cache
</span></span><span style=display:flex><span> ---&gt; b276d91c589e
</span></span><span style=display:flex><span>Successfully built b276d91c589e
</span></span><span style=display:flex><span>Successfully tagged registry.cn-hangzhou.aliyuncs.com/tanjunchen/proxyv2:dev-tanjunchen
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>time</span> <span style=color:#ff79c6>(</span>mkdir -p /work/out/linux_amd64/docker_build/docker.app <span style=color:#ff79c6>&amp;&amp;</span> cp -rp /work/out/linux_amd64/docker_temp/certs pkg/test/echo/docker/Dockerfile.app /work/out/linux_amd64/client /work/out/linux_amd64/server /work/out/linux_amd64/docker_build/docker.app <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#8be9fd;font-style:italic>cd</span> /work/out/linux_amd64/docker_build/docker.app <span style=color:#ff79c6>&amp;&amp;</span> chmod <span style=color:#bd93f9>755</span> server client <span style=color:#ff79c6>&amp;&amp;</span> docker build --build-arg <span style=color:#8be9fd;font-style:italic>BASE_VERSION</span><span style=color:#ff79c6>=</span>1.10-dev.1 --build-arg <span style=color:#8be9fd;font-style:italic>BASE_DISTRIBUTION</span><span style=color:#ff79c6>=</span>default -t registry.cn-hangzhou.aliyuncs.com/tanjunchen/app:dev-tanjunchen -f Dockerfile.app . <span style=color:#ff79c6>)</span>;
</span></span><span style=display:flex><span>Sending build context to Docker daemon  31.23MB
</span></span><span style=display:flex><span>Step 1/7 : ARG <span style=color:#8be9fd;font-style:italic>BASE_VERSION</span><span style=color:#ff79c6>=</span>latest
</span></span><span style=display:flex><span>Step 2/7 : FROM gcr.io/istio-release/base:<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>BASE_VERSION</span><span style=color:#f1fa8c>}</span>
</span></span><span style=display:flex><span> ---&gt; d1542e974449
</span></span></code></pre></div><p>将编译后的 istio docker 镜像推送到私有仓库，<code>make docker push</code>，详细流程如下所示：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir -p /work/out/linux_amd64/logs
</span></span><span style=display:flex><span>mkdir -p /work/out/linux_amd64/release
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>GOOS</span><span style=color:#ff79c6>=</span>linux <span style=color:#8be9fd;font-style:italic>GOARCH</span><span style=color:#ff79c6>=</span>amd64 <span style=color:#8be9fd;font-style:italic>LDFLAGS</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#39;-extldflags -static -s -w&#39;</span> common/scripts/gobuild.sh /work/out/linux_amd64/ ./istioctl/cmd/istioctl ./pilot/cmd/pilot-discovery ./pkg/test/echo/cmd/client ./pkg/test/echo/cmd/server ./operator/cmd/operator ./cni/cmd/istio-cni ./cni/cmd/istio-cni-repair ./cni/cmd/istio-cni-taint ./cni/cmd/install-cni ./tools/istio-iptables ./tools/bug-report
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>GOOS</span><span style=color:#ff79c6>=</span>linux <span style=color:#8be9fd;font-style:italic>GOARCH</span><span style=color:#ff79c6>=</span>amd64 <span style=color:#8be9fd;font-style:italic>LDFLAGS</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#39;-extldflags -static -s -w&#39;</span> common/scripts/gobuild.sh /work/out/linux_amd64/ -tags<span style=color:#ff79c6>=</span>agent ./pilot/cmd/pilot-agent
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>time</span> <span style=color:#ff79c6>(</span>mkdir -p /work/out/linux_amd64/docker_build/docker.pilot <span style=color:#ff79c6>&amp;&amp;</span> cp -rp pilot/docker/Dockerfile.pilot /work/out/linux_amd64/pilot-discovery /work/out/linux_amd64/docker_build/docker.pilot <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#8be9fd;font-style:italic>cd</span> /work/out/linux_amd64/docker_build/docker.pilot <span style=color:#ff79c6>&amp;&amp;</span> chmod <span style=color:#bd93f9>755</span> pilot-discovery <span style=color:#ff79c6>&amp;&amp;</span> docker build --build-arg <span style=color:#8be9fd;font-style:italic>BASE_VERSION</span><span style=color:#ff79c6>=</span>1.10-dev.1 --build-arg <span style=color:#8be9fd;font-style:italic>BASE_DISTRIBUTION</span><span style=color:#ff79c6>=</span>default -t registry.cn-hangzhou.aliyuncs.com/tanjunchen/pilot:dev-tanjunchen -f Dockerfile.pilot . <span style=color:#ff79c6>)</span>; 
</span></span><span style=display:flex><span>Sending build context to Docker daemon  91.11MB
</span></span><span style=display:flex><span>Step 1/8 : ARG <span style=color:#8be9fd;font-style:italic>BASE_DISTRIBUTION</span><span style=color:#ff79c6>=</span>default
</span></span><span style=display:flex><span>Step 2/8 : ARG <span style=color:#8be9fd;font-style:italic>BASE_VERSION</span><span style=color:#ff79c6>=</span>latest
</span></span><span style=display:flex><span>Step 3/8 : FROM gcr.io/istio-release/base:<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>BASE_VERSION</span><span style=color:#f1fa8c>}</span> as default
</span></span><span style=display:flex><span> ---&gt; d1542e974449
</span></span><span style=display:flex><span>Step 4/8 : FROM gcr.io/istio-release/distroless:<span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>BASE_VERSION</span><span style=color:#f1fa8c>}</span> as distroless
</span></span><span style=display:flex><span> ---&gt; e4794e4d4bb6
</span></span><span style=display:flex><span>Step 5/8 : FROM <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>BASE_DISTRIBUTION</span><span style=color:#f1fa8c>}</span>
</span></span><span style=display:flex><span> ---&gt; d1542e974449
</span></span><span style=display:flex><span>Step 6/8 : COPY pilot-discovery /usr/local/bin/
</span></span><span style=display:flex><span> ---&gt; Using cache
</span></span><span style=display:flex><span> ---&gt; dd929463e8ec
</span></span><span style=display:flex><span>Step 7/8 : USER 1337:1337
</span></span><span style=display:flex><span> ---&gt; Using cache
</span></span><span style=display:flex><span> ---&gt; c1582e1824ad
</span></span><span style=display:flex><span>Step 8/8 : ENTRYPOINT <span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#34;/usr/local/bin/pilot-discovery&#34;</span><span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span> ---&gt; Using cache
</span></span><span style=display:flex><span> ---&gt; 109a5ab0ba4b
</span></span><span style=display:flex><span>Successfully built 109a5ab0ba4b
</span></span><span style=display:flex><span>Successfully tagged registry.cn-hangzhou.aliyuncs.com/tanjunchen/pilot:dev-tanjunchen
</span></span><span style=display:flex><span>......
</span></span><span style=display:flex><span>f6dd38aa176a: Layer already exists
</span></span><span style=display:flex><span>fe6d8881187d: Layer already exists
</span></span><span style=display:flex><span>23135df75b44: Layer already exists
</span></span><span style=display:flex><span>0933ae865aef: Layer already exists
</span></span><span style=display:flex><span>dev-tanjunchen: digest: sha256:59383c79c515666f94238e82d16d691ba77f8f6c1297a432eb0b518a0eb2fee0 size: <span style=color:#bd93f9>2421</span>
</span></span></code></pre></div><p>查看生成的 istio docker 私有镜像。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>root@tanjunchen:~# docker images | grep dev-tanjunchen
</span></span><span style=display:flex><span>registry.cn-hangzhou.aliyuncs.com/tanjunchen/app_sidecar_centos_7        dev-tanjunchen                    d88d2b86dfc5        <span style=color:#bd93f9>43</span> minutes ago      581MB
</span></span><span style=display:flex><span>registry.cn-hangzhou.aliyuncs.com/tanjunchen/app_sidecar_centos_8        dev-tanjunchen                    1015cfa1cfc2        <span style=color:#bd93f9>44</span> minutes ago      569MB
</span></span><span style=display:flex><span>registry.cn-hangzhou.aliyuncs.com/tanjunchen/app_sidecar_debian_10       dev-tanjunchen                    63f97cf191ce        <span style=color:#bd93f9>45</span> minutes ago      379MB
</span></span><span style=display:flex><span>registry.cn-hangzhou.aliyuncs.com/tanjunchen/app_sidecar_debian_9        dev-tanjunchen                    0dddbc4081c0        <span style=color:#bd93f9>45</span> minutes ago      363MB
</span></span><span style=display:flex><span>registry.cn-hangzhou.aliyuncs.com/tanjunchen/app_sidecar_ubuntu_focal    dev-tanjunchen                    85c9102d27f5        <span style=color:#bd93f9>46</span> minutes ago      343MB
</span></span><span style=display:flex><span>registry.cn-hangzhou.aliyuncs.com/tanjunchen/app_sidecar_ubuntu_bionic   dev-tanjunchen                    b803ec33ca1b        <span style=color:#bd93f9>46</span> minutes ago      345MB
</span></span><span style=display:flex><span>registry.cn-hangzhou.aliyuncs.com/tanjunchen/app_sidecar_ubuntu_xenial   dev-tanjunchen                    09fb9b7a4557        <span style=color:#bd93f9>47</span> minutes ago      398MB
</span></span><span style=display:flex><span>registry.cn-hangzhou.aliyuncs.com/tanjunchen/install-cni                 dev-tanjunchen                    f05f796de449        About an hour ago   335MB
</span></span><span style=display:flex><span>registry.cn-hangzhou.aliyuncs.com/tanjunchen/operator                    dev-tanjunchen                    dd83e3528e07        About an hour ago   246MB
</span></span><span style=display:flex><span>registry.cn-hangzhou.aliyuncs.com/tanjunchen/istioctl                    dev-tanjunchen                    67d778570229        About an hour ago   248MB
</span></span><span style=display:flex><span>registry.cn-hangzhou.aliyuncs.com/tanjunchen/app                         dev-tanjunchen                    f91c3a40ecb3        <span style=color:#bd93f9>2</span> hours ago         184MB
</span></span><span style=display:flex><span>registry.cn-hangzhou.aliyuncs.com/tanjunchen/proxyv2                     dev-tanjunchen                    b276d91c589e        <span style=color:#bd93f9>2</span> hours ago         301MB
</span></span><span style=display:flex><span>registry.cn-hangzhou.aliyuncs.com/tanjunchen/pilot                       dev-tanjunchen                    109a5ab0ba4b        <span style=color:#bd93f9>2</span> hours ago         244MB
</span></span></code></pre></div><p>至此，所有 Istio 使用的镜像全部编译与构建完成，如上所示。</p><p><strong>参考</strong></p><ol><li><a href=https://github.com/istio/istio/wiki/Preparing-for-Development>https://github.com/istio/istio/wiki/Preparing-for-Development</a></li></ol><hr><ul class=pager><li class=previous><a href=/post/2020-03-14-cka-practice/ data-toggle=tooltip data-placement=top title="高效通过 Kubernetes CKAD 考试">&larr;
Previous Post</a></li><li class=next><a href=/post/2020-10-06-participate-community/ data-toggle=tooltip data-placement=top title="如何参与 Kubernetes 开源社区">Next
Post &rarr;</a></li></ul></div><div class="col-lg-2 col-lg-offset-0
visible-lg-block
sidebar-container
catalog-container"><div class=side-catalog><hr class="hidden-sm hidden-xs"><h5><a class=catalog-toggle href=#>CATALOG</a></h5><ul class=catalog-body></ul></div></div><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
sidebar-container"></div></div></div></article><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"><li><a href=mailto:tanjunchen20@gmail.com><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=/img/wechat.jpg><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-weixin fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://github.com/tanjunchen><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="copyright text-muted">Copyright &copy; 陈谭军 2023<br><a href=https://themes.gohugo.io/hugo-theme-cleanwhite>CleanWhite Hugo Theme</a> by <a href=https://github.com/tanjunchen>tanjunchen</a> |
<iframe style=margin-left:2px;margin-bottom:-5px frameborder=0 scrolling=0 width=100px height=20px src="https://ghbtns.com/github-btn.html?user=tanjunchen&repo=hugo-theme-cleanwhite&type=star&count=true"></iframe></p></div></div></div></footer><script>function loadAsync(e,t){var s=document,o="script",n=s.createElement(o),i=s.getElementsByTagName(o)[0];n.src=e,t&&n.addEventListener("load",function(e){t(null,e)},!1),i.parentNode.insertBefore(n,i)}</script><script>$("#tag_cloud").length!==0&&loadAsync("/js/jquery.tagcloud.js",function(){$.fn.tagcloud.defaults={color:{start:"#bbbbee",end:"#0085a1"}},$("#tag_cloud a").tagcloud()})</script><script>loadAsync("https://cdn.jsdelivr.net/npm/fastclick@1.0.6/lib/fastclick.min.js",function(){var e=document.querySelector("nav");e&&FastClick.attach(e)})</script><script type=text/javascript>function generateCatalog(e){_containerSelector="div.post-container";var t,n,s,o,i,r=$(_containerSelector),a=r.find("h1,h2,h3,h4,h5,h6");return $(e).html(""),a.each(function(){n=$(this).prop("tagName").toLowerCase(),i="#"+$(this).prop("id"),s=$(this).text(),t=$('<a href="'+i+'" rel="nofollow">'+s+"</a>"),o=$('<li class="'+n+'_nav"></li>').append(t),$(e).append(o)}),!0}generateCatalog(".catalog-body"),$(".catalog-toggle").click(function(e){e.preventDefault(),$(".side-catalog").toggleClass("fold")}),loadAsync("/js/jquery.nav.js",function(){$(".catalog-body").onePageNav({currentClass:"active",changeHash:!1,easing:"swing",filter:"",scrollSpeed:700,scrollOffset:0,scrollThreshold:.2,begin:null,end:null,scrollChange:null,padding:80})})</script></body></html>