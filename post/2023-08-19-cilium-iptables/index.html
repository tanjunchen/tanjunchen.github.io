<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:site_name" content="漫步远方，心荡神往"><meta property="og:type" content="article"><meta property="og:image" content="https://tanjunchen.github.io/img/home.webp"><meta property="twitter:image" content="https://tanjunchen.github.io/img/home.webp"><meta name=title content="浅析 Cilium 与 iptables"><meta property="og:title" content="浅析 Cilium 与 iptables"><meta property="twitter:title" content="浅析 Cilium 与 iptables"><meta name=description content="似乎大家都不太喜欢 iptables，Cilium 好像也是一样的。使用了 Cilium 一段时间，对于 Cilium 使用 eBPF 构建高性能、可扩展的容器网络印象深刻，并且还具备 L7 策略和可观测性能力。如果你之前还没有听说过 Cilium，可以去了解与试用一下！"><meta property="og:description" content="似乎大家都不太喜欢 iptables，Cilium 好像也是一样的。使用了 Cilium 一段时间，对于 Cilium 使用 eBPF 构建高性能、可扩展的容器网络印象深刻，并且还具备 L7 策略和可观测性能力。如果你之前还没有听说过 Cilium，可以去了解与试用一下！"><meta property="twitter:description" content="似乎大家都不太喜欢 iptables，Cilium 好像也是一样的。使用了 Cilium 一段时间，对于 Cilium 使用 eBPF 构建高性能、可扩展的容器网络印象深刻，并且还具备 L7 策略和可观测性能力。如果你之前还没有听说过 Cilium，可以去了解与试用一下！"><meta property="twitter:card" content="summary"><meta name=keyword content="陈谭军, 互联网, 云原生, 容器, 微服务, Web, PaaS, Istio, Kubernetes, Microservice"><link rel="shortcut icon" href=/img/favicon.ico><title>浅析 Cilium 与 iptables | 陈谭军的博客 | tanjunchen Blog</title><link rel=canonical href=/post/2023-08-19-cilium-iptables/><link rel=stylesheet href=/css/bootstrap.min.css><link rel=stylesheet href=/css/hugo-theme-cleanwhite.min.css><link rel=stylesheet href=/css/zanshang.css><link rel=stylesheet href=/css/font-awesome.all.min.css><script src=/js/jquery.min.js></script>
<script src=/js/bootstrap.min.js></script>
<script src=/js/hux-blog.min.js></script>
<script src=/js/lazysizes.min.js></script></head><nav class="navbar navbar-default navbar-custom navbar-fixed-top"><div class=container-fluid><div class="navbar-header page-scroll"><button type=button class=navbar-toggle>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span></button>
<a class=navbar-brand href=/>漫步远方，心荡神往</a></div><div id=huxblog_navbar><div class=navbar-collapse><ul class="nav navbar-nav navbar-right"><li><a href=/>All Posts</a></li><li><a href=/categories/technology/>technology</a></li><li><a href=/categories/think/>think</a></li><li><a href=/learning/>LEARNING</a></li><li><a href=/archive/>ARCHIVE</a></li><li><a href=/about/>ABOUT</a></li><li><a href=/search><i class="fa fa-search"></i></a></li></ul></div></div></div></nav><script>var $body=document.body,$toggle=document.querySelector(".navbar-toggle"),$navbar=document.querySelector("#huxblog_navbar"),$collapse=document.querySelector(".navbar-collapse");$toggle.addEventListener("click",handleMagic);function handleMagic(){$navbar.className.indexOf("in")>0?($navbar.className=" ",setTimeout(function(){$navbar.className.indexOf("in")<0&&($collapse.style.height="0px")},400)):($collapse.style.height="auto",$navbar.className+=" in")}</script><style type=text/css>header.intro-header{background-image:url(/img/home.webp)}</style><header class=intro-header><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><div class=tags><a class=tag href=/tags/cilium title=cilium>cilium</a>
<a class=tag href=/tags/iptables title=iptables>iptables</a></div><h1>浅析 Cilium 与 iptables</h1><h2 class=subheading>浅析 Cilium 为什么仍然使用 iptables。</h2><span class=meta>Posted by
陈谭军
on
Saturday, August 19, 2023
<span id=busuanzi_container_page_pv>|<span id=busuanzi_value_page_pv></span><span>
<span id=/post/2023-08-19-cilium-iptables/ class="leancloud_visitors meta_data_item" data-flag-title><span class=post-meta-item-icon><span class="octicon octicon-eye"></span></span>
<i class="fa fa-eye"></i>
<span class=old-visitors-count style=display:none></span>
<span class=leancloud-visitors-count></span></span>
<script src=https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js></script>
<script>AV.initialize("","")</script><script type=text/javascript>function showTime(e){var n=new AV.Query(e),t=[],s=$(".leancloud_visitors");s.each(function(){t.push($(this).attr("id").trim())}),n.containedIn("url",t),n.find().done(function(e){for(var s,o,i,a,r,c,l=".leancloud-visitors-count",d=".old-visitors-count",n=0;n<e.length;n++)a=e[n],i=a.get("url"),c=a.get("time"),s=document.getElementById(i),$(s).find(l).text(c);for(n=0;n<t.length;n++)i=t[n],s=document.getElementById(i),o=$(s).find(l),o.text()==""&&(r=$(s).find(d).text(),r!=""?o.text(0+parseInt(r)):o.text(0))}).fail(function(e,t){console.log("Error: "+t.code+" "+t.message)})}function addCount(e){var n=$(".leancloud_visitors"),t=n.attr("id").trim(),o=n.attr("data-flag-title").trim(),s=new AV.Query(e);s.equalTo("url",t),s.find({success:function(n){if(n.length>0){var s,i,r,c,l,a=n[0];a.fetchWhenSave(!0),a.increment("time"),a.save(null,{success:function(e){var n=$(document.getElementById(t));n.find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to save Visitor num, with error message: "+t.message)}})}else s=new e,i=new AV.ACL,i.setPublicReadAccess(!0),i.setPublicWriteAccess(!0),s.setACL(i),s.set("title",o),s.set("url",t),c=".old-visitors-count",l=$(document.getElementById(t)),r=l.find(c).text(),r!=""?s.set("time",parseInt(r)+1):s.set("time",1),s.save(null,{success:function(e){var n=$(document.getElementById(t));n.find(".leancloud-visitors-count").text(e.get("time"))},error:function(){console.log("Failed to create")}})},error:function(e){console.log("Error:"+e.code+" "+e.message)}})}$(function(){var e=AV.Object.extend("Counter");$(".leancloud_visitors").length==1?addCount(e):showTime(e)})</script>阅读 </span></span>|<span class=post-date>共 5619 字</span>，阅读约 <span class=more-meta>12 分钟</span></span></div></div></div></div></header><article><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
post-container"><h1 id=目的>目的</h1><p>浅析 Cilium 为什么仍然使用 iptables。</p><h1 id=前言>前言</h1><p>似乎大家都不太喜欢 iptables，<a href=https://cilium.io/>Cilium</a> 好像也是一样的。使用了 Cilium 一段时间，对于 Cilium 使用 eBPF 构建高性能、可扩展的容器网络印象深刻，并且还具备 L7 策略和可观测性能力。如果你之前还没有听说过 Cilium，可以去了解与试用一下！</p><p><img src=/images/2023-08-19-cilium-iptables/1.png alt></p><p>如上图所示：这是 Cilium 目前正在做的事情。一方面因为基于 iptables 的 kube-proxy 当前的实现存在可拓展性与性能问题，另一方面，基于 eBPF 替换 kube-proxy 组件展现出高吞吐量、低延迟、更少的资源消耗优势。当前 Cilium 作为容器网络在 Kubernetes 领域大放异彩。<br>在当前的内核版本（4.19）中，Cilium 仍需要 iptables 来执行其代理重定向任务，为什么 Cilium 还在使用 iptables？</p><h1 id=简述-iptables>简述 iptables？</h1><p>iptables 是 Linux 系统中的一个命令行工具，它允许系统管理员配置 Linux 内核防火墙的规则。它可以用来创建、修改、删除防火墙规则，以控制进出 Linux 系统的网络流量。<br>iptables 主要有五个表，分别是：filter、nat、mangle、raw 和 security，每个表有自己的特定功能和责任链。</p><p><img src=/images/2023-08-19-cilium-iptables/2.png alt></p><ol><li>Filter 表：这是 iptables 的默认表，主要用于数据包过滤。它包含三个内置链，分别是 INPUT、FORWARD 和 OUTPUT。INPUT 链：处理进入本机的数据包、FORWARD 链：处理通过本机转发的数据包、OUTPUT 链：处理本机产生的出站数据包。</li><li>NAT 表：用于网络地址转换（NAT）。它包含三个内置链，分别是 PREROUTING、OUTPUT 和 POSTROUTING。PREROUTING 链：用于目标地址转换（DNAT）、OUTPUT 链：处理本机产生的数据包，用于本地生成的数据包的目标地址转换、POSTROUTING 链：用于源地址转换（SNAT）。</li><li>Mangle 表：用于特殊的数据包修改。它包含五个内置链，分别是 PREROUTING、OUTPUT、INPUT、FORWARD 和 POSTROUTING。</li><li>Raw 表：主要用于配置 exemptions，即免除某些数据包不被 stateful tracking system 追踪，它包含两个内置链，分别是 PREROUTING 和 OUTPUT。</li><li>Security 表：主要用于 SELinux 安全策略的设置。它包含三个内置链，分别是 INPUT、OUTPUT 和 FORWARD。</li></ol><h1 id=为什么-cilium-仍然使用-iptables>为什么 Cilium 仍然使用 iptables？</h1><p>有两个主要原因：</p><ol><li>确保 Cilium 数据平面与现有的 iptables 可以良好兼容。无论 Cilium 对 iptables 有何看法，它仍然是 Linux 网络的一部分，数据包仍会通过它，只是影响要小得多。</li><li>实现旧内核版本（4.x）中的关键功能，例如 L7 网络策略（TPROXY），这些功能无法由基于 eBPF 的解决方案实现，因为旧内核不支持它。</li></ol><p>关键核心：<br>Cilium 成功地通过其基于 eBPF 的解决方案替换了 kube-proxy，它解决了基于 iptables 的 kube-proxy 不可扩展与性能问题，在所有节点上不再有大量的 iptables 规则了，这是一个巨大的进步。</p><h1 id=cilium-如何使用-iptables>Cilium 如何使用 iptables？</h1><p>Cilium 使用 iptables 流程如下所示：</p><ul><li>Cilium Agent 在启动或创建新的 L7 策略时初始化规则（将基于随机选择的端口号生成一些带有 <a href=https://github.com/cilium/cilium/blob/1108684e354d2b6ecf66cbaf1cd82de5fa88b70f/pkg/datapath/iptables/iptables.go#L560>fwmark</a> 的规则）</li><li>Cilium 并不像 kube-proxy 那样定期同步这些规则。如果以某种方式删除了自定义链中的规则，则必须手动将其添加回来或重新启动 Cilium Agent。 这里比较有意思，不知是个 bug 还是 feature?</li><li>如上所述，规则包含两个主要部分：<ul><li>确保流量顺利通过默认 iptables table/chain，而不会被默认策略丢弃。（例如：接受来自自定义 veth 的流量，例如 FORWARD chain, filter table 中的 lxc_* 或 cilium_* ）。</li><li>将流量重定向到其 Envoy 代理（在 mangle 表中标记数据包并使用 <a href=https://docs.kernel.org/networking/tproxy.html>TPROXY</a>，在 raw table 中匹配 <a href=https://github.com/cilium/cilium/blob/main/pkg/datapath/linux/linux_defaults/mark.go>magic mark</a> 以避免被跟踪），这些规则在每个节点上略有不同。</li></ul></li><li>更多关于 L7 策略相关规则，它需要一些外部配置才能正常运行。<ul><li>TPROXY 需要用于转发标记流量的策略路由。</li><li><a href=https://github.com/cilium/cilium/blob/main/pkg/datapath/linux/linux_defaults/mark.go#L51>标记</a> 由 <a href=https://docs.cilium.io/en/v1.9/concepts/ebpf/intro/>bpf hooks</a> 设置。</li><li>需要一个应用程序代理，并带有 IP_TRANSPARENT 套接字选项。</li></ul></li><li>默认情况下，Cilium Agent 通过 iptables 管理 conntrack ( install-no-conntrack-iptables-rules=false )，nat 表中会有一些额外的规则，并在每个节点上设置 1 个名为 cilium_node_set_v4 的 ipset，用于处理各种 NAT 操作 ( 如允许节点连接到互联网）。在 4.19 内核中，Cilium Agent 使用 enable-bpf-masquerade 选项可以达到相同的效果。</li><li>最后但并非最不重要的一点：规则的数量不会随着 endpoints 或 services（如 kube-proxy ）的数量线性增加，它们是相当固定的。在此过程中唯一可以添加的一件事是每种类型的 L7 策略（到目前为止，dns、http、kafka）的 2 条规则（入口/出口）规则。</li></ul><p>Cilium 会在每个 Node 节点上生成 iptables 规则，更多详细信息可参见附录中的 iptables 规则。</p><h1 id=结语>结语</h1><p>在接触 Cilium 之前，我认为我们根本不需要 iptables，但事实并非如此，至少对于使用的内核版本（4.19）来说是这样。Cilium 提供了许多厉害的能力，但其中许多仍处于测试阶段或需要更新的内核，这很遗憾。所以，有时我们仍然不得不坚持使用 iptables。</p><h1 id=附录>附录</h1><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#6272a4># mangle 表</span>
</span></span><span style=display:flex><span>*mangle
</span></span><span style=display:flex><span>:PREROUTING ACCEPT <span style=color:#ff79c6>[</span>0:0<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>:INPUT ACCEPT <span style=color:#ff79c6>[</span>0:0<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>:FORWARD ACCEPT <span style=color:#ff79c6>[</span>0:0<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>:OUTPUT ACCEPT <span style=color:#ff79c6>[</span>0:0<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>:POSTROUTING ACCEPT <span style=color:#ff79c6>[</span>0:0<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>:CILIUM_POST_mangle - <span style=color:#ff79c6>[</span>0:0<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>:CILIUM_PRE_mangle - <span style=color:#ff79c6>[</span>0:0<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>:KUBE-IPTABLES-HINT - <span style=color:#ff79c6>[</span>0:0<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>:KUBE-KUBELET-CANARY - <span style=color:#ff79c6>[</span>0:0<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>-A PREROUTING -m comment --comment <span style=color:#f1fa8c>&#34;cilium-feeder: CILIUM_PRE_mangle&#34;</span> -j CILIUM_PRE_mangle
</span></span><span style=display:flex><span><span style=color:#6272a4># PREROUTING链的第一条规则是通过注释指定的CILIUM_PRE_mangle链。这个链是Cilium提供的一个自定义链，用于重定向代理流量或其他网络功能。</span>
</span></span><span style=display:flex><span>-A PREROUTING -d 10.164.251.0/24 -m mark ! --mark 0x23 -j MARK --set-xmark 0x21/0xffffffff
</span></span><span style=display:flex><span>-A PREROUTING -d 11.254.0.0/16 -m mark ! --mark 0x23 -j MARK --set-xmark 0x21/0xffffffff
</span></span><span style=display:flex><span><span style=color:#6272a4># PREROUTING 链对特定的网络IP地址段进行了标记。如果输入流量的目标IP地址在10.164.251.0/24或11.254.0.0/16范围内，且标记比0x23小，就会对这个流量进行标记（set-xmark），标记值是0x21。</span>
</span></span><span style=display:flex><span>-A POSTROUTING -m comment --comment <span style=color:#f1fa8c>&#34;cilium-feeder: CILIUM_POST_mangle&#34;</span> -j CILIUM_POST_mangle
</span></span><span style=display:flex><span><span style=color:#6272a4># POSTROUTING链的第一条规则与PREROUTING链的第一条规则类似，使用了注释标记的CILIUM_POST_mangle自定义链。</span>
</span></span><span style=display:flex><span>-A POSTROUTING -s 11.254.0.0/16 -j MARK --set-xmark 0x21/0xffffffff
</span></span><span style=display:flex><span>-A POSTROUTING -s 10.164.251.0/24 -j MARK --set-xmark 0x21/0xffffffff
</span></span><span style=display:flex><span><span style=color:#6272a4># POSTROUTING链也对特定的网络IP地址段进行了标记。如果输出流量的源IP地址与10.164.251.0/24或11.254.0.0/16匹配，则会对这个流量进行标记，标记值是0x21。</span>
</span></span><span style=display:flex><span>-A CILIUM_PRE_mangle -m socket --transparent -m comment --comment <span style=color:#f1fa8c>&#34;cilium: any-&gt;pod redirect proxied traffic to host proxy&#34;</span> -j MARK --set-xmark 0x200/0xffffffff
</span></span><span style=display:flex><span>-A CILIUM_PRE_mangle -p tcp -m mark --mark 0x23420200 -m comment --comment <span style=color:#f1fa8c>&#34;cilium: TPROXY to host cilium-dns-egress proxy&#34;</span> -j TPROXY --on-port <span style=color:#bd93f9>16931</span> --on-ip 127.0.0.1 --tproxy-mark 0x200/0xffffffff
</span></span><span style=display:flex><span>-A CILIUM_PRE_mangle -p udp -m mark --mark 0x23420200 -m comment --comment <span style=color:#f1fa8c>&#34;cilium: TPROXY to host cilium-dns-egress proxy&#34;</span> -j TPROXY --on-port <span style=color:#bd93f9>16931</span> --on-ip 127.0.0.1 --tproxy-mark 0x200/0xffffffff
</span></span><span style=display:flex><span>-A CILIUM_PRE_mangle -p tcp -m mark --mark 0x19420200 -m comment --comment <span style=color:#f1fa8c>&#34;cilium: TPROXY to host /tanjunchen/envoy-lb-listener proxy&#34;</span> -j TPROXY --on-port <span style=color:#bd93f9>16921</span> --on-ip 127.0.0.1 --tproxy-mark 0x200/0xffffffff
</span></span><span style=display:flex><span>-A CILIUM_PRE_mangle -p udp -m mark --mark 0x19420200 -m comment --comment <span style=color:#f1fa8c>&#34;cilium: TPROXY to host /tanjunchen/envoy-lb-listener proxy&#34;</span> -j TPROXY --on-port <span style=color:#bd93f9>16921</span> --on-ip 127.0.0.1 --tproxy-mark 0x200/0xffffffff
</span></span><span style=display:flex><span><span style=color:#6272a4># 自定义链CILIUM_PRE_mangle包含4条规则，他们的目的是将代理请求流量重定向到主机代理。这些规则基于TCP和udp协议，通过mark匹配特定的标记值（0x23420200和0x19420200），并使用TPROXY命令将流量定向到本地IP地址127.0.0.1上的特定端口（16931和16921）。</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># raw 表</span>
</span></span><span style=display:flex><span>*raw
</span></span><span style=display:flex><span>:PREROUTING ACCEPT <span style=color:#ff79c6>[</span>0:0<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>:OUTPUT ACCEPT <span style=color:#ff79c6>[</span>0:0<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>:CILIUM_OUTPUT_raw - <span style=color:#ff79c6>[</span>0:0<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>:CILIUM_PRE_raw - <span style=color:#ff79c6>[</span>0:0<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>-A PREROUTING -m comment --comment <span style=color:#f1fa8c>&#34;cilium-feeder: CILIUM_PRE_raw&#34;</span> -j CILIUM_PRE_raw
</span></span><span style=display:flex><span><span style=color:#6272a4># 在 PREROUTING 链上，CILIUM_PRE_raw 规则是一条自定义链规则。当满足 PREROUTING 的流量到达时，该规则调用 CILIUM_PRE_raw 自定义链。</span>
</span></span><span style=display:flex><span>-A OUTPUT -m comment --comment <span style=color:#f1fa8c>&#34;cilium-feeder: CILIUM_OUTPUT_raw&#34;</span> -j CILIUM_OUTPUT_raw
</span></span><span style=display:flex><span><span style=color:#6272a4># 在 OUTPUT 链上，CILIUM_OUTPUT_raw 规则是一条自定义链规则。当满足 OUTPUT 的流量到达时，该规则调用 CILIUM_OUTPUT_raw 自定义链。</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>-A CILIUM_OUTPUT_raw -o lxc+ -m mark --mark 0xa00/0xfffffeff -m comment --comment <span style=color:#f1fa8c>&#34;cilium: NOTRACK for proxy return traffic&#34;</span> -j CT --notrack
</span></span><span style=display:flex><span>-A CILIUM_OUTPUT_raw -o cilium_host -m mark --mark 0xa00/0xfffffeff -m comment --comment <span style=color:#f1fa8c>&#34;cilium: NOTRACK for proxy return traffic&#34;</span> -j CT --notrack
</span></span><span style=display:flex><span>-A CILIUM_OUTPUT_raw -o lxc+ -m mark --mark 0x800/0xe00 -m comment --comment <span style=color:#f1fa8c>&#34;cilium: NOTRACK for L7 proxy upstream traffic&#34;</span> -j CT --notrack
</span></span><span style=display:flex><span>-A CILIUM_OUTPUT_raw -o cilium_host -m mark --mark 0x800/0xe00 -m comment --comment <span style=color:#f1fa8c>&#34;cilium: NOTRACK for L7 proxy upstream traffic&#34;</span> -j CT --notrack
</span></span><span style=display:flex><span><span style=color:#6272a4># 对于匹配输出路径的流量（-o lxc+ 或 -o cilium_host）和满足特定标记（0xa00/0xfffffeff 或 0x800/0xe00）的流量，将会应用 ct 模块（Connection Tracking）的 notrack 功能，以便不会被 conntrack 提取并添加到链接跟踪表中。notrack 规则的作用是使得操作系统不跟踪这些连接，不对其进行连接追踪和状态检查，从而可以避免对其进行 NAT 原地址改写的操作。</span>
</span></span><span style=display:flex><span>-A CILIUM_PRE_raw -m mark --mark 0x200/0xf00 -m comment --comment <span style=color:#f1fa8c>&#34;cilium: NOTRACK for proxy traffic&#34;</span> -j CT --notrack
</span></span><span style=display:flex><span><span style=color:#6272a4># 对于满足特定标记（0x200/0xf00）的流量，同样会应用 ct 模块的 notrack 功能。这个规则可能用于不需要被 cilium 代理的流量，此时操作系统不会对这些连接进行状态追踪和状态检查，从而提高网络性能。</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># filter 表</span>
</span></span><span style=display:flex><span>*filter
</span></span><span style=display:flex><span>:INPUT ACCEPT <span style=color:#ff79c6>[</span>0:0<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>:FORWARD ACCEPT <span style=color:#ff79c6>[</span>0:0<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>:OUTPUT ACCEPT <span style=color:#ff79c6>[</span>0:0<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>:CILIUM_FORWARD - <span style=color:#ff79c6>[</span>0:0<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>:CILIUM_INPUT - <span style=color:#ff79c6>[</span>0:0<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>:CILIUM_OUTPUT - <span style=color:#ff79c6>[</span>0:0<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>:KUBE-FIREWALL - <span style=color:#ff79c6>[</span>0:0<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>:KUBE-FORWARD - <span style=color:#ff79c6>[</span>0:0<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>:KUBE-KUBELET-CANARY - <span style=color:#ff79c6>[</span>0:0<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>:KUBE-NODE-PORT - <span style=color:#ff79c6>[</span>0:0<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>-A INPUT -m comment --comment <span style=color:#f1fa8c>&#34;cilium-feeder: CILIUM_INPUT&#34;</span> -j CILIUM_INPUT
</span></span><span style=display:flex><span><span style=color:#6272a4># 对于匹配 INPUT 的流量，将会应用 CILIUM_INPUT 规则。这是一条自定义链规则。</span>
</span></span><span style=display:flex><span>-A INPUT -j KUBE-FIREWALL
</span></span><span style=display:flex><span><span style=color:#6272a4># 匹配 INPUT 链的其他流量将会转到 KUBE-FIREWALL 规则链。</span>
</span></span><span style=display:flex><span>-A INPUT -m comment --comment <span style=color:#f1fa8c>&#34;kubernetes health check rules&#34;</span> -j KUBE-NODE-PORT
</span></span><span style=display:flex><span><span style=color:#6272a4># 对于需要进行 Kubernetes 健康检查的流量，将会被应用 KUBE-NODE-PORT 规则。</span>
</span></span><span style=display:flex><span>-A FORWARD -m comment --comment <span style=color:#f1fa8c>&#34;cilium-feeder: CILIUM_FORWARD&#34;</span> -j CILIUM_FORWARD
</span></span><span style=display:flex><span><span style=color:#6272a4># 对于匹配 FORWARD 的流量，将会应用 CILIUM_FORWARD 规则。这是一条自定义链规则。</span>
</span></span><span style=display:flex><span>-A FORWARD -m comment --comment <span style=color:#f1fa8c>&#34;kubernetes forwarding rules&#34;</span> -j KUBE-FORWARD
</span></span><span style=display:flex><span><span style=color:#6272a4># 对于其他需要进行 Kubernetes 转发的流量，将会应用 KUBE-FORWARD 规则链。</span>
</span></span><span style=display:flex><span>-A OUTPUT -m comment --comment <span style=color:#f1fa8c>&#34;cilium-feeder: CILIUM_OUTPUT&#34;</span> -j CILIUM_OUTPUT
</span></span><span style=display:flex><span><span style=color:#6272a4># 对于匹配 OUTPUT 的流量，将会应用 CILIUM_OUTPUT 规则。这是一条自定义链规则。</span>
</span></span><span style=display:flex><span>-A OUTPUT -j KUBE-FIREWALL
</span></span><span style=display:flex><span><span style=color:#6272a4># 匹配 OUTPUT 链的其他流量将会转到 KUBE-FIREWALL 规则链。</span>
</span></span><span style=display:flex><span>-A CILIUM_FORWARD -o cilium_host -m comment --comment <span style=color:#f1fa8c>&#34;cilium: any-&gt;cluster on cilium_host forward accept&#34;</span> -j ACCEPT
</span></span><span style=display:flex><span><span style=color:#6272a4># 对于流向 cilium_host 接口并需要进行转发的流量，将会被允许通过 CILIUM_FORWARD 规则链的第一个规则。</span>
</span></span><span style=display:flex><span>-A CILIUM_FORWARD -i cilium_host -m comment --comment <span style=color:#f1fa8c>&#34;cilium: cluster-&gt;any on cilium_host forward accept (nodeport)&#34;</span> -j ACCEPT
</span></span><span style=display:flex><span><span style=color:#6272a4># 对于从 cilium_host 接口流向 cluster 并需要进行转发的流量，将会被允许通过 CILIUM_FORWARD 规则链的第二个规则。</span>
</span></span><span style=display:flex><span>-A CILIUM_FORWARD -i lxc+ -m comment --comment <span style=color:#f1fa8c>&#34;cilium: cluster-&gt;any on lxc+ forward accept&#34;</span> -j ACCEPT
</span></span><span style=display:flex><span><span style=color:#6272a4># 对于从 lxc+ 接口流向 cluster 并需要进行转发的流量，将会被允许通过 CILIUM_FORWARD 规则链的第三个规则。</span>
</span></span><span style=display:flex><span>-A CILIUM_FORWARD -i cilium_net -m comment --comment <span style=color:#f1fa8c>&#34;cilium: cluster-&gt;any on cilium_net forward accept (nodeport)&#34;</span> -j ACCEPT
</span></span><span style=display:flex><span><span style=color:#6272a4># 对于从 cilium_net 接口流向 cluster 并需要进行转发的流量，将会被允许通过 CILIUM_FORWARD 规则链的第四个规则。</span>
</span></span><span style=display:flex><span>-A CILIUM_INPUT -m mark --mark 0x200/0xf00 -m comment --comment <span style=color:#f1fa8c>&#34;cilium: ACCEPT for proxy traffic&#34;</span> -j ACCEPT
</span></span><span style=display:flex><span><span style=color:#6272a4># 对于被标记为 0x200/0xf00 的流量，将会被允许通过 CILIUM_INPUT 规则链的第一个规则。</span>
</span></span><span style=display:flex><span>-A CILIUM_OUTPUT -m mark --mark 0xa00/0xfffffeff -m comment --comment <span style=color:#f1fa8c>&#34;cilium: ACCEPT for proxy return traffic&#34;</span> -j ACCEPT
</span></span><span style=display:flex><span><span style=color:#6272a4># 对于被标记为 0xa00/0xfffffeff 的流量，将会被允许通过 CILIUM_OUTPUT 规则链的第一个规则。</span>
</span></span><span style=display:flex><span>-A CILIUM_OUTPUT -m mark --mark 0x800/0xe00 -m comment --comment <span style=color:#f1fa8c>&#34;cilium: ACCEPT for l7 proxy upstream traffic&#34;</span> -j ACCEPT
</span></span><span style=display:flex><span><span style=color:#6272a4># 对于被标记为 0x800/0xe00 的流量，将会被允许通过 CILIUM_OUTPUT 规则链的第二个规则。</span>
</span></span><span style=display:flex><span>-A CILIUM_OUTPUT -m mark ! --mark 0xe00/0xf00 -m mark ! --mark 0xd00/0xf00 -m mark ! --mark 0xa00/0xe00 -m mark ! --mark 0x800/0xe00 -m mark ! --mark 0xf00/0xf00 -m comment --comment <span style=color:#f1fa8c>&#34;cilium: host-&gt;any mark as from host&#34;</span> -j MARK --set-xmark 0xc00/0xf00
</span></span><span style=display:flex><span><span style=color:#6272a4># 对于从 host 发起的流量，并不属于代理流量或 L7 代理上游流量，将会被标记为 0xc00/0xf00，并允许通过 CILIUM_OUTPUT 规则链的第五个规则。</span>
</span></span><span style=display:flex><span>-A KUBE-FIREWALL -m comment --comment <span style=color:#f1fa8c>&#34;kubernetes firewall for dropping marked packets&#34;</span> -m mark --mark 0x8000/0x8000 -j DROP
</span></span><span style=display:flex><span><span style=color:#6272a4># 对于被标记为 0x8000/0x8000 的流量，将被 KUBE-FIREWALL 规则链的第一个规则丢弃。</span>
</span></span><span style=display:flex><span>-A KUBE-FIREWALL ! -s 127.0.0.0/8 -d 127.0.0.0/8 -m comment --comment <span style=color:#f1fa8c>&#34;block incoming localnet connections&#34;</span> -m conntrack ! --ctstate RELATED,ESTABLISHED,DNAT -j DROP
</span></span><span style=display:flex><span><span style=color:#6272a4># 对于不允许从本地网络（127.0.0.0/8）建立的未被跟踪状态的连接，将会被 KUBE-FIREWALL 规则链的第二个规则丢弃。</span>
</span></span><span style=display:flex><span>-A KUBE-FORWARD -m comment --comment <span style=color:#f1fa8c>&#34;kubernetes forwarding rules&#34;</span> -m mark --mark 0x4000/0x4000 -j ACCEPT
</span></span><span style=display:flex><span>-A KUBE-FORWARD -m comment --comment <span style=color:#f1fa8c>&#34;kubernetes forwarding conntrack rule&#34;</span> -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
</span></span><span style=display:flex><span><span style=color:#6272a4># 对于需要转发的已建立连接，将被允许通过 KUBE-FORWARD 规则链的第二个规则。</span>
</span></span><span style=display:flex><span>-A KUBE-NODE-PORT -m comment --comment <span style=color:#f1fa8c>&#34;Kubernetes health check node port&#34;</span> -m <span style=color:#8be9fd;font-style:italic>set</span> --match-set KUBE-HEALTH-CHECK-NODE-PORT dst -j ACCEPT
</span></span><span style=display:flex><span><span style=color:#6272a4># 对于匹配 KUBE-HEALTH-CHECK-NODE-PORT 的流量，将会被允许通过 KUBE-NODE-PORT 规则链的第一个规则。</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># nat 表</span>
</span></span><span style=display:flex><span>*nat
</span></span><span style=display:flex><span>:PREROUTING ACCEPT <span style=color:#ff79c6>[</span>0:0<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>:INPUT ACCEPT <span style=color:#ff79c6>[</span>0:0<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>:OUTPUT ACCEPT <span style=color:#ff79c6>[</span>0:0<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>:POSTROUTING ACCEPT <span style=color:#ff79c6>[</span>0:0<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>:CILIUM_OUTPUT_nat - <span style=color:#ff79c6>[</span>0:0<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>:CILIUM_POST_nat - <span style=color:#ff79c6>[</span>0:0<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>:CILIUM_PRE_nat - <span style=color:#ff79c6>[</span>0:0<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>:KUBE-FIREWALL - <span style=color:#ff79c6>[</span>0:0<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>:KUBE-KUBELET-CANARY - <span style=color:#ff79c6>[</span>0:0<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>:KUBE-LOAD-BALANCER - <span style=color:#ff79c6>[</span>0:0<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>:KUBE-MARK-DROP - <span style=color:#ff79c6>[</span>0:0<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>:KUBE-MARK-MASQ - <span style=color:#ff79c6>[</span>0:0<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>:KUBE-NODE-PORT - <span style=color:#ff79c6>[</span>0:0<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>:KUBE-POSTROUTING - <span style=color:#ff79c6>[</span>0:0<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>:KUBE-SERVICES - <span style=color:#ff79c6>[</span>0:0<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>-A PREROUTING -m comment --comment <span style=color:#f1fa8c>&#34;cilium-feeder: CILIUM_PRE_nat&#34;</span> -j CILIUM_PRE_nat
</span></span><span style=display:flex><span><span style=color:#6272a4># 对于匹配 PREROUTING 链的流量，将会应用 CILIUM_PRE_nat 规则。这是一个自定义链规则。</span>
</span></span><span style=display:flex><span>-A PREROUTING -m comment --comment <span style=color:#f1fa8c>&#34;kubernetes service portals&#34;</span> -j KUBE-SERVICES
</span></span><span style=display:flex><span><span style=color:#6272a4># 对于需要进行 Kubernetes 服务暴露的流量，将会应用 KUBE-SERVICES 规则链。</span>
</span></span><span style=display:flex><span>-A OUTPUT -m comment --comment <span style=color:#f1fa8c>&#34;cilium-feeder: CILIUM_OUTPUT_nat&#34;</span> -j CILIUM_OUTPUT_nat
</span></span><span style=display:flex><span><span style=color:#6272a4># 对于匹配 OUTPUT 链的流量，将会应用 CILIUM_OUTPUT_nat 规则。这是一个自定义链规则。</span>
</span></span><span style=display:flex><span>-A OUTPUT -m comment --comment <span style=color:#f1fa8c>&#34;kubernetes service portals&#34;</span> -j KUBE-SERVICES
</span></span><span style=display:flex><span><span style=color:#6272a4># 对于需要进行 Kubernetes 服务暴露的流量，将会应用 KUBE-SERVICES 规则链。</span>
</span></span><span style=display:flex><span>-A POSTROUTING -m comment --comment <span style=color:#f1fa8c>&#34;cilium-feeder: CILIUM_POST_nat&#34;</span> -j CILIUM_POST_nat
</span></span><span style=display:flex><span><span style=color:#6272a4># 对于匹配 POSTROUTING 链的流量，将会应用 CILIUM_POST_nat 规则。这是一个自定义链规则。</span>
</span></span><span style=display:flex><span>-A POSTROUTING -m comment --comment <span style=color:#f1fa8c>&#34;kubernetes postrouting rules&#34;</span> -j KUBE-POSTROUTING
</span></span><span style=display:flex><span><span style=color:#6272a4># 对于需要进行 Kubernetes 集群内转发的流量，将会应用 KUBE-POSTROUTING 规则链。</span>
</span></span><span style=display:flex><span>-A POSTROUTING -s 33.0.0.0/8 ! -d 33.0.0.0/8 -j MASQUERADE
</span></span><span style=display:flex><span><span style=color:#6272a4># 对于来自 33.0.0.0/8 子网的流量（但不是目标地址为该子网的流量），将会进行地址伪装。</span>
</span></span><span style=display:flex><span>-A POSTROUTING -s 192.168.0.0/16 ! -d 192.168.0.0/16 -j MASQUERADE
</span></span><span style=display:flex><span><span style=color:#6272a4># 对于来自 192.168.0.0/16 子网的流量（但不是目标地址为该子网的流量），将会进行地址伪装。</span>
</span></span><span style=display:flex><span>-A POSTROUTING -m mark --mark 0x21 -j MASQUERADE
</span></span><span style=display:flex><span>-A POSTROUTING -m mark --mark 0x21 -j MASQUERADE
</span></span><span style=display:flex><span><span style=color:#6272a4># 对于被标记为 0x21 的流量，将会进行地址伪装。</span>
</span></span><span style=display:flex><span>-A POSTROUTING -s 100.65.0.0/16 ! -d 100.65.0.0/16 -j MASQUERADE
</span></span><span style=display:flex><span><span style=color:#6272a4># 对于来自 100.65.0.0/16 子网的、不属于该子网的目标地址的流量，将会进行地址伪装。</span>
</span></span><span style=display:flex><span>-A POSTROUTING -s 100.64.0.0/10 ! -d 100.64.0.0/10 -j MASQUERADE
</span></span><span style=display:flex><span><span style=color:#6272a4># 对于来自 100.64.0.0/10 子网的、不属于该子网的目标地址的流量，也将会进行地址伪装。</span>
</span></span><span style=display:flex><span>-A POSTROUTING -o ol+ -m mark ! --mark 0x23 -j MASQUERADE
</span></span><span style=display:flex><span><span style=color:#6272a4># 对于在 ol+ 接口流出的被标记为不是 0x23 的流量，将会进行地址伪装。</span>
</span></span><span style=display:flex><span>-A CILIUM_POST_nat -s 100.64.64.0/24 ! -d 100.64.64.0/24 ! -o cilium_+ -m comment --comment <span style=color:#f1fa8c>&#34;cilium masquerade non-cluster&#34;</span> -j MASQUERADE
</span></span><span style=display:flex><span><span style=color:#6272a4># 对于来自 100.64.64.0/24 子网的、不属于该子网的目标地址的流量（且不是从 cilium_host 接口发送出去），将会进行地址伪装。</span>
</span></span><span style=display:flex><span>-A CILIUM_POST_nat -m mark --mark 0xa00/0xe00 -m comment --comment <span style=color:#f1fa8c>&#34;exclude proxy return traffic from masquerade&#34;</span> -j ACCEPT
</span></span><span style=display:flex><span><span style=color:#6272a4># 对于被标记为 0xa00/0xe00 的流量，将会排除不进行地址伪装的规则。</span>
</span></span><span style=display:flex><span>-A CILIUM_POST_nat ! -s 100.64.64.0/24 ! -d 100.64.64.0/24 -o cilium_host -m comment --comment <span style=color:#f1fa8c>&#34;cilium host-&gt;cluster masquerade&#34;</span> -j SNAT --to-source 100.64.64.84
</span></span><span style=display:flex><span><span style=color:#6272a4># 对于从 cilium_host 接口发送出去的、不属于 100.64.64.0/24 子网的目标地址的流量，将会进行地址伪装（源地址为 100.64.64.84）。</span>
</span></span><span style=display:flex><span>-A CILIUM_POST_nat -s 127.0.0.1/32 -o cilium_host -m comment --comment <span style=color:#f1fa8c>&#34;cilium host-&gt;cluster from 127.0.0.1 masquerade&#34;</span> -j SNAT --to-source 100.64.64.84
</span></span><span style=display:flex><span><span style=color:#6272a4># 对于从 127.0.0.1 发送出去的、不属于 100.64.64.0/24 子网的目标地址的流量，将会进行地址伪装（源地址为 100.64.64.84）。</span>
</span></span><span style=display:flex><span>-A CILIUM_POST_nat -o cilium_host -m mark --mark 0xf00/0xf00 -m conntrack --ctstate DNAT -m comment --comment <span style=color:#f1fa8c>&#34;hairpin traffic that originated from a local pod&#34;</span> -j SNAT --to-source 100.64.64.84
</span></span><span style=display:flex><span><span style=color:#6272a4># 对于从 cilium_host 接口发送出去的、被标记为 0xf00/0xf00 并且正在进行 DNAT 的流量，将会进行地址伪装（源地址为 100.64.64.84）。</span>
</span></span><span style=display:flex><span>-A KUBE-FIREWALL -j KUBE-MARK-DROP
</span></span><span style=display:flex><span><span style=color:#6272a4># 对于被匹配到 KUBE-FIREWALL 的流量，将会被标记为 0x8000/0x8000 进行丢弃。</span>
</span></span><span style=display:flex><span>-A KUBE-LOAD-BALANCER -j KUBE-MARK-MASQ
</span></span><span style=display:flex><span><span style=color:#6272a4># 对于需要进行负载均衡的流量，将会被标记为 0x4000/0x4000 进行地址伪装。</span>
</span></span><span style=display:flex><span>-A KUBE-MARK-DROP -j MARK --set-xmark 0x8000/0x8000
</span></span><span style=display:flex><span><span style=color:#6272a4># 对于需要被丢弃的流量，将会被标记为 0x8000/0x8000 然后直接丢弃。</span>
</span></span><span style=display:flex><span>-A KUBE-MARK-MASQ -j MARK --set-xmark 0x4000/0x4000
</span></span><span style=display:flex><span><span style=color:#6272a4># 对于需要进行地址伪装的流量，将会被标记为 0x4000/0x4000 进行地址伪装。</span>
</span></span><span style=display:flex><span>-A KUBE-NODE-PORT -p tcp -m comment --comment <span style=color:#f1fa8c>&#34;Kubernetes nodeport TCP port for masquerade purpose&#34;</span> -m <span style=color:#8be9fd;font-style:italic>set</span> --match-set KUBE-NODE-PORT-TCP dst -j KUBE-MARK-MASQ
</span></span><span style=display:flex><span><span style=color:#6272a4># 对于需要进行负载均衡的 TCP 流量，将会匹配到 Kubernetes 节点的端口上，并进行地址伪装。</span>
</span></span><span style=display:flex><span>-A KUBE-POSTROUTING -m mark ! --mark 0x4000/0x4000 -j RETURN
</span></span><span style=display:flex><span><span style=color:#6272a4># 对于没有匹配到前面规则的流量，将会直接返回。</span>
</span></span><span style=display:flex><span>-A KUBE-POSTROUTING -j MARK --set-xmark 0x4000/0x0
</span></span><span style=display:flex><span><span style=color:#6272a4># 对于需要进行地址伪装的流量，将会被标记为 0x4000/0x0 进行地址伪装。</span>
</span></span><span style=display:flex><span>-A KUBE-POSTROUTING -m comment --comment <span style=color:#f1fa8c>&#34;kubernetes service traffic requiring SNAT&#34;</span> -j MASQUERADE --random-fully
</span></span><span style=display:flex><span><span style=color:#6272a4># 对于需要进行 Kubernetes 服务的 SNAT 处理的流量，将会进行地址伪装。</span>
</span></span><span style=display:flex><span>-A KUBE-SERVICES ! -s 100.64.64.0/18 -m comment --comment <span style=color:#f1fa8c>&#34;Kubernetes service cluster ip + port for masquerade purpose&#34;</span> -m <span style=color:#8be9fd;font-style:italic>set</span> --match-set KUBE-CLUSTER-IP dst,dst -j KUBE-MARK-MASQ
</span></span><span style=display:flex><span><span style=color:#6272a4># 对于需要进行地址伪装的流量，如果目标地址不属于 100.64.64.0/18 子网，则进行地址伪装和标记。</span>
</span></span><span style=display:flex><span>-A KUBE-SERVICES -m comment --comment <span style=color:#f1fa8c>&#34;Kubernetes service external ip + port for masquerade and filter purpose&#34;</span> -m <span style=color:#8be9fd;font-style:italic>set</span> --match-set KUBE-EXTERNAL-IP dst,dst -j KUBE-MARK-MASQ
</span></span><span style=display:flex><span><span style=color:#6272a4># 对于需要进行地址伪装的、目标地址为本地 IP 的流量，将直接被接受（不需要进行地址伪装）。</span>
</span></span><span style=display:flex><span>-A KUBE-SERVICES -m comment --comment <span style=color:#f1fa8c>&#34;Kubernetes service external ip + port for masquerade and filter purpose&#34;</span> -m <span style=color:#8be9fd;font-style:italic>set</span> --match-set KUBE-EXTERNAL-IP dst,dst -m physdev ! --physdev-is-in -m addrtype ! --src-type LOCAL -j ACCEPT
</span></span><span style=display:flex><span><span style=color:#6272a4># 对于需要进行地址伪装的、目标地址为本地节点的 Kubernetes 服务流量，将会匹配到 Kubernetes 节点的端口上进行处理。</span>
</span></span><span style=display:flex><span>-A KUBE-SERVICES -m comment --comment <span style=color:#f1fa8c>&#34;Kubernetes service external ip + port for masquerade and filter purpose&#34;</span> -m <span style=color:#8be9fd;font-style:italic>set</span> --match-set KUBE-EXTERNAL-IP dst,dst -m addrtype --dst-type LOCAL -j ACCEPT
</span></span><span style=display:flex><span><span style=color:#6272a4># 对于需要进行地址伪装的、目标地址为 Kubernetes 服务的流量，并且流量的目标地址属于当前集群，则直接接受（不需要进行地址伪装）。</span>
</span></span><span style=display:flex><span>-A KUBE-SERVICES -m addrtype --dst-type LOCAL -j KUBE-NODE-PORT
</span></span><span style=display:flex><span><span style=color:#6272a4># 如果流量的目标地址为本地地址，则需要匹配到 Kubernetes 节点的端口上进行处理。这里的本地地址指的是本地主机上的 IP 地址。</span>
</span></span><span style=display:flex><span>-A KUBE-SERVICES -m <span style=color:#8be9fd;font-style:italic>set</span> --match-set KUBE-CLUSTER-IP dst,dst -j ACCEPT
</span></span><span style=display:flex><span><span style=color:#6272a4># 如果流量的目标地址为 Kubernetes 服务的集群 IP 地址，则直接接受该流量，不需要进行地址伪装。这里的集群 IP 地址是指由 Kubernetes 控制平面分配给服务的虚拟 IP 地址。</span>
</span></span></code></pre></div><hr><ul class=pager><li class=previous><a href=/post/2023-08-12-cilium-mesh-example/ data-toggle=tooltip data-placement=top title="Cilium Mesh 常见场景与示例">&larr;
Previous Post</a></li><li class=next><a href=/post/2023-09-02-ambient-mesh-learn-first/ data-toggle=tooltip data-placement=top title="初识 Istio Ambient Mesh 新模式">Next
Post &rarr;</a></li></ul></div><div class="col-lg-2 col-lg-offset-0
visible-lg-block
sidebar-container
catalog-container"><div class=side-catalog><hr class="hidden-sm hidden-xs"><h5><a class=catalog-toggle href=#>CATALOG</a></h5><ul class=catalog-body></ul></div></div><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
sidebar-container"></div></div></div></article><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"><li><a href=mailto:tanjunchen20@gmail.com><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=/img/wechat.jpg><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-weixin fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://github.com/tanjunchen><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="copyright text-muted">Copyright &copy; 陈谭军 2023</p></div></div></div></footer><script>function loadAsync(e,t){var s=document,o="script",n=s.createElement(o),i=s.getElementsByTagName(o)[0];n.src=e,t&&n.addEventListener("load",function(e){t(null,e)},!1),i.parentNode.insertBefore(n,i)}</script><script>$("#tag_cloud").length!==0&&loadAsync("/js/jquery.tagcloud.js",function(){$.fn.tagcloud.defaults={color:{start:"#bbbbee",end:"#0085a1"}},$("#tag_cloud a").tagcloud()})</script><script>loadAsync("https://cdn.jsdelivr.net/npm/fastclick@1.0.6/lib/fastclick.min.js",function(){var e=document.querySelector("nav");e&&FastClick.attach(e)})</script><script type=text/javascript>function generateCatalog(e){_containerSelector="div.post-container";var t,n,s,o,i,r=$(_containerSelector),a=r.find("h1,h2,h3,h4,h5,h6");return $(e).html(""),a.each(function(){n=$(this).prop("tagName").toLowerCase(),i="#"+$(this).prop("id"),s=$(this).text(),t=$('<a href="'+i+'" rel="nofollow">'+s+"</a>"),o=$('<li class="'+n+'_nav"></li>').append(t),$(e).append(o)}),!0}generateCatalog(".catalog-body"),$(".catalog-toggle").click(function(e){e.preventDefault(),$(".side-catalog").toggleClass("fold")}),loadAsync("/js/jquery.nav.js",function(){$(".catalog-body").onePageNav({currentClass:"active",changeHash:!1,easing:"swing",filter:"",scrollSpeed:700,scrollOffset:0,scrollThreshold:.2,begin:null,end:null,scrollChange:null,padding:80})})</script></body></html>