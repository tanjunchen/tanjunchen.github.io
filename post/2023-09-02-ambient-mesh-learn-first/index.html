<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:site_name" content="漫步远方，心荡神往"><meta property="og:type" content="article"><meta property="og:image" content="https://tanjunchen.github.io/img/home.webp"><meta property="twitter:image" content="https://tanjunchen.github.io/img/home.webp"><meta name=title content="初识 Istio Ambient Mesh 新模式"><meta property="og:title" content="初识 Istio Ambient Mesh 新模式"><meta property="twitter:title" content="初识 Istio Ambient Mesh 新模式"><meta name=description content="Ambient Mesh，这是 Istio 提供的一种新的数据平面模式，旨在简化操作，提供更广泛的应用兼容性，并降低基础设施的成本。Ambient mesh 使得用户可以选择使用一种可以集成到其基础设施中的 Mesh 数据平面，而不是需要和应用一起部署的 sidecar。同时，该模式可以提供和 Sidecar 模式相同的零信任安全、遥测和流量管理等 Istio 的核心功能。目前 Ambient mesh 处于 alpha 阶段。"><meta property="og:description" content="Ambient Mesh，这是 Istio 提供的一种新的数据平面模式，旨在简化操作，提供更广泛的应用兼容性，并降低基础设施的成本。Ambient mesh 使得用户可以选择使用一种可以集成到其基础设施中的 Mesh 数据平面，而不是需要和应用一起部署的 sidecar。同时，该模式可以提供和 Sidecar 模式相同的零信任安全、遥测和流量管理等 Istio 的核心功能。目前 Ambient mesh 处于 alpha 阶段。"><meta property="twitter:description" content="Ambient Mesh，这是 Istio 提供的一种新的数据平面模式，旨在简化操作，提供更广泛的应用兼容性，并降低基础设施的成本。Ambient mesh 使得用户可以选择使用一种可以集成到其基础设施中的 Mesh 数据平面，而不是需要和应用一起部署的 sidecar。同时，该模式可以提供和 Sidecar 模式相同的零信任安全、遥测和流量管理等 Istio 的核心功能。目前 Ambient mesh 处于 alpha 阶段。"><meta property="twitter:card" content="summary"><meta name=keyword content="陈谭军, 互联网, 云原生, 容器, 微服务, Web, PaaS, Istio, Kubernetes, Microservice"><link rel="shortcut icon" href=/img/favicon.ico><title>初识 Istio Ambient Mesh 新模式 | 陈谭军的博客 | tanjunchen Blog</title><link rel=canonical href=/post/2023-09-02-ambient-mesh-learn-first/><link rel=stylesheet href=/css/bootstrap.min.css><link rel=stylesheet href=/css/hugo-theme-cleanwhite.min.css><link rel=stylesheet href=/css/zanshang.css><link rel=stylesheet href=/css/font-awesome.all.min.css><script src=/js/jquery.min.js></script>
<script src=/js/bootstrap.min.js></script>
<script src=/js/hux-blog.min.js></script>
<script src=/js/lazysizes.min.js></script></head><nav class="navbar navbar-default navbar-custom navbar-fixed-top"><div class=container-fluid><div class="navbar-header page-scroll"><button type=button class=navbar-toggle>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span></button>
<a class=navbar-brand href=/>漫步远方，心荡神往</a></div><div id=huxblog_navbar><div class=navbar-collapse><ul class="nav navbar-nav navbar-right"><li><a href=/>All Posts</a></li><li><a href=/categories/technology/>technology</a></li><li><a href=/categories/think/>think</a></li><li><a href=/learning/>LEARNING</a></li><li><a href=/archive/>ARCHIVE</a></li><li><a href=/about/>ABOUT</a></li><li><a href=/search><i class="fa fa-search"></i></a></li></ul></div></div></div></nav><script>var $body=document.body,$toggle=document.querySelector(".navbar-toggle"),$navbar=document.querySelector("#huxblog_navbar"),$collapse=document.querySelector(".navbar-collapse");$toggle.addEventListener("click",handleMagic);function handleMagic(){$navbar.className.indexOf("in")>0?($navbar.className=" ",setTimeout(function(){$navbar.className.indexOf("in")<0&&($collapse.style.height="0px")},400)):($collapse.style.height="auto",$navbar.className+=" in")}</script><style type=text/css>header.intro-header{background-image:url(/img/home.webp)}</style><header class=intro-header><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><div class=tags><a class=tag href=/tags/ambient-mesh title=ambient-mesh>ambient-mesh</a>
<a class=tag href=/tags/istio title=istio>istio</a></div><h1>初识 Istio Ambient Mesh 新模式</h1><h2 class=subheading>初步了解 Istio 新数据平面 Ambient，目前 Ambient 尚处于 Alpha 阶段，Sidecar 模式依然是首选，但我相信 Ambient 模式是未来很好的选择。</h2><span class=meta>Posted by
陈谭军
on
Saturday, September 2, 2023
<span id=busuanzi_container_page_pv>|<span id=busuanzi_value_page_pv></span><span>
<span id=/post/2023-09-02-ambient-mesh-learn-first/ class="leancloud_visitors meta_data_item" data-flag-title><span class=post-meta-item-icon><span class="octicon octicon-eye"></span></span>
<i class="fa fa-eye"></i>
<span class=old-visitors-count style=display:none></span>
<span class=leancloud-visitors-count></span></span>
<script src=https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js></script>
<script>AV.initialize("","")</script><script type=text/javascript>function showTime(e){var n=new AV.Query(e),t=[],s=$(".leancloud_visitors");s.each(function(){t.push($(this).attr("id").trim())}),n.containedIn("url",t),n.find().done(function(e){for(var s,o,i,a,r,c,l=".leancloud-visitors-count",d=".old-visitors-count",n=0;n<e.length;n++)a=e[n],i=a.get("url"),c=a.get("time"),s=document.getElementById(i),$(s).find(l).text(c);for(n=0;n<t.length;n++)i=t[n],s=document.getElementById(i),o=$(s).find(l),o.text()==""&&(r=$(s).find(d).text(),r!=""?o.text(0+parseInt(r)):o.text(0))}).fail(function(e,t){console.log("Error: "+t.code+" "+t.message)})}function addCount(e){var n=$(".leancloud_visitors"),t=n.attr("id").trim(),o=n.attr("data-flag-title").trim(),s=new AV.Query(e);s.equalTo("url",t),s.find({success:function(n){if(n.length>0){var s,i,r,c,l,a=n[0];a.fetchWhenSave(!0),a.increment("time"),a.save(null,{success:function(e){var n=$(document.getElementById(t));n.find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to save Visitor num, with error message: "+t.message)}})}else s=new e,i=new AV.ACL,i.setPublicReadAccess(!0),i.setPublicWriteAccess(!0),s.setACL(i),s.set("title",o),s.set("url",t),c=".old-visitors-count",l=$(document.getElementById(t)),r=l.find(c).text(),r!=""?s.set("time",parseInt(r)+1):s.set("time",1),s.save(null,{success:function(e){var n=$(document.getElementById(t));n.find(".leancloud-visitors-count").text(e.get("time"))},error:function(){console.log("Failed to create")}})},error:function(e){console.log("Error:"+e.code+" "+e.message)}})}$(function(){var e=AV.Object.extend("Counter");$(".leancloud_visitors").length==1?addCount(e):showTime(e)})</script>阅读 </span></span>|<span class=post-date>共 5866 字</span>，阅读约 <span class=more-meta>12 分钟</span></span></div></div></div></div></header><article><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
post-container"><p>Ambient Mesh，这是 Istio 提供的一种新的数据平面模式，旨在简化操作，提供更广泛的应用兼容性，并降低基础设施的成本。Ambient mesh 使得用户可以选择使用一种可以集成到其基础设施中的 Mesh 数据平面，而不是需要和应用一起部署的 sidecar。同时，该模式可以提供和 Sidecar 模式相同的零信任安全、遥测和流量管理等 Istio 的核心功能，目前 Ambient mesh 处于 alpha 阶段。</p><h1 id=安装-ambient-mesh>安装 Ambient Mesh</h1><p><strong>前提条件</strong><br><em>要求 Kubernetes 版本 1.24, 1.25, 1.26, 1.27+。</em><br><em>istio 1.18+。</em></p><p><em>Ambient 目前处于 alpha，alpha 版本中存在已知的性能、稳定性和安全问题，请不要在生产环境中使用。mbient 目前需要使用 istio-cni 来配置 Kubernetes 网络规则，istio-cni 模式目前不支持某些 CNI 类型（即不使用 veth 设备的 CN，如桥接模式）</em></p><p>下载最新版本的 <a href=https://github.com/istio/istio/releases>Istio</a>，其中 alpha 版本提供对 ambient mesh 的支持。</p><p>使用 Kind 部署 Kubernetes 集群。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kind create cluster --config<span style=color:#ff79c6>=</span>- <span style=color:#f1fa8c>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>kind: Cluster
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>apiVersion: kind.x-k8s.io/v1alpha4
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>name: ambient
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>nodes:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>- role: control-plane
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>- role: worker
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>- role: worker
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>EOF</span>
</span></span></code></pre></div><p><img src=/images/2023-09-02-ambient-mesh-learn-first/1.png alt></p><p>如果我们的 Kubernetes 集群不支持 Kubernetes Gateway CRDs，可以参考以下方式安装。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get crd gateways.gateway.networking.k8s.io &amp;&gt; /dev/null <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span> <span style=color:#ff79c6>{</span> kubectl kustomize <span style=color:#f1fa8c>&#34;github.com/kubernetes-sigs/gateway-api/config/crd/experimental?ref=v0.6.1&#34;</span> | kubectl apply -f -; <span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>使用 istioctl 安装 Istio 集群</p><pre tabindex=0><code>istioctl install --set profile=ambient --skip-confirmation
</code></pre><p><img src=/images/2023-09-02-ambient-mesh-learn-first/2.png alt></p><p><img src=/images/2023-09-02-ambient-mesh-learn-first/3.png alt></p><p>运行上述命令后，如下所示，相关组件（含 ztunnel）已成功安装。</p><p><img src=/images/2023-09-02-ambient-mesh-learn-first/4.png alt></p><p>ambient profile 在集群中安装了 Istiod, ingress gateway, ztunnel 和 istio-cni 组件。其中 ztunnel 和 istio-cni 以 daemonset 方式部署在每个 node 上。istio-cni 用于检测 pod 是否处于 ambient 模式，监听并且同步创建与更新 pod 出向流量和入向流量重定向到 node 的 ztunnel 的 iptables 规则。</p><h1 id=部署-demo-应用>部署 demo 应用</h1><p>执行下面的命令，部署 demo 测试应用，我们使用 Istio 官网示例 bookinfo 应用程序。确保 default 命名空间不包含标签 istio-injection=enabled。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f samples/bookinfo/platform/kube/bookinfo.yaml
</span></span><span style=display:flex><span>kubectl apply -f samples/sleep/sleep.yaml
</span></span><span style=display:flex><span>kubectl apply -f samples/sleep/notsleep.yaml
</span></span></code></pre></div><p>应用列表如下所示：</p><p><img src=/images/2023-09-02-ambient-mesh-learn-first/5-1.png alt></p><p>部署入口网关，我们可以从集群外部访问 bookinfo 应用程序。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f samples/bookinfo/networking/bookinfo-gateway.yaml
</span></span></code></pre></div><p>配置 Istio 入口网关环境变量。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>GATEWAY_HOST</span><span style=color:#ff79c6>=</span>istio-ingressgateway.istio-system
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>GATEWAY_SERVICE_ACCOUNT</span><span style=color:#ff79c6>=</span>ns/istio-system/sa/istio-ingressgateway-service-account
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl <span style=color:#8be9fd;font-style:italic>exec</span> deploy/sleep -- curl -s <span style=color:#f1fa8c>&#34;http://</span><span style=color:#8be9fd;font-style:italic>$GATEWAY_HOST</span><span style=color:#f1fa8c>/productpage&#34;</span> | grep -o <span style=color:#f1fa8c>&#34;&lt;title&gt;.*&lt;/title&gt;&#34;</span>
</span></span><span style=display:flex><span>kubectl <span style=color:#8be9fd;font-style:italic>exec</span> deploy/sleep -- curl -s http://productpage:9080/ | grep -o <span style=color:#f1fa8c>&#34;&lt;title&gt;.*&lt;/title&gt;&#34;</span>
</span></span><span style=display:flex><span>kubectl <span style=color:#8be9fd;font-style:italic>exec</span> deploy/notsleep -- curl -s http://productpage:9080/ | grep -o <span style=color:#f1fa8c>&#34;&lt;title&gt;.*&lt;/title&gt;&#34;</span>
</span></span></code></pre></div><p>测试结果如下所示，bookinfo 应用程序可以在有或没有网关的情况下都能正确访问。</p><p><img src=/images/2023-09-02-ambient-mesh-learn-first/6.png alt></p><h1 id=纳管-demo-应用到-ambient-mesh>纳管 demo 应用到 Ambient Mesh</h1><p>为 default namespace 打上标签来将该 namespace 中的所有应用加入 ambient mesh 中。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl label namespace default istio.io/dataplane-mode<span style=color:#ff79c6>=</span>ambient
</span></span></code></pre></div><p>我们查看 istio-cni 的日志，可以看到 istio-cni 为 default 命名空间下的应用 pod 创建了相应的路由规则：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n istio-system logs -f istio-cni-node-wf4rz
</span></span><span style=display:flex><span>2023-08-28T10:57:57.293344Z	info	ambient	Namespace default is enabled in ambient mesh
</span></span><span style=display:flex><span>2023-08-28T10:57:57.293403Z	info	ambient	Namespace istio-system is disabled from ambient mesh
</span></span><span style=display:flex><span>2023-08-28T11:36:14.314354Z	info	cni	istio-cni cmdAdd podName: details-v1-5ffd6b64f7-zmcjx podIPs: <span style=color:#ff79c6>[{</span>IP:10.244.1.23 Mask:ffffff00<span style=color:#ff79c6>}]</span>
</span></span><span style=display:flex><span>2023-08-28T11:36:14.314683Z	info	cni	Adding pod <span style=color:#f1fa8c>&#39;details-v1-5ffd6b64f7-zmcjx/default&#39;</span> <span style=color:#ff79c6>(</span>fdd0a7d4-b360-4df1-bc81-2a1808906233<span style=color:#ff79c6>)</span> to ipset
</span></span><span style=display:flex><span>2023-08-28T11:36:14.314688Z	info	cni	Adding route <span style=color:#ff79c6>for</span> details-v1-5ffd6b64f7-zmcjx/default: <span style=color:#ff79c6>[</span>table <span style=color:#bd93f9>100</span> 10.244.1.23/32 via 192.168.126.2 dev istioin src 10.244.1.1<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>2023-08-28T11:36:14.356859Z	info	cni	istio-cni cmdAdd podName: productpage-v1-8b588bf6d-qrbnw podIPs: <span style=color:#ff79c6>[{</span>IP:10.244.1.24 Mask:ffffff00<span style=color:#ff79c6>}]</span>
</span></span><span style=display:flex><span>2023-08-28T11:36:14.356927Z	info	cni	Adding pod <span style=color:#f1fa8c>&#39;productpage-v1-8b588bf6d-qrbnw/default&#39;</span> <span style=color:#ff79c6>(</span>44f702b9-98ae-4e78-b630-e0ae77428dd3<span style=color:#ff79c6>)</span> to ipset
</span></span><span style=display:flex><span>2023-08-28T11:36:14.356935Z	info	cni	Adding route <span style=color:#ff79c6>for</span> productpage-v1-8b588bf6d-qrbnw/default: <span style=color:#ff79c6>[</span>table <span style=color:#bd93f9>100</span> 10.244.1.24/32 via 192.168.126.2 dev istioin src 10.244.1.1<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>2023-08-28T11:36:14.373139Z	info	cni	istio-cni cmdAdd podName: ratings-v1-5f9699cfdf-ncvqw podIPs: <span style=color:#ff79c6>[{</span>IP:10.244.1.22 Mask:ffffff00<span style=color:#ff79c6>}]</span>
</span></span><span style=display:flex><span>2023-08-28T11:36:14.373186Z	info	cni	Adding pod <span style=color:#f1fa8c>&#39;ratings-v1-5f9699cfdf-ncvqw/default&#39;</span> <span style=color:#ff79c6>(</span>725b2415-0de4-4fd4-b3c4-47d6f60c2d5a<span style=color:#ff79c6>)</span> to ipset
</span></span><span style=display:flex><span>2023-08-28T11:36:14.373206Z	info	cni	Adding route <span style=color:#ff79c6>for</span> ratings-v1-5f9699cfdf-ncvqw/default: <span style=color:#ff79c6>[</span>table <span style=color:#bd93f9>100</span> 10.244.1.22/32 via 192.168.126.2 dev istioin src 10.244.1.1<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>2023-08-28T11:36:14.673081Z	info	cni	istio-cni cmdAdd podName: reviews-v1-569db879f5-24l6k podIPs: <span style=color:#ff79c6>[{</span>IP:10.244.1.25 Mask:ffffff00<span style=color:#ff79c6>}]</span>
</span></span><span style=display:flex><span>2023-08-28T11:36:14.673123Z	info	cni	Adding pod <span style=color:#f1fa8c>&#39;reviews-v1-569db879f5-24l6k/default&#39;</span> <span style=color:#ff79c6>(</span>abace4b5-872a-47e9-b3ae-9dacee882785<span style=color:#ff79c6>)</span> to ipset
</span></span><span style=display:flex><span>2023-08-28T11:36:14.673130Z	info	cni	Adding route <span style=color:#ff79c6>for</span> reviews-v1-569db879f5-24l6k/default: <span style=color:#ff79c6>[</span>table <span style=color:#bd93f9>100</span> 10.244.1.25/32 via 192.168.126.2 dev istioin src 10.244.1.1<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>2023-08-28T11:36:14.993462Z	info	cni	istio-cni cmdAdd podName: reviews-v2-65c4dc6fdc-ncnjs podIPs: <span style=color:#ff79c6>[{</span>IP:10.244.1.27 Mask:ffffff00<span style=color:#ff79c6>}]</span>
</span></span><span style=display:flex><span>2023-08-28T11:36:14.993618Z	info	cni	Adding pod <span style=color:#f1fa8c>&#39;reviews-v2-65c4dc6fdc-ncnjs/default&#39;</span> <span style=color:#ff79c6>(</span>967839fe-ad67-49b8-85ed-d9f4179da260<span style=color:#ff79c6>)</span> to ipset
</span></span><span style=display:flex><span>2023-08-28T11:36:14.993626Z	info	cni	Adding route <span style=color:#ff79c6>for</span> reviews-v2-65c4dc6fdc-ncnjs/default: <span style=color:#ff79c6>[</span>table <span style=color:#bd93f9>100</span> 10.244.1.27/32 via 192.168.126.2 dev istioin src 10.244.1.1<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>2023-08-28T11:36:15.300465Z	info	cni	istio-cni cmdAdd podName: reviews-v3-c9c4fb987-4ft5g podIPs: <span style=color:#ff79c6>[{</span>IP:10.244.1.26 Mask:ffffff00<span style=color:#ff79c6>}]</span>
</span></span><span style=display:flex><span>2023-08-28T11:36:15.300538Z	info	cni	Adding pod <span style=color:#f1fa8c>&#39;reviews-v3-c9c4fb987-4ft5g/default&#39;</span> <span style=color:#ff79c6>(</span>5f1119df-b3d6-47fd-b5c3-7bb15b2d7fdd<span style=color:#ff79c6>)</span> to ipset
</span></span><span style=display:flex><span>2023-08-28T11:36:15.300542Z	info	cni	Adding route <span style=color:#ff79c6>for</span> reviews-v3-c9c4fb987-4ft5g/default: <span style=color:#ff79c6>[</span>table <span style=color:#bd93f9>100</span> 10.244.1.26/32 via 192.168.126.2 dev istioin src 10.244.1.1<span style=color:#ff79c6>]</span>
</span></span></code></pre></div><p>发起测试请求，如下所示：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl <span style=color:#8be9fd;font-style:italic>exec</span> deploy/sleep -- curl -s <span style=color:#f1fa8c>&#34;http://</span><span style=color:#8be9fd;font-style:italic>$GATEWAY_HOST</span><span style=color:#f1fa8c>/productpage&#34;</span> | grep -o <span style=color:#f1fa8c>&#34;&lt;title&gt;.*&lt;/title&gt;&#34;</span>
</span></span><span style=display:flex><span>kubectl <span style=color:#8be9fd;font-style:italic>exec</span> deploy/sleep -- curl -s http://productpage:9080/ | grep -o <span style=color:#f1fa8c>&#34;&lt;title&gt;.*&lt;/title&gt;&#34;</span>
</span></span><span style=display:flex><span>kubectl <span style=color:#8be9fd;font-style:italic>exec</span> deploy/notsleep -- curl -s http://productpage:9080/ | grep -o <span style=color:#f1fa8c>&#34;&lt;title&gt;.*&lt;/title&gt;&#34;</span>
</span></span></code></pre></div><p>测试结果，如下所示：
<img src=/images/2023-09-02-ambient-mesh-learn-first/6-1.png alt></p><p>istio-system 命名空间下的 ztunnel Pod 列表如下所示：</p><p><img src=/images/2023-09-02-ambient-mesh-learn-first/7.png alt></p><p><img src=/images/2023-09-02-ambient-mesh-learn-first/8.png alt></p><p>查看 node 节点上的 sleep 与 productpage 对应的 ztunnel 访问日志，sleep 所在 node 上的 ztunnel 日志（outbound 请求），如下所示：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n istio-system logs -f ztunnel-w5zvr
</span></span><span style=display:flex><span>2023-08-28T11:39:33.716634Z  INFO outbound<span style=color:#ff79c6>{</span><span style=color:#8be9fd;font-style:italic>id</span><span style=color:#ff79c6>=</span>86e9d44b9a866661edd61c102465805e<span style=color:#ff79c6>}</span>: ztunnel::proxy::outbound: proxy to 10.244.1.24:9080 using HBONE via 10.244.1.24:15008 <span style=color:#8be9fd;font-style:italic>type</span> Direct
</span></span><span style=display:flex><span>2023-08-28T11:39:33.756833Z  INFO outbound<span style=color:#ff79c6>{</span><span style=color:#8be9fd;font-style:italic>id</span><span style=color:#ff79c6>=</span>86e9d44b9a866661edd61c102465805e<span style=color:#ff79c6>}</span>: ztunnel::proxy::outbound: <span style=color:#8be9fd;font-style:italic>complete</span> <span style=color:#8be9fd;font-style:italic>dur</span><span style=color:#ff79c6>=</span>42.17475ms
</span></span></code></pre></div><p><img src=/images/2023-09-02-ambient-mesh-learn-first/9.png alt></p><p>productpage 所在 node 上的 ztunnel 日志（inbound 请求），如下所示：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n istio-system logs -f ztunnel-8k6cp
</span></span><span style=display:flex><span>2023-08-28T11:41:06.835522Z  INFO inbound<span style=color:#ff79c6>{</span><span style=color:#8be9fd;font-style:italic>id</span><span style=color:#ff79c6>=</span>7fb5b4259eaf43c599f8d9f4fe2c5657 <span style=color:#8be9fd;font-style:italic>peer_ip</span><span style=color:#ff79c6>=</span>10.244.2.9 <span style=color:#8be9fd;font-style:italic>peer_id</span><span style=color:#ff79c6>=</span>spiffe://cluster.local/ns/default/sa/sleep<span style=color:#ff79c6>}</span>: ztunnel::proxy::inbound: got CONNECT request to 10.244.1.24:9080
</span></span></code></pre></div><p>因为 ambient 只开启了 L4，流量只会通过 ztunnel ，不会经过 waypoint proxy。此时应用程序的流量路径如下图所示：
<img src=/images/2023-09-02-ambient-mesh-learn-first/10.svg alt></p><p><strong>使用 Prometheus</strong></p><p>按照文档 <a href=https://istio.io/latest/docs/ops/integrations/prometheus/#installation>https://istio.io/latest/docs/ops/integrations/prometheus/#installation</a>，部署 Prometheus。</p><p><strong>使用 Kiali</strong></p><p>按照文档 <a href=https://istio.io/latest/docs/ops/integrations/kiali/#installation>https://istio.io/latest/docs/ops/integrations/kiali/#installation</a>，部署 Kiali。按照上述请求方式给 productpage 发送请求，kiali 流量拓扑图如下所示：
<img src=/images/2023-09-02-ambient-mesh-learn-first/11.png alt></p><h1 id=为-ambient-mesh-启用安全策略>为 Ambient Mesh 启用安全策略</h1><p>使用 L4 授权策略来保护应用程序访问，可以根据客户端工作负载身份来控制对服务的访问。以下案例只允许 sleep 和 gateway serviceaccount 调用 productpage 服务。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>kubectl apply -f - &lt;&lt;EOF
</span></span><span style=display:flex><span><span style=color:#ff79c6>apiVersion</span>: security.istio.io/v1beta1
</span></span><span style=display:flex><span><span style=color:#ff79c6>kind</span>: AuthorizationPolicy
</span></span><span style=display:flex><span><span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span> <span style=color:#ff79c6>name</span>: productpage-viewer
</span></span><span style=display:flex><span> <span style=color:#ff79c6>namespace</span>: default
</span></span><span style=display:flex><span><span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex><span> <span style=color:#ff79c6>selector</span>:
</span></span><span style=display:flex><span>   <span style=color:#ff79c6>matchLabels</span>:
</span></span><span style=display:flex><span>     <span style=color:#ff79c6>app</span>: productpage
</span></span><span style=display:flex><span> <span style=color:#ff79c6>action</span>: ALLOW
</span></span><span style=display:flex><span> <span style=color:#ff79c6>rules</span>:
</span></span><span style=display:flex><span> - <span style=color:#ff79c6>from</span>:
</span></span><span style=display:flex><span>   - <span style=color:#ff79c6>source</span>:
</span></span><span style=display:flex><span>       <span style=color:#ff79c6>principals</span>:
</span></span><span style=display:flex><span>       - cluster.local/ns/default/sa/sleep
</span></span><span style=display:flex><span>       - cluster.local/$GATEWAY_SERVICE_ACCOUNT
</span></span><span style=display:flex><span>EOF
</span></span></code></pre></div><p>我们发现，sleep 服务可以访问 productpage，而 notsleep 不行，符合预期，访问结果如下所示：
<img src=/images/2023-09-02-ambient-mesh-learn-first/12.png alt></p><h1 id=ambient-mesh-启用-l7-功能>Ambient Mesh 启用 L7 功能</h1><p>使用 Kubernetes Gateway API 来启用某个服务的 L7 功能，创建下面的 gateway，为 productpage 服务开启七层处理。任何流向 productpage 服务的流量都将由第 7 层(L7) 代理进行管理。为 productpage 部署 waypoint proxy，如下所示：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>istioctl x waypoint apply --service-account bookinfo-productpage
</span></span></code></pre></div><p><img src=/images/2023-09-02-ambient-mesh-learn-first/13.png alt></p><p>istioctl x waypoint 默认生成的 Gateway 如下所示：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>apiVersion</span>: gateway.networking.k8s.io/v1beta1
</span></span><span style=display:flex><span><span style=color:#ff79c6>kind</span>: Gateway
</span></span><span style=display:flex><span><span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>name</span>: bookinfo-productpage
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>namespace</span>: default
</span></span><span style=display:flex><span><span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>gatewayClassName</span>: istio-waypoint
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>listeners</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ff79c6>allowedRoutes</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>namespaces</span>:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>from</span>: Same
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>name</span>: mesh
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>port</span>: <span style=color:#bd93f9>15008</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>protocol</span>: ALL
</span></span></code></pre></div><p><img src=/images/2023-09-02-ambient-mesh-learn-first/14.png alt></p><p><img src=/images/2023-09-02-ambient-mesh-learn-first/15.png alt></p><p>istio-waypoint 会通过 Kubernetes Gateway 产生 bookinfo-productpage-istio-waypoint deploy 工作负载（istio-proxy 镜像），作为 productpage L7 流量管理的组件。此时可以查看到 Istio 创建的 waypoint proxy 如下所示：</p><p>重新使用 sleep 访问 productpage，如下所示：
<img src=/images/2023-09-02-ambient-mesh-learn-first/16.png alt></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl <span style=color:#8be9fd;font-style:italic>exec</span> deploy/sleep -- curl -s http://productpage:9080/ | grep -o <span style=color:#f1fa8c>&#34;&lt;title&gt;.*&lt;/title&gt;&#34;</span>
</span></span></code></pre></div><p>查看 node 节点上的 sleep 与 productpage 对应的 ztunnel 访问日志。</p><p>sleep 所在 node 上的 ztunnel 日志（outbound 请求）如下所示：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n istio-system logs -f ztunnel-w5zvr
</span></span><span style=display:flex><span>2023-08-28T11:48:01.666338Z  INFO outbound<span style=color:#ff79c6>{</span><span style=color:#8be9fd;font-style:italic>id</span><span style=color:#ff79c6>=</span>e69949c7ec4f07f497e5fb9460f520d5<span style=color:#ff79c6>}</span>: ztunnel::proxy::outbound: proxy to 10.96.138.243:9080 using HBONE via 10.244.1.28:15008 <span style=color:#8be9fd;font-style:italic>type</span> ToServerWaypoint
</span></span><span style=display:flex><span>2023-08-28T11:48:01.708804Z  INFO outbound<span style=color:#ff79c6>{</span><span style=color:#8be9fd;font-style:italic>id</span><span style=color:#ff79c6>=</span>e69949c7ec4f07f497e5fb9460f520d5<span style=color:#ff79c6>}</span>: ztunnel::proxy::outbound: <span style=color:#8be9fd;font-style:italic>complete</span> <span style=color:#8be9fd;font-style:italic>dur</span><span style=color:#ff79c6>=</span>43.172542ms
</span></span></code></pre></div><p>productpage 所在 node 上的 ztunnel 日志（inbound 请求），如下所示：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl -n istio-system logs -f ztunnel-8k6cp
</span></span><span style=display:flex><span>2023-08-28T11:49:36.808574Z  INFO inbound<span style=color:#ff79c6>{</span><span style=color:#8be9fd;font-style:italic>id</span><span style=color:#ff79c6>=</span>d691e6a37a21a781b30fee7d7401f4f3 <span style=color:#8be9fd;font-style:italic>peer_ip</span><span style=color:#ff79c6>=</span>10.244.1.28 <span style=color:#8be9fd;font-style:italic>peer_id</span><span style=color:#ff79c6>=</span>spiffe://cluster.local/ns/default/sa/bookinfo-productpage-istio-waypoint<span style=color:#ff79c6>}</span>: ztunnel::proxy::inbound: got CONNECT request to 10.244.1.24:9080
</span></span><span style=display:flex><span>bookinfo-productpage-istio-waypoint-68cb5fb4d6-pxzbr Pod 中的日志如下所示：
</span></span><span style=display:flex><span><span style=color:#ff79c6>{</span><span style=color:#f1fa8c>&#34;start_time&#34;</span>:<span style=color:#f1fa8c>&#34;2023-08-28T11:59:07.644Z&#34;</span>,<span style=color:#f1fa8c>&#34;upstream_host&#34;</span>:<span style=color:#f1fa8c>&#34;envoy://connect_originate/10.244.1.24:9080&#34;</span>,<span style=color:#f1fa8c>&#34;authority&#34;</span>:<span style=color:#f1fa8c>&#34;productpage:9080&#34;</span>,<span style=color:#f1fa8c>&#34;connection_termination_details&#34;</span>:null,<span style=color:#f1fa8c>&#34;response_code&#34;</span>:200,<span style=color:#f1fa8c>&#34;requested_server_name&#34;</span>:null,<span style=color:#f1fa8c>&#34;downstream_remote_address&#34;</span>:<span style=color:#f1fa8c>&#34;envoy://internal_client_address/&#34;</span>,<span style=color:#f1fa8c>&#34;upstream_local_address&#34;</span>:<span style=color:#f1fa8c>&#34;envoy://internal_client_address/&#34;</span>,<span style=color:#f1fa8c>&#34;method&#34;</span>:<span style=color:#f1fa8c>&#34;GET&#34;</span>,<span style=color:#f1fa8c>&#34;user_agent&#34;</span>:<span style=color:#f1fa8c>&#34;curl/8.2.1&#34;</span>,<span style=color:#f1fa8c>&#34;downstream_local_address&#34;</span>:<span style=color:#f1fa8c>&#34;10.96.138.243:9080&#34;</span>,<span style=color:#f1fa8c>&#34;x_forwarded_for&#34;</span>:null,<span style=color:#f1fa8c>&#34;route_name&#34;</span>:<span style=color:#f1fa8c>&#34;default&#34;</span>,<span style=color:#f1fa8c>&#34;bytes_sent&#34;</span>:1683,<span style=color:#f1fa8c>&#34;upstream_transport_failure_reason&#34;</span>:null,<span style=color:#f1fa8c>&#34;path&#34;</span>:<span style=color:#f1fa8c>&#34;/&#34;</span>,<span style=color:#f1fa8c>&#34;upstream_cluster&#34;</span>:<span style=color:#f1fa8c>&#34;inbound-vip|9080|http|productpage.default.svc.cluster.local&#34;</span>,<span style=color:#f1fa8c>&#34;bytes_received&#34;</span>:0,<span style=color:#f1fa8c>&#34;response_code_details&#34;</span>:<span style=color:#f1fa8c>&#34;via_upstream&#34;</span>,<span style=color:#f1fa8c>&#34;response_flags&#34;</span>:<span style=color:#f1fa8c>&#34;-&#34;</span>,<span style=color:#f1fa8c>&#34;upstream_service_time&#34;</span>:<span style=color:#f1fa8c>&#34;10&#34;</span>,<span style=color:#f1fa8c>&#34;request_id&#34;</span>:<span style=color:#f1fa8c>&#34;66401a61-0656-4838-9d84-df03448355f9&#34;</span>,<span style=color:#f1fa8c>&#34;protocol&#34;</span>:<span style=color:#f1fa8c>&#34;HTTP/1.1&#34;</span>,<span style=color:#f1fa8c>&#34;duration&#34;</span>:11<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>{</span><span style=color:#f1fa8c>&#34;duration&#34;</span>:2,<span style=color:#f1fa8c>&#34;route_name&#34;</span>:<span style=color:#f1fa8c>&#34;default&#34;</span>,<span style=color:#f1fa8c>&#34;authority&#34;</span>:<span style=color:#f1fa8c>&#34;productpage:9080&#34;</span>,<span style=color:#f1fa8c>&#34;bytes_sent&#34;</span>:1683,<span style=color:#f1fa8c>&#34;upstream_host&#34;</span>:<span style=color:#f1fa8c>&#34;envoy://connect_originate/10.244.1.24:9080&#34;</span>,<span style=color:#f1fa8c>&#34;protocol&#34;</span>:<span style=color:#f1fa8c>&#34;HTTP/1.1&#34;</span>,<span style=color:#f1fa8c>&#34;start_time&#34;</span>:<span style=color:#f1fa8c>&#34;2023-08-28T11:59:08.924Z&#34;</span>,<span style=color:#f1fa8c>&#34;upstream_cluster&#34;</span>:<span style=color:#f1fa8c>&#34;inbound-vip|9080|http|productpage.default.svc.cluster.local&#34;</span>,<span style=color:#f1fa8c>&#34;response_code&#34;</span>:200,<span style=color:#f1fa8c>&#34;request_id&#34;</span>:<span style=color:#f1fa8c>&#34;ab4922ee-f733-4625-84e3-f5c045d979e8&#34;</span>,<span style=color:#f1fa8c>&#34;upstream_transport_failure_reason&#34;</span>:null,<span style=color:#f1fa8c>&#34;response_flags&#34;</span>:<span style=color:#f1fa8c>&#34;-&#34;</span>,<span style=color:#f1fa8c>&#34;user_agent&#34;</span>:<span style=color:#f1fa8c>&#34;curl/8.2.1&#34;</span>,<span style=color:#f1fa8c>&#34;x_forwarded_for&#34;</span>:null,<span style=color:#f1fa8c>&#34;bytes_received&#34;</span>:0,<span style=color:#f1fa8c>&#34;method&#34;</span>:<span style=color:#f1fa8c>&#34;GET&#34;</span>,<span style=color:#f1fa8c>&#34;downstream_local_address&#34;</span>:<span style=color:#f1fa8c>&#34;10.96.138.243:9080&#34;</span>,<span style=color:#f1fa8c>&#34;requested_server_name&#34;</span>:null,<span style=color:#f1fa8c>&#34;connection_termination_details&#34;</span>:null,<span style=color:#f1fa8c>&#34;downstream_remote_address&#34;</span>:<span style=color:#f1fa8c>&#34;envoy://internal_client_address/&#34;</span>,<span style=color:#f1fa8c>&#34;upstream_service_time&#34;</span>:<span style=color:#f1fa8c>&#34;2&#34;</span>,<span style=color:#f1fa8c>&#34;response_code_details&#34;</span>:<span style=color:#f1fa8c>&#34;via_upstream&#34;</span>,<span style=color:#f1fa8c>&#34;path&#34;</span>:<span style=color:#f1fa8c>&#34;/&#34;</span>,<span style=color:#f1fa8c>&#34;upstream_local_address&#34;</span>:<span style=color:#f1fa8c>&#34;envoy://internal_client_address/&#34;</span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>可以从上面的日志中看到 (ToServerWaypoint) 标志，并且 bookinfo-productpage-istio-waypoint Envoy 有 access_log，说明请求经过 waypoint proxy，此时应用程序的流量路径如下图所示：</p><p><img src=/images/2023-09-02-ambient-mesh-learn-first/17.svg alt></p><p>使用 L7 授权策略来保护应用程序访问，可以根据客户端工作负载身份来控制对服务的访问。以下案例只允许 sleep 和 gateway serviceaccount 调用productpage 服务。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f - <span style=color:#f1fa8c>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>apiVersion: security.istio.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>kind: AuthorizationPolicy
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>metadata:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c> name: productpage-viewer
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c> namespace: default
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>spec:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c> selector:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>   matchLabels:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>     istio.io/gateway-name: bookinfo-productpage
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c> action: ALLOW
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c> rules:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c> - from:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>   - source:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>       principals:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>       - cluster.local/ns/default/sa/sleep
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>       - cluster.local/$GATEWAY_SERVICE_ACCOUNT
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>   to:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>   - operation:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>       methods: [&#34;GET&#34;]
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>EOF</span>
</span></span></code></pre></div><p>我们发现，sleep 服务只支持 GET 方法访问 productpage，其他服务与方法都不行，符合预期，访问结果如下所示：
<img src=/images/2023-09-02-ambient-mesh-learn-first/18.png alt></p><h1 id=ambient-mesh-配置-l7-流量管理>Ambient Mesh 配置 L7 流量管理</h1><p>同理，我们通过创建 gateway 为 review 服务启用 L7 能力。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>istioctl x waypoint apply --service-account bookinfo-reviews
</span></span></code></pre></div><p>bookinfo-reviews Yaml 文件如下所示：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>apiVersion</span>: gateway.networking.k8s.io/v1beta1
</span></span><span style=display:flex><span><span style=color:#ff79c6>kind</span>: Gateway
</span></span><span style=display:flex><span><span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>annotations</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>istio.io/for-service-account</span>: bookinfo-reviews
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>name</span>: bookinfo-reviews
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>namespace</span>: default
</span></span><span style=display:flex><span><span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>gatewayClassName</span>: istio-waypoint
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>listeners</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ff79c6>allowedRoutes</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>namespaces</span>:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>from</span>: Same
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>name</span>: mesh
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>port</span>: <span style=color:#bd93f9>15008</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>protocol</span>: ALL
</span></span></code></pre></div><p>分别通过 VirtualService 与 DestinationRule 创建路由策略，按 80/20 的比例将请求发送到 V1 和 V2 版本，如下所示：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>kubectl apply -f - &lt;&lt;EOF
</span></span><span style=display:flex><span><span style=color:#ff79c6>apiVersion</span>: networking.istio.io/v1alpha3
</span></span><span style=display:flex><span><span style=color:#ff79c6>kind</span>: DestinationRule
</span></span><span style=display:flex><span><span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>name</span>: reviews
</span></span><span style=display:flex><span><span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>host</span>: reviews
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>trafficPolicy</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>loadBalancer</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>simple</span>: RANDOM
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>subsets</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ff79c6>name</span>: v1
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>labels</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>version</span>: v1
</span></span><span style=display:flex><span>  - <span style=color:#ff79c6>name</span>: v2
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>labels</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>version</span>: v2
</span></span><span style=display:flex><span>  - <span style=color:#ff79c6>name</span>: v3
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>labels</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>version</span>: v3
</span></span><span style=display:flex><span>EOF
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl apply -f - &lt;&lt;EOF
</span></span><span style=display:flex><span><span style=color:#ff79c6>apiVersion</span>: networking.istio.io/v1alpha3
</span></span><span style=display:flex><span><span style=color:#ff79c6>kind</span>: VirtualService
</span></span><span style=display:flex><span><span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>name</span>: reviews
</span></span><span style=display:flex><span><span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>hosts</span>:
</span></span><span style=display:flex><span>    - reviews
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>http</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ff79c6>route</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ff79c6>destination</span>:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>host</span>: reviews
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>subset</span>: v1
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>weight</span>: <span style=color:#bd93f9>80</span>
</span></span><span style=display:flex><span>    - <span style=color:#ff79c6>destination</span>:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>host</span>: reviews
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>subset</span>: v2
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>weight</span>: <span style=color:#bd93f9>20</span>
</span></span><span style=display:flex><span>EOF
</span></span></code></pre></div><p>执行以下命令验证 10 个请求中大约 10% 的流量流向 Reviews-v2，测试结果符合预期，如下所示：</p><p><img src=/images/2023-09-02-ambient-mesh-learn-first/19.png alt></p><h1 id=与其他-mesh-对比>与其他 Mesh 对比</h1><p>我们简单来介绍 Mesh 周边生态（Istio、Ambient Mesh、Cilium Mesh等）与架构，并且做个对比。Istio 架构如下所示：</p><p><img src=/images/2023-09-02-ambient-mesh-learn-first/20.png alt></p><p>Ambient Mesh 架构如下所示，L4 流程如下所示：</p><p><img src=/images/2023-09-02-ambient-mesh-learn-first/21.png alt></p><p>Ambient Mesh 架构如下所示，L7 流程如下所示：</p><p><img src=/images/2023-09-02-ambient-mesh-learn-first/22.png alt></p><p>Cilium Mesh 架构如下所示：</p><p><img src=/images/2023-09-02-ambient-mesh-learn-first/23.png alt></p><p><img src=/images/2023-09-02-ambient-mesh-learn-first/24.png alt></p><p><img src=/images/2023-09-02-ambient-mesh-learn-first/24-2.png alt></p><table><thead><tr><th>功能</th><th>Ambient Mesh</th><th>Istio Mesh</th><th>Cilium Mesh</th></tr></thead><tbody><tr><td>数据平面</td><td>No sidecar(ztunnel + waypoint-proxy 模式)</td><td>sidecar 模式</td><td>cilium-agent + Envoy</td></tr><tr><td>L4</td><td>ztunnel + istio-cni</td><td>istio-proxy</td><td>cilium agent</td></tr><tr><td>L7</td><td>Ambient mesh 的每节点的 ztunnel 代理的固定开销较低，其 waypoint proxy 则可以动态伸缩，因此需要的资源预留总体上要少得多，资源开销较小，从而使集群的资源利用效率更高。</td><td>相比 Ambient Mesh，每个 Pod 需要单独为 istio-proxy 设置资源，资源开销较大</td><td>Envoy 是单节点部署，资源消耗较小</td></tr><tr><td>资源开销</td><td>ztunnel + waypoint-proxy</td><td>sidecar 模式</td><td>cilium-agent + Envoy</td></tr><tr><td>安全</td><td>较好</td><td>中等</td><td>较好</td></tr><tr><td>mtls</td><td>ztunnel</td><td>istio-proxy</td><td>cilium-agent + Envoy</td></tr><tr><td>per-proxy per-node 模式</td><td>否(部分)</td><td>否</td><td>是</td></tr><tr><td>支持 eBPF</td><td>支持</td><td>不支持</td><td>支持</td></tr><tr><td>&mldr;</td><td></td><td></td><td></td></tr></tbody></table><p>Cilium Mesh、Istio 和 Ambient Mesh 都是基于服务网格的解决方案，提供服务发现、负载均衡、流量管理、安全等功能，但技术实现和重点不同。Cilium Mesh 使用 Linux 内核 BPF 技术实现高效的数据包处理和过滤；Istio 使用 Envoy 代理实现流量管理、策略和认证授权等功能；Ambient Mesh 提供灵活的部署和扩容方案，并且支持基于社区标准的 API 协议。</p><h1 id=ambient-mesh-总结>Ambient Mesh 总结</h1><p>我们可以看到在 Ambient 模式下，我们不需要在对业务 Pod 注入 sidecar，将服务网格彻底下沉到了基础设施层面。原生 sidecar 功能由 ztunnel(L4) 与 waypoint proxy(L7) 提供支持，很好地解决了需要业务 pod template 增加 sidecar 模板问题。但是目前要为服务启用 L7 网格能力，必须显示创建一个 gateway(Kubernetes Gateway)，Istio 需要为每个服务账号创建一个 waypoint proxy deployment，步骤稍微繁琐，是个运维负担。目前 ambient 尚处于 alpha，sidecar 模式依然是首选，但我相信 ambient 模式是未来很好的选择。越来越多的产品 Mesh 化逐渐与 CNI 融合，使用 eBPF 进行网络加速。</p><h1 id=卸载--ambient-mesh>卸载 Ambient Mesh</h1><p>删除 default 命名空间 ambient-mesh 标识。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl label namespace default istio.io/dataplane-mode-
</span></span></code></pre></div><p>删除 sleep 与 notsleep 应用。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl delete -f samples/sleep/sleep.yaml
</span></span><span style=display:flex><span>kubectl delete -f samples/sleep/notsleep.yaml
</span></span></code></pre></div><p>删除 Gateway API CRDs。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl kustomize <span style=color:#f1fa8c>&#34;github.com/kubernetes-sigs/gateway-api/config/crd/experimental?ref=v0.6.1&#34;</span> | kubectl delete -f -
</span></span></code></pre></div><p>删除 productpage-viewer 授权策略，waypoint 代理，卸载 istio。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl delete authorizationpolicy productpage-viewer
</span></span><span style=display:flex><span>istioctl x waypoint delete --service-account bookinfo-reviews
</span></span><span style=display:flex><span>istioctl x waypoint delete --service-account bookinfo-productpage
</span></span><span style=display:flex><span>istioctl uninstall -y --purge
</span></span><span style=display:flex><span>kubectl delete namespace istio-system
</span></span></code></pre></div><h1 id=为什么系列>为什么系列</h1><p><strong>什么是 HBONE?</strong><br>Ambient mesh 使用 HTTP CONNECT over mTLS 来实现其安全隧道，并在流量路径中插入 waypoint proxy，我们把这种模式称为 HBONE（HTTP-Based Overlay Network Environment）。HBONE 提供了比 TLS 本身更干净的流量封装，同时实现了与通用负载平衡器基础设施的互操作性。Ambient mesh 将默认使用 <a href="https://www.nist.gov/standardsgov/compliance-faqs-federal-information-processing-standards-fips#:~:text=are%20FIPS%20developed%3F-,What%20are%20Federal%20Information%20Processing%20Standards%20(FIPS)%3F,by%20the%20Secretary%20of%20Commerce.">FIPS</a> 构建，以满足合规性需求。</p><p><img src=/images/2023-09-02-ambient-mesh-learn-first/25.png alt></p><p>ambient 模式采用了 <a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods/CONNECT>HTTP 的 CONNECT 方法</a>在 ztunnel 和 waypoint proxy 创建了一个隧道，通过该隧道来传输数据。</p><p><img src=/images/2023-09-02-ambient-mesh-learn-first/26.png alt></p><p><em>备注：除了 HTTP CONNECT 以外，采用 HTTP GET 和 POST 也可以创建 HTTP 隧道，这种方式创建的隧道的原理是将 TCP 数据封装到 HTTP 数据包中发送到外部服务器，该外部服务器会提取并执行客户端的原始网络请求。外部服务器收到此请求的响应后，将其重新打包为 HTTP 响应，并发送回客户端。在这种方式中，客户端所有流量都封装在 HTTP GET 或者 POST 请求中。</em></p><p><strong>Istio Ambient 是如何实现 HBONE?</strong><br>采用 Envoy 来创建 HTTP CONNECT 隧道，并对隧道中的数据进行 HTTP 处理。
<img src=/images/2023-09-02-ambient-mesh-learn-first/27.png alt></p><p>Istio HBONE 采用了上面介绍的方法来创建 HTTP CONNET 隧道，TCP 流量在进入隧道时会进行 mTLS 加密，在出隧道时进行 mTLS 卸载。一个采用 HBONE 创建的连接如下所示：
<img src=/images/2023-09-02-ambient-mesh-learn-first/28.png alt></p><p>HBONE 由于采用了 HTTP CONNECT 创建隧道，还可以在 HTTP CONNECT 请求中加入一些 header 来很方便地在 downstream 和 upstream 之间传递上下文信息，包括：</p><ul><li>authority - 请求的原始目的地址，例如 1.2.3.4:80。</li><li>X-Forwarded-For（可选） - 请求的原始源地址，用于在多跳访问之间保留源地址。</li><li>baggage (可选) - client/server 的一些元数据，在 telemetry 中使用。</li></ul><p>具体可以参考 <a href=https://www.zhaohuabing.com/post/2022-09-11-ambient-deep-dive-1/>Istio Ambient 模式流量管理实现机制详解 - HBONE 隧道原理</a>。</p><p><strong>什么是 ztunnel ？为什么 Istio 会使用 ztunnel？</strong><br>ztunnel(Rust 编写) 实现了服务网格的核心功能：零信任。当为一个 namespace 启用 ambient 时，Istio 会创建一个安全覆盖层(secure overlay)，该安全覆盖层为工作负载提供 mTLS, 遥测和认证，以及 L4 权限控制，并不需要中断 HTTP 链接或者解析 HTTP 数据。<br><img src=/images/2023-09-02-ambient-mesh-learn-first/29.png alt></p><p><strong>什么是 waypoint proxy？</strong><br>当我们需要支持 L7 流量时，Istio 控制平面会配置集群中的 ztunnel，将所有需要进行 L7 处理的流量发送到 waypoint proxy。重要的是，从 Kubernetes 的角度来看，waypoint proxy（istio-proxy） 只是普通的 pod，可以像其他 Kubernetes 工作负载一样进行自动伸缩。由于 waypoint proxy 可以根据其服务的 namespace 的实时流量需求进行自动伸缩，而不是按照可能的最大工作负载进行配置，我们预计这将为用户节省大量资源。<br><img src=/images/2023-09-02-ambient-mesh-learn-first/30.png alt></p><p><strong>abient mesh 为何不在本地节点（daemonset）上进行 L7 处理，而引入 waypoint?</strong></p><ul><li>多租户 - Envoy 本质上并不支持多租户。因此如果共享 L7 代理，则需要在一个共享代理实例中对来自多个租户的 L7 流量一起进行复杂的规则处理，我们对这种做法有安全顾虑。通过严格限制只在共享代理中进行 L4 处理，我们大大减少了出现 CVE 的几率。</li><li>成本 - 与 waypoint proxy 所需的 L7 处理相比，ztunnel 所提供的 mTLS 和 L4 功能需要的 CPU 和内存占用要小得多。通过将 waypoint proxy 作为一个共享的 namespace 基本的资源来运行，我们可以根据该 namespace 的需求来对它们进独立伸缩，其成本不会不公平地分配给不相关的租户。</li><li>解耦 - 通过减少 ztunnel 的作用范围，我们可以很容易为 Istio 和 ztunnel 之间的互操作定义一个标准接口，并可以使用其他满足该标准接口的安全隧道的实现替换 ztunnel。</li></ul><p><strong>在 ambient mesh 模式中，waypoint 与他服务的工作负载不在同一个 Node，增加的网络链路是不是成为性能问题？</strong></p><ul><li>事实上，Istio 的大部分网络延迟并不是来自于网络（现代的云供应商拥有极快的网络），而是来自于实现其复杂的功能特性所需的大量 L7 处理。sidecar 模式中每个连接需要两个 L7 处理步骤（both sidecar），而 ambient mesh 将这两个步骤合并成 one sidecar。在大多数情况下，我们认为这种减少的处理成本能够补偿额外的网络跳数带来的延迟。</li><li>在部署 Mesh 时，用户往往首先启用零信任安全，然后再根据需要选择性地启用 L7 功能。Ambient mesh 允许这些用户在不需要 L7 处理时完全避开其带来的成本。</li></ul><p><strong>CNI ptp 与 bridge 网络模式是？</strong><br>关于 bridge 桥接模式可以参考 <a href=https://www.cni.dev/plugins/current/main/bridge/>cni-bridge</a>，关于 ptp 网络模型可以参考 <a href=https://www.cni.dev/plugins/current/main/ptp/>cni-ptp</a>。ambient 目前还不支持 <a href=https://www.cni.dev/plugins/current/main/bridge/>bridige</a> 模式。pod 和 node 通过 <a href=https://www.cni.dev/plugins/current/main/ptp/>ptp</a> 方式连接，即 pod 和 node 之间通过一个 veth pair 连接，并通过设置 node 上的路由规则来打通 pod 和 node 之间的网络。</p><p><strong>ztunnel 是如何实现流量劫持的？</strong><br>Istio 采用了 iptables 规则、策略路由<a href=https://en.wikipedia.org/wiki/Policy-based_routing>Policy-based Routing</a>、TPROXY 等 linux 网络工具来将应用 pod 的流量转发到 ztunnel。Ambient 模式修改了 node 上的 iptables 规则和路由，和某些 k8s cni 插件可能出现冲突。相对而言，sidecar 模式只会影响到 pod 自身的 network namespace，和 k8s cni 的兼容性较好。ambient 模式目前只支持 ptp 类型的 k8s 网络，bridige 模式目前还不支持。</p><p>outbound 流量劫持 outbound 方向的流量劫持主要涉及两个步骤：</p><ul><li>采用 node 上的 iptables 规则和策略路由将应用 pod 的 outbound 流量路由到 ztunnel pod。</li><li>采用 TPROXY 将进入 ztunnel pod 的 outbound 流量重定向到 envoy 的 15001 端口。</li></ul><p><img src=/images/2023-09-02-ambient-mesh-learn-first/31.png alt></p><p>inbound 流量劫持 inbound 方向的流量劫持和 outbound 类似，也主要涉及两个步骤：</p><ol><li>采用 node 上的策略路由将应用 pod 的 inbound 流量路由到 ztunnel pod。</li><li>采用 TPROXY 将进入 ztunnel pod 的 inbound 流量重定向到 envoy 的 15006 和 15008 端口。其中 15006 处理 plain tcp 数据，15008 处理 tls 数据。</li></ol><p><img src=/images/2023-09-02-ambient-mesh-learn-first/32.png alt></p><p><em>目前的 iptables 应该还会设置 connmark 来跟踪，只有首包会走到 istioout 和 istioin，后续的包会走到 0x400 的 mark 直接走 veth pair 不封包了。抓包的话也可以看到只有 SYN 到了 istioin 的网卡。大家可以试试。</em></p><p>具体可以参考 <a href=https://www.zhaohuabing.com/post/2022-09-11-ambient-deep-dive-2/>Istio Ambient 模式流量管理实现机制详解 - ztunnel 流量劫持</a></p><p><strong>什么是 istio-cni？为什么 Istio 提供 istio-cni？</strong><br>默认情况下，Istio 需要在网格中部署的 pod 中注入一个 init 容器 istio-init。istio-init 容器初始化拦截 Pod 进出流量到 sidecar iptables 规则。istio-init 要求将 pod 部署到网格的用户或服务帐户拥有足够的 Kubernetes RBAC 权限来部署具有 NET_ADMIN 和 NET_RAW 功能的容器。</p><p><em>注意：Istio CNI 插件作为链式 CNI 插件运行，它设计与其他 CNI 插件（例如 PTP 或 Calico）一起使用。 有关详细信息，请参阅与其他 CNI 插件，见 <a href=https://istio.io/latest/docs/setup/additional-setup/cni/#compatibility-with-other-cni-plugins>CNI 兼容性</a>。</em></p><p><strong>什么是 geneve tunnel？为啥 ztunnel 不使用 veth-pair 而使用 geneve geneve？</strong><br><img src=/images/2023-09-02-ambient-mesh-learn-first/33.png alt><br>具体可参见 <a href=https://jimmysong.io/en/blog/traffic-interception-with-geneve-tunnel-with-istio-ambient-mesh/>Using Geneve Tunnels to Implement Istio Ambient Mesh Traffic Interception</a> 或者<a href=https://jimmysong.io/blog/traffic-interception-with-geneve-tunnel-with-istio-ambient-mesh/>使用 Geneve 隧道实现 Istio Ambient Mesh 的流量拦截</a>。</p><p><strong>Istio 支持 eBPF 作为 datapath?</strong></p><p>在 Istio 1.18 中，增加了 eBPF 选项，你可以选择使用 iptables 或 eBPF 来做流量劫持。使用 eBPF 方式避免了部分 iptables 规则和隧道封装，相比使用 iptables 和 Geneve 隧道更加高效。只需要在安装 Istio 时设置values.cni.ambient.redirectMode参数即可，如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>istioctl install --set <span style=color:#8be9fd;font-style:italic>profile</span><span style=color:#ff79c6>=</span>ambient --set values.cni.ambient.redirectMode<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;ebpf&#34;</span>
</span></span></code></pre></div><p>&mldr;&mldr;当然，Ambient Mesh 肯定不止这些内容需要我们去研究，如 L4 劫持过程、L7 劫持过程、ztunnel 实现原理，
这些内容后续在继续深入调研与研究。</p><h1 id=参考与致谢>参考与致谢</h1><ol><li><a href=https://istio.io/latest/blog/2023/ambient-merged-istio-main/>2023-ambient-merged-istio-main</a></li><li><a href=https://istio.io/latest/docs/ops/ambient/getting-started/#download>Getting Started with Ambient Mesh</a></li><li><a href=https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/other_features/ip_transparency.html>Envoy IP Transparency</a></li><li><a href=https://istio.io/latest/blog/2022/introducing-ambient-mesh/>Introducing Ambient Mesh</a></li><li><a href=https://tetrate.io/blog/l7-traffic-path-in-ambient-mesh/>l7-traffic-path-in-ambient-mesh</a></li><li><a href=https://www.zhaohuabing.com/tags/ambient-mesh/>zhaohubing-ambient-mesh</a></li></ol><hr><ul class=pager><li class=previous><a href=/post/2023-08-19-cilium-iptables/ data-toggle=tooltip data-placement=top title="浅析 Cilium 与 iptables">&larr;
Previous Post</a></li><li class=next><a href=/post/2023-09-16-kubernetes-service/ data-toggle=tooltip data-placement=top title="深入研究 Kubernetes 集群中的 Service 通信机制">Next
Post &rarr;</a></li></ul></div><div class="col-lg-2 col-lg-offset-0
visible-lg-block
sidebar-container
catalog-container"><div class=side-catalog><hr class="hidden-sm hidden-xs"><h5><a class=catalog-toggle href=#>CATALOG</a></h5><ul class=catalog-body></ul></div></div><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
sidebar-container"></div></div></div></article><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"><li><a href=mailto:tanjunchen20@gmail.com><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=/img/wechat.jpg><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-weixin fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://github.com/tanjunchen><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="copyright text-muted">Copyright &copy; 陈谭军 2023</p></div></div></div></footer><script>function loadAsync(e,t){var s=document,o="script",n=s.createElement(o),i=s.getElementsByTagName(o)[0];n.src=e,t&&n.addEventListener("load",function(e){t(null,e)},!1),i.parentNode.insertBefore(n,i)}</script><script>$("#tag_cloud").length!==0&&loadAsync("/js/jquery.tagcloud.js",function(){$.fn.tagcloud.defaults={color:{start:"#bbbbee",end:"#0085a1"}},$("#tag_cloud a").tagcloud()})</script><script>loadAsync("https://cdn.jsdelivr.net/npm/fastclick@1.0.6/lib/fastclick.min.js",function(){var e=document.querySelector("nav");e&&FastClick.attach(e)})</script><script type=text/javascript>function generateCatalog(e){_containerSelector="div.post-container";var t,n,s,o,i,r=$(_containerSelector),a=r.find("h1,h2,h3,h4,h5,h6");return $(e).html(""),a.each(function(){n=$(this).prop("tagName").toLowerCase(),i="#"+$(this).prop("id"),s=$(this).text(),t=$('<a href="'+i+'" rel="nofollow">'+s+"</a>"),o=$('<li class="'+n+'_nav"></li>').append(t),$(e).append(o)}),!0}generateCatalog(".catalog-body"),$(".catalog-toggle").click(function(e){e.preventDefault(),$(".side-catalog").toggleClass("fold")}),loadAsync("/js/jquery.nav.js",function(){$(".catalog-body").onePageNav({currentClass:"active",changeHash:!1,easing:"swing",filter:"",scrollSpeed:700,scrollOffset:0,scrollThreshold:.2,begin:null,end:null,scrollChange:null,padding:80})})</script></body></html>