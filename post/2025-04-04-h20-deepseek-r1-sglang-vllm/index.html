<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:site_name" content="漫步远方，心荡神往"><meta property="og:type" content="article"><meta property="og:image" content="https://tanjunchen.github.io/img/home.webp"><meta property="twitter:image" content="https://tanjunchen.github.io/img/home.webp"><meta name=title content="单机H20(8*96GiB)部署满血DeepSeek-R1(fp8)验证过程"><meta property="og:title" content="单机H20(8*96GiB)部署满血DeepSeek-R1(fp8)验证过程"><meta property="twitter:title" content="单机H20(8*96GiB)部署满血DeepSeek-R1(fp8)验证过程"><meta name=description content="陈谭军，软件工程师, 开源爱好者, 互联网, 云原生, 容器, 微服务, Web, PaaS, Istio, Kubernetes, Microservice"><meta property="og:description" content="陈谭军，软件工程师, 开源爱好者, 互联网, 云原生, 容器, 微服务, Web, PaaS, Istio, Kubernetes, Microservice"><meta property="twitter:description" content="陈谭军，软件工程师, 开源爱好者, 互联网, 云原生, 容器, 微服务, Web, PaaS, Istio, Kubernetes, Microservice"><meta property="twitter:card" content="summary"><meta name=keyword content="陈谭军, 互联网, 云原生, 容器, 微服务, Web, PaaS, Istio, Kubernetes, Microservice"><link rel="shortcut icon" href=/img/favicon.ico><title>单机H20(8*96GiB)部署满血DeepSeek-R1(fp8)验证过程 | 陈谭军的博客 | tanjunchen Blog</title><link rel=canonical href=/post/2025-04-04-h20-deepseek-r1-sglang-vllm/><link rel=stylesheet href=/css/bootstrap.min.css><link rel=stylesheet href=/css/hugo-theme-cleanwhite.min.css><link rel=stylesheet href=/css/zanshang.css><link rel=stylesheet href=/css/font-awesome.all.min.css><script src=/js/jquery.min.js></script>
<script src=/js/bootstrap.min.js></script>
<script src=/js/hux-blog.min.js></script>
<script src=/js/lazysizes.min.js></script></head><nav class="navbar navbar-default navbar-custom navbar-fixed-top"><div class=container-fluid><div class="navbar-header page-scroll"><button type=button class=navbar-toggle>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span></button>
<a class=navbar-brand href=/>漫步远方，心荡神往</a></div><div id=huxblog_navbar><div class=navbar-collapse><ul class="nav navbar-nav navbar-right"><li><a href=/>All Posts</a></li><li><a href=/categories/technology/>technology</a></li><li><a href=/categories/think/>think</a></li><li><a href=/learning/>LEARNING</a></li><li><a href=/archive/>ARCHIVE</a></li><li><a href=/about/>ABOUT</a></li><li><a href=/search><i class="fa fa-search"></i></a></li></ul></div></div></div></nav><script>var $body=document.body,$toggle=document.querySelector(".navbar-toggle"),$navbar=document.querySelector("#huxblog_navbar"),$collapse=document.querySelector(".navbar-collapse");$toggle.addEventListener("click",handleMagic);function handleMagic(){$navbar.className.indexOf("in")>0?($navbar.className=" ",setTimeout(function(){$navbar.className.indexOf("in")<0&&($collapse.style.height="0px")},400)):($collapse.style.height="auto",$navbar.className+=" in")}</script><style type=text/css>header.intro-header{background-image:url(/img/home.webp)}</style><header class=intro-header><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><div class=tags><a class=tag href=/tags/ai title=AI>AI</a>
<a class=tag href=/tags/%E5%A4%A7%E6%A8%A1%E5%9E%8B title=大模型>大模型</a>
<a class=tag href=/tags/deepseek title=DeepSeek>DeepSeek</a>
<a class=tag href=/tags/nvidia-h20-%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95 title="NVIDIA H20 性能测试">NVIDIA H20 性能测试</a></div><h1>单机H20(8*96GiB)部署满血DeepSeek-R1(fp8)验证过程</h1><h2 class=subheading>单机H20(8*96GiB)部署满血DeepSeek-R1(fp8)验证过程、vllm 验证过程、sglang 验证过程</h2><span class=meta>Posted by
陈谭军
on
Friday, April 4, 2025
<span id=busuanzi_container_page_pv>|<span id=busuanzi_value_page_pv></span><span>
<span id=/post/2025-04-04-h20-deepseek-r1-sglang-vllm/ class="leancloud_visitors meta_data_item" data-flag-title><span class=post-meta-item-icon><span class="octicon octicon-eye"></span></span>
<i class="fa fa-eye"></i>
<span class=old-visitors-count style=display:none></span>
<span class=leancloud-visitors-count></span></span>
<script src=https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js></script>
<script>AV.initialize("","")</script><script type=text/javascript>function showTime(e){var n=new AV.Query(e),t=[],s=$(".leancloud_visitors");s.each(function(){t.push($(this).attr("id").trim())}),n.containedIn("url",t),n.find().done(function(e){for(var s,o,i,a,r,c,l=".leancloud-visitors-count",d=".old-visitors-count",n=0;n<e.length;n++)a=e[n],i=a.get("url"),c=a.get("time"),s=document.getElementById(i),$(s).find(l).text(c);for(n=0;n<t.length;n++)i=t[n],s=document.getElementById(i),o=$(s).find(l),o.text()==""&&(r=$(s).find(d).text(),r!=""?o.text(0+parseInt(r)):o.text(0))}).fail(function(e,t){console.log("Error: "+t.code+" "+t.message)})}function addCount(e){var n=$(".leancloud_visitors"),t=n.attr("id").trim(),o=n.attr("data-flag-title").trim(),s=new AV.Query(e);s.equalTo("url",t),s.find({success:function(n){if(n.length>0){var s,i,r,c,l,a=n[0];a.fetchWhenSave(!0),a.increment("time"),a.save(null,{success:function(e){var n=$(document.getElementById(t));n.find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to save Visitor num, with error message: "+t.message)}})}else s=new e,i=new AV.ACL,i.setPublicReadAccess(!0),i.setPublicWriteAccess(!0),s.setACL(i),s.set("title",o),s.set("url",t),c=".old-visitors-count",l=$(document.getElementById(t)),r=l.find(c).text(),r!=""?s.set("time",parseInt(r)+1):s.set("time",1),s.save(null,{success:function(e){var n=$(document.getElementById(t));n.find(".leancloud-visitors-count").text(e.get("time"))},error:function(){console.log("Failed to create")}})},error:function(e){console.log("Error:"+e.code+" "+e.message)}})}$(function(){var e=AV.Object.extend("Counter");$(".leancloud_visitors").length==1?addCount(e):showTime(e)})</script>阅读 </span></span>|<span class=post-date>共 3218 字</span>，阅读约 <span class=more-meta>7 分钟</span></span></div></div></div></div></header><article><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
post-container"><h1 id=环境信息>环境信息</h1><h2 id=机器配置>机器配置</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>OS：CentOS Linux release 7.6 <span style=color:#ff79c6>(</span>Final<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>Kernel：4.19.0-1.0.0.9
</span></span><span style=display:flex><span>驱动： Driver Version: 535.216.03   CUDA Version: 12.2
</span></span><span style=display:flex><span>GPU：NVIDIA  H20
</span></span><span style=display:flex><span>vLLM：https://docs.vllm.ai/en/stable/
</span></span><span style=display:flex><span>Docker：v1.5.4
</span></span><span style=display:flex><span>nvidia-container-runtime：1.0.2-dev
</span></span><span style=display:flex><span>vllm 测试镜像：vllm/vllm-openai:v0.8.2
</span></span><span style=display:flex><span>sglang 测试镜像：lmsysorg/sglang:ea52b45be1a7 
</span></span><span style=display:flex><span>配置与模型根目录  /mnt/models
</span></span></code></pre></div><p><span style=color:red>⚠️ 注意：模型文件可能分为多个部分，一定要验证所有文件的完整性，避免因文件损坏导致的启动失败</span></p><h2 id=下载权重>下载权重</h2><p>从 <a href=https://huggingface.co/deepseek-ai/DeepSeek-R1>DeepSeek-R1</a> 下载 DeepSeek-R1 FP8 模型文件；</p><h1 id=vllm-单机测试>vllm 单机测试</h1><h2 id=启动环境>启动环境</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span> docker run -itd --privileged     <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>     --net<span style=color:#ff79c6>=</span>host                   <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>     --cap-add<span style=color:#ff79c6>=</span>SYS_PTRACE <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>     --security-opt <span style=color:#8be9fd;font-style:italic>seccomp</span><span style=color:#ff79c6>=</span>unconfined     <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>     --tmpfs /dev/shm:rw,nosuid,nodev,exec,size<span style=color:#ff79c6>=</span>128g     <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>     -v /ssd1/models:/mnt/models              <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>     --gpus all <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>     --name vllm-test          <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>     --entrypoint <span style=color:#f1fa8c>&#34;&#34;</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>     -w /workspace     <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>     vllm/vllm-openai:v0.8.2 <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>     /bin/bash
</span></span></code></pre></div><h2 id=启动-deepseek-r1-模型>启动 deepseek r1 模型</h2><p><span style=color:red>注：如果机器开启ipv6双栈网络，强烈建议配置该参数；</span></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>VLLM_HOST_IP</span><span style=color:#ff79c6>=</span><span style=color:#ff79c6>$(</span>hostname -I | awk <span style=color:#f1fa8c>&#39;{print $1}&#39;</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>HOST_IP</span><span style=color:#ff79c6>=</span><span style=color:#ff79c6>$(</span>hostname -I | awk <span style=color:#f1fa8c>&#39;{print $1}&#39;</span><span style=color:#ff79c6>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker <span style=color:#8be9fd;font-style:italic>exec</span> -it vllm-test bash
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>VLLM_HOST_IP</span><span style=color:#ff79c6>=</span><span style=color:#ff79c6>$(</span>hostname -I | awk <span style=color:#f1fa8c>&#39;{print $1}&#39;</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>HOST_IP</span><span style=color:#ff79c6>=</span><span style=color:#ff79c6>$(</span>hostname -I | awk <span style=color:#f1fa8c>&#39;{print $1}&#39;</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>nohup python3 -m vllm.entrypoints.openai.api_server --model /mnt/models/DeepSeek-R1 --gpu-memory-utilization 0.95 --tensor-parallel-size <span style=color:#bd93f9>8</span> --host 0.0.0.0 --trust-remote-code --port <span style=color:#bd93f9>8000</span>  --max_num_seqs <span style=color:#bd93f9>256</span>  --max-num-batched-tokens <span style=color:#bd93f9>16384</span>  --max_model_len <span style=color:#bd93f9>4096</span>  --max_seq_len_to_capture <span style=color:#bd93f9>16384</span>   --tokenizer-mode auto  --enable-chunked-prefill<span style=color:#ff79c6>=</span>False  --enable-reasoning --reasoning-parser deepseek_r1  --enforce-eager  &gt; vllm-server.log 2&gt;&amp;<span style=color:#bd93f9>1</span> &amp; 
</span></span></code></pre></div><p>参数说明：</p><ul><li>&ndash;model 模型路径，加载 /workspace/DeepSeek-R1 目录下的模型。</li><li>&ndash;host 0.0.0.0监听所有网络接口的请求（允许外部访问）。</li><li>&ndash;port 服务端口号设为 8000。</li><li>&ndash;tokenizer-mode auto 自动选择分词器模式（优先使用 HuggingFace 的 auto 配置）。</li><li>&ndash;gpu-memory-utilization 0.90 GPU 显存利用率上限设为 90%（避免 OOM）。如果高并发服务运行异常，建议调低此值。</li><li>&ndash;tensor-parallel-size 16 使用 16 路张量并行（需 GPU 数量支持，适合超大模型）。</li><li>&ndash;enforce-eager 强制启用 PyTorch 的 eager 模式（可能牺牲性能以提升兼容性）。</li><li>&ndash;max_num_seqs 256 单次批处理的最大序列数（并发请求数上限）。vLLM 会动态调整，一般默认值设置为256。</li><li>&ndash;max-num-batched-tokens 16384 批处理的最大总 token 数（影响吞吐量）。最大输入长度要小于这个数值。</li><li>&ndash;max_model_len 16384 模型支持的最大上下文长度（16K tokens）。</li><li>&ndash;max_seq_len_to_capture 16384 捕获的序列最大长度（用于优化 CUDA 内核）。框架默认超参，当前版本需要与 max_model_len 保持一致。</li><li>&ndash;enable-chunked-prefill=False 禁用分块预填充（可能减少延迟但增加显存压力）。</li><li>&ndash;enable-reasoning 启用推理模式（需配合 &ndash;reasoning-parser）。</li><li>&ndash;reasoning-parser deepseek_r1 指定推理解析器为 deepseek_r1（自定义逻辑）。</li><li>&ndash;trust-remote-code 允许加载远程代码（如自定义模型或分词器）。</li></ul><p>出现如下文字表示启动成功：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ff79c6>[</span>api_server.py:1028<span style=color:#ff79c6>]</span> Starting vLLM API server on http://0.0.0.0:8000
</span></span></code></pre></div><h2 id=性能测试>性能测试</h2><p>参考官方 vLLM 链接：<a href=https://github.com/vllm-project/vllm/blob/main/benchmarks/benchmark_serving.py>vllm-benchmarks</a></p><p>测试脚本如下所示：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ff79c6>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#ff79c6></span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>output_dir</span><span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>$1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>declare</span> -A <span style=color:#8be9fd;font-style:italic>test_cases</span><span style=color:#ff79c6>=(</span>
</span></span><span style=display:flex><span>     <span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#34;128 128&#34;</span><span style=color:#ff79c6>]=</span><span style=color:#f1fa8c>&#34;128&#34;</span>
</span></span><span style=display:flex><span>     <span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#34;256 256&#34;</span><span style=color:#ff79c6>]=</span><span style=color:#f1fa8c>&#34;256&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>numprt_values</span><span style=color:#ff79c6>=(</span><span style=color:#bd93f9>1</span> <span style=color:#bd93f9>2</span> <span style=color:#bd93f9>4</span> <span style=color:#bd93f9>8</span> <span style=color:#bd93f9>16</span> <span style=color:#bd93f9>32</span> <span style=color:#bd93f9>64</span> <span style=color:#bd93f9>128</span> <span style=color:#bd93f9>200</span> <span style=color:#bd93f9>256</span> <span style=color:#bd93f9>512</span> 1024<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>for</span> <span style=color:#ff79c6>case</span> in <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span>!test_cases[@]<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span>; <span style=color:#ff79c6>do</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>IFS</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#39; &#39;</span> <span style=color:#8be9fd;font-style:italic>read</span> inlen outlen <span style=color:#ff79c6>&lt;&lt;&lt;</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>case</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>for</span> numprt in <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>numprt_values</span>[@]<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span>; <span style=color:#ff79c6>do</span>
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>log_filename</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>output_dir</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>/serving_benchmark_</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>numprt</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>_</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>inlen</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>_</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>outlen</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>.log&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>result_file</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>output_dir</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>/serving_benchmark_</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>numprt</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>_</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>inlen</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>_</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>outlen</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>.json&#34;</span>
</span></span><span style=display:flex><span>        python3 benchmark_serving.py <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>            --host 0.0.0.0 <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>            --port <span style=color:#bd93f9>8000</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>            --backend vllm <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>            --model /mnt/models/DeepSeek-R1 <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>            --dataset-name random <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>            --num-prompts <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$numprt</span><span style=color:#f1fa8c>&#34;</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>            --random-input-len <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$inlen</span><span style=color:#f1fa8c>&#34;</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>            --save-result <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>            --random-range-ratio 1.0 <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>            --result-filename <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$result_file</span><span style=color:#f1fa8c>&#34;</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>            --random-output-len <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$outlen</span><span style=color:#f1fa8c>&#34;</span> &gt; <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$log_filename</span><span style=color:#f1fa8c>&#34;</span> 2&gt;&amp;<span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;Executed command for num-prompts=</span><span style=color:#8be9fd;font-style:italic>$numprt</span><span style=color:#f1fa8c>, inlen=</span><span style=color:#8be9fd;font-style:italic>$inlen</span><span style=color:#f1fa8c>, outlen=</span><span style=color:#8be9fd;font-style:italic>$outlen</span><span style=color:#f1fa8c>. Output saved to </span><span style=color:#8be9fd;font-style:italic>$log_filename</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>done</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>done</span>
</span></span></code></pre></div><p>测试结果收集脚本如下所示：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>import json
</span></span><span style=display:flex><span>import os
</span></span><span style=display:flex><span>import csv
</span></span><span style=display:flex><span>import re
</span></span><span style=display:flex><span>import argparse
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4>#fieldnames = [&#34;tp&#34;, &#34;concurrency&#34;, &#34;mean TTFT(ms)&#34;, &#34;p90_tpot_ms&#34;, </span>
</span></span><span style=display:flex><span><span style=color:#6272a4>#              &#34;output_throughput(tokens/s)&#34;, &#34;total_throughput(tokens/s)&#34;, </span>
</span></span><span style=display:flex><span><span style=color:#6272a4>#              &#34;mean TPOT(ms)&#34;, &#34;mean e2e(ms)&#34;, &#34;mean_input_len&#34;, &#34;mean_output_len&#34;]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>fieldnames</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#34;concurrency&#34;</span>, <span style=color:#f1fa8c>&#34;mean TTFT(ms)&#34;</span>, <span style=color:#f1fa8c>&#34;input_throughput(tokens/s)&#34;</span>, 
</span></span><span style=display:flex><span>              <span style=color:#f1fa8c>&#34;output_throughput(tokens/s)&#34;</span>, <span style=color:#f1fa8c>&#34;mean TPOT(ms)&#34;</span>, <span style=color:#f1fa8c>&#34;mean_input_len&#34;</span>, 
</span></span><span style=display:flex><span>              <span style=color:#f1fa8c>&#34;mean_output_len&#34;</span><span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>def main<span style=color:#ff79c6>(</span>args<span style=color:#ff79c6>)</span>:
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>data</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>[]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>for</span> _, _, files in os.walk<span style=color:#ff79c6>(</span>args.dir<span style=color:#ff79c6>)</span>:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>for</span> file in files:
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> file.endswith<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;.json&#34;</span><span style=color:#ff79c6>)</span>:
</span></span><span style=display:flex><span>                <span style=color:#6272a4># tp${TENSOR_PARALLEL}_CON${i}_in${INPUT_LENGTH}_out${OUTPUT_LENGTH}.json</span>
</span></span><span style=display:flex><span>                <span style=color:#6272a4># pattern = r&#39;tp(\d+)_CON(\d+)_in(\d+)_out(\d+)\.json&#39;</span>
</span></span><span style=display:flex><span>                <span style=color:#8be9fd;font-style:italic>pattern</span> <span style=color:#ff79c6>=</span> r<span style=color:#f1fa8c>&#39;serving_benchmark_(\d+)_(\d+)_(\d+).json&#39;</span>
</span></span><span style=display:flex><span>                <span style=color:#6272a4># 使用正则表达式匹配文件名</span>
</span></span><span style=display:flex><span>                <span style=color:#8be9fd;font-style:italic>match</span> <span style=color:#ff79c6>=</span> re.match<span style=color:#ff79c6>(</span>pattern, file<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>if</span> match:
</span></span><span style=display:flex><span>                    <span style=color:#6272a4># tp = int(match.group(1))</span>
</span></span><span style=display:flex><span>                    <span style=color:#6272a4># con = int(match.group(2))</span>
</span></span><span style=display:flex><span>                    <span style=color:#6272a4># input_length = int(match.group(3))</span>
</span></span><span style=display:flex><span>                    <span style=color:#6272a4># output_length = int(match.group(4))</span>
</span></span><span style=display:flex><span>                    <span style=color:#8be9fd;font-style:italic>con</span> <span style=color:#ff79c6>=</span> int<span style=color:#ff79c6>(</span>match.group<span style=color:#ff79c6>(</span>1<span style=color:#ff79c6>))</span>
</span></span><span style=display:flex><span>                    <span style=color:#8be9fd;font-style:italic>input_length</span> <span style=color:#ff79c6>=</span> int<span style=color:#ff79c6>(</span>match.group<span style=color:#ff79c6>(</span>2<span style=color:#ff79c6>))</span>
</span></span><span style=display:flex><span>                    <span style=color:#8be9fd;font-style:italic>output_length</span> <span style=color:#ff79c6>=</span> int<span style=color:#ff79c6>(</span>match.group<span style=color:#ff79c6>(</span>3<span style=color:#ff79c6>))</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>else</span>:
</span></span><span style=display:flex><span>                    print<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;not match&#34;</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                with open<span style=color:#ff79c6>(</span>os.path.join<span style=color:#ff79c6>(</span>args.dir, file<span style=color:#ff79c6>)</span>, <span style=color:#f1fa8c>&#39;r&#39;</span><span style=color:#ff79c6>)</span> as f:
</span></span><span style=display:flex><span>                    <span style=color:#8be9fd;font-style:italic>result</span> <span style=color:#ff79c6>=</span> json.load<span style=color:#ff79c6>(</span>f<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>                    data.append<span style=color:#ff79c6>(</span>
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                            <span style=color:#6272a4># &#34;tp&#34;: tp, </span>
</span></span><span style=display:flex><span>                            <span style=color:#f1fa8c>&#34;concurrency&#34;</span>: con, 
</span></span><span style=display:flex><span>                            <span style=color:#f1fa8c>&#34;mean TTFT(ms)&#34;</span>: result<span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#39;mean_ttft_ms&#39;</span><span style=color:#ff79c6>]</span>,
</span></span><span style=display:flex><span>                            <span style=color:#6272a4># &#34;p90_tpot_ms&#34;: result[&#34;p90_tpot_ms&#34;],</span>
</span></span><span style=display:flex><span>                            <span style=color:#f1fa8c>&#34;input_throughput(tokens/s)&#34;</span>: result<span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#34;input_throughput&#34;</span><span style=color:#ff79c6>]</span>,
</span></span><span style=display:flex><span>                            <span style=color:#f1fa8c>&#34;output_throughput(tokens/s)&#34;</span>: result<span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#39;output_throughput&#39;</span><span style=color:#ff79c6>]</span>,
</span></span><span style=display:flex><span>                            <span style=color:#6272a4># &#34;total_throughput(tokens/s)&#34;: result[&#34;total_token_throughput&#34;],</span>
</span></span><span style=display:flex><span>                            <span style=color:#f1fa8c>&#34;mean TPOT(ms)&#34;</span>: result<span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#39;mean_tpot_ms&#39;</span><span style=color:#ff79c6>]</span>,
</span></span><span style=display:flex><span>                            <span style=color:#6272a4># &#34;mean e2e(ms)&#34;: result[&#39;mean_e2el_ms&#39;],</span>
</span></span><span style=display:flex><span>                            <span style=color:#f1fa8c>&#34;mean_input_len&#34;</span>: sum<span style=color:#ff79c6>(</span>result<span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#39;input_lens&#39;</span><span style=color:#ff79c6>])</span> / len<span style=color:#ff79c6>(</span>result<span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#39;input_lens&#39;</span><span style=color:#ff79c6>])</span>,
</span></span><span style=display:flex><span>                            <span style=color:#f1fa8c>&#34;mean_output_len&#34;</span>: sum<span style=color:#ff79c6>(</span>result<span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#39;output_lens&#39;</span><span style=color:#ff79c6>])</span> / len<span style=color:#ff79c6>(</span>result<span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#39;output_lens&#39;</span><span style=color:#ff79c6>])</span>
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    with open<span style=color:#ff79c6>(</span>os.path.join<span style=color:#ff79c6>(</span>args.dir, <span style=color:#f1fa8c>&#39;summary.csv&#39;</span><span style=color:#ff79c6>)</span>, <span style=color:#f1fa8c>&#39;w&#39;</span><span style=color:#ff79c6>)</span> as f:
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>writer</span> <span style=color:#ff79c6>=</span> csv.DictWriter<span style=color:#ff79c6>(</span>f, <span style=color:#8be9fd;font-style:italic>fieldnames</span><span style=color:#ff79c6>=</span>fieldnames<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>        writer.writeheader<span style=color:#ff79c6>()</span>
</span></span><span style=display:flex><span>        writer.writerows<span style=color:#ff79c6>(</span>data<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>if</span> <span style=color:#8be9fd;font-style:italic>__name__</span> <span style=color:#ff79c6>==</span> <span style=color:#f1fa8c>&#34;__main__&#34;</span>:
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>parser</span> <span style=color:#ff79c6>=</span> argparse.ArgumentParser<span style=color:#ff79c6>()</span>
</span></span><span style=display:flex><span>    parser.add_argument<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;--dir&#34;</span>, <span style=color:#8be9fd;font-style:italic>type</span><span style=color:#ff79c6>=</span>str, <span style=color:#8be9fd;font-style:italic>help</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;&#34;</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>args</span> <span style=color:#ff79c6>=</span> parser.parse_args<span style=color:#ff79c6>()</span>
</span></span><span style=display:flex><span>    main<span style=color:#ff79c6>(</span>args<span style=color:#ff79c6>)</span>
</span></span></code></pre></div><h2 id=测试数据>测试数据</h2><table><thead><tr><th>Concurrency</th><th>Mean TTFT (ms)</th><th>Input Throughput (tokens/s)</th><th>Output Throughput (tokens/s)</th><th>Mean TPOT (ms)</th><th>Mean Input Len</th><th>Mean Output Len</th></tr></thead><tbody><tr><td>1</td><td>377.24</td><td>8.97</td><td>8.97</td><td>110.40</td><td>256</td><td>256</td></tr><tr><td>1</td><td>137.49</td><td>9.04</td><td>9.04</td><td>110.35</td><td>128</td><td>128</td></tr><tr><td>2</td><td>220.46</td><td>17.19</td><td>17.19</td><td>115.10</td><td>128</td><td>128</td></tr><tr><td>2</td><td>209.63</td><td>17.37</td><td>17.37</td><td>114.58</td><td>256</td><td>256</td></tr><tr><td>4</td><td>577.66</td><td>34.55</td><td>32.66</td><td>114.34</td><td>256</td><td>242</td></tr><tr><td>4</td><td>273.70</td><td>34.37</td><td>34.37</td><td>114.89</td><td>128</td><td>128</td></tr><tr><td>8</td><td>541.72</td><td>69.82</td><td>54.79</td><td>113.49</td><td>256</td><td>200.88</td></tr><tr><td>8</td><td>283.15</td><td>69.96</td><td>69.90</td><td>112.99</td><td>128</td><td>127.88</td></tr><tr><td>16</td><td>311.16</td><td>136.80</td><td>118.03</td><td>115.77</td><td>128</td><td>110.44</td></tr><tr><td>16</td><td>804.60</td><td>137.17</td><td>108.03</td><td>116.83</td><td>256</td><td>201.63</td></tr><tr><td>32</td><td>1154.97</td><td>264.47</td><td>223.66</td><td>118.56</td><td>256</td><td>216.50</td></tr><tr><td>32</td><td>406.02</td><td>272.43</td><td>259.52</td><td>115.50</td><td>128</td><td>121.94</td></tr><tr><td>64</td><td>1037.10</td><td>490.31</td><td>441.89</td><td>120.80</td><td>256</td><td>230.72</td></tr><tr><td>64</td><td>638.28</td><td>533.76</td><td>505.68</td><td>116.10</td><td>128</td><td>121.27</td></tr><tr><td>128</td><td>12775.06</td><td>523.47</td><td>467.29</td><td>127.68</td><td>256</td><td>228.52</td></tr><tr><td>128</td><td>1691.78</td><td>535.46</td><td>496.57</td><td>123.48</td><td>128</td><td>118.70</td></tr><tr><td>200</td><td>27349.28</td><td>536.20</td><td>471.17</td><td>133.32</td><td>256</td><td>224.95</td></tr><tr><td>200</td><td>8098.16</td><td>750.38</td><td>692.81</td><td>125.01</td><td>128</td><td>118.18</td></tr><tr><td>256</td><td>10997.02</td><td>736.63</td><td>675.69</td><td>124.53</td><td>128</td><td>117.41</td></tr><tr><td>256</td><td>42065.50</td><td>508.52</td><td>464.55</td><td>137.75</td><td>256</td><td>233.87</td></tr><tr><td>512</td><td>95793.97</td><td>525.61</td><td>471.70</td><td>137.59</td><td>256</td><td>229.74</td></tr><tr><td>512</td><td>28965.09</td><td>787.83</td><td>738.58</td><td>127.15</td><td>128</td><td>120.00</td></tr><tr><td>1024</td><td>64294.62</td><td>863.69</td><td>799.89</td><td>130.09</td><td>128</td><td>118.54</td></tr><tr><td>1024</td><td>216813.43</td><td>541.80</td><td>496.40</td><td>136.48</td><td>256</td><td>234.55</td></tr></tbody></table><h2 id=faq>FAQ</h2><p>使用 vllm/vllm-openai:v0.7.2 镜像，以下命令启动会失败，具体可参考 <a href=https://github.com/vllm-project/vllm/issues/13294>https://github.com/vllm-project/vllm/issues/13294</a> 。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>python3 -m vllm.entrypoints.openai.api_server --model /mnt/models/DeepSeek-R1 --gpu-memory-utilization 0.95 --tensor-parallel-size <span style=color:#bd93f9>8</span> --host 0.0.0.0 --trust-remote-code --port <span style=color:#bd93f9>8000</span>  --max_num_seqs <span style=color:#bd93f9>256</span>  --max-num-batched-tokens <span style=color:#bd93f9>16384</span>  --max_model_len <span style=color:#bd93f9>4096</span>  --max_seq_len_to_capture <span style=color:#bd93f9>16384</span>   --tokenizer-mode auto  --enable-chunked-prefill<span style=color:#ff79c6>=</span>False  --enable-reasoning --reasoning-parser deepseek_r1  --enforce-eager 
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>WARNING 03-29 21：10：39 fused moe.py:806<span style=color:#ff79c6>]</span> Using default MoE config. Performance might be sub-optimal! Config file not found at /usr/local
</span></span><span style=display:flex><span>11ib/python3.12/dist-packages/v1lm/model executor/layers/fused moe/configs/E<span style=color:#ff79c6>=</span>256,N<span style=color:#ff79c6>=</span>256,device <span style=color:#8be9fd;font-style:italic>name</span><span style=color:#ff79c6>=</span>NVIDIA H20,dtype<span style=color:#ff79c6>=</span>fp8 w8a8,block <span style=color:#8be9fd;font-style:italic>shape</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>=[</span>128,128<span style=color:#ff79c6>]</span>.json
</span></span><span style=display:flex><span><span style=color:#ff79c6>(</span>VllmMorkerProcess <span style=color:#8be9fd;font-style:italic>pid</span><span style=color:#ff79c6>=</span>518<span style=color:#ff79c6>)</span> WARNING 03-29 21：10：39 fused moe.py:806<span style=color:#ff79c6>]</span> Using default MoE config. Performance might be sub-optimal! Config
</span></span><span style=display:flex><span>file not found at /usr/local/lib/python3.12/dist-packages/vllm/model executor/layers/fused moe/configs/E<span style=color:#ff79c6>=</span>256,N<span style=color:#ff79c6>=</span>256,device <span style=color:#8be9fd;font-style:italic>name</span><span style=color:#ff79c6>=</span>NVIDIA H2
</span></span><span style=display:flex><span>0,dtype<span style=color:#ff79c6>=</span>fp8_w8a8,block_shape<span style=color:#ff79c6>=[</span>128,128<span style=color:#ff79c6>]</span>.json
</span></span><span style=display:flex><span>0,dtype<span style=color:#ff79c6>=</span>fp8 w8a8,block <span style=color:#8be9fd;font-style:italic>shape</span><span style=color:#ff79c6>=[</span>128,128<span style=color:#ff79c6>]</span>.json
</span></span><span style=display:flex><span>ERROR 03-29 21：10：47 engine. py: 389<span style=color:#ff79c6>]</span> NCCL Error 1： unhandled cuda error <span style=color:#ff79c6>(</span>run with <span style=color:#8be9fd;font-style:italic>NCCL_DEBUG</span><span style=color:#ff79c6>=</span>INFO <span style=color:#ff79c6>for</span> details<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>ERROR 03-29 21：10：47 engine.py:389<span style=color:#ff79c6>]</span> Traceback <span style=color:#ff79c6>(</span>most recent call last<span style=color:#ff79c6>)</span>:
</span></span><span style=display:flex><span>ERROR 03-29 21： 10： <span style=color:#bd93f9>47</span> engine.py: 389<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span><span style=color:#bd93f9>499</span>
</span></span><span style=display:flex><span>File<span style=color:#f1fa8c>&#34;/usr/local/lib/python3.12/dist-packages/vllm/engine/multiprocessing/engine.py&#34;</span>,line 380，in
</span></span><span style=display:flex><span>run mp engine
</span></span><span style=display:flex><span>ERROR 03-29 21： 10：47 engine.py: <span style=color:#bd93f9>389</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>engine</span> <span style=color:#ff79c6>=</span> MQLLMEngine.from_engine_args<span style=color:#ff79c6>(</span><span style=color:#8be9fd;font-style:italic>engine_args</span><span style=color:#ff79c6>=</span>engine_args,
</span></span><span style=display:flex><span>ERROR 03-29 21：10：47 engine.py: 389<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>AAAAAAAAAAAAAAAAAAAAAAAAAAAAa
</span></span><span style=display:flex><span>ERROR 03-29 21： 10： <span style=color:#bd93f9>47</span> engine.py: 389<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>File <span style=color:#f1fa8c>&#34;/usr/local/lib/python3.12/dist-packages/vllm/engine/multiprocessing/engine.py&#34;</span>,line 123，in
</span></span><span style=display:flex><span>from engine args
</span></span><span style=display:flex><span>ERROR 03-29 21： 10： <span style=color:#bd93f9>47</span> engine.py: <span style=color:#bd93f9>389</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>return</span> cls<span style=color:#ff79c6>(</span><span style=color:#8be9fd;font-style:italic>ipc_path</span><span style=color:#ff79c6>=</span>ipc_path,
</span></span><span style=display:flex><span>ERROR 03-29 21： 10：47 engine.py: <span style=color:#bd93f9>389</span>
</span></span><span style=display:flex><span>ERROR 03-29 21：10：47 engine.py: <span style=color:#bd93f9>389</span>
</span></span><span style=display:flex><span>File <span style=color:#f1fa8c>&#34;/usr/local/lib/python3.12/dist-packages/vllm/engine/multiprocessing/engine.py&#34;</span>, line 75， in
</span></span><span style=display:flex><span>init
</span></span><span style=display:flex><span>ERROR 03-29 21： 10： <span style=color:#bd93f9>47</span> engine.py: 389<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>self.engine <span style=color:#ff79c6>=</span> LLMEngine<span style=color:#ff79c6>(</span>*args, **kwargs<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>ERROR 03-29 21： 10： <span style=color:#bd93f9>47</span> engine.py: 389<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>^^^^^^^^^^^^^^^^
</span></span><span style=display:flex><span>^^^^^^
</span></span><span style=display:flex><span>ERROR 03-29 21： 10：47 engine.py: <span style=color:#bd93f9>389</span>
</span></span><span style=display:flex><span>File <span style=color:#f1fa8c>&#34;/usr/local/lib/python3.12/dist-packages/vllm/engine/llm_engine.py&#34;</span>, line 276， in _init
</span></span><span style=display:flex><span>ERROR 03-29 21： 10：47 engine.py: <span style=color:#bd93f9>389</span>
</span></span><span style=display:flex><span>self. _initialize_kv_caches<span style=color:#ff79c6>()</span>
</span></span><span style=display:flex><span>ERROR 03-29 21：10：47 engine.py: <span style=color:#bd93f9>389</span>
</span></span><span style=display:flex><span>File <span style=color:#f1fa8c>&#34;/usr/local/lib/python3.12/dist-packages/vllm/engine/llm_engine.py&#34;</span>, line 416， in _initialize
</span></span><span style=display:flex><span>kv caches
</span></span><span style=display:flex><span>ERROR 03-29 21： 10： <span style=color:#bd93f9>47</span> engine.py: 389<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>self.model executor.determine num available blocks<span style=color:#ff79c6>())</span>
</span></span></code></pre></div><h1 id=sglang-单机测试>sglang 单机测试</h1><h2 id=启动环境-1>启动环境</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run -itd --privileged     <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>     --net<span style=color:#ff79c6>=</span>host                   <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>     --cap-add<span style=color:#ff79c6>=</span>SYS_PTRACE <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>     --security-opt <span style=color:#8be9fd;font-style:italic>seccomp</span><span style=color:#ff79c6>=</span>unconfined     <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>     --tmpfs /dev/shm:rw,nosuid,nodev,exec,size<span style=color:#ff79c6>=</span>128g     <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>     -v /ssd1/models:/mnt/models            <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>     --gpus all <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>     --name sglang-test          <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>     --entrypoint <span style=color:#f1fa8c>&#34;&#34;</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>     -w /workspace     <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>     lmsysorg/sglang:ea52b45be1a7  <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>     /bin/bash
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker <span style=color:#8be9fd;font-style:italic>exec</span> -it sglang-test bash
</span></span></code></pre></div><h2 id=启动-deepseek-r1-模型-1>启动 deepseek r1 模型</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nohup python3 -m sglang.launch_server <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --model-path /mnt/models/DeepSeek-R1 <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --host 0.0.0.0 <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --port <span style=color:#bd93f9>8000</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --tensor-parallel-size <span style=color:#bd93f9>8</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --trust-remote-code <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --tokenizer-mode auto <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --mem-fraction-static 0.90 <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --context-length  <span style=color:#bd93f9>65536</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --quantization fp8  <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --reasoning-parser deepseek-r1 <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --chunked-prefill-size  <span style=color:#bd93f9>4096</span> &gt; sglang-server.log 2&gt;&amp;<span style=color:#bd93f9>1</span> &amp; 
</span></span></code></pre></div><p>出现如下文字表示启动成功：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Uvicorn running on http://0.0.0.0:8000 <span style=color:#ff79c6>(</span>Press CTRL+C to quit<span style=color:#ff79c6>)</span>
</span></span></code></pre></div><p>以下命令启动失败，需要单机H200或者H20（8*141GiB显存）机器才能运行DeepSeek-R1（fp8权重）。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>python3 -m sglang.launch_server --model-path /mnt/models/DeepSeek-R1 --tp <span style=color:#bd93f9>8</span> --trust-remote-code --host 0.0.0.0 --port <span style=color:#bd93f9>8000</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Loading safetensors checkpoint shards: 98% Completed
</span></span><span style=display:flex><span>160/163<span style=color:#ff79c6>[</span>00:55&lt;00:01, 2.90it/s<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>Loading safetensors checkpoint shards: 99% Completed
</span></span><span style=display:flex><span>161/163<span style=color:#ff79c6>[</span>00:55&lt;00:00,2.93it/s<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>Loading safetensors checkpoint shards: 99% Completed
</span></span><span style=display:flex><span>162/163<span style=color:#ff79c6>[</span>00:55&lt;00:00,2.97it/s<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>Loading safetensors checkpoint shards: 100% Completed
</span></span><span style=display:flex><span>163/163<span style=color:#ff79c6>[</span>00:56&lt;00:00,2.94it/s<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>Loading safetensors checkpoint shards: 100% Completed
</span></span><span style=display:flex><span>163/163<span style=color:#ff79c6>[</span>00:56&lt;00:00,2.91it/s<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>2025-03-29 11：31：03 TP5<span style=color:#ff79c6>]</span> Scheduler hit an exception: Traceback <span style=color:#ff79c6>(</span>most recent call last<span style=color:#ff79c6>)</span>:
</span></span><span style=display:flex><span>File<span style=color:#f1fa8c>&#34;/sgl-workspace/sglang/python/sglang/srt/managers/scheduler.py&#34;</span>,line 1748，in run_scheduler_process
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>scheduler</span> <span style=color:#ff79c6>=</span> Scheduler<span style=color:#ff79c6>(</span>server_args, port_args, gpu_id, tp_rank, dp_rank<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>File<span style=color:#f1fa8c>&#34;/sgl-workspace/sglang/python/sglang/srt/managers/scheduler.py&#34;</span>,line 218，in _init
</span></span><span style=display:flex><span>self.tp_worker <span style=color:#ff79c6>=</span> TpWorkerClass<span style=color:#ff79c6>(</span>
</span></span><span style=display:flex><span>File<span style=color:#f1fa8c>&#34;/sgl-workspace/sglang/python/sglang/srt/managers/tp_worker_overlap_thread.py&#34;</span>,line 63，in _init
</span></span><span style=display:flex><span>self.worker <span style=color:#ff79c6>=</span> TpModelWorker（server_args， gpu_id， tp_rank， dp_rank， nccl_port）
</span></span><span style=display:flex><span>File<span style=color:#f1fa8c>&#34;/sgl-workspace/sglang/python/sglang/srt/managers/tp_worker.py&#34;</span>,line 74，in_init_
</span></span><span style=display:flex><span>self.model_runner <span style=color:#ff79c6>=</span> ModelRunner<span style=color:#ff79c6>(</span>
</span></span><span style=display:flex><span>File<span style=color:#f1fa8c>&#34;/sgl-workspace/sglang/python/sglang/srt/model_executor/model_runner.py&#34;</span>,line 166， in_init_
</span></span><span style=display:flex><span>self.initialize<span style=color:#ff79c6>(</span>min_per_gpu_memory<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>File<span style=color:#f1fa8c>&#34;/sgl-workspace/sglang/python/sglang/srt/model_executor/model_runner.py&#34;</span>,line 199，in initialize
</span></span><span style=display:flex><span>self.init_memory_pool<span style=color:#ff79c6>(</span>
</span></span><span style=display:flex><span>File<span style=color:#f1fa8c>&#34;/sgl-workspace/sglang/python/sglang/srt/model_executor/model_runner.py&#34;</span>,line 715，in init_memory_pool
</span></span><span style=display:flex><span>RuntimeError: Not enough memory. Please try to increase --mem-fraction-static.
</span></span></code></pre></div><h2 id=性能测试-1>性能测试</h2><p>测试脚本：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ff79c6>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#ff79c6></span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>output_dir</span><span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>$1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>declare</span> -A <span style=color:#8be9fd;font-style:italic>test_cases</span><span style=color:#ff79c6>=(</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4># 格式: &#34;输入长度 输出长度 numprt&#34;=&#34;描述&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#34;128 128 1&#34;</span><span style=color:#ff79c6>]=</span><span style=color:#f1fa8c>&#34;128&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#34;128 128 2&#34;</span><span style=color:#ff79c6>]=</span><span style=color:#f1fa8c>&#34;128&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#34;128 128 4&#34;</span><span style=color:#ff79c6>]=</span><span style=color:#f1fa8c>&#34;128&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#34;128 128 8&#34;</span><span style=color:#ff79c6>]=</span><span style=color:#f1fa8c>&#34;128&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#34;128 128 16&#34;</span><span style=color:#ff79c6>]=</span><span style=color:#f1fa8c>&#34;128&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#34;128 128 32&#34;</span><span style=color:#ff79c6>]=</span><span style=color:#f1fa8c>&#34;128&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#34;128 128 64&#34;</span><span style=color:#ff79c6>]=</span><span style=color:#f1fa8c>&#34;128&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#34;128 128 128&#34;</span><span style=color:#ff79c6>]=</span><span style=color:#f1fa8c>&#34;128&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#34;128 128 256&#34;</span><span style=color:#ff79c6>]=</span><span style=color:#f1fa8c>&#34;128&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#34;128 128 512&#34;</span><span style=color:#ff79c6>]=</span><span style=color:#f1fa8c>&#34;128&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#34;128 128 1024&#34;</span><span style=color:#ff79c6>]=</span><span style=color:#f1fa8c>&#34;128&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#34;256 256 1&#34;</span><span style=color:#ff79c6>]=</span><span style=color:#f1fa8c>&#34;256&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#34;256 256 2&#34;</span><span style=color:#ff79c6>]=</span><span style=color:#f1fa8c>&#34;256&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#34;256 256 4&#34;</span><span style=color:#ff79c6>]=</span><span style=color:#f1fa8c>&#34;256&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#34;256 256 8&#34;</span><span style=color:#ff79c6>]=</span><span style=color:#f1fa8c>&#34;256&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#34;256 256 16&#34;</span><span style=color:#ff79c6>]=</span><span style=color:#f1fa8c>&#34;256&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#34;256 256 32&#34;</span><span style=color:#ff79c6>]=</span><span style=color:#f1fa8c>&#34;256&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#34;256 256 64&#34;</span><span style=color:#ff79c6>]=</span><span style=color:#f1fa8c>&#34;256&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#34;256 256 128&#34;</span><span style=color:#ff79c6>]=</span><span style=color:#f1fa8c>&#34;256&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#34;256 256 256&#34;</span><span style=color:#ff79c6>]=</span><span style=color:#f1fa8c>&#34;256&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#34;256 256 512&#34;</span><span style=color:#ff79c6>]=</span><span style=color:#f1fa8c>&#34;256&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#34;256 256 1024&#34;</span><span style=color:#ff79c6>]=</span><span style=color:#f1fa8c>&#34;256&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>random_range_ratios</span><span style=color:#ff79c6>=(</span>1.0<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># 循环遍历所有测试用例</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>for</span> <span style=color:#ff79c6>case</span> in <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span>!test_cases[@]<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span>; <span style=color:#ff79c6>do</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4># 分割输入长度、输出长度和numprt</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>IFS</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#39; &#39;</span> <span style=color:#8be9fd;font-style:italic>read</span> inlen outlen numprt <span style=color:#ff79c6>&lt;&lt;&lt;</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>case</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#6272a4># 构建日志文件名和结果文件名</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>result_file</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>output_dir</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>/serving_benchmark_</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>numprt</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>_</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>inlen</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>_</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>outlen</span><span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>.json&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     <span style=color:#ff79c6>for</span> ratio in <span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>random_range_ratios</span>[@]<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>do</span>
</span></span><span style=display:flex><span>            python3 -m sglang.bench_serving <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>                --backend sglang <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>                --dataset-name random <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>                --dataset-path /mnt/models/sglang/ShareGPT_V3_unfiltered_cleaned_split.json <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>                --model /mnt/models/DeepSeek-R1 <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>                --random-input <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>inlen</span><span style=color:#f1fa8c>}</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>                --random-output <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>outlen</span><span style=color:#f1fa8c>}</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>                --random-range-ratio <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>ratio</span><span style=color:#f1fa8c>}</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>                --num-prompts <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>numprt</span><span style=color:#f1fa8c>}</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>                --host 0.0.0.0 <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>                --port <span style=color:#bd93f9>8000</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>                --output-file <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$result_file</span><span style=color:#f1fa8c>&#34;</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>                --max-concurrency <span style=color:#f1fa8c>${</span><span style=color:#8be9fd;font-style:italic>numprt</span><span style=color:#f1fa8c>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>done</span>
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>echo</span> <span style=color:#f1fa8c>&#34;Executed command for num-prompts=</span><span style=color:#8be9fd;font-style:italic>$numprt</span><span style=color:#f1fa8c>, inlen=</span><span style=color:#8be9fd;font-style:italic>$input_len</span><span style=color:#f1fa8c>, outlen=</span><span style=color:#8be9fd;font-style:italic>$output_len</span><span style=color:#f1fa8c>. Output saved to </span><span style=color:#8be9fd;font-style:italic>$result_file</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>done</span>
</span></span></code></pre></div><p>收集测试结果脚本：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>import json
</span></span><span style=display:flex><span>import os
</span></span><span style=display:flex><span>import csv
</span></span><span style=display:flex><span>import re
</span></span><span style=display:flex><span>import argparse
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4>#fieldnames = [&#34;tp&#34;, &#34;concurrency&#34;, &#34;mean TTFT(ms)&#34;, &#34;p90_tpot_ms&#34;, </span>
</span></span><span style=display:flex><span><span style=color:#6272a4>#              &#34;output_throughput(tokens/s)&#34;, &#34;total_throughput(tokens/s)&#34;, </span>
</span></span><span style=display:flex><span><span style=color:#6272a4>#              &#34;mean TPOT(ms)&#34;, &#34;mean e2e(ms)&#34;, &#34;mean_input_len&#34;, &#34;mean_output_len&#34;]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>fieldnames</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#34;concurrency&#34;</span>, <span style=color:#f1fa8c>&#34;mean TTFT(ms)&#34;</span>, <span style=color:#f1fa8c>&#34;input_throughput(tokens/s)&#34;</span>, 
</span></span><span style=display:flex><span>              <span style=color:#f1fa8c>&#34;output_throughput(tokens/s)&#34;</span>, <span style=color:#f1fa8c>&#34;mean TPOT(ms)&#34;</span>, <span style=color:#f1fa8c>&#34;mean_input_len&#34;</span>, 
</span></span><span style=display:flex><span>              <span style=color:#f1fa8c>&#34;mean_output_len&#34;</span><span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>def main<span style=color:#ff79c6>(</span>args<span style=color:#ff79c6>)</span>:
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>data</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>[]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>for</span> _, _, files in os.walk<span style=color:#ff79c6>(</span>args.dir<span style=color:#ff79c6>)</span>:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>for</span> file in files:
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> file.endswith<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;.json&#34;</span><span style=color:#ff79c6>)</span>:
</span></span><span style=display:flex><span>                <span style=color:#6272a4># tp${TENSOR_PARALLEL}_CON${i}_in${INPUT_LENGTH}_out${OUTPUT_LENGTH}.json</span>
</span></span><span style=display:flex><span>                <span style=color:#6272a4># pattern = r&#39;tp(\d+)_CON(\d+)_in(\d+)_out(\d+)\.json&#39;</span>
</span></span><span style=display:flex><span>                <span style=color:#8be9fd;font-style:italic>pattern</span> <span style=color:#ff79c6>=</span> r<span style=color:#f1fa8c>&#39;serving_benchmark_(\d+)_(\d+)_(\d+).json&#39;</span>
</span></span><span style=display:flex><span>                <span style=color:#6272a4># 使用正则表达式匹配文件名</span>
</span></span><span style=display:flex><span>                <span style=color:#8be9fd;font-style:italic>match</span> <span style=color:#ff79c6>=</span> re.match<span style=color:#ff79c6>(</span>pattern, file<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>if</span> match:
</span></span><span style=display:flex><span>                    <span style=color:#6272a4># tp = int(match.group(1))</span>
</span></span><span style=display:flex><span>                    <span style=color:#6272a4># con = int(match.group(2))</span>
</span></span><span style=display:flex><span>                    <span style=color:#6272a4># input_length = int(match.group(3))</span>
</span></span><span style=display:flex><span>                    <span style=color:#6272a4># output_length = int(match.group(4))</span>
</span></span><span style=display:flex><span>                    <span style=color:#8be9fd;font-style:italic>con</span> <span style=color:#ff79c6>=</span> int<span style=color:#ff79c6>(</span>match.group<span style=color:#ff79c6>(</span>1<span style=color:#ff79c6>))</span>
</span></span><span style=display:flex><span>                    <span style=color:#8be9fd;font-style:italic>input_length</span> <span style=color:#ff79c6>=</span> int<span style=color:#ff79c6>(</span>match.group<span style=color:#ff79c6>(</span>2<span style=color:#ff79c6>))</span>
</span></span><span style=display:flex><span>                    <span style=color:#8be9fd;font-style:italic>output_length</span> <span style=color:#ff79c6>=</span> int<span style=color:#ff79c6>(</span>match.group<span style=color:#ff79c6>(</span>3<span style=color:#ff79c6>))</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>else</span>:
</span></span><span style=display:flex><span>                    print<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;not match&#34;</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                with open<span style=color:#ff79c6>(</span>os.path.join<span style=color:#ff79c6>(</span>args.dir, file<span style=color:#ff79c6>)</span>, <span style=color:#f1fa8c>&#39;r&#39;</span><span style=color:#ff79c6>)</span> as f:
</span></span><span style=display:flex><span>                    <span style=color:#8be9fd;font-style:italic>result</span> <span style=color:#ff79c6>=</span> json.load<span style=color:#ff79c6>(</span>f<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>                    data.append<span style=color:#ff79c6>(</span>
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                            <span style=color:#6272a4># &#34;tp&#34;: tp, </span>
</span></span><span style=display:flex><span>                            <span style=color:#f1fa8c>&#34;concurrency&#34;</span>: con, 
</span></span><span style=display:flex><span>                            <span style=color:#f1fa8c>&#34;mean TTFT(ms)&#34;</span>: result<span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#39;mean_ttft_ms&#39;</span><span style=color:#ff79c6>]</span>,
</span></span><span style=display:flex><span>                            <span style=color:#6272a4># &#34;p90_tpot_ms&#34;: result[&#34;p90_tpot_ms&#34;],</span>
</span></span><span style=display:flex><span>                            <span style=color:#f1fa8c>&#34;input_throughput(tokens/s)&#34;</span>: result<span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#34;input_throughput&#34;</span><span style=color:#ff79c6>]</span>,
</span></span><span style=display:flex><span>                            <span style=color:#f1fa8c>&#34;output_throughput(tokens/s)&#34;</span>: result<span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#39;output_throughput&#39;</span><span style=color:#ff79c6>]</span>,
</span></span><span style=display:flex><span>                            <span style=color:#6272a4># &#34;total_throughput(tokens/s)&#34;: result[&#34;total_token_throughput&#34;],</span>
</span></span><span style=display:flex><span>                            <span style=color:#f1fa8c>&#34;mean TPOT(ms)&#34;</span>: result<span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#39;mean_tpot_ms&#39;</span><span style=color:#ff79c6>]</span>,
</span></span><span style=display:flex><span>                            <span style=color:#6272a4># &#34;mean e2e(ms)&#34;: result[&#39;mean_e2el_ms&#39;],</span>
</span></span><span style=display:flex><span>                            <span style=color:#f1fa8c>&#34;mean_input_len&#34;</span>: result<span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#39;random_input_len&#39;</span><span style=color:#ff79c6>]</span>,
</span></span><span style=display:flex><span>                            <span style=color:#f1fa8c>&#34;mean_output_len&#34;</span>: result<span style=color:#ff79c6>[</span><span style=color:#f1fa8c>&#39;random_output_len&#39;</span><span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    with open<span style=color:#ff79c6>(</span>os.path.join<span style=color:#ff79c6>(</span>args.dir, <span style=color:#f1fa8c>&#39;summary.csv&#39;</span><span style=color:#ff79c6>)</span>, <span style=color:#f1fa8c>&#39;w&#39;</span><span style=color:#ff79c6>)</span> as f:
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>writer</span> <span style=color:#ff79c6>=</span> csv.DictWriter<span style=color:#ff79c6>(</span>f, <span style=color:#8be9fd;font-style:italic>fieldnames</span><span style=color:#ff79c6>=</span>fieldnames<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>        writer.writeheader<span style=color:#ff79c6>()</span>
</span></span><span style=display:flex><span>        writer.writerows<span style=color:#ff79c6>(</span>data<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>if</span> <span style=color:#8be9fd;font-style:italic>__name__</span> <span style=color:#ff79c6>==</span> <span style=color:#f1fa8c>&#34;__main__&#34;</span>:
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>parser</span> <span style=color:#ff79c6>=</span> argparse.ArgumentParser<span style=color:#ff79c6>()</span>
</span></span><span style=display:flex><span>    parser.add_argument<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;--dir&#34;</span>, <span style=color:#8be9fd;font-style:italic>type</span><span style=color:#ff79c6>=</span>str, <span style=color:#8be9fd;font-style:italic>help</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;&#34;</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>args</span> <span style=color:#ff79c6>=</span> parser.parse_args<span style=color:#ff79c6>()</span>
</span></span><span style=display:flex><span>    main<span style=color:#ff79c6>(</span>args<span style=color:#ff79c6>)</span>
</span></span></code></pre></div><h2 id=测试数据-1>测试数据</h2><table><thead><tr><th>Concurrency</th><th>Mean TTFT (ms)</th><th>Input Throughput (tokens/s)</th><th>Output Throughput (tokens/s)</th><th>Mean TPOT (ms)</th><th>Mean Input Len</th><th>Mean Output Len</th></tr></thead><tbody><tr><td>1</td><td>194.20</td><td>23.23</td><td>23.23</td><td>42.24</td><td>256</td><td>256</td></tr><tr><td>1</td><td>182.48</td><td>23.02</td><td>23.02</td><td>42.00</td><td>128</td><td>128</td></tr><tr><td>2</td><td>224.36</td><td>49.47</td><td>49.47</td><td>39.55</td><td>256</td><td>256</td></tr><tr><td>2</td><td>403.36</td><td>47.01</td><td>47.01</td><td>39.36</td><td>128</td><td>128</td></tr><tr><td>4</td><td>522.17</td><td>90.16</td><td>90.16</td><td>42.32</td><td>256</td><td>256</td></tr><tr><td>4</td><td>337.92</td><td>88.69</td><td>88.69</td><td>42.43</td><td>128</td><td>128</td></tr><tr><td>8</td><td>454.64</td><td>141.60</td><td>141.60</td><td>52.94</td><td>128</td><td>128</td></tr><tr><td>8</td><td>556.54</td><td>143.92</td><td>143.92</td><td>53.36</td><td>256</td><td>256</td></tr><tr><td>16</td><td>798.92</td><td>228.58</td><td>228.58</td><td>66.88</td><td>256</td><td>256</td></tr><tr><td>16</td><td>761.36</td><td>221.29</td><td>221.29</td><td>66.34</td><td>128</td><td>128</td></tr><tr><td>32</td><td>1413.67</td><td>356.98</td><td>356.98</td><td>84.12</td><td>256</td><td>256</td></tr><tr><td>32</td><td>2746.37</td><td>298.55</td><td>298.55</td><td>85.71</td><td>128</td><td>128</td></tr><tr><td>64</td><td>2194.33</td><td>525.62</td><td>525.62</td><td>104.64</td><td>128</td><td>128</td></tr><tr><td>64</td><td>2066.74</td><td>554.94</td><td>554.94</td><td>107.27</td><td>256</td><td>256</td></tr><tr><td>128</td><td>1947.21</td><td>905.80</td><td>905.80</td><td>126.22</td><td>128</td><td>128</td></tr><tr><td>128</td><td>4998.13</td><td>755.78</td><td>755.78</td><td>134.56</td><td>256</td><td>256</td></tr><tr><td>256</td><td>22308.28</td><td>726.58</td><td>726.58</td><td>139.63</td><td>256</td><td>256</td></tr><tr><td>256</td><td>3240.90</td><td>1126.60</td><td>1126.60</td><td>182.61</td><td>128</td><td>128</td></tr><tr><td>512</td><td>60348.03</td><td>778.92</td><td>778.92</td><td>146.90</td><td>256</td><td>256</td></tr><tr><td>512</td><td>17057.59</td><td>1017.13</td><td>1017.13</td><td>201.92</td><td>128</td><td>128</td></tr><tr><td>1024</td><td>43769.94</td><td>1100.93</td><td>1100.93</td><td>209.22</td><td>128</td><td>128</td></tr><tr><td>1024</td><td>135037.16</td><td>813.92</td><td>813.92</td><td>175.95</td><td>256</td><td>256</td></tr></tbody></table><h1 id=总结>总结</h1><h2 id=对比分析>对比分析</h2><ul><li>吞吐量（Throughput）<ul><li>SGLang 显著更高：<ul><li>最高达1100 tokens/s（vLLM 仅 ~800 tokens/s），提升约 37%。</li><li>在16-256 并发区间扩展性更好，吞吐增长更接近线性，而 vLLM 在高并发时下降明显。</li></ul></li></ul></li><li>延迟（Latency）<ul><li>首 Token 延迟（TTFT）：<ul><li>vLLM 更低（最低137ms，SGLang 最低182ms），适合实时交互场景。</li><li>但SGLang 在高并发时更稳定（vLLM 的 TTFT 在 1024 并发时飙升至12.7s+）。</li></ul></li><li>每 Token 生成时间（TPOT）：<ul><li>SGLang 大幅优化（最低仅39ms，vLLM 最低 110ms），提速 64%，更适合长文本流式输出。</li></ul></li></ul></li><li>输入长度影响<ul><li>SGLang 对短序列（128 tokens）优化极佳：<ul><li>在 256 并发时，128-length 吞吐1126 tokens/s（vLLM 仅 737 tokens/s），提升 53%。</li></ul></li><li>vLLM 对 256-length 序列更均衡，但 SGLang 在短序列上优势明显。</li></ul></li></ul><h2 id=核心要素>核心要素</h2><ul><li>SGLang 更适合高并发、短文本场景，吞吐和 TPOT 表现更优，但首 Token 延迟略高。</li><li>vLLM 在低延迟需求（如实时交互）和长文本场景更稳定。</li><li>如果业务允许稍高的首 Token 延迟，SGLang 的综合性能更优，尤其适合需要高并发的生产环境。</li></ul><hr><ul class=pager><li class=previous><a href=/post/2025-03-23-h20-deepseek-r1/ data-toggle=tooltip data-placement=top title="单台 H20 机器 DeepSeek R1 (FP8)、DeepSeek-R1-Block-INT8 精度测试与性能测试过程">&larr;
Previous Post</a></li></ul></div><div class="col-lg-2 col-lg-offset-0
visible-lg-block
sidebar-container
catalog-container"><div class=side-catalog><hr class="hidden-sm hidden-xs"><h5><a class=catalog-toggle href=#>CATALOG</a></h5><ul class=catalog-body></ul></div></div><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
sidebar-container"></div></div></div></article><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"><li><a href=mailto:tanjunchen20@gmail.com><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=/img/wechat.jpg><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-weixin fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://github.com/tanjunchen><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="copyright text-muted">Copyright &copy; 陈谭军 2025</p></div></div></div></footer><script>function loadAsync(e,t){var s=document,o="script",n=s.createElement(o),i=s.getElementsByTagName(o)[0];n.src=e,t&&n.addEventListener("load",function(e){t(null,e)},!1),i.parentNode.insertBefore(n,i)}</script><script>$("#tag_cloud").length!==0&&loadAsync("/js/jquery.tagcloud.js",function(){$.fn.tagcloud.defaults={color:{start:"#bbbbee",end:"#0085a1"}},$("#tag_cloud a").tagcloud()})</script><script>loadAsync("https://cdn.jsdelivr.net/npm/fastclick@1.0.6/lib/fastclick.min.js",function(){var e=document.querySelector("nav");e&&FastClick.attach(e)})</script><script type=text/javascript>function generateCatalog(e){_containerSelector="div.post-container";var t,n,s,o,i,r=$(_containerSelector),a=r.find("h1,h2,h3,h4,h5,h6");return $(e).html(""),a.each(function(){n=$(this).prop("tagName").toLowerCase(),i="#"+$(this).prop("id"),s=$(this).text(),t=$('<a href="'+i+'" rel="nofollow">'+s+"</a>"),o=$('<li class="'+n+'_nav"></li>').append(t),$(e).append(o)}),!0}generateCatalog(".catalog-body"),$(".catalog-toggle").click(function(e){e.preventDefault(),$(".side-catalog").toggleClass("fold")}),loadAsync("/js/jquery.nav.js",function(){$(".catalog-body").onePageNav({currentClass:"active",changeHash:!1,easing:"swing",filter:"",scrollSpeed:700,scrollOffset:0,scrollThreshold:.2,begin:null,end:null,scrollChange:null,padding:80})})</script></body></html>