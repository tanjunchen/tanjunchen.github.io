<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:site_name" content="æ¼«æ­¥è¿œæ–¹ï¼Œå¿ƒè¡ç¥å¾€"><meta property="og:type" content="article"><meta property="og:image" content="https://tanjunchen.github.io/img/home.webp"><meta property="twitter:image" content="https://tanjunchen.github.io/img/home.webp"><meta name=title content="Istio æœåŠ¡ç½‘æ ¼å¦‚ä½•å¤„ç†å®‰å…¨é—®é¢˜"><meta property="og:title" content="Istio æœåŠ¡ç½‘æ ¼å¦‚ä½•å¤„ç†å®‰å…¨é—®é¢˜"><meta property="twitter:title" content="Istio æœåŠ¡ç½‘æ ¼å¦‚ä½•å¤„ç†å®‰å…¨é—®é¢˜"><meta name=description content="é™ˆè°­å†›ï¼Œè½¯ä»¶å·¥ç¨‹å¸ˆ, å¼€æºçˆ±å¥½è€…"><meta property="og:description" content="é™ˆè°­å†›ï¼Œè½¯ä»¶å·¥ç¨‹å¸ˆ, å¼€æºçˆ±å¥½è€…"><meta property="twitter:description" content="é™ˆè°­å†›ï¼Œè½¯ä»¶å·¥ç¨‹å¸ˆ, å¼€æºçˆ±å¥½è€…"><meta property="twitter:card" content="summary"><meta name=keyword content="é™ˆè°­å†›, äº’è”ç½‘, äº‘åŸç”Ÿ, å®¹å™¨, å¾®æœåŠ¡, Web, PaaS, Istio, Kubernetes, Microservice"><link rel="shortcut icon" href=/img/favicon.ico><title>Istio æœåŠ¡ç½‘æ ¼å¦‚ä½•å¤„ç†å®‰å…¨é—®é¢˜ | é™ˆè°­å†›çš„åšå®¢ | tanjunchen Blog</title><link rel=canonical href=/post/2022-02-19-istio-security/><link rel=stylesheet href=/css/bootstrap.min.css><link rel=stylesheet href=/css/hugo-theme-cleanwhite.min.css><link rel=stylesheet href=/css/zanshang.css><link rel=stylesheet href=/css/font-awesome.all.min.css><script src=/js/jquery.min.js></script>
<script src=/js/bootstrap.min.js></script>
<script src=/js/hux-blog.min.js></script>
<script src=/js/lazysizes.min.js></script></head><nav class="navbar navbar-default navbar-custom navbar-fixed-top"><div class=container-fluid><div class="navbar-header page-scroll"><button type=button class=navbar-toggle>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span></button>
<a class=navbar-brand href=/>æ¼«æ­¥è¿œæ–¹ï¼Œå¿ƒè¡ç¥å¾€</a></div><div id=huxblog_navbar><div class=navbar-collapse><ul class="nav navbar-nav navbar-right"><li><a href=/>All Posts</a></li><li><a href=/categories/technology/>technology</a></li><li><a href=/categories/think/>think</a></li><li><a href=/learning/>LEARNING</a></li><li><a href=/archive/>ARCHIVE</a></li><li><a href=/about/>ABOUT</a></li><li><a href=/search><i class="fa fa-search"></i></a></li></ul></div></div></div></nav><script>var $body=document.body,$toggle=document.querySelector(".navbar-toggle"),$navbar=document.querySelector("#huxblog_navbar"),$collapse=document.querySelector(".navbar-collapse");$toggle.addEventListener("click",handleMagic);function handleMagic(){$navbar.className.indexOf("in")>0?($navbar.className=" ",setTimeout(function(){$navbar.className.indexOf("in")<0&&($collapse.style.height="0px")},400)):($collapse.style.height="auto",$navbar.className+=" in")}</script><style type=text/css>header.intro-header{background-image:url(/img/home.webp)}</style><header class=intro-header><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><div class=tags><a class=tag href=/tags/istio title=istio>istio</a>
<a class=tag href=/tags/kubernetes title=kubernetes>kubernetes</a>
<a class=tag href=/tags/microservice title=microservice>microservice</a></div><h1>Istio æœåŠ¡ç½‘æ ¼å¦‚ä½•å¤„ç†å®‰å…¨é—®é¢˜</h1><h2 class=subheading></h2><span class=meta>Posted by
é™ˆè°­å†›
on
Saturday, February 19, 2022
<span id=busuanzi_container_page_pv>|<span id=busuanzi_value_page_pv></span><span>
<span id=/post/2022-02-19-istio-security/ class="leancloud_visitors meta_data_item" data-flag-title><span class=post-meta-item-icon><span class="octicon octicon-eye"></span></span>
<i class="fa fa-eye"></i>
<span class=old-visitors-count style=display:none></span>
<span class=leancloud-visitors-count></span></span>
<script src=https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js></script>
<script>AV.initialize("","")</script><script type=text/javascript>function showTime(e){var n=new AV.Query(e),t=[],s=$(".leancloud_visitors");s.each(function(){t.push($(this).attr("id").trim())}),n.containedIn("url",t),n.find().done(function(e){for(var s,o,i,a,r,c,l=".leancloud-visitors-count",d=".old-visitors-count",n=0;n<e.length;n++)a=e[n],i=a.get("url"),c=a.get("time"),s=document.getElementById(i),$(s).find(l).text(c);for(n=0;n<t.length;n++)i=t[n],s=document.getElementById(i),o=$(s).find(l),o.text()==""&&(r=$(s).find(d).text(),r!=""?o.text(0+parseInt(r)):o.text(0))}).fail(function(e,t){console.log("Error: "+t.code+" "+t.message)})}function addCount(e){var n=$(".leancloud_visitors"),t=n.attr("id").trim(),o=n.attr("data-flag-title").trim(),s=new AV.Query(e);s.equalTo("url",t),s.find({success:function(n){if(n.length>0){var s,i,r,c,l,a=n[0];a.fetchWhenSave(!0),a.increment("time"),a.save(null,{success:function(e){var n=$(document.getElementById(t));n.find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to save Visitor num, with error message: "+t.message)}})}else s=new e,i=new AV.ACL,i.setPublicReadAccess(!0),i.setPublicWriteAccess(!0),s.setACL(i),s.set("title",o),s.set("url",t),c=".old-visitors-count",l=$(document.getElementById(t)),r=l.find(c).text(),r!=""?s.set("time",parseInt(r)+1):s.set("time",1),s.save(null,{success:function(e){var n=$(document.getElementById(t));n.find(".leancloud-visitors-count").text(e.get("time"))},error:function(){console.log("Failed to create")}})},error:function(e){console.log("Error:"+e.code+" "+e.message)}})}$(function(){var e=AV.Object.extend("Counter");$(".leancloud_visitors").length==1?addCount(e):showTime(e)})</script>é˜…è¯» </span></span>|<span class=post-date>å…± 5368 å­—</span>ï¼Œé˜…è¯»çº¦ <span class=more-meta>11 åˆ†é’Ÿ</span></span></div></div></div></div></header><article><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
sidebar-container"><section><hr class="hidden-sm hidden-xs"><h5><a href=/tags/>FEATURED TAGS</a></h5><div class=tags><a href=/tags/istio title=istio>istio</a></div></section></div><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
post-container"><p>åœ¨è¿™ç¯‡åšå®¢ä¸­ï¼Œæˆ‘å°†è§£é‡Š Istio å¦‚ä½•è§£å†³è¯¸å¦‚æµé‡åŠ å¯†ã€æä¾›çµæ´»çš„æœåŠ¡è®¿é—®æ§åˆ¶ã€é…ç½®åŒå‘ TLS å’Œç»†ç²’åº¦è®¿é—®ç­–ç•¥ä¸å®¡è®¡ç­‰é—®é¢˜ã€‚</p><h1 id=istio-å®‰å…¨æ¶æ„>Istio å®‰å…¨æ¶æ„</h1><p>Istio æœåŠ¡ç½‘æ ¼å‘å±•å†å²å¦‚ä¸‹æ‰€ç¤ºï¼š
<img src=/images/2022-02-19-istio-security/1.jpeg alt></p><p>Istio ä¸»è¦ç”±ä»¥ä¸‹ç»„ä»¶æä¾›å®‰å…¨åŠŸèƒ½ï¼š</p><ol><li>ç”¨äºç®¡ç†å¯†é’¥å’Œè¯ä¹¦çš„è¯ä¹¦é¢å‘æœºæ„ (CA)</li><li>Sidecar ä»£ç†ï¼šå®ç°å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„å®‰å…¨é€šä¿¡ï¼ˆå®ƒä»¬ç”¨ä½œç­–ç•¥æ‰§è¡Œç‚¹ (PEP)ï¼‰</li><li>Envoy ä»£ç†æ‰©å±•å±‚ï¼šç®¡ç†é¥æµ‹å’Œå®¡è®¡ç­‰</li><li>é…ç½® API æœåŠ¡å™¨ï¼šåˆ†å‘èº«ä»½éªŒè¯ã€æˆæƒç­–ç•¥å’Œå®‰å…¨å‘½åä¿¡æ¯ç­‰</li></ol><p>ç­–ç•¥æ‰§è¡Œç‚¹ (PEP) æ˜¯å……å½“èµ„æºå®ˆæŠ¤è€…çš„ç»„ä»¶ã€‚è®©æˆ‘ä»¬æŸ¥é˜…ä¸‹å›¾ä¸­ä¸åŒç»„ä»¶åŠå…¶èŒè´£çš„æ¶æ„å›¾ã€‚
<img src=/images/2022-02-19-istio-security/2.png alt></p><h2 id=è®¤è¯authentication>è®¤è¯ï¼ˆAuthenticationï¼‰</h2><p>æ ¹æ®å®šä¹‰ï¼Œèº«ä»½è®¤è¯æ˜¯éªŒè¯ç”¨æˆ·æˆ–è¿›ç¨‹çš„èº«ä»½çš„è¿‡ç¨‹æˆ–åŠ¨ä½œã€‚æ„å‘³ç€ Istio éœ€è¦ä»è¯·æ±‚ä¸­æå–å‡­è¯å¹¶è¯æ˜å®ƒä»¬æ˜¯çœŸå®çš„ã€‚Istio ä¸­çš„ Envoy ä»£ç†åœ¨ç›¸äº’é€šä¿¡æ—¶ä½¿ç”¨è¯ä¹¦ä½œä¸ºå…¶å‡­è¯ã€‚è¿™äº›è¯ä¹¦ä¸ Kubernetes ä¸­çš„æœåŠ¡å¸æˆ·ç›¸å…³è”ã€‚</p><p>å½“ä¸¤ä¸ªæœåŠ¡å¼€å§‹é€šä¿¡æ—¶ï¼Œå®ƒä»¬éœ€è¦ç”¨èº«ä»½ä¿¡æ¯äº¤æ¢å‡­è¯ä»¥ç›¸äº’éªŒè¯å¯¹æ–¹ã€‚å®¢æˆ·ç«¯æ ¹æ®å®‰å…¨å‘½åä¿¡æ¯æ£€æŸ¥æœåŠ¡å™¨çš„èº«ä»½ï¼Œä»¥æŸ¥çœ‹å®ƒæ˜¯å¦æ˜¯æœåŠ¡çš„æˆæƒè¿è¡Œè€…ã€‚åœ¨æœåŠ¡å™¨ç«¯ï¼ŒæœåŠ¡å™¨æ ¹æ®æˆæƒç­–ç•¥ç¡®å®šå®¢æˆ·ç«¯å¯ä»¥è®¿é—®å“ªäº›ä¿¡æ¯ã€‚</p><p>æ­¤å¤–ï¼ŒæœåŠ¡å™¨å¯ä»¥å®¡æ ¸è°åœ¨ä»€ä¹ˆæ—¶é—´è®¿é—®äº†ä»€ä¹ˆï¼Œå¹¶å†³å®šæ˜¯æ‰¹å‡†è¿˜æ˜¯æ‹’ç»å®¢æˆ·ç«¯å¯¹æœåŠ¡å™¨çš„è°ƒç”¨ã€‚å®‰å…¨å‘½åä¿¡æ¯åŒ…å«ä»æœåŠ¡æ ‡è¯†åˆ°æœåŠ¡åç§°çš„æ˜ å°„ã€‚æœåŠ¡å™¨èº«ä»½ç¼–ç åœ¨è¯ä¹¦ä¸­ï¼ŒæœåŠ¡åç§°æ˜¯å‘ç°æœåŠ¡æˆ– DNS ä½¿ç”¨çš„åç§°ã€‚ä»èº«ä»½ A åˆ°æœåŠ¡åç§° B çš„å•ä¸ªæ˜ å°„æ„å‘³ç€â€œA æ˜¯å…è®¸å’Œæˆæƒçš„æœåŠ¡ Bâ€ã€‚Pilot ç”Ÿæˆå®‰å…¨å‘½åä¿¡æ¯ï¼Œç„¶ååˆ†å‘ç»™æ‰€æœ‰ Sidecar Envoyã€‚</p><h2 id=èº«ä»½identity>èº«ä»½ï¼ˆIdentityï¼‰</h2><p>å¯¹äºå‘å¸ƒèº«ä»½ï¼ŒIstio ä½¿ç”¨é€‚ç”¨äºæ‰€æœ‰äººçš„å®‰å…¨çš„ç”Ÿäº§çº§åˆ«èº«ä»½æ¡†æ¶ SPIFFEï¼ˆå‘éŸ³ä¸º spiffyï¼‰ã€‚SPIFFE æ˜¯å¯ä»¥å¼•å¯¼å’Œå‘å¸ƒèº«ä»½çš„æ¡†æ¶çš„è§„èŒƒã€‚</p><p>Citadel å®ç°äº† SPIFFE è§„èŒƒï¼›SPIFFE çš„å¦ä¸€ç§å®ç°ç§°ä¸º SPIREï¼ˆSPIFFE è¿è¡Œæ—¶æ¡†æ¶ï¼‰ã€‚SPIFFE æ ‡å‡†åŒ…å«ä¸‰ä¸ªæ¦‚å¿µï¼š</p><ol><li>SPIFFE IDï¼šå®šä¹‰æœåŠ¡å¦‚ä½•è¯†åˆ«è‡ªå·±çš„èº«ä»½å‘½åç©ºé—´</li><li>SPIFFE å¯éªŒè¯èº«ä»½è¯æ˜æ–‡ä»¶ (SVID)ï¼šè§„å®šå¦‚ä½•å‘ˆç°å’ŒéªŒè¯å·²å‘å¸ƒçš„èº«ä»½ã€‚å®ƒå¯¹ SPIFFE ID è¿›è¡Œç¼–ç ã€‚</li><li>å·¥ä½œè´Ÿè½½ APIï¼šæŒ‡å®šç”¨äºå‘å¸ƒæˆ–æ£€ç´¢å¦ä¸€ä¸ªå·¥ä½œè´Ÿè½½ SVID çš„å·¥ä½œè´Ÿè½½çš„ API</li></ol><p>åœ¨ Kubernetes ä¸­ï¼ŒæœåŠ¡å¸æˆ·ç”¨äºæœåŠ¡èº«ä»½ã€‚è¡¨ç¤º SPIFFE ID çš„ URI çš„æ ¼å¼å¦‚ä¸‹ï¼šspiffe://cluster-name/ns/namespace/sa/service-account-nameã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œä»»ä½•æœªæ˜ç¡®è®¾ç½®æœåŠ¡å¸æˆ·çš„ pod éƒ½å°†ä½¿ç”¨éƒ¨ç½²åœ¨å‘½åç©ºé—´ä¸­çš„é»˜è®¤æœåŠ¡å¸æˆ·ã€‚å¯ä»¥è¿™æ ·æŸ¥çœ‹æœåŠ¡å¸æˆ·å’Œç›¸åº”çš„ secretï¼š</p><pre tabindex=0><code>$ kubectl describe sa default
Name:                default
Namespace:           default
Labels:              &lt;none&gt;
Annotations:         &lt;none&gt;
Image pull secrets:  &lt;none&gt;
Mountable secrets:   default-token-pjqr9
Tokens:              default-token-pjqr9
Events:              &lt;none&gt;
</code></pre><p>å¯æŒ‚è½½çš„ secret/token åç§°æ˜¯åŒ…å«è¯ä¹¦å’Œä»¤ç‰Œçš„åŒä¸€å‘½åç©ºé—´ä¸­çš„ secret åç§°ã€‚</p><pre tabindex=0><code>$ kubectl describe secret default-token-pjqr9
Name:         default-token-pjqr9
Namespace:    default
Labels:       &lt;none&gt;
Annotations:  kubernetes.io/service-account.name: default
              kubernetes.io/service-account.uid: fe107ed9-8707-11e9-9803-025000000001

Type:  kubernetes.io/service-account-token

Data
====
ca.crt:     1025 bytes
namespace:  7 bytes
token:      ey....
</code></pre><p>å› æ­¤ï¼Œé»˜è®¤æœåŠ¡å¸æˆ·çš„ SPIFFE ID å°†ç¼–ç å¦‚ä¸‹ï¼šspiffe://cluster.local/ns/default/sa/defaultã€‚è¯¥è§„èŒƒè¿˜æè¿°äº†å¦‚ä½•å°†æ­¤èº«ä»½ç¼–ç ä¸ºå¯ç”¨äºè¯æ˜èº«ä»½çš„è¯ä¹¦ã€‚SPIFFE è¡¨ç¤ºèº«ä»½ï¼ˆURIï¼‰éœ€è¦åœ¨è¯ä¹¦çš„ä¸»é¢˜å¤‡ç”¨åç§°ï¼ˆSANï¼‰ä¸­è¿›è¡Œç¼–ç ã€‚æœ€åï¼ŒIstio ä¸­ç”¨äºå‘å¸ƒå’Œæ£€ç´¢ SVID çš„å·¥ä½œè´Ÿè½½ API æ˜¯ä½¿ç”¨ ACMEï¼ˆè‡ªåŠ¨è¯ä¹¦ç®¡ç†ç¯å¢ƒï¼‰åè®®å®ç°çš„ã€‚Citadel ç»„ä»¶è‡ªåŠ¨ä¸ºç°æœ‰å’Œæ–°çš„æœåŠ¡å¸æˆ·åˆ›å»ºè¯ä¹¦ï¼Œç„¶åå°†å®ƒä»¬å­˜å‚¨ä¸º Kubernetes Secretã€‚å¦‚æœåˆ›å»ºéƒ¨ç½²å¹¶æŸ¥çœ‹ pod è§„èŒƒï¼Œä¼šæ³¨æ„åˆ°å¦‚ä¸‹å†…å®¹ï¼š</p><pre tabindex=0><code>...
 volumeMounts:
    - mountPath: /var/run/secrets/kubernetes.io/serviceaccount
      name: default-token-pjqr9
      readOnly: true
...
</code></pre><p>ä½¿ç”¨æ­¤ä»£ç æ®µï¼ŒKubernetes å°†è¯ä¹¦å’Œå…¶ä»–ä¿¡æ¯ä»æœåŠ¡å¸æˆ·å®‰è£…åˆ° podã€‚å‡ºäºå®‰å…¨ç›®çš„ï¼Œé¢å‘çš„è¯ä¹¦æ˜¯çŸ­æš‚çš„ï¼ˆå³ä½¿æ”»å‡»è€…å¯ä»¥è·å¾— SVIDï¼Œä»–ä»¬ä¹Ÿåªèƒ½åœ¨çŸ­æ—¶é—´å†…ä½¿ç”¨å®ƒï¼‰ï¼ŒCitadel ç¡®ä¿è¯ä¹¦è‡ªåŠ¨è½®æ¢ã€‚</p><h3 id=åŒå‘-tls-èº«ä»½éªŒè¯mutual-tls-authentication>åŒå‘ TLS èº«ä»½éªŒè¯ï¼ˆMutual TLS authenticationï¼‰</h3><p>ä¼ è¾“èº«ä»½éªŒè¯ï¼Œä¹Ÿç§°ä¸ºæœåŠ¡åˆ°æœåŠ¡èº«ä»½éªŒè¯ï¼Œæ˜¯ Istio æ”¯æŒçš„èº«ä»½éªŒè¯ç±»å‹ä¹‹ä¸€ã€‚Istio å®ç°åŒå‘ TLS ä½œä¸ºä¼ è¾“èº«ä»½éªŒè¯çš„è§£å†³æ–¹æ¡ˆã€‚</p><p>TLS ä»£è¡¨ä¼ è¾“å±‚å®‰å…¨æ€§ã€‚æ¯æ¬¡å°è¯•è®¿é—®å®‰å…¨ç«¯ç‚¹æ—¶éƒ½ä¼šä½¿ç”¨ TLSã€‚ä¾‹å¦‚ï¼Œé€šè¿‡ HTTPS è®¿é—® <a href=https://learnistio.com>https://learnistio.com</a> ä¼šåˆ©ç”¨ TLS æ¥ä¿æŠ¤è¿è¡Œç½‘ç«™çš„æœåŠ¡å™¨ä¸ä½¿ç”¨çš„æµè§ˆå™¨ä¹‹é—´çš„é€šä¿¡ã€‚ä¼ è¾“æ•æ„Ÿä¿¡æ¯æˆ–ç§äººä¿¡æ¯ç”šè‡³éƒ½æ— å…³ç´§è¦ - æ— è®ºå¦‚ä½•ï¼Œè¿æ¥éƒ½æ˜¯å®‰å…¨çš„ã€‚</p><p>ä½¿ç”¨ TLS éœ€è¦è¯ä¹¦é¢å‘æœºæ„ (CA) å‘æœåŠ¡å™¨é¢å‘æ•°å­—è¯ä¹¦ï¼Œç„¶åè¯¥æœåŠ¡å™¨å°†å…¶äº¤ç»™æµè§ˆå™¨ä»¥é€šè¿‡ CA è¿›è¡ŒéªŒè¯ã€‚
mTLS é‡‡ç”¨ç›¸åŒçš„æƒ³æ³•ï¼Œä½†å°†å…¶åº”ç”¨äºåº”ç”¨ç¨‹åºæˆ–æœåŠ¡ã€‚è¿™æ„å‘³ç€å®¢æˆ·ç«¯ä¸ä»…éªŒè¯æœåŠ¡å™¨çš„è¯ä¹¦ï¼Œè¿˜éªŒè¯å®¢æˆ·ç«¯çš„è¯ä¹¦ã€‚
TLS çš„ä¸€ä¸ªä¾‹å­æ˜¯è¶Šè¿‡è¾¹å¢ƒï¼Œéœ€è¦å‘æµ·å…³å®˜å‘˜å‡ºç¤ºæŠ¤ç…§ï¼ˆè¯ä¹¦ï¼‰ã€‚æµ·å…³å®˜å‘˜ç¡®ä¿æŠ¤ç…§æœ‰æ•ˆã€æœªè¿‡æœŸç­‰ã€‚åœ¨ mTLS çš„æƒ…å†µä¸‹ï¼Œè¿˜éœ€è¦å‘æµ·å…³å®˜å‘˜ç´¢å–æŠ¤ç…§ï¼Œç„¶åè¿›è¡ŒéªŒè¯ã€‚ä¸€æ—¦åŒæ–¹é€šè¿‡å„è‡ªçš„ CA éªŒè¯äº†è¯ä¹¦ï¼ŒåŒæ–¹ä¹‹é—´çš„é€šä¿¡å°±å¯ä»¥å®‰å…¨åœ°è¿›è¡Œã€‚</p><p>å¯¹äº Istioï¼ŒæœåŠ¡ä¹‹é—´çš„æ‰€æœ‰é€šä¿¡éƒ½é€šè¿‡ Envoy ä»£ç†ã€‚ä»¥ä¸‹æ˜¯ä»æœåŠ¡ A å‘æœåŠ¡ B è¿›è¡Œè°ƒç”¨æ—¶å‘ç”Ÿçš„æ­¥éª¤ï¼š</p><ol><li>æµé‡ä»æœåŠ¡ A è·¯ç”±åˆ°åŒä¸€ä¸ª pod ä¸­çš„ Envoy ä»£ç†</li><li>æœåŠ¡ A ä»£ç†å¯åŠ¨ä¸æœåŠ¡ B ä»£ç†çš„ mTLS æ¡æ‰‹ï¼ˆä¹Ÿä¼šè¿›è¡Œå®‰å…¨å‘½åæ£€æŸ¥ï¼‰</li><li>mTLS è¿æ¥å»ºç«‹</li><li>æµé‡è¢«è½¬å‘åˆ°æœåŠ¡ B ä»£ç†</li><li>æœåŠ¡ B ä»£ç†å°†æµé‡è½¬å‘åˆ°åŒä¸€ä¸ª pod ä¸­çš„æœåŠ¡ B</li></ol><p>Istio ä¸­çš„ Mutual TLS æ”¯æŒä¸€ç§è®¸å¯æ¨¡å¼ã€‚æ­¤æ¨¡å¼å…è®¸æœåŠ¡åŒæ—¶æ¥å—çº¯æ–‡æœ¬æµé‡å’Œ mTLS æµé‡ã€‚è¿™å¯ä»¥å¸®åŠ©æˆ‘ä»¬é€æ­¥å°†æœåŠ¡è¿ç§»åˆ° mTLSï¼Œè€Œä¸ä¼šç ´åç°æœ‰çš„çº¯æ–‡æœ¬æµé‡ã€‚ä¸€æ—¦æ‰€æœ‰æœåŠ¡éƒ½æ‹¥æœ‰ä»£ç†ï¼Œå°±å¯ä»¥æ”¹ä¸ºé…ç½® mTLS å”¯ä¸€æ¨¡å¼ã€‚</p><p>è¦åœ¨æœåŠ¡ä¹‹é—´é…ç½® mTLSï¼Œä½¿ç”¨ç›®æ ‡è§„åˆ™ (DestinationRule) ä¸­çš„æµé‡ç­–ç•¥å­—æ®µã€‚ä¾‹å¦‚ï¼Œè¦æ±‚å®¢æˆ·ç«¯åœ¨ä¸ service-b é€šä¿¡æ—¶ä½¿ç”¨ mTLSï¼Œå¯ä»¥ä½¿ç”¨ ISTIO_MUTUAL æ¨¡å¼ï¼š</p><pre tabindex=0><code>apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: service-b-istio-mtls
spec:
  host: service-b.default.svc.cluster.local
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL
</code></pre><p>è¿˜å¯ä»¥æä¾›è‡ªå·±çš„è¯ä¹¦å¹¶å°†æ¨¡å¼è®¾ç½®ä¸º MUTUALï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre tabindex=0><code>apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: service-b-mtls
spec:
  host: service-b.default.svc.cluster.local
  trafficPolicy:
    tls:
      mode: MUTUAL
      clientCertificate: /etc/certs/cert.pem
      privateKey: /etc/certs/pkey.pem
      caCertificates: /etc/certs/cacerts.pem
</code></pre><p>æœ€åï¼Œè¿˜å¯ä»¥å°† mode å­—æ®µè®¾ç½®ä¸º SIMPLE ä»¥ä¾¿å®¢æˆ·ç«¯é…ç½®ä½¿ç”¨ TLSï¼š</p><pre tabindex=0><code>apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: service-b-tls
spec:
  host: service-b.default.svc.cluster.local
  trafficPolicy:
    tls:
      mode: SIMPLE
</code></pre><h3 id=æºè®¤è¯origin-authentication>æºè®¤è¯ï¼ˆOrigin authenticationï¼‰</h3><p>æºèº«ä»½éªŒè¯ï¼Œç§°ä¸ºæœ€ç»ˆç”¨æˆ·èº«ä»½éªŒè¯ï¼Œç”¨äºéªŒè¯ä½œä¸ºæœ€ç»ˆç”¨æˆ·æˆ–è®¾å¤‡è¯·æ±‚çš„åŸå§‹å®¢æˆ·ç«¯ã€‚Istio é€šè¿‡ JSON Web Token (JWT) éªŒè¯å’Œå¼€æº OpenID è¿æ¥æä¾›ç¨‹åºï¼ˆä¾‹å¦‚ Googe Authã€Auth0 æˆ– Firebase Authï¼‰å¯ç”¨åŸå§‹èº«ä»½éªŒè¯ã€‚åœ¨åŸå§‹èº«ä»½éªŒè¯ (JWT) çš„æƒ…å†µä¸‹ï¼Œåº”ç”¨ç¨‹åºæœ¬èº«è´Ÿè´£è·å– JWT ä»¤ç‰Œå¹¶å°†å…¶é™„åŠ åˆ°è¯·æ±‚ä¸­ã€‚</p><h3 id=èº«ä»½è®¤è¯ç­–ç•¥>èº«ä»½è®¤è¯ç­–ç•¥</h3><p>èº«ä»½è®¤è¯ç­–ç•¥ç”¨äºæŒ‡å®šç½‘æ ¼å†…æœåŠ¡çš„èº«ä»½éªŒè¯è¦æ±‚ã€‚åŒæ ·ï¼Œä¸æµé‡è·¯ç”±ä¸€æ ·ï¼ŒPilot ç›‘è§†ç­–ç•¥èµ„æºçš„å˜åŒ–ï¼Œç„¶åå°†é…ç½®è½¬æ¢å¹¶æ¨é€åˆ° Envoy ä»£ç†ã€‚äº›ç­–ç•¥å®šä¹‰äº†å¯ä»¥æ¥å—çš„èº«ä»½éªŒè¯æ–¹æ³•ï¼ˆå³æ¥æ”¶çš„è¯·æ±‚ï¼‰ã€‚è€Œå¯¹äºä¼ å‡ºè¯·æ±‚ï¼Œå¯ä»¥å°†ä½¿ç”¨æœ¬åšå®¢å‰é¢æ‰€è¿°çš„ç›®æ ‡è§„åˆ™ã€‚ä¸‹å›¾è¯´æ˜äº†è¿™ä¸€ç‚¹ï¼š</p><p><img src=/images/2022-02-19-istio-security/3.png alt>
å¯ä»¥åœ¨æ¥ä¸‹æ¥è§£é‡Šçš„ä¸¤ä¸ªèŒƒå›´å†…å®šä¹‰èº«ä»½éªŒè¯ç­–ç•¥ã€‚</p><h3 id=å‘½åç©ºé—´èŒƒå›´çš„ç­–ç•¥>å‘½åç©ºé—´èŒƒå›´çš„ç­–ç•¥</h3><p>å‘½åç©ºé—´èŒƒå›´å†…çš„ç­–ç•¥åªèƒ½å½±å“åœ¨åŒä¸€å‘½åç©ºé—´ä¸­è¿è¡Œçš„æœåŠ¡ã€‚æ­¤å¤–ï¼Œéœ€è¦æŒ‡å®šå‘½åç©ºé—´åç§°ï¼Œå¦åˆ™å°†ä½¿ç”¨é»˜è®¤å‘½åç©ºé—´ã€‚ä¸‹é¢æ˜¯ prod å‘½åç©ºé—´çš„å‘½åç©ºé—´ç­–ç•¥ç¤ºä¾‹ï¼š</p><pre tabindex=0><code>apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: default
spec:
  mtls:
    mode: STRICT
</code></pre><h3 id=ç½‘æ ¼èŒƒå›´çš„ç­–ç•¥>ç½‘æ ¼èŒƒå›´çš„ç­–ç•¥</h3><p>ç½‘æ ¼èŒƒå›´çš„ç­–ç•¥å¯ä»¥åº”ç”¨äºç½‘æ ¼ä¸­çš„æ‰€æœ‰æœåŠ¡ã€‚åªèƒ½å®šä¹‰ä¸€ä¸ªåä¸º default å’Œä¸€ä¸ªç©ºç›®æ ‡éƒ¨åˆ†çš„ç½‘æ ¼èŒƒå›´ç­–ç•¥ã€‚ä¸å‘½åç©ºé—´èŒƒå›´ç­–ç•¥çš„ä¸€ä¸ªåŒºåˆ«æ˜¯èµ„æºåç§°ã€‚å‘½åç©ºé—´èŒƒå›´çš„ç­–ç•¥èµ„æºç§°ä¸ºâ€œPolicyâ€ï¼Œè€Œç½‘æ ¼èŒƒå›´çš„ç­–ç•¥èµ„æºç§°ä¸ºâ€œMeshPolicyâ€ã€‚</p><h3 id=ç›®æ ‡é€‰æ‹©å™¨>ç›®æ ‡é€‰æ‹©å™¨</h3><p>ä¸ºäº†å®šä¹‰å—ç­–ç•¥å½±å“çš„æœåŠ¡ï¼Œä½¿ç”¨äº†ç›®æ ‡é€‰æ‹©å™¨ã€‚ç›®æ ‡é€‰æ‹©å™¨æ˜¯åº”ç”¨ç­–ç•¥çš„é€‰å®šæœåŠ¡çš„è§„åˆ™åˆ—è¡¨ã€‚å¦‚æœæœªæä¾›ç›®æ ‡é€‰æ‹©å™¨ï¼Œåˆ™è¯¥ç­–ç•¥å°†ç”¨äºåŒä¸€å‘½åç©ºé—´ä¸­çš„æ‰€æœ‰æœåŠ¡ã€‚ä¾‹å¦‚ï¼Œä¸‹é¢çš„å‘½åç©ºé—´èŒƒå›´ç­–ç•¥å°†åº”ç”¨äºç«¯å£ 8080 ä¸Šçš„æœåŠ¡ aï¼ˆæ— è®ºç«¯å£ï¼‰å’ŒæœåŠ¡ bï¼š</p><pre tabindex=0><code>apiVersion: authentication.istio.io/v1alpha1
kind: PeerAuthentication
metadata:
  name: sample-policy
  namespace: prod
spec:
  target:
  - name: service-a
  - name: service-b
    ports:
    - number: 8080
</code></pre><p>å­˜åœ¨å¤šä¸ªç­–ç•¥çš„æƒ…å†µä¸‹ï¼Œå®ƒä»¬ä»æœ€çª„çš„åŒ¹é…ç­–ç•¥ï¼ˆä¾‹å¦‚ç‰¹å®šæœåŠ¡ï¼‰åˆ°å‘½åç©ºé—´å’Œç½‘æ ¼èŒƒå›´å†…è¿›è¡Œè¯„ä¼°ã€‚å¦‚æœå¤šä¸ªç­–ç•¥é€‚ç”¨äºä¸€é¡¹æœåŠ¡ï¼Œåˆ™éšæœºé€‰æ‹©ä¸€ä¸ªã€‚</p><h3 id=ä¼ è¾“è®¤è¯>ä¼ è¾“è®¤è¯</h3><p>åä¸º peers çš„å­—æ®µå®šä¹‰äº†èº«ä»½éªŒè¯æ–¹æ³•å’Œè¯¥æ–¹æ³•çš„ä»»ä½•å‚æ•°ã€‚åœ¨æ’°å†™æœ¬æ–‡æ—¶ï¼Œå”¯ä¸€å—æ”¯æŒçš„èº«ä»½éªŒè¯æ–¹æ³•æ˜¯ mTLSã€‚è¦å¯ç”¨å®ƒï¼Œä½¿ç”¨ mtls é”®ï¼ˆä½¿ç”¨å‰é¢çš„ç¤ºä¾‹ï¼‰ï¼š</p><pre tabindex=0><code>apiVersion: authentication.istio.io/v1alpha1
kind: PeerAuthentication
metadata:
  name: sample-policy
  namespace: prod
spec:
  target:
  - name: service-a
  - name: service-b
    ports:
    - number: 8080
  peers:
    - mtls:
...
</code></pre><h3 id=æºè®¤è¯>æºè®¤è¯</h3><p>ç›®å‰ Istio æ”¯æŒçš„å”¯ä¸€æ¥æºèº«ä»½éªŒè¯æ˜¯ JWTã€‚ä½¿ç”¨ origins å­—æ®µï¼Œå¯ä»¥å®šä¹‰æ–¹æ³•å’Œå‚æ•°ï¼Œä¾‹å¦‚å…è®¸çš„ JWT é¢å‘è€…ä»¥åŠå¯ç”¨æˆ–ç¦ç”¨ç‰¹å®šè·¯å¾„çš„ JWT èº«ä»½éªŒè¯ã€‚è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹ç‰‡æ®µï¼Œå±•ç¤ºäº†å¦‚ä½•å®šä¹‰æ¥å— Google å‘å¸ƒçš„ JWT çš„åŸå§‹èº«ä»½éªŒè¯ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬ä» JWT èº«ä»½éªŒè¯ä¸­æ’é™¤ /health è·¯å¾„ï¼š</p><pre tabindex=0><code>origins:
- jwt:
    issuer: https://accounts.google.com
    jwksUri: https://www.googleapis.com/oauth2/v3/certs
    trigger_rules:
    - excluded_paths:
      - exact: /health
</code></pre><h2 id=æˆæƒauthorization>æˆæƒï¼ˆAuthorizationï¼‰</h2><p>æˆæƒåŠŸèƒ½å¯ç”¨äºå¯ç”¨å¯¹ç½‘æ ¼ä¸­å·¥ä½œè´Ÿè½½çš„è®¿é—®æ§åˆ¶ã€‚è¯¥ç­–ç•¥æ”¯æŒ ALLOW å’Œ DENY ç­–ç•¥ã€‚å¦‚æœåŒæ—¶ä½¿ç”¨å…è®¸å’Œæ‹’ç»ç­–ç•¥ï¼Œåˆ™é¦–å…ˆè¯„ä¼°æ‹’ç»ç­–ç•¥ã€‚æ¯ä¸ª Envoy ä»£ç†éƒ½ä½¿ç”¨ä¸€ä¸ªæˆæƒå¼•æ“ï¼Œè¯¥å¼•æ“åœ¨è¿è¡Œæ—¶å†³å®šæ˜¯å…è®¸è¿˜æ˜¯æ‹’ç»è¯·æ±‚ã€‚å½“è¯·æ±‚åˆ°è¾¾ä»£ç†æ—¶ï¼Œæˆæƒå¼•æ“è¯„ä¼°è¯·æ±‚å¹¶è¿”å›æˆæƒç»“æœ - å…è®¸æˆ–æ‹’ç»ã€‚ç­–ç•¥æŒ‰ä»¥ä¸‹é¡ºåºè¿›è¡Œè¯„ä¼°ï¼š</p><ol><li>å¦‚æœä»»ä½• DENY ç­–ç•¥ä¸è¯·æ±‚åŒ¹é… â†’ æ‹’ç»è¯·æ±‚</li><li>å¦‚æœå·¥ä½œè´Ÿè½½æ²¡æœ‰ ALLOW ç­–ç•¥ â†’ å…è®¸è¯·æ±‚</li><li>å¦‚æœä»»ä½• ALLOW ç­–ç•¥ä¸è¯·æ±‚åŒ¹é… â†’ å…è®¸è¯·æ±‚</li></ol><p>æ‹’ç»è¯·æ±‚ï¼Œæ— éœ€å•ç‹¬å¯ç”¨ä»»ä½•æˆæƒåŠŸèƒ½ã€‚ä¸ºå·¥ä½œè´Ÿè½½åˆ›å»ºå’Œåº”ç”¨æˆæƒç­–ç•¥å°±è¶³å¤Ÿäº†ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœæ²¡æœ‰å®šä¹‰æˆæƒç­–ç•¥ï¼Œåˆ™ä¸ä¼šå¼ºåˆ¶æ‰§è¡Œè®¿é—®æ§åˆ¶å¹¶å…è®¸æ‰€æœ‰è¯·æ±‚ã€‚</p><p>æˆæƒç­–ç•¥æ˜¯ä½¿ç”¨ AuthorizationPolicy èµ„æºé…ç½®çš„ã€‚æ­¤èµ„æºåŒ…æ‹¬é€‰æ‹©å™¨ï¼ˆç›®æ ‡å·¥ä½œè´Ÿè½½ï¼‰ã€æ“ä½œï¼ˆå…è®¸æˆ–æ‹’ç»ï¼‰å’ŒæŒ‡å®šä½•æ—¶è§¦å‘æ“ä½œçš„è§„åˆ™åˆ—è¡¨ã€‚</p><p>ä¾‹å¦‚ï¼Œé€šè¿‡ä¸‹é¢çš„ä»£ç ç‰‡æ®µï¼Œå¯ä»¥å°†æˆæƒç­–ç•¥åº”ç”¨äºä»»ä½•è®¾ç½®äº†æ ‡ç­¾ app=greeter-service å’Œ version=v2 çš„å·¥ä½œè´Ÿè½½ã€‚ä¸€æ—¦è¯·æ±‚åˆ°è¾¾å·¥ä½œè´Ÿè½½çš„ Envoy ä»£ç†ï¼Œæˆæƒå¼•æ“å°±ä¼šæ£€æŸ¥æµé‡æ˜¯å¦æ¥è‡ªå…·æœ‰æä¾›çš„æœåŠ¡å¸æˆ· (helloweb) çš„ä¸»ä½“ï¼Œä»¥åŠæ“ä½œæ˜¯å¦æ˜¯ GET å¹¶ä¸” x-user æ ‡å¤´è®¾ç½®ä¸º user-1ã€‚å¦‚æœæ‰€æœ‰è¿™äº›éƒ½æ»¡è¶³ï¼Œåˆ™å…è®¸è¯·æ±‚ï¼Œå¦åˆ™ï¼Œè¯·æ±‚è¢«æ‹’ç»ã€‚</p><pre tabindex=0><code>apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
 name: greeter-service
 namespace: default
spec:
 action: ALLOW
 selector:
   matchLabels:
     app: greeter-service
     version: v2
 rules:
 - from:
   - source:
       principals: [&#34;cluster.local/ns/default/sa/helloweb&#34;]
   to:
   - operation:
       methods: [&#34;GET&#34;]
   when:
   - key: request.headers[x-user]
     values: [&#34;user-1&#34;]
</code></pre><p>æˆ‘ä»¬ä¸“é—¨å°†æˆæƒç­–ç•¥åº”ç”¨äºæ ‡è®°ä¸º app: greeter-service å’Œ version: v2 çš„å·¥ä½œè´Ÿè½½ã€‚å¦‚æœæˆ‘ä»¬æƒ³å°†ç­–ç•¥åº”ç”¨äºé»˜è®¤å‘½åç©ºé—´ä¸­çš„æ‰€æœ‰å·¥ä½œè´Ÿè½½ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•åœ°çœç•¥é€‰æ‹©å™¨å­—æ®µï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre tabindex=0><code>apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
 name: greeter-service
 namespace: default
spec:
 rules:
 - from:
   - source:
       principals: [&#34;cluster.local/ns/default/sa/helloweb&#34;]
   to:
   - operation:
       methods: [&#34;GET&#34;]
   when:
   - key: request.headers[x-user]
     values: [&#34;user-1&#34;]
</code></pre><p>è¿˜å¯ä»¥å®šä¹‰é€‚ç”¨äºæœåŠ¡ç½‘æ ¼ä¸­æ‰€æœ‰å·¥ä½œè´Ÿè½½çš„æˆæƒç­–ç•¥ï¼Œæ— è®ºå‘½åç©ºé—´å¦‚ä½•ã€‚ä¸ºæ­¤ï¼Œéœ€è¦åœ¨æ ¹å‘½åç©ºé—´ä¸­åˆ›å»ºä¸€ä¸ª AuthorizationPolicyã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ ¹å‘½åç©ºé—´æ˜¯ istio-systemã€‚å¦‚æœéœ€è¦æ›´æ”¹å®ƒï¼Œåˆ™å¿…é¡»æ›´æ–° MeshConfig ä¸­çš„ rootNamespace å­—æ®µã€‚</p><h3 id=å€¼åŒ¹é…>å€¼åŒ¹é…</h3><p>å¯ä»¥å¯¹æˆæƒç­–ç•¥ä¸­çš„å¤§å¤šæ•°å­—æ®µä½¿ç”¨ä»¥ä¸‹åŒ¹é…æ–¹æ¡ˆï¼š</p><ol><li>ç²¾ç¡®(Exact): åŒ¹é…ç²¾ç¡®çš„å­—ç¬¦ä¸²</li><li>å‰ç¼€(Prefix)ï¼šåŒ¹é…ä»¥æŒ‡å®šå€¼ [Prefix]* å¼€å¤´çš„å­—ç¬¦ä¸²ã€‚ä¾‹å¦‚ï¼š&ldquo;hello.world&rdquo; åŒ¹é… &ldquo;hello.world.blah&rdquo;ï¼Œä½†ä¸åŒ¹é… &ldquo;blah.hello.world&rdquo;ã€‚</li><li>åç¼€(Suffix)ï¼šåŒ¹é…ä»¥æŒ‡å®šå€¼ *[åç¼€] ç»“å°¾çš„å­—ç¬¦ä¸²ã€‚ä¾‹å¦‚ï¼š&ldquo;hello.world&rdquo; åŒ¹é… &ldquo;blah.hello.world&rdquo;ï¼Œä½†ä¸åŒ¹é… &ldquo;hell.world.blah&rdquo;ã€‚</li></ol><p>çŠ¶æ€(Presence)ï¼šåŒ¹é…é™¤ç©ºä¹‹å¤–çš„ä»»ä½•å€¼ï¼ˆå³å¿…é¡»æä¾›å€¼ï¼Œä½†åªè¦å®ƒä¸æ˜¯ç©ºçš„ï¼Œæˆ‘ä»¬ä¸åœ¨ä¹å®ƒæ˜¯ä»€ä¹ˆï¼‰ã€‚æœ‰å‡ ä¸ªå­—æ®µè¢«è±å…ï¼Œåªæ”¯æŒç²¾ç¡®åŒ¹é…ï¼š</p><ol><li>when éƒ¨åˆ†ä¸‹çš„ key å­—æ®µ</li><li>source éƒ¨åˆ†ä¸‹çš„ ipBlocks å­—æ®µ</li><li>to éƒ¨åˆ†ä¸‹çš„ ports å­—æ®µ</li></ol><p>ä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œè¯´æ˜å¦‚ä½•é…ç½®å…è®¸è®¿é—® /api ä¸‹çš„ä»»ä½•è·¯å¾„ï¼Œåªè¦å®ƒæ˜¯ GET è¯·æ±‚ï¼š</p><pre tabindex=0><code>apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
 name: greeter-service
 namespace: default
spec:
  selector:
    matchLabels:
      app: greeter-service
  action: ALLOW
  rules:
   - to:
    - operation:
        methods: [&#34;GET&#34;]
        paths: [&#34;/api/*&#34;]
</code></pre><h3 id=å€¼ä¸åŒ¹é…>å€¼ä¸åŒ¹é…</h3><p>é™¤äº†åŒ…å«åŒ¹é…ï¼ŒIstio è¿˜æ”¯æŒåŒ¹é…æ’é™¤ã€‚è¿™æ„å‘³ç€å¯ä»¥åŒ¹é… NotValueã€notPorts æˆ– notIpBlocks ç­‰ç›¸åæ¡ä»¶ã€‚ä»¥ä¸‹ä»£ç æ®µå…è®¸ä¸æ˜¯ /private è·¯å¾„ä¸‹çš„è¯·æ±‚ï¼š</p><pre tabindex=0><code>apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
 name: greeter-service
 namespace: default
spec:
  selector:
    matchLabels:
      app: greeter-service
  action: ALLOW
  rules:
   - to:
    - operation:
        notPaths: [&#34;/private&#34;]
</code></pre><h3 id=å…è®¸ä¸æ‹’ç»>å…è®¸ä¸æ‹’ç»</h3><p>è¦åˆ›å»ºå…è®¸å®Œå…¨è®¿é—®æŒ‡å®šå‘½åç©ºé—´ä¸­æ‰€æœ‰å·¥ä½œè´Ÿè½½çš„ authorization policyï¼Œ å¯ä»¥åˆ›å»ºä¸€ä¸ªåŒ…å«ç©ºè§„åˆ™éƒ¨åˆ†çš„ç­–ç•¥ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre tabindex=0><code>apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: allow-all
  namespace: default
spec:
  action: ALLOW
  rules:
  - {}
</code></pre><p>ç±»ä¼¼åœ°ï¼Œå¯ä»¥é€šè¿‡ä½¿ç”¨ç©ºçš„è§„èŒƒå­—æ®µæ¥æ‹’ç»å¯¹æ‰€æœ‰å·¥ä½œè´Ÿè½½çš„è®¿é—®ï¼š</p><pre tabindex=0><code>apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: deny-all
  namespace: default
spec:
  {}
</code></pre><h1 id=æ¡ˆä¾‹>æ¡ˆä¾‹</h1><p>ä¸ºäº†æ¼”ç¤ºå®‰å…¨ç‰¹æ€§ï¼Œæˆ‘ä»¬å°†éƒ¨ç½² Hello Webã€Greeter æœåŠ¡å’Œç›¸åº”çš„è™šæ‹ŸæœåŠ¡ã€‚éƒ¨ç½² greeter deployment å’Œ service:</p><pre tabindex=0><code>cat &lt;&lt;EOF | kubectl create -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: greeter-service-v1
  labels:
    app: greeter-service
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: greeter-service
      version: v1
  template:
    metadata:
      labels:
        app: greeter-service
        version: v1
    spec:
      containers:
        - image: learnistio/greeter-service:1.0.0
          imagePullPolicy: Always
          name: svc
          ports:
            - containerPort: 3000
---
kind: Service
apiVersion: v1
metadata:
  name: greeter-service
  labels:
    app: greeter-service
spec:
  selector:
    app: greeter-service
  ports:
    - port: 3000
      name: http
EOF
</code></pre><p>ç„¶åï¼Œéƒ¨ç½² Hello Web å·¥ä½œè´Ÿè½½ä¸æœåŠ¡:</p><pre tabindex=0><code>cat &lt;&lt;EOF | kubectl create -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: helloweb
  labels:
    app: helloweb
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: helloweb
      version: v1
  template:
    metadata:
      labels:
        app: helloweb
        version: v1
    spec:
      containers:
        - image: learnistio/hello-web:1.0.0
          imagePullPolicy: Always
          name: web
          ports:
            - containerPort: 3000
          env:
            - name: GREETER_SERVICE_URL
              value: &#39;http://greeter-service.default.svc.cluster.local:3000&#39;
---
kind: Service
apiVersion: v1
metadata:
  name: helloweb
  labels:
    app: helloweb
spec:
  selector:
    app: helloweb
  ports:
    - port: 3000
      name: http
EOF
</code></pre><p>æœ€åï¼Œä¸º Hello web åˆ›å»ºè™šæ‹ŸæœåŠ¡ï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥é€šè¿‡ç½‘å…³è®¿é—®å®ƒã€‚ä¸è¦å¿˜è®°åœ¨ç¬¬ä¸‰ç¯‡åšå®¢ä¸­æåˆ°çš„éƒ¨ç½²ç½‘å…³æ­¥éª¤ã€‚</p><pre tabindex=0><code>cat &lt;&lt;EOF | kubectl apply -f -
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: helloweb
spec:
  hosts:
    - &#39;*&#39;
  gateways:
    - gateway
  http:
    - route:
      - destination:
          host: helloweb.default.svc.cluster.local
          port:
            number: 3000
EOF
</code></pre><p>æ‰“å¼€ http://$GATEWAYï¼Œåº”è¯¥ä¼šçœ‹åˆ°ç†Ÿæ‚‰çš„ Hello webï¼Œä»¥åŠæ¥è‡ªé—®å€™æœåŠ¡çš„å“åº”ã€‚è®©æˆ‘ä»¬ä¸‹å‘ä½¿ç”¨æ‹’ç»è®¿é—®æ‰€æœ‰å·¥ä½œè´Ÿè½½çš„æˆæƒç­–ç•¥ï¼š</p><pre tabindex=0><code>cat &lt;&lt;EOF | kubectl apply -f - 
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: deny-all
  namespace: default
spec: {}
EOF
</code></pre><p>ä½¿ç”¨æ­¤é…ç½®ï¼Œæˆ‘ä»¬å°†æ‹’ç»è®¿é—®é»˜è®¤åç§°ç©ºé—´ä¸­çš„æ‰€æœ‰å·¥ä½œè´Ÿè½½ã€‚å°è¯•åˆ·æ–° http://$GATEWAY æˆ–è¿è¡Œ curl http://$GATEWAYã€‚è¿™ä¸€æ¬¡ï¼Œå®ƒå°†ä¸èµ·ä½œç”¨ï¼Œå°†çœ‹åˆ°ä»¥ä¸‹é”™è¯¯ï¼š</p><pre tabindex=0><code>RBAC: access denied
</code></pre><p>ä¸ºäº†å…è®¸ Hello Web æœåŠ¡è°ƒç”¨ Greeter æœåŠ¡ï¼Œæˆ‘ä»¬å¯ä»¥æ›´æ–°æˆæƒç­–ç•¥ï¼Œè¯¥ç­–ç•¥æ˜ç¡®å…è®¸ Hello Web å‘ Greeter æœåŠ¡å‘å‡ºè¯·æ±‚ã€‚è®©æˆ‘ä»¬å…ˆè¿è¡Œä»¥ä¸‹å‘½ä»¤åˆ é™¤ä¸Šä¸€ä¸ªç­–ç•¥ï¼š</p><pre tabindex=0><code>kubectl delete authorizationpolicy deny-all
</code></pre><p>ç°åœ¨æˆ‘ä»¬å¯ä»¥åˆ›å»ºæ–°ç­–ç•¥ï¼š</p><pre tabindex=0><code>cat &lt;&lt;EOF | kubectl apply -f -
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
 name: greeter-service
 namespace: default
spec:
 selector:
  matchLabels:
    app: greeter-service
 rules:
  - to: 
    - operation:
        methods: [&#34;GET&#34;]
EOF
</code></pre><p>å¦‚æœä½ è¯•å›¾é‡æ–°è®¿é—®è¯¥ç½‘ç«™ï¼Œä½ åº”è¯¥èƒ½å¤Ÿå†æ¬¡çœ‹åˆ°å›å¤ã€‚è¯·æ³¨æ„ï¼Œç¼“å­˜å¯èƒ½ä¼šå¯¼è‡´ä¸€äº›å»¶è¿Ÿã€‚è®©æˆ‘ä»¬è¿›ä¸€æ­¥æ”¶ç´§æœåŠ¡è§’è‰²å¹¶æ›´æ–°æˆæƒç­–ç•¥ï¼Œè¿™æ ·æˆ‘ä»¬åªèƒ½åœ¨å…¶ä¸Šè°ƒç”¨ /hello è·¯å¾„ï¼š</p><pre tabindex=0><code>cat &lt;&lt;EOF | kubectl apply -f -
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
 name: greeter-service
 namespace: default
spec:
 selector:
  matchLabels:
    app: greeter-service
 rules:
  - to: 
    - operation:
        methods: [&#34;GET&#34;]
        paths: [&#34;*/hello&#34;]
EOF
</code></pre><p>ä¸ºäº†æµ‹è¯•è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å°†åœ¨ Hello web å®¹å™¨ä¸­è·å¾—ä¸€ä¸ª shellï¼Œå¹¶ä½¿ç”¨ curl å‘ greeter æœåŠ¡å‘å‡ºè¯·æ±‚ã€‚é¦–å…ˆï¼Œè®©æˆ‘ä»¬é€šè¿‡è¿è¡Œ kubectl get podï¼Œç„¶åè¿è¡Œ exec å‘½ä»¤æ¥è®¡ç®— Hello web pod çš„åç§°ï¼š</p><pre tabindex=0><code>kubectl exec -it [podname] /bin/sh
</code></pre><p>åœ¨å®¹å™¨ä¸­ï¼Œè®©æˆ‘ä»¬å…ˆå®‰è£… curlï¼š</p><pre tabindex=0><code>apk add curl
</code></pre><p>æˆ‘ä»¬ç°åœ¨å¯ä»¥æµ‹è¯•æœåŠ¡è§’è‰²äº†ã€‚å¦‚æœå¯¹ /hello è·¯å¾„è¿è¡Œ curlï¼Œä¸€åˆ‡éƒ½ä¼šæŒ‰é¢„æœŸè¿è¡Œï¼š</p><pre tabindex=0><code>curl greeter-service.default.svc.cluster.local:3000/hello
{&#34;message&#34;:&#34;hello ğŸ‘‹ &#34;,&#34;version&#34;:&#34;1.0.0&#34;}
</code></pre><p>ä½†æ˜¯ï¼Œå¦‚æœå¯¹ /version è·¯å¾„å‘å‡ºè¯·æ±‚ï¼Œå°†çœ‹åˆ°å¸¸è§çš„é”™è¯¯æ¶ˆæ¯ï¼š</p><pre tabindex=0><code>curl greeter-service.default.svc.cluster.local:3000/version
RBAC: access denied
</code></pre><p>è¦æ¸…é™¤æ‰€æœ‰å†…å®¹ï¼Œåªéœ€åˆ é™¤æˆæƒç­–ç•¥ã€‚</p><h1 id=æ€»ç»“>æ€»ç»“</h1><p>åœ¨æœ¬åšå®¢ä¸­ï¼Œé€šè¿‡å‡ ä¸ªç¤ºä¾‹ï¼Œè®¤è¯†æœåŠ¡ç½‘æ ¼ istio æ˜¯å¦‚ä½•å¤„ç†å®‰å…¨æ€§é—®é¢˜å’Œç”¨äºå®šä¹‰æˆæƒç­–ç•¥çš„ä¸åŒåŠŸèƒ½ã€‚</p><h1 id=å‚è€ƒ>å‚è€ƒ</h1><ol><li><a href=https://istio.tetratelabs.io/blog/istio-security/>https://istio.tetratelabs.io/blog/istio-security/</a></li></ol><hr><ul class=pager><li class=previous><a href=/post/2021-12-18-scheduling-framework/ data-toggle=tooltip data-placement=top title="è°ƒåº¦æ¡†æ¶ Scheduling Framework">&larr;
Previous Post</a></li><li class=next><a href=/post/2022-03-27-multi-architecture/ data-toggle=tooltip data-placement=top title="å¦‚ä½•æ„å»ºå¤šæ¶æ„å¤šå¹³å° Docker é•œåƒï¼Ÿ">Next
Post &rarr;</a></li></ul></div><div class="col-lg-2 col-lg-offset-0
visible-lg-block
sidebar-container
catalog-container"><div class=side-catalog><hr class="hidden-sm hidden-xs"><h5><a class=catalog-toggle href=#>CATALOG</a></h5><ul class=catalog-body></ul></div></div></div></div></article><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"><li><a href=mailto:tanjunchen20@gmail.com><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=/img/wechat.jpg><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-weixin fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://github.com/tanjunchen><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="copyright text-muted">Copyright &copy; é™ˆè°­å†› 2023<br><a href=https://themes.gohugo.io/hugo-theme-cleanwhite>CleanWhite Hugo Theme</a> by <a href=https://github.com/tanjunchen>tanjunchen</a></p></div></div></div></footer><script>function loadAsync(e,t){var s=document,o="script",n=s.createElement(o),i=s.getElementsByTagName(o)[0];n.src=e,t&&n.addEventListener("load",function(e){t(null,e)},!1),i.parentNode.insertBefore(n,i)}</script><script>$("#tag_cloud").length!==0&&loadAsync("/js/jquery.tagcloud.js",function(){$.fn.tagcloud.defaults={color:{start:"#bbbbee",end:"#0085a1"}},$("#tag_cloud a").tagcloud()})</script><script>loadAsync("https://cdn.jsdelivr.net/npm/fastclick@1.0.6/lib/fastclick.min.js",function(){var e=document.querySelector("nav");e&&FastClick.attach(e)})</script><script type=text/javascript>function generateCatalog(e){_containerSelector="div.post-container";var t,n,s,o,i,r=$(_containerSelector),a=r.find("h1,h2,h3,h4,h5,h6");return $(e).html(""),a.each(function(){n=$(this).prop("tagName").toLowerCase(),i="#"+$(this).prop("id"),s=$(this).text(),t=$('<a href="'+i+'" rel="nofollow">'+s+"</a>"),o=$('<li class="'+n+'_nav"></li>').append(t),$(e).append(o)}),!0}generateCatalog(".catalog-body"),$(".catalog-toggle").click(function(e){e.preventDefault(),$(".side-catalog").toggleClass("fold")}),loadAsync("/js/jquery.nav.js",function(){$(".catalog-body").onePageNav({currentClass:"active",changeHash:!1,easing:"swing",filter:"",scrollSpeed:700,scrollOffset:0,scrollThreshold:.2,begin:null,end:null,scrollChange:null,padding:80})})</script></body></html>