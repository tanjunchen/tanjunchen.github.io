<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:site_name" content="漫步远方，心荡神往"><meta property="og:type" content="article"><meta property="og:image" content="https://tanjunchen.github.io/img/home.webp"><meta property="twitter:image" content="https://tanjunchen.github.io/img/home.webp"><meta name=title content="使用 Istio 过程中遇到的常见问题与解决方法（五）"><meta property="og:title" content="使用 Istio 过程中遇到的常见问题与解决方法（五）"><meta property="twitter:title" content="使用 Istio 过程中遇到的常见问题与解决方法（五）"><meta name=description content="陈谭军，软件工程师, 开源爱好者, 互联网, 云原生, 容器, 微服务, Web, PaaS, Istio, Kubernetes, Microservice"><meta property="og:description" content="陈谭军，软件工程师, 开源爱好者, 互联网, 云原生, 容器, 微服务, Web, PaaS, Istio, Kubernetes, Microservice"><meta property="twitter:description" content="陈谭军，软件工程师, 开源爱好者, 互联网, 云原生, 容器, 微服务, Web, PaaS, Istio, Kubernetes, Microservice"><meta property="twitter:card" content="summary"><meta name=keyword content="陈谭军, 互联网, 云原生, 容器, 微服务, Web, PaaS, Istio, Kubernetes, Microservice"><link rel="shortcut icon" href=/img/favicon.ico><title>使用 Istio 过程中遇到的常见问题与解决方法（五） | 陈谭军的博客 | tanjunchen Blog</title><link rel=canonical href=/post/2022-11-22-istio-questions-5/><link rel=stylesheet href=/css/bootstrap.min.css><link rel=stylesheet href=/css/hugo-theme-cleanwhite.min.css><link rel=stylesheet href=/css/zanshang.css><link rel=stylesheet href=/css/font-awesome.all.min.css><script src=/js/jquery.min.js></script>
<script src=/js/bootstrap.min.js></script>
<script src=/js/hux-blog.min.js></script>
<script src=/js/lazysizes.min.js></script></head><nav class="navbar navbar-default navbar-custom navbar-fixed-top"><div class=container-fluid><div class="navbar-header page-scroll"><button type=button class=navbar-toggle>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span></button>
<a class=navbar-brand href=/>漫步远方，心荡神往</a></div><div id=huxblog_navbar><div class=navbar-collapse><ul class="nav navbar-nav navbar-right"><li><a href=/>All Posts</a></li><li><a href=/categories/technology/>technology</a></li><li><a href=/categories/think/>think</a></li><li><a href=/learning/>LEARNING</a></li><li><a href=/archive/>ARCHIVE</a></li><li><a href=/about/>ABOUT</a></li><li><a href=/search><i class="fa fa-search"></i></a></li></ul></div></div></div></nav><script>var $body=document.body,$toggle=document.querySelector(".navbar-toggle"),$navbar=document.querySelector("#huxblog_navbar"),$collapse=document.querySelector(".navbar-collapse");$toggle.addEventListener("click",handleMagic);function handleMagic(){$navbar.className.indexOf("in")>0?($navbar.className=" ",setTimeout(function(){$navbar.className.indexOf("in")<0&&($collapse.style.height="0px")},400)):($collapse.style.height="auto",$navbar.className+=" in")}</script><style type=text/css>header.intro-header{background-image:url(/img/home.webp)}</style><header class=intro-header><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><div class=tags><a class=tag href=/tags/istio title=istio>istio</a></div><h1>使用 Istio 过程中遇到的常见问题与解决方法（五）</h1><h2 class=subheading>在使用 Istio 过程中可能会碰到的棘手问题以及常见排查手段与解决方法</h2><span class=meta>Posted by
陈谭军
on
Tuesday, November 22, 2022
<span id=busuanzi_container_page_pv>|<span id=busuanzi_value_page_pv></span><span>
<span id=/post/2022-11-22-istio-questions-5/ class="leancloud_visitors meta_data_item" data-flag-title><span class=post-meta-item-icon><span class="octicon octicon-eye"></span></span>
<i class="fa fa-eye"></i>
<span class=old-visitors-count style=display:none></span>
<span class=leancloud-visitors-count></span></span>
<script src=https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js></script>
<script>AV.initialize("","")</script><script type=text/javascript>function showTime(e){var n=new AV.Query(e),t=[],s=$(".leancloud_visitors");s.each(function(){t.push($(this).attr("id").trim())}),n.containedIn("url",t),n.find().done(function(e){for(var s,o,i,a,r,c,l=".leancloud-visitors-count",d=".old-visitors-count",n=0;n<e.length;n++)a=e[n],i=a.get("url"),c=a.get("time"),s=document.getElementById(i),$(s).find(l).text(c);for(n=0;n<t.length;n++)i=t[n],s=document.getElementById(i),o=$(s).find(l),o.text()==""&&(r=$(s).find(d).text(),r!=""?o.text(0+parseInt(r)):o.text(0))}).fail(function(e,t){console.log("Error: "+t.code+" "+t.message)})}function addCount(e){var n=$(".leancloud_visitors"),t=n.attr("id").trim(),o=n.attr("data-flag-title").trim(),s=new AV.Query(e);s.equalTo("url",t),s.find({success:function(n){if(n.length>0){var s,i,r,c,l,a=n[0];a.fetchWhenSave(!0),a.increment("time"),a.save(null,{success:function(e){var n=$(document.getElementById(t));n.find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to save Visitor num, with error message: "+t.message)}})}else s=new e,i=new AV.ACL,i.setPublicReadAccess(!0),i.setPublicWriteAccess(!0),s.setACL(i),s.set("title",o),s.set("url",t),c=".old-visitors-count",l=$(document.getElementById(t)),r=l.find(c).text(),r!=""?s.set("time",parseInt(r)+1):s.set("time",1),s.save(null,{success:function(e){var n=$(document.getElementById(t));n.find(".leancloud-visitors-count").text(e.get("time"))},error:function(){console.log("Failed to create")}})},error:function(e){console.log("Error:"+e.code+" "+e.message)}})}$(function(){var e=AV.Object.extend("Counter");$(".leancloud_visitors").length==1?addCount(e):showTime(e)})</script>阅读 </span></span>|<span class=post-date>共 4350 字</span>，阅读约 <span class=more-meta>9 分钟</span></span></div></div></div></div></header><article><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
post-container"><p>服务网格为微服务提供了一个服务通信的基础设施层，统一为上层的微服务提供了服务发现、负载均衡、重试、熔断等基础通信功能，以及服务路由、灰度发布等高级治理功能。如果我们在使用服务网格系统出现问题的话，我们如何才能快速定位问题以及处理呢？</p><p><a href=https://tanjunchen.github.io/post/2022-11-18-istio-questions-1/>使用 Istio 过程中遇到的常见问题与解决方法（一）</a><br><a href=https://tanjunchen.github.io/post/2022-11-19-istio-questions-2/>使用 Istio 过程中遇到的常见问题与解决方法（二）</a><br><a href=https://tanjunchen.github.io/post/2022-11-20-istio-questions-3/>使用 Istio 过程中遇到的常见问题与解决方法（三）</a><br><a href=https://tanjunchen.github.io/post/2022-11-21-istio-questions-4/>使用 Istio 过程中遇到的常见问题与解决方法（四）</a><br><a href=https://tanjunchen.github.io/post/2022-11-22-istio-questions-5/>使用 Istio 过程中遇到的常见问题与解决方法（五）</a><br><a href=https://tanjunchen.github.io/post/2022-11-23-istio-questions-6/>使用 Istio 过程中遇到的常见问题与解决方法（六）</a></p><h1 id=istio-常见问题列表>Istio 常见问题列表</h1><ol><li>无法访问不带 sidecar 的 Pod</li><li>使用 ab 压测服务失败</li><li>服务使用 istio 保留端口导致 pod 启动失败</li><li>Envoy 报错: <code>gRPC config stream closed</code></li><li>Pod 启动卡住 <code>MountVolume.SetUp failed for volume "istio-token"</code></li><li>Istio 高频链接</li><li>服务地域感知不生效</li><li>Istio 常见的调试技巧、方法、脚本</li><li>Envoy 常见异常状态码汇总</li><li>如何编译 Istio 二进制与相关镜像</li></ol><h1 id=无法访问不带-sidecar-的-pod>无法访问不带 sidecar 的 Pod</h1><p><strong>现象</strong>：不能从带 sidecar proxy 的 pod 访问不带 sidecar proxy 的服务。</p><p><strong>原因</strong>：Istio 默认对服务会缺省启用 mTLS。带有 sidecar proxy 的 pod 出流量会使用 mTLS 加密，导致接受到流量的 Pod 解析失败，从而无法通信。</p><p><strong>解决办法</strong>：使用 DestinationRule 规则禁用该服务的 mTLS，示例如下所示：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>apiVersion</span>: networking.istio.io/v1beta1
</span></span><span style=display:flex><span><span style=color:#ff79c6>kind</span>: DestinationRule
</span></span><span style=display:flex><span><span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>name</span>: nginx
</span></span><span style=display:flex><span><span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>host</span>: nginx
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>trafficPolicy</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>loadBalancer</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>simple</span>: ROUND_ROBIN
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>tls</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>mode</span>: DISABLE
</span></span></code></pre></div><h1 id=使用-ab-压测服务失败>使用 ab 压测服务失败</h1><p><strong>现象</strong>：为服务配置了 DestinationRule 和 VirtualService，且 VirtualService 绑好了 Gateway，DestinationRule 配置了 trafficPolicy，指定了熔断策略，但使用 ab 压测发现没有触发熔断 (ingressgateway 的 access_log 中 response_flags 没有 &ldquo;UO&rdquo;)。</p><p><strong>原因</strong>：ab 压测时发送的是 HTTP/1.0 请求，而 envoy 需要 HTTP/1.1，因此返回 <code>426 Upgrade Required</code>，根本不会进行转发，所以也就不会返回 503，response_flags 也不会有。</p><p><strong>解决办法</strong>：使用其他压测工具，如 wrk、fortio 等，默认发送 HTTP/1.1 的请求，可以正常触发熔断。</p><h1 id=服务使用-istio-保留端口导致-pod-启动失败>服务使用 istio 保留端口导致 pod 启动失败</h1><p><strong>现象</strong>：有新启动的 Pod 无法 ready，sidecar 报错，如 <code>warning envoy config gRPC config for type.googleapis.com/envoy.config.listener.v3.Listener rejected: Error adding/updating listener(s) 0.0.0.0_15090: error adding listener: '0.0.0.0_15090' has duplicate address '0.0.0.0:15090' as existing listener</code>，同时 istiod 也报错，如 <code>ADS:LDS: ACK ERROR sidecar~172.18.0.185~reviews-v1-7d46f9dd-w5k8q.istio-test~istio-test.svc.cluster.local-20847 Internal:Error adding/updating listener(s) 0.0.0.0_15090: error adding listener: '0.0.0.0_15090' has duplicate address '0.0.0.0:15090' as existing listener</code>。</p><p><strong>原因</strong>：是 dynamic 配置中也有 <code>0.0.0.0:15090</code> 监听导致的冲突，而 dynamic 中监听来源通常是 Kubernetes 的服务发现(Service, ServiceEntry)，检查一下是否有 Service 监听 15090，如下所示：</p><pre tabindex=0><code>kubectl get service --all-namespaces -o yaml | grep 15090
</code></pre><p>最终发现确实有 Service 用到了 15090 端口，更改成其它端口即可恢复。Sidecar 启动时获取 LDS 规则，istiod 发现 <code>0.0.0.0:15090</code> 这个监听重复了，属于异常现象，下发 xDS 规则就会失败，导致 sidecar 一直无法 ready。但并不是所有 envoy 使用的端口都被加入到 static 配置中的监听，只有 15090 和 15021 这两个端口在 static 配置中有监听，也验证了 Service 使用 15021 端口也会有相同的问题。Service 使用其它 envoy 的端口不会造成 sidecar 不 ready 的问题，但至少要保证业务程序也不能去监听这些端口，因为会跟 envoy 冲突，istio 官网也说明了这一点: <code>To avoid port conflicts with sidecars, applications should not use any of the ports used by Envoy</code>。15090 端口是 istio 用于暴露 envoy prometheus 指标的端口，是 envoy 使用的端口之一。更多的 Istio 默认使用的端口可参见 <a href=https://istio.io/latest/docs/ops/deployment/requirements/>Application Requirements</a>。</p><p><strong>最佳实践</strong>：业务尽量不使用 Istio 默认占用的端口。</p><ul><li>Service/ServiceEntry 不能定义 15090 和 15021 端口，不然会导致 Pod 无法启动成功。</li><li>业务进程不能监听 envoy 使用到的所有端口: <code>15000, 15001, 15006, 15008, 15020, 15021, 15090</code>。</li></ul><h1 id=envoy-报错-grpc-config-stream-closed>Envoy 报错: <code>gRPC config stream closed</code></h1><p><strong>现象</strong>：Envoy 中的日志出现报错 <code>gRPC config stream closed: 13</code> 或者 <code>gRPC config stream closed: 14</code>。如下所示：
<img src=/images/2022-11-22-istio-questions-5/1.png alt></p><p><strong>原因</strong>：因为控制面默认每 30 分钟强制断开 xDS 连接，然后数据面会自动重新连接控制平面。更多的详情可参考 <a href=https://github.com/istio/istio/wiki/Troubleshooting-Istio#common-issues>Common Issues</a>。</p><h1 id=pod-启动卡住-mountvolumesetup-failed-for-volume-istio-token>Pod 启动卡住 <code>MountVolume.SetUp failed for volume "istio-token"</code></h1><p><strong>现象</strong>：Istio 相关的 Pod (注入 sidecar 的 Pod) 一直卡在 ContainerCreating，起不来，describe pod 报错 <code>MountVolume.SetUp failed for volume "istio-token" : failed to fetch token: the server could not find the requested resource:</code>。</p><p><strong>原因</strong>：根据官方文档 <a href=https://istio.io/latest/docs/ops/best-practices/security/#configure-third-party-service-account-tokens>Configure third party service account tokens</a> 的描述得知支持的列表信息如下所示：</p><ul><li>istio-proxy 需要使用 K8S 的 ServiceAccount token，而 K8S 支持 third party 和 first party 两种 token。</li><li>third party token 安全性更高，istio 默认使用这种类型。</li><li>不是所有集群都支持这种 token，取决于 K8S 版本和 apiserver 配置。</li></ul><p>如果集群不支持 third party token，就会导致 ServiceAccount token 不自动创建出来，从而出现上面这种报错。如何判断集群是否启用了该特性呢？可通过一下命令查询：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get --raw /api/v1 | jq <span style=color:#f1fa8c>&#39;.resources[] | select(.name | index(&#34;serviceaccounts/token&#34;))&#39;</span>
</span></span></code></pre></div><p>若返回空，说明不支持；若返回如下 json，说明支持：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&#34;name&#34;</span>: <span style=color:#f1fa8c>&#34;serviceaccounts/token&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&#34;singularName&#34;</span>: <span style=color:#f1fa8c>&#34;&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&#34;namespaced&#34;</span>: <span style=color:#ff79c6>true</span>,
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&#34;group&#34;</span>: <span style=color:#f1fa8c>&#34;authentication.k8s.io&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&#34;version&#34;</span>: <span style=color:#f1fa8c>&#34;v1&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&#34;kind&#34;</span>: <span style=color:#f1fa8c>&#34;TokenRequest&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&#34;verbs&#34;</span>: [
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;create&#34;</span>
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>什么是 third party token ? 其实就是 <a href=https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#service-account-token-volume-projection>ServiceAccountTokenVolumeProjection</a> 这个特性，在 1.12 beta，1.20 GA。该特性是为了增强 <code>ServiceAccount token</code> 的安全性，可以设置有效期(会自动轮转)，避免 token 泄露带来的安全风险，还可以控制 token 的受众。</p><p><strong>解决办法</strong>：方案一：安装 istio 时不使用 <code>third party token</code>；方案二：集群启用 <code>ServiceAccountTokenVolumeProjection</code> 特性。</p><p>方案一：安装 istio 时不使用 <code>third party token</code>：使用 istioctl 安装会自动检测集群是否支持 <code>third party token</code>，建议强制指定用 <code>first party token</code>，用参数 <code>--set values.global.jwtPolicy=first-party-jwt</code> 来显示指定，示例如下所示：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>istioctl manifest generate  --set <span style=color:#8be9fd;font-style:italic>profile</span><span style=color:#ff79c6>=</span>demo  --set values.global.jwtPolicy<span style=color:#ff79c6>=</span>first-party-jwtm &gt; istio.yaml
</span></span></code></pre></div><p>方案二：集群启用 <code>ServiceAccountTokenVolumeProjection</code> 特性：如何启用 <code>ServiceAccountTokenVolumeProjection</code> 这个特性呢？需要给 apiserver 配置类似如下的参数：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>--service-account-key-file<span style=color:#ff79c6>=</span>/etc/kubernetes/pki/sa.key 
</span></span><span style=display:flex><span>--service-account-issuer<span style=color:#ff79c6>=</span>kubernetes.default.svc
</span></span><span style=display:flex><span>--service-account-signing-key-file<span style=color:#ff79c6>=</span>/etc/kubernetes/pki/sa.key <span style=color:#6272a4># 注意实际路径</span>
</span></span><span style=display:flex><span>--api-audiences<span style=color:#ff79c6>=</span>kubernetes.default.svc
</span></span></code></pre></div><h1 id=istio-高频链接>Istio 高频链接</h1><ul><li>Istio 默认使用的端口，见 <a href=https://istio.io/latest/docs/ops/deployment/requirements/#ports-used-by-istio>ports-used-by-istio</a></li><li>Istio 资源注解，见 <a href=https://istio.io/latest/docs/reference/config/annotations/>Resource Annotations</a></li><li><a href=https://istio.io/latest/docs/releases/supported-releases/#support-status-of-istio-releases>Istio 支持的 Kubernetes 版本</a></li><li><a href=https://istio.io/>Istio 官网</a></li><li><a href=https://kubernetes.io/>Kubernetes 官网</a></li><li><a href=https://www.envoyproxy.io/>Envoy 官网</a></li></ul><h1 id=服务地域感知不生效>服务地域感知不生效</h1><p><strong>现象</strong>：使用 istio 地域感知能力时，测试没生效。</p><p><strong>原因</strong>：DestinationRule 未配置 outlierDetection；client 没配置 service；使用了 headless service 等等。</p><p>DestinationRule 未配置 outlierDetection：地域感知默认开启，但还需要配置 DestinationRule，且指定 outlierDetection 才会生效，指定这个配置的作用主要是让 istio 感知 endpoints 是否异常，当前 locality 的 endpoints 发生异常时会 failover 到其它地方的 endpoints。DestinationRule 的示例如下所示：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>apiVersion</span>: networking.istio.io/v1beta1
</span></span><span style=display:flex><span><span style=color:#ff79c6>kind</span>: DestinationRule
</span></span><span style=display:flex><span><span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>name</span>: test
</span></span><span style=display:flex><span><span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>host</span>: test
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>trafficPolicy</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>outlierDetection</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>consecutive5xxErrors</span>: <span style=color:#bd93f9>3</span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>interval</span>: 30s
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>baseEjectionTime</span>: 30s
</span></span></code></pre></div><p>使用 headless service：如果访问 headless service，headless service 本身是不支持地域感知的，因为 istio 会对 headless service 请求直接 passthrough，不做负载均衡，客户端会直接访问到 dns 解析出来的 pod ip。单独创建一个 service (非 headless)即可。</p><p>client 没配置 service：istio 控制面会为每个数据面单独下发 EDS，不同数据面实例(Envoy)的 locality 可能不一样，生成的 EDS 也就可能不一样。istio 会获取数据面的 locality 信息，获取方式主要是找到数据面对应的 endpoint 上保存的 region、zone 等信息，如果 client 没有任何 service，也就不会有 endpoint，控制面也就无法获取 client 的 locality 信息，也就无法实现地域感知。解决办法：为 client 配置 service，selector 选中 client 的 label；如果 client 本身不对外提供服务，service 的 ports 也可以随便定义。</p><h1 id=istio-常见的调试技巧方法脚本>Istio 常见的调试技巧、方法、脚本</h1><ul><li>查看 sidecar 证书</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#6272a4># 查看证书</span>
</span></span><span style=display:flex><span>istioctl proxy-config secret productpage-v1-66756cddfd-shz6l.default
</span></span><span style=display:flex><span>istioctl proxy-config secret productpage-v1-66756cddfd-shz6l.default -o json
</span></span><span style=display:flex><span><span style=color:#6272a4># 查看证书</span>
</span></span><span style=display:flex><span>istioctl proxy-config secret productpage-v1-66756cddfd-shz6l.default -o json | jq <span style=color:#f1fa8c>&#39;[.dynamicActiveSecrets[] | select(.name == &#34;default&#34;)][0].secret.tlsCertificate.certificateChain.inlineBytes&#39;</span> -r | base64 -d | openssl x509 -noout -text
</span></span></code></pre></div><ul><li>测试服务与 istiod 的连通性</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#6272a4># 测试与 istiod 的连通性</span>
</span></span><span style=display:flex><span>kubectl -n <span style=color:#8be9fd;font-style:italic>test</span> <span style=color:#8be9fd;font-style:italic>exec</span> test-6fd7477c9d-brqmq -c istio-proxy -- curl -sS istiod.istio-system:15014/debug/endpointz
</span></span></code></pre></div><ul><li>查看 istio-proxy 指标</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl <span style=color:#8be9fd;font-style:italic>exec</span> -it sleep-cdf8d68bc-t7gq5 -c istio-proxy -- curl localhost:15000/stats
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl <span style=color:#8be9fd;font-style:italic>exec</span> -it sleep-cdf8d68bc-t7gq5 -c istio-proxy -- curl localhost:15000/stats/prometheus
</span></span></code></pre></div><ul><li>为工作负载取消 sidecar 注入</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>template</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>annotations</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>sidecar.istio.io/inject</span>: <span style=color:#f1fa8c>&#34;false&#34;</span>
</span></span></code></pre></div><ul><li>自定义 proxy 参数</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>template</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>annotations</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>&#34;sidecar.istio.io/proxyCPU&#34;: </span><span style=color:#f1fa8c>&#34;1000m&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>&#34;sidecar.istio.io/proxyCPULimit&#34;: </span><span style=color:#f1fa8c>&#34;2&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>&#34;sidecar.istio.io/proxyMemory&#34;: </span><span style=color:#f1fa8c>&#34;500Mi&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>&#34;sidecar.istio.io/proxyMemoryLimit&#34;: </span><span style=color:#f1fa8c>&#34;2Gi&#34;</span>
</span></span></code></pre></div><p>更多的注解参考 <a href=https://istio.io/latest/docs/reference/config/annotations/>annotations</a>。</p><ul><li>自定义日志级别</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>template</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>annotations</span>:
</span></span><span style=display:flex><span>      <span style=color:#6272a4># 可选: trace, debug, info, warning, error, critical, off</span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>&#34;sidecar.istio.io/logLevel&#34;: </span>debug 
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>&#34;sidecar.istio.io/componentLogLevel&#34;: </span><span style=color:#f1fa8c>&#34;ext_authz:trace,filter:debug&#34;</span>
</span></span></code></pre></div><p>更多的日志级别调整参考 <a href=https://www.envoyproxy.io/docs/envoy/latest/operations/cli#cmdoption-component-log-level>cmdoption-component-log-level</a>。</p><ul><li>不劫持某些 ip 网段</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>template</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>annotations</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>traffic.sidecar.istio.io/excludeOutboundIPRanges</span>: <span style=color:#f1fa8c>&#34;10.10.31.1/32,10.10.31.2/32&#34;</span>
</span></span></code></pre></div><ul><li>全局禁用 mtls</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>apiVersion</span>: security.istio.io/v1beta1
</span></span><span style=display:flex><span><span style=color:#ff79c6>kind</span>: PeerAuthentication
</span></span><span style=display:flex><span><span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>name</span>: default
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>namespace</span>: istio-system
</span></span><span style=display:flex><span><span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>mtls</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>mode</span>: DISABLE
</span></span></code></pre></div><ul><li><code>DestinationRule</code> 为某个服务启用地域感知</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>apiVersion</span>: networking.istio.io/v1beta1
</span></span><span style=display:flex><span><span style=color:#ff79c6>kind</span>: DestinationRule
</span></span><span style=display:flex><span><span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>name</span>: nginx
</span></span><span style=display:flex><span><span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>host</span>: nginx
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>trafficPolicy</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>outlierDetection</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>consecutive5xxErrors</span>: <span style=color:#bd93f9>3</span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>interval</span>: 30s
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>baseEjectionTime</span>: 30s
</span></span></code></pre></div><ul><li>调大 Envoy 默认 header 与请求体大小</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>apiVersion</span>: networking.istio.io/v1alpha3
</span></span><span style=display:flex><span><span style=color:#ff79c6>kind</span>: EnvoyFilter
</span></span><span style=display:flex><span><span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>name</span>: http-options
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>namespace</span>: istio-system
</span></span><span style=display:flex><span><span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>configPatches</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ff79c6>applyTo</span>: NETWORK_FILTER
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>match</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>context</span>: ANY
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>listener</span>:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>filterChain</span>:
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>filter</span>:
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>name</span>: <span style=color:#f1fa8c>&#34;envoy.http_connection_manager&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>patch</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>operation</span>: MERGE
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>value</span>:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>typed_config</span>:
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>&#34;@type&#34;: </span><span style=color:#f1fa8c>&#34;type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>max_request_headers_kb</span>: <span style=color:#bd93f9>96</span> <span style=color:#6272a4># 96KB, 请求 header 最大限制</span>
</span></span><span style=display:flex><span>  - <span style=color:#ff79c6>applyTo</span>: HTTP_FILTER
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>match</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>context</span>: GATEWAY
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>listener</span>:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>filterChain</span>:
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>filter</span>:
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>name</span>: <span style=color:#f1fa8c>&#34;envoy.http_connection_manager&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>patch</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>operation</span>: INSERT_BEFORE
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>value</span>:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>name</span>: <span style=color:#f1fa8c>&#34;envoy.filters.http.buffer&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>typed_config</span>:
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>&#39;@type&#39;</span>: <span style=color:#f1fa8c>&#34;type.googleapis.com/envoy.extensions.filters.http.buffer.v3.Buffer&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>max_request_bytes</span>: <span style=color:#bd93f9>10485760</span>  <span style=color:#6272a4># 10MB, 请求最大限制</span>
</span></span></code></pre></div><ul><li>将 Header 全部转为首字母大写</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>apiVersion</span>: networking.istio.io/v1alpha3
</span></span><span style=display:flex><span><span style=color:#ff79c6>kind</span>: EnvoyFilter
</span></span><span style=display:flex><span><span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>name</span>: http-header-proper-case-words
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>namespace</span>: istio-system
</span></span><span style=display:flex><span><span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>configPatches</span>:
</span></span><span style=display:flex><span>  <span style=color:#6272a4># 配置保留 upstream 的 request header 大小写</span>
</span></span><span style=display:flex><span>  - <span style=color:#ff79c6>applyTo</span>: CLUSTER
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>patch</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>operation</span>: MERGE
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>value</span>:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>typed_extension_protocol_options</span>:
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>Envoy.extensions.upstreams.http.v3.HttpProtocolOptions</span>:
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>&#39;@type&#39;</span>: type.googleapis.com/Envoy.extensions.upstreams.http.v3.HttpProtocolOptions
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>use_downstream_protocol_config</span>:
</span></span><span style=display:flex><span>              <span style=color:#ff79c6>http_protocol_options</span>:
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>header_key_format</span>:
</span></span><span style=display:flex><span>                  <span style=color:#ff79c6>stateful_formatter</span>:
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>name</span>: preserve_case
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>typed_config</span>:
</span></span><span style=display:flex><span>                      <span style=color:#ff79c6>&#39;@type&#39;</span>: type.googleapis.com/Envoy.extensions.http.header_formatters.preserve_case.v3.PreserveCaseFormatterConfig
</span></span><span style=display:flex><span>  <span style=color:#6272a4># 配置保留收到的 response header 大小写</span>
</span></span><span style=display:flex><span>  - <span style=color:#ff79c6>applyTo</span>: NETWORK_FILTER
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>match</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>listener</span>:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>filterChain</span>:
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>filter</span>:
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>name</span>: Envoy.filters.network.http_connection_manager
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>patch</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>operation</span>: MERGE
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>value</span>:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>typed_config</span>:
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>&#39;@type&#39;</span>: type.googleapis.com/Envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>http_protocol_options</span>:
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>header_key_format</span>:
</span></span><span style=display:flex><span>              <span style=color:#ff79c6>stateful_formatter</span>:
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>name</span>: preserve_case
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>typed_config</span>:
</span></span><span style=display:flex><span>                  <span style=color:#ff79c6>&#39;@type&#39;</span>: type.googleapis.com/Envoy.extensions.http.header_formatters.preserve_case.v3.PreserveCaseFormatterConfig
</span></span></code></pre></div><ul><li>为 ingressgateway 启用 gzip 压缩</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>apiVersion</span>: networking.istio.io/v1alpha3
</span></span><span style=display:flex><span><span style=color:#ff79c6>kind</span>: EnvoyFilter
</span></span><span style=display:flex><span><span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>namespace</span>: istio-system
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>name</span>: ingressgateway-gzip
</span></span><span style=display:flex><span><span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>workloadSelector</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>labels</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>istio</span>: ingressgateway
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>configPatches</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ff79c6>applyTo</span>: HTTP_FILTER
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>match</span>:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>context</span>: GATEWAY
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>listener</span>:
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>filterChain</span>:
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>filter</span>:
</span></span><span style=display:flex><span>              <span style=color:#ff79c6>name</span>: envoy.filters.network.http_connection_manager
</span></span><span style=display:flex><span>              <span style=color:#ff79c6>subFilter</span>:
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>name</span>: envoy.filters.http.router
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>patch</span>:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>operation</span>: INSERT_BEFORE
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>value</span>:
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>name</span>: envoy.filters.http.compressor
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>typed_config</span>:
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>&#34;@type&#34;: </span>type.googleapis.com/envoy.extensions.filters.http.compressor.v3.Compressor
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>response_direction_config</span>:
</span></span><span style=display:flex><span>              <span style=color:#ff79c6>common_config</span>:
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>min_content_length</span>: <span style=color:#bd93f9>100</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>content_type</span>:
</span></span><span style=display:flex><span>                  - <span style=color:#f1fa8c>&#39;application/javascript&#39;</span>
</span></span><span style=display:flex><span>                  - <span style=color:#f1fa8c>&#39;application/json&#39;</span>
</span></span><span style=display:flex><span>                  - <span style=color:#f1fa8c>&#39;application/xhtml+xml&#39;</span>
</span></span><span style=display:flex><span>                  - <span style=color:#f1fa8c>&#39;image/svg+xml&#39;</span>
</span></span><span style=display:flex><span>                  - <span style=color:#f1fa8c>&#39;text/css&#39;</span>
</span></span><span style=display:flex><span>                  - <span style=color:#f1fa8c>&#39;text/html&#39;</span>
</span></span><span style=display:flex><span>                  - <span style=color:#f1fa8c>&#39;text/plain&#39;</span>
</span></span><span style=display:flex><span>                  - <span style=color:#f1fa8c>&#39;text/xml&#39;</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>compressor_library</span>:
</span></span><span style=display:flex><span>              <span style=color:#ff79c6>name</span>: text_optimized
</span></span><span style=display:flex><span>              <span style=color:#ff79c6>typed_config</span>:
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>&#34;@type&#34;: </span>type.googleapis.com/envoy.extensions.compression.gzip.compressor.v3.Gzip
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>memory_level</span>: <span style=color:#bd93f9>9</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>window_bits</span>: <span style=color:#bd93f9>15</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>compression_level</span>: BEST_COMPRESSION
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>compression_strategy</span>: DEFAULT_STRATEGY
</span></span></code></pre></div><ul><li>给指定 workload 出流量加上 header（全链路灰度）</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>apiVersion</span>: networking.istio.io/v1alpha3
</span></span><span style=display:flex><span><span style=color:#ff79c6>kind</span>: EnvoyFilter
</span></span><span style=display:flex><span><span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>name</span>: label-outbound-traffic
</span></span><span style=display:flex><span><span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>workloadSelector</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>labels</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>app</span>: productpage
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>configPatches</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ff79c6>applyTo</span>: HTTP_FILTER
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>match</span>:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>context</span>: SIDECAR_OUTBOUND
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>listener</span>:
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>filterChain</span>:
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>filter</span>:
</span></span><span style=display:flex><span>              <span style=color:#ff79c6>name</span>: envoy.http_connection_manager
</span></span><span style=display:flex><span>              <span style=color:#ff79c6>subFilter</span>:
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>name</span>: envoy.router
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>patch</span>:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>operation</span>: INSERT_BEFORE
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>value</span>:
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>name</span>: envoy.lua
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>typed_config</span>:
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>&#34;@type&#34;: </span><span style=color:#f1fa8c>&#34;type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>inlineCode</span>: |<span style=color:#f1fa8c>
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>              function envoy_on_request(request_handle)
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>                request_handle:headers():add(&#34;app-custom&#34;, os.getenv(&#34;ISTIO_META_WORKLOAD_NAME&#34;))
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>              end</span>              
</span></span></code></pre></div><h1 id=envoy-常见异常状态码汇总>Envoy 常见异常状态码汇总</h1><ul><li>431 Request Header Fields Too Large：此状态码说明 http 请求 header 大小超限，默认限制为 60 KiB，由 HttpConnectionManager 配置的 max_request_headers_kb 字段决定，最大可调整到 96 KiB。可以通过 EnvoyFilter 调整 max_request_headers_kb 字段来提升 header 大小限制。下述是 V3 版本的 Yaml 文件。（若 header 大小超过 96 KiB，这种情况本身也很不正常，建议将这部分数据放到 body）。</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>apiVersion</span>: networking.istio.io/v1alpha3
</span></span><span style=display:flex><span><span style=color:#ff79c6>kind</span>: EnvoyFilter
</span></span><span style=display:flex><span><span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>name</span>: max-header
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>namespace</span>: istio-system
</span></span><span style=display:flex><span><span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>configPatches</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ff79c6>applyTo</span>: NETWORK_FILTER
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>match</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>context</span>: ANY
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>listener</span>:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>filterChain</span>:
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>filter</span>:
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>name</span>: <span style=color:#f1fa8c>&#34;envoy.http_connection_manager&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>patch</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>operation</span>: MERGE
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>value</span>:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>typed_config</span>:
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>&#34;@type&#34;: </span><span style=color:#f1fa8c>&#34;type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>max_request_headers_kb</span>: <span style=color:#bd93f9>96</span>
</span></span></code></pre></div><ul><li><p>访问 StatefulSet Pod IP 返回 404：在 istio 中业务容器访问同集群 Pod IP 返回 404，在 istio-proxy 中访问却正常。Pod 属于 StatefulSet，使用 headless svc，在 istio 中对 headless svc 的支持跟普通 svc 不太一样，如果 pod 用的普通 svc，对应的 listener 有兜底的 passthrough，即转发到报文对应的真实目的IP+Port，但 headless svc 的就没有，我们理解是因为 headless svc 没有 vip，它的路由是确定的，只指向后端固定的 pod，如果路由匹配不上就肯定出了问题，如果也用 passthrough 兜底路由，只会掩盖问题，所以就没有为 headless svc 创建 passthrough 兜底路由。同样的业务，上了 istio 才会有这个问题，也算是 istio 的设计或实现问题。在 istio 场景下 (kubernetes 之上)，请求 config service 就不需要不走 apollo meta server 获取 config service 的 ip 来实现高可用，直接用 kubernetes 的 service 做服务发现就行。幸运的是，apollo 也支持跳过 meta server 服务发现，这样访问 config service 时就可以直接请求 k8s service 了，也就可以解决此问题。</p></li><li><p>426 Upgrade Required：Istio 使用 Envoy 作为数据面转发 HTTP 请求，而 Envoy 默认要求使用 HTTP/1.1 或 HTTP/2，当客户端使用 HTTP/1.0 时就会返回 426 Upgrade Required。ab 压测时会发送 HTTP/1.0 的请求，Envoy 固定返回 426 Upgrade Required，根本不会进行转发，所以压测的结果也不会准确。有些 SDK 或框架可能会使用 HTTP/1.0 协议，比如使用 HTTP/1.0 去资源中心/配置中心拉取配置信息，在不想改动代码的情况下让服务跑在 istio 上，也可以修改 istiod 配置，加上 <code>PILOT_HTTP10: 1</code> 环境变量来启用 HTTP/1.0。更多的详情可参考 <a href=https://istio.io/latest/docs/ops/common-problems/network-issues/#envoy-won-t-connect-to-my-http-1-0-service>envoy-won-t-connect-to-my-http-1-0-service</a>。</p></li></ul><h1 id=如何编译-istio-二进制与相关镜像>如何编译 Istio 二进制与相关镜像</h1><p>本地能够拉取到编译镜像（需要翻墙），如本次实验使用的编译镜像工具是 <code>gcr.io/istio-testing/build-tools:master-7c2cba5679671f40312e6324d270a0d70ad097d0</code>；按照以下步骤即可编译与获取 istio 镜像，具体步骤如下所示：</p><ul><li>克隆 istio 存储库到 <code>$GOPATH/src/istio.io/</code>；</li><li>设置环境变量；<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>当前目录：~/opensource/istio
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>USER</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;tanjunchen&#34;</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>HUB</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;docker.io/</span><span style=color:#8be9fd;font-style:italic>$USER</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>TAG</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;06-25-dev&#34;</span>
</span></span></code></pre></div></li><li>进入 istio 根目录，编译与构建 istio 所有组件，如 pilot、istioctl 等；<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make build
</span></span></code></pre></div></li><li>构建与推送镜像；<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>BUILD_WITH_CONTAINER</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>0</span> make docker.push
</span></span></code></pre></div></li><li>构建并推送特定的镜像；<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>BUILD_WITH_CONTAINER</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>0</span> make push.docker.pilot
</span></span></code></pre></div></li><li>清理二进制与镜像<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make clean
</span></span></code></pre></div></li></ul><p>更多的详细信息可参考 <a href=https://github.com/istio/istio/wiki/Preparing-for-Development>Preparing for Development</a>。</p><hr><ul class=pager><li class=previous><a href=/post/2022-11-21-istio-questions-4/ data-toggle=tooltip data-placement=top title="使用 Istio 过程中遇到的常见问题与解决方法（四）">&larr;
Previous Post</a></li><li class=next><a href=/post/2022-11-23-istio-questions-6/ data-toggle=tooltip data-placement=top title="使用 Istio 过程中遇到的常见问题与解决方法（六）">Next
Post &rarr;</a></li></ul></div><div class="col-lg-2 col-lg-offset-0
visible-lg-block
sidebar-container
catalog-container"><div class=side-catalog><hr class="hidden-sm hidden-xs"><h5><a class=catalog-toggle href=#>CATALOG</a></h5><ul class=catalog-body></ul></div></div><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
sidebar-container"></div></div></div></article><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"><li><a href=mailto:tanjunchen20@gmail.com><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=/img/wechat.jpg><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-weixin fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://github.com/tanjunchen><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="copyright text-muted">Copyright &copy; 陈谭军 2024</p></div></div></div></footer><script>function loadAsync(e,t){var s=document,o="script",n=s.createElement(o),i=s.getElementsByTagName(o)[0];n.src=e,t&&n.addEventListener("load",function(e){t(null,e)},!1),i.parentNode.insertBefore(n,i)}</script><script>$("#tag_cloud").length!==0&&loadAsync("/js/jquery.tagcloud.js",function(){$.fn.tagcloud.defaults={color:{start:"#bbbbee",end:"#0085a1"}},$("#tag_cloud a").tagcloud()})</script><script>loadAsync("https://cdn.jsdelivr.net/npm/fastclick@1.0.6/lib/fastclick.min.js",function(){var e=document.querySelector("nav");e&&FastClick.attach(e)})</script><script type=text/javascript>function generateCatalog(e){_containerSelector="div.post-container";var t,n,s,o,i,r=$(_containerSelector),a=r.find("h1,h2,h3,h4,h5,h6");return $(e).html(""),a.each(function(){n=$(this).prop("tagName").toLowerCase(),i="#"+$(this).prop("id"),s=$(this).text(),t=$('<a href="'+i+'" rel="nofollow">'+s+"</a>"),o=$('<li class="'+n+'_nav"></li>').append(t),$(e).append(o)}),!0}generateCatalog(".catalog-body"),$(".catalog-toggle").click(function(e){e.preventDefault(),$(".side-catalog").toggleClass("fold")}),loadAsync("/js/jquery.nav.js",function(){$(".catalog-body").onePageNav({currentClass:"active",changeHash:!1,easing:"swing",filter:"",scrollSpeed:700,scrollOffset:0,scrollThreshold:.2,begin:null,end:null,scrollChange:null,padding:80})})</script></body></html>