<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:site_name" content="æ¼«æ­¥è¿œæ–¹ï¼Œå¿ƒè¡ç¥å¾€"><meta property="og:type" content="article"><meta property="og:image" content="https://tanjunchen.github.io/img/home.webp"><meta property="twitter:image" content="https://tanjunchen.github.io/img/home.webp"><meta name=title content="Cilium Mesh å¸¸è§åœºæ™¯ä¸ç¤ºä¾‹"><meta property="og:title" content="Cilium Mesh å¸¸è§åœºæ™¯ä¸ç¤ºä¾‹"><meta property="twitter:title" content="Cilium Mesh å¸¸è§åœºæ™¯ä¸ç¤ºä¾‹"><meta name=description content="ä»æ—©æœŸå¼€å§‹ï¼ŒCilium å°±é€šè¿‡ç½‘ç»œå’Œåº”ç”¨ç¨‹åºåè®®å±‚æ¥æä¾›è¿æ¥ã€è´Ÿè½½å¹³è¡¡ã€å®‰å…¨æ€§å’Œå¯è§‚å¯Ÿæ€§ï¼Œä»è€Œä¸æœåŠ¡ç½‘æ ¼æ¦‚å¿µä¿æŒè‰¯å¥½ä¸€è‡´ã€‚å¯¹äºæ‰€æœ‰ç½‘ç»œå¤„ç†ï¼ŒåŒ…æ‹¬ IPã€TCP å’Œ UDP ç­‰åè®®ï¼ŒCilium ä½¿ç”¨ eBPF ä½œä¸ºé«˜æ•ˆçš„å†…æ ¸æ•°æ®è·¯å¾„ã€‚HTTPã€Kafkaã€gRPCã€DNS ç­‰åº”ç”¨å±‚åè®®é€šè¿‡ Envoy ç­‰ä»£ç†è¿›è¡Œè§£æã€‚"><meta property="og:description" content="ä»æ—©æœŸå¼€å§‹ï¼ŒCilium å°±é€šè¿‡ç½‘ç»œå’Œåº”ç”¨ç¨‹åºåè®®å±‚æ¥æä¾›è¿æ¥ã€è´Ÿè½½å¹³è¡¡ã€å®‰å…¨æ€§å’Œå¯è§‚å¯Ÿæ€§ï¼Œä»è€Œä¸æœåŠ¡ç½‘æ ¼æ¦‚å¿µä¿æŒè‰¯å¥½ä¸€è‡´ã€‚å¯¹äºæ‰€æœ‰ç½‘ç»œå¤„ç†ï¼ŒåŒ…æ‹¬ IPã€TCP å’Œ UDP ç­‰åè®®ï¼ŒCilium ä½¿ç”¨ eBPF ä½œä¸ºé«˜æ•ˆçš„å†…æ ¸æ•°æ®è·¯å¾„ã€‚HTTPã€Kafkaã€gRPCã€DNS ç­‰åº”ç”¨å±‚åè®®é€šè¿‡ Envoy ç­‰ä»£ç†è¿›è¡Œè§£æã€‚"><meta property="twitter:description" content="ä»æ—©æœŸå¼€å§‹ï¼ŒCilium å°±é€šè¿‡ç½‘ç»œå’Œåº”ç”¨ç¨‹åºåè®®å±‚æ¥æä¾›è¿æ¥ã€è´Ÿè½½å¹³è¡¡ã€å®‰å…¨æ€§å’Œå¯è§‚å¯Ÿæ€§ï¼Œä»è€Œä¸æœåŠ¡ç½‘æ ¼æ¦‚å¿µä¿æŒè‰¯å¥½ä¸€è‡´ã€‚å¯¹äºæ‰€æœ‰ç½‘ç»œå¤„ç†ï¼ŒåŒ…æ‹¬ IPã€TCP å’Œ UDP ç­‰åè®®ï¼ŒCilium ä½¿ç”¨ eBPF ä½œä¸ºé«˜æ•ˆçš„å†…æ ¸æ•°æ®è·¯å¾„ã€‚HTTPã€Kafkaã€gRPCã€DNS ç­‰åº”ç”¨å±‚åè®®é€šè¿‡ Envoy ç­‰ä»£ç†è¿›è¡Œè§£æã€‚"><meta property="twitter:card" content="summary"><meta name=keyword content="é™ˆè°­å†›, äº’è”ç½‘, äº‘åŸç”Ÿ, å®¹å™¨, å¾®æœåŠ¡, Web, PaaS, Istio, Kubernetes, Microservice"><link rel="shortcut icon" href=/img/favicon.ico><title>Cilium Mesh å¸¸è§åœºæ™¯ä¸ç¤ºä¾‹ | é™ˆè°­å†›çš„åšå®¢ | tanjunchen Blog</title><link rel=canonical href=/post/2023-08-12-cilium-mesh-example/><link rel=stylesheet href=/css/bootstrap.min.css><link rel=stylesheet href=/css/hugo-theme-cleanwhite.min.css><link rel=stylesheet href=/css/zanshang.css><link rel=stylesheet href=/css/font-awesome.all.min.css><script src=/js/jquery.min.js></script>
<script src=/js/bootstrap.min.js></script>
<script src=/js/hux-blog.min.js></script>
<script src=/js/lazysizes.min.js></script></head><nav class="navbar navbar-default navbar-custom navbar-fixed-top"><div class=container-fluid><div class="navbar-header page-scroll"><button type=button class=navbar-toggle>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span></button>
<a class=navbar-brand href=/>æ¼«æ­¥è¿œæ–¹ï¼Œå¿ƒè¡ç¥å¾€</a></div><div id=huxblog_navbar><div class=navbar-collapse><ul class="nav navbar-nav navbar-right"><li><a href=/>All Posts</a></li><li><a href=/categories/technology/>technology</a></li><li><a href=/categories/think/>think</a></li><li><a href=/learning/>LEARNING</a></li><li><a href=/archive/>ARCHIVE</a></li><li><a href=/about/>ABOUT</a></li><li><a href=/search><i class="fa fa-search"></i></a></li></ul></div></div></div></nav><script>var $body=document.body,$toggle=document.querySelector(".navbar-toggle"),$navbar=document.querySelector("#huxblog_navbar"),$collapse=document.querySelector(".navbar-collapse");$toggle.addEventListener("click",handleMagic);function handleMagic(){$navbar.className.indexOf("in")>0?($navbar.className=" ",setTimeout(function(){$navbar.className.indexOf("in")<0&&($collapse.style.height="0px")},400)):($collapse.style.height="auto",$navbar.className+=" in")}</script><style type=text/css>header.intro-header{background-image:url(/img/home.webp)}</style><header class=intro-header><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><div class=tags><a class=tag href=/tags/ebpf title=eBPF>eBPF</a>
<a class=tag href=/tags/cilium title=cilium>cilium</a>
<a class=tag href=/tags/kubernetes title=kubernetes>kubernetes</a></div><h1>Cilium Mesh å¸¸è§åœºæ™¯ä¸ç¤ºä¾‹</h1><h2 class=subheading>Cilium Mesh æµé‡æ²»ç†åŠŸèƒ½ï¼Œå¦‚é™æµã€ç†”æ–­ã€è´Ÿè½½å‡è¡¡ã€ç°åº¦ã€Adminç­‰</h2><span class=meta>Posted by
é™ˆè°­å†›
on
Saturday, August 12, 2023
<span id=busuanzi_container_page_pv>|<span id=busuanzi_value_page_pv></span><span>
<span id=/post/2023-08-12-cilium-mesh-example/ class="leancloud_visitors meta_data_item" data-flag-title><span class=post-meta-item-icon><span class="octicon octicon-eye"></span></span>
<i class="fa fa-eye"></i>
<span class=old-visitors-count style=display:none></span>
<span class=leancloud-visitors-count></span></span>
<script src=https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js></script>
<script>AV.initialize("","")</script><script type=text/javascript>function showTime(e){var n=new AV.Query(e),t=[],s=$(".leancloud_visitors");s.each(function(){t.push($(this).attr("id").trim())}),n.containedIn("url",t),n.find().done(function(e){for(var s,o,i,a,r,c,l=".leancloud-visitors-count",d=".old-visitors-count",n=0;n<e.length;n++)a=e[n],i=a.get("url"),c=a.get("time"),s=document.getElementById(i),$(s).find(l).text(c);for(n=0;n<t.length;n++)i=t[n],s=document.getElementById(i),o=$(s).find(l),o.text()==""&&(r=$(s).find(d).text(),r!=""?o.text(0+parseInt(r)):o.text(0))}).fail(function(e,t){console.log("Error: "+t.code+" "+t.message)})}function addCount(e){var n=$(".leancloud_visitors"),t=n.attr("id").trim(),o=n.attr("data-flag-title").trim(),s=new AV.Query(e);s.equalTo("url",t),s.find({success:function(n){if(n.length>0){var s,i,r,c,l,a=n[0];a.fetchWhenSave(!0),a.increment("time"),a.save(null,{success:function(e){var n=$(document.getElementById(t));n.find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to save Visitor num, with error message: "+t.message)}})}else s=new e,i=new AV.ACL,i.setPublicReadAccess(!0),i.setPublicWriteAccess(!0),s.setACL(i),s.set("title",o),s.set("url",t),c=".old-visitors-count",l=$(document.getElementById(t)),r=l.find(c).text(),r!=""?s.set("time",parseInt(r)+1):s.set("time",1),s.save(null,{success:function(e){var n=$(document.getElementById(t));n.find(".leancloud-visitors-count").text(e.get("time"))},error:function(){console.log("Failed to create")}})},error:function(e){console.log("Error:"+e.code+" "+e.message)}})}$(function(){var e=AV.Object.extend("Counter");$(".leancloud_visitors").length==1?addCount(e):showTime(e)})</script>é˜…è¯» </span></span>|<span class=post-date>å…± 3990 å­—</span>ï¼Œé˜…è¯»çº¦ <span class=more-meta>8 åˆ†é’Ÿ</span></span></div></div></div></div></header><article><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
post-container"><p>Cilium å®˜æ–¹ç‰ˆæœ¬ç»™å‡ºçš„ Service Mesh å…¨æ™¯å›¾ï¼Œä¸åŒäºå…¶å®ƒ Service Mesh å¼€æºé¡¹ç›®è®¾è®¡äº†å¾ˆå¤š CRD æ¦‚å¿µï¼ŒCilium Service Mesh å½“å‰ä¸“æ³¨å®ç°äº† mesh data planeï¼Œé€šè¿‡å¼€æ”¾ã€åŒ…å®¹çš„è®¾è®¡ï¼Œèƒ½å¤Ÿå¯¹æ¥å…¶å®ƒ control planeï¼Œå½“å‰ç‰ˆæœ¬å·²å®ç°äº†å¯¹ Envoy CRDã€Kubernetes ingressã€Istioã€Spiffeã€Gateway API çš„æ”¯æŒã€‚</p><p><img src=/images/2023-08-12-cilium-mesh-example/1.png alt></p><h1 id=å‰è¨€>å‰è¨€</h1><p>Cilium Service Mesh ä¸å…¶å®ƒ ServiceMesh æ˜¾è‘—å¯¹æ¯”ï¼š</p><ul><li>å½“å‰ Service Mesh é¢†åŸŸä¸­ï¼Œ per-pod proxy (å³ sidecar) å¤§è¡Œå…¶é“ï¼ŒCilium èµ°å‡ºäº† per-node proxy è·¯çº¿çš„é¡¹ç›®ï¼Œå…¶è§„é¿äº† sidecar èµ„æºå¼€é”€å¤šã€ç½‘ç»œå»¶æ—¶é«˜ç­‰å¼Šç«¯ã€‚</li><li>å…¶å®ƒ Service Mesh é¡¹ç›®å‡ ä¹éƒ½æ˜¯å€ŸåŠ© Linux å†…æ ¸ç½‘ç»œåè®®æ ˆåŠ«æŒæµé‡ï¼Œè€Œ Cilium Service Mesh åŸºäº eBPF datapathï¼Œæœ‰ç€å¤©ç”Ÿçš„åŠ é€Ÿæ•ˆæœã€‚</li><li>Cilium Service Mesh æ‰¿è½½äº Cilium CNI çš„åº•åº§èƒ½åŠ›ï¼ŒCilium CNI æœ¬èº«æä¾›çš„ç½‘ç»œ policyã€å¤šé›†ç¾¤ cluster meshã€eBPF åŠ é€Ÿã€è§‚å¯Ÿæ€§ hubble ç­‰èƒ½åŠ›ï¼Œå…¶åŠŸèƒ½éå¸¸ä¸°å¯Œã€‚</li></ul><p>Cilium å®ç°äº† 2ä¸ªæ–°çš„ CRDï¼ŒCiliumEnvoyConfig å’Œ CiliumClusterwideEnvoyConfigï¼Œä¸¤è€…çš„å†™æ³•å’Œä½œç”¨å‡ ä¹ç›¸åŒï¼Œå”¯ä¸€åŒºåˆ«æ˜¯ï¼ŒCiliumEnvoyConfig æ˜¯ namespace scopeï¼Œè€Œ CiliumClusterwideEnvoyConfig æ˜¯ cluster scopeã€‚</p><p>æœ¬ç¯‡æ–‡ç« é€šè¿‡ Cilium Mesh ç¤ºä¾‹æ¥äº†è§£å¦‚ä½•é…ç½® CiliumEnvoyConfigã€CiliumClusterwideEnvoyConfigã€‚</p><h1 id=æ­å»º-kubernetes-é›†ç¾¤>æ­å»º Kubernetes é›†ç¾¤</h1><p>ä½¿ç”¨ Kind æ„å»º k8s é›†ç¾¤ï¼Œå…·ä½“å¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kind create cluster  --image<span style=color:#ff79c6>=</span>kindest/node:v1.22.17 --name  tanjunchen
</span></span><span style=display:flex><span>Creating cluster <span style=color:#f1fa8c>&#34;tanjunchen&#34;</span> ...
</span></span><span style=display:flex><span>â¢€â¡± Ensuring node image <span style=color:#ff79c6>(</span>kindest/node:v1.22.17<span style=color:#ff79c6>)</span> ğŸ–¼
</span></span><span style=display:flex><span>â¢â¡€ Ensuring node image <span style=color:#ff79c6>(</span>kindest/node:v1.22.17<span style=color:#ff79c6>)</span> ğŸ–¼
</span></span><span style=display:flex><span>â â  Ensuring node image <span style=color:#ff79c6>(</span>kindest/node:v1.22.17<span style=color:#ff79c6>)</span> ğŸ–¼
</span></span><span style=display:flex><span> âœ“ Ensuring node image <span style=color:#ff79c6>(</span>kindest/node:v1.22.17<span style=color:#ff79c6>)</span> ğŸ–¼
</span></span><span style=display:flex><span> âœ“ Preparing nodes ğŸ“¦
</span></span><span style=display:flex><span> âœ“ Writing configuration ğŸ“œ
</span></span><span style=display:flex><span> âœ“ Starting control-plane ğŸ•¹ï¸
</span></span><span style=display:flex><span> âœ“ Installing CNI ğŸ”Œ
</span></span><span style=display:flex><span> âœ“ Installing StorageClass ğŸ’¾
</span></span><span style=display:flex><span>Set kubectl context to <span style=color:#f1fa8c>&#34;kind-tanjunchen&#34;</span>
</span></span><span style=display:flex><span>You can now use your cluster with:
</span></span><span style=display:flex><span>kubectl cluster-info --context kind-tanjunchen
</span></span><span style=display:flex><span>Thanks <span style=color:#ff79c6>for</span> using kind! ğŸ˜Š
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>root@instance-00qqerhq:~/cilium-mesh# kubectl get nodes
</span></span><span style=display:flex><span>NAME                       STATUS   ROLES                  AGE   VERSION
</span></span><span style=display:flex><span>tanjunchen-control-plane   Ready    control-plane,master   61s   v1.22.17
</span></span><span style=display:flex><span>root@instance-00qqerhq:~/cilium-mesh# kubectl version --short
</span></span><span style=display:flex><span>Flag --short has been deprecated, and will be removed in the future. The --short output will become the default.
</span></span><span style=display:flex><span>Client Version: v1.27.2
</span></span><span style=display:flex><span>Kustomize Version: v5.0.1
</span></span><span style=display:flex><span>Server Version: v1.22.17
</span></span><span style=display:flex><span>WARNING: version difference between client <span style=color:#ff79c6>(</span>1.27<span style=color:#ff79c6>)</span> and server <span style=color:#ff79c6>(</span>1.22<span style=color:#ff79c6>)</span> exceeds the supported minor version skew of +/-1
</span></span></code></pre></div><h1 id=éƒ¨ç½²æµ‹è¯•åº”ç”¨>éƒ¨ç½²æµ‹è¯•åº”ç”¨</h1><p>éƒ¨ç½²æµ‹è¯•åº”ç”¨ wrk ä¸ nginxï¼Œå…·ä½“å¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>root@instance-00qqerhq:~/cilium-mesh# kubectl apply -f wrk-nginx.yaml
</span></span><span style=display:flex><span>deployment.apps/wrk unchanged
</span></span><span style=display:flex><span>service/nginx unchanged
</span></span><span style=display:flex><span>deployment.apps/nginx configured
</span></span><span style=display:flex><span>root@instance-00qqerhq:~/cilium-mesh# kubectl get pod
</span></span><span style=display:flex><span>NAME                     READY   STATUS    RESTARTS   AGE
</span></span><span style=display:flex><span>nginx-699bb76bb4-p26v7   1/1     Running   <span style=color:#bd93f9>0</span>          2m16s
</span></span><span style=display:flex><span>wrk-64884c57d7-vpml8     1/1     Running   <span style=color:#bd93f9>0</span>          2m16s
</span></span></code></pre></div><h1 id=cilium-mesh>Cilium Mesh</h1><h2 id=å‰ææ¡ä»¶>å‰ææ¡ä»¶</h2><ul><li>Cilium å¿…é¡»ä½¿ç”¨ kubeProxyReplacement æ¨¡å¼ä¸º partial æˆ– strictã€‚</li><li>æ”¯æŒçš„æœ€ä½ Kubernetes ç‰ˆæœ¬æ˜¯ 1.19ã€‚</li></ul><h2 id=å®‰è£…>å®‰è£…</h2><p>å®‰è£… Cilium Mesh</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>helm repo add cilium https://helm.cilium.io/
</span></span><span style=display:flex><span>helm install cilium cilium/cilium --version 1.14.0  --namespace kube-system --set <span style=color:#8be9fd;font-style:italic>kubeProxyReplacement</span><span style=color:#ff79c6>=</span>strict --set-string extraConfig.enable-envoy-config<span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>true</span>  --set envoy.enabled<span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>true</span> --set hubble.relay.enabled<span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>true</span> --set hubble.ui.enabled<span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>true</span>
</span></span></code></pre></div><p><img src=/images/2023-08-12-cilium-mesh-example/2.png alt></p><p><img src=/images/2023-08-12-cilium-mesh-example/3.png alt></p><h2 id=envoy-é…ç½®>Envoy é…ç½®</h2><p>ç›®å‰ä»…æ”¯æŒ Envoy API v3ã€‚Cilium èŠ‚ç‚¹éƒ¨ç½² Envoy æ¥æ”¯æŒ Cilium HTTP ç½‘ç»œç­–ç•¥å’Œå¯è§‚å¯Ÿæ€§ã€‚Cilium Mesh ä¸­ä½¿ç”¨çš„ Envoy å·²ç»é’ˆå¯¹ Cilium Agent çš„éœ€æ±‚è¿›è¡Œäº†ä¼˜åŒ–ï¼Œå¹¶ä¸”ä¸åŒ…å« Envoy ä»£ç åº“ä¸­å¯ç”¨çš„è®¸å¤š Envoy æ‰©å±•ã€‚Envoy æ–‡æ¡£ä¸­å¼•ç”¨çš„æ ‡å‡†ç±»å‹ï¼ˆtype.googleapis.com/envoy.config.listener.v3.Listener å’Œ type.googleapis.com/envoy.config.route.v3.RouteConfigurationï¼‰å§‹ç»ˆå¯ç”¨ã€‚å…·ä½“æ‹“å±•å¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>envoy.clusters.dynamic_forward_proxy
</span></span><span style=display:flex><span>envoy.filters.http.dynamic_forward_proxy
</span></span><span style=display:flex><span>envoy.filters.http.ext_authz
</span></span><span style=display:flex><span>envoy.filters.http.jwt_authn
</span></span><span style=display:flex><span>envoy.filters.http.local_ratelimit
</span></span><span style=display:flex><span>envoy.filters.http.oauth2
</span></span><span style=display:flex><span>envoy.filters.http.ratelimit
</span></span><span style=display:flex><span>envoy.filters.http.router
</span></span><span style=display:flex><span>envoy.filters.http.set_metadata
</span></span><span style=display:flex><span>envoy.filters.listener.tls_inspector
</span></span><span style=display:flex><span>envoy.filters.network.connection_limit
</span></span><span style=display:flex><span>envoy.filters.network.ext_authz
</span></span><span style=display:flex><span>envoy.filters.network.http_connection_manager
</span></span><span style=display:flex><span>envoy.filters.network.local_ratelimit
</span></span><span style=display:flex><span>envoy.filters.network.mongo_proxy
</span></span><span style=display:flex><span>envoy.filters.network.mysql_proxy
</span></span><span style=display:flex><span>envoy.filters.network.ratelimit
</span></span><span style=display:flex><span>envoy.filters.network.tcp_proxy
</span></span><span style=display:flex><span>envoy.filters.network.sni_cluster
</span></span><span style=display:flex><span>envoy.filters.network.sni_dynamic_forward_proxy
</span></span><span style=display:flex><span>envoy.stat_sinks.metrics_service
</span></span><span style=display:flex><span>envoy.transport_sockets.raw_buffer
</span></span><span style=display:flex><span>envoy.upstreams.http.http
</span></span><span style=display:flex><span>envoy.upstreams.http.tcp
</span></span></code></pre></div><h1 id=åœºæ™¯>åœºæ™¯</h1><p>Cilium æä¾›äº†é€šè¿‡ CRD CiliumEnvoyConfig å’Œ CiliumClusterwideEnvoyConfig æ§åˆ¶ L7 æµé‡ã€‚</p><p><strong>è¿™äº› Envoy CRD é…ç½®æ ¹æœ¬æ²¡æœ‰ç»è¿‡ K8s éªŒè¯ï¼Œå› æ­¤ Envoy èµ„æºä¸­çš„ä»»ä½•é”™è¯¯åªä¼šåœ¨ Cilium Agent çœ‹åˆ°ã€‚kubectl apply å°†æŠ¥å‘ŠæˆåŠŸï¼Œè€Œè§£æå’Œ/æˆ–å®‰è£…èŠ‚ç‚¹æœ¬åœ° Envoy å®ä¾‹çš„èµ„æºå¯èƒ½ä¼šå¤±è´¥ã€‚ç›®å‰éªŒè¯è¿™ä¸€ç‚¹çš„å”¯ä¸€æ–¹æ³•æ˜¯è§‚å¯Ÿ Cilium Agent æ—¥å¿—ä¸­çš„é”™è¯¯å’Œè­¦å‘Šã€‚</strong></p><h2 id=ç‰ˆæœ¬>ç‰ˆæœ¬</h2><ul><li>Ciliumï¼šv1.14.0</li><li>Kubernetesï¼šv1.22.17</li></ul><h2 id=é…ç½®-admin>é…ç½® Admin</h2><p>ç»™ envoy ä¸‹å‘ admin é…ç½®ï¼Œä½¿å…¶æš´éœ² admin ç®¡ç†ç•Œé¢ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>apiVersion</span>: cilium.io/v2
</span></span><span style=display:flex><span><span style=color:#ff79c6>kind</span>: CiliumClusterwideEnvoyConfig
</span></span><span style=display:flex><span><span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>name</span>: envoy-admin-listener
</span></span><span style=display:flex><span><span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>resources</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ff79c6>&#34;@type&#34;: </span>type.googleapis.com/envoy.config.listener.v3.Listener
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>name</span>: envoy-admin-listener
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>address</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>socket_address</span>:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>address</span>: <span style=color:#f1fa8c>&#34;::&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>ipv4_compat</span>: <span style=color:#ff79c6>true</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>port_value</span>: <span style=color:#bd93f9>9901</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>filter_chains</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ff79c6>filters</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ff79c6>name</span>: envoy.filters.network.http_connection_manager
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>typed_config</span>:
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>&#34;@type&#34;: </span>type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>stat_prefix</span>: envoy-admin-listener
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>route_config</span>:
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>name</span>: admin_route
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>virtual_hosts</span>:
</span></span><span style=display:flex><span>            - <span style=color:#ff79c6>name</span>: <span style=color:#f1fa8c>&#34;admin_route&#34;</span>
</span></span><span style=display:flex><span>              <span style=color:#ff79c6>domains</span>: [<span style=color:#f1fa8c>&#34;*&#34;</span>]
</span></span><span style=display:flex><span>              <span style=color:#ff79c6>routes</span>:
</span></span><span style=display:flex><span>              - <span style=color:#ff79c6>match</span>:
</span></span><span style=display:flex><span>                  <span style=color:#ff79c6>prefix</span>: <span style=color:#f1fa8c>&#34;/&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>route</span>:
</span></span><span style=display:flex><span>                  <span style=color:#ff79c6>cluster</span>: <span style=color:#f1fa8c>&#34;envoy-admin&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>use_remote_address</span>: <span style=color:#ff79c6>true</span>
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>skip_xff_append</span>: <span style=color:#ff79c6>true</span>
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>http_filters</span>:
</span></span><span style=display:flex><span>          - <span style=color:#ff79c6>name</span>: envoy.filters.http.router
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>typed_config</span>:
</span></span><span style=display:flex><span>              <span style=color:#ff79c6>&#34;@type&#34;: </span>type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
</span></span></code></pre></div><p>æŸ¥çœ‹ envoy çš„ config_dump æ¥å£ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src=/images/2023-08-12-cilium-mesh-example/4.png alt></p><h2 id=url-é‡å†™>URL é‡å†™</h2><p>éƒ¨ç½²åº”ç”¨</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f https://raw.githubusercontent.com/cilium/cilium/1.14.0/examples/kubernetes/servicemesh/envoy/test-application.yaml
</span></span></code></pre></div><p><img src=/images/2023-08-12-cilium-mesh-example/5.png alt></p><p>æµ‹è¯•åº”ç”¨å·¥ä½œè´Ÿè½½åŒ…æ‹¬ï¼šä¸¤ä¸ªå®¢æˆ·ç«¯ client å’Œ client2ï¼Œä¸¤ä¸ªæœåŠ¡ echo-service-1 å’Œ echo-service-2ã€‚</p><p><img src=/images/2023-08-12-cilium-mesh-example/6.png alt></p><p>é…ç½®ç¯å¢ƒå˜é‡</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>CLIENT2</span><span style=color:#ff79c6>=</span><span style=color:#ff79c6>$(</span>kubectl get pods -l <span style=color:#8be9fd;font-style:italic>name</span><span style=color:#ff79c6>=</span>client2 -o <span style=color:#8be9fd;font-style:italic>jsonpath</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#39;{.items[0].metadata.name}&#39;</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>CLIENT</span><span style=color:#ff79c6>=</span><span style=color:#ff79c6>$(</span>kubectl get pods -l <span style=color:#8be9fd;font-style:italic>name</span><span style=color:#ff79c6>=</span>client -o <span style=color:#8be9fd;font-style:italic>jsonpath</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#39;{.items[0].metadata.name}&#39;</span><span style=color:#ff79c6>)</span>
</span></span></code></pre></div><p>æˆ‘ä»¬å°†ä½¿ç”¨ Envoy é…ç½®æ¥è¯·æ±‚æœåŠ¡ echo-service-1 å’Œ echo-service-2ã€‚æˆ‘ä»¬å¯ä»¥è¯·æ±‚ /ï¼Œä½†æ˜¯è¯·æ±‚ /foo è·¯å¾„ï¼Œå°±ä¼šæŠ¥ 404ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl <span style=color:#8be9fd;font-style:italic>exec</span> -it <span style=color:#8be9fd;font-style:italic>$CLIENT2</span> -- curl -I echo-service-1:8080/foo
</span></span><span style=display:flex><span>kubectl <span style=color:#8be9fd;font-style:italic>exec</span> -it <span style=color:#8be9fd;font-style:italic>$CLIENT2</span> -- curl -I echo-service-1:8080
</span></span><span style=display:flex><span>kubectl <span style=color:#8be9fd;font-style:italic>exec</span> -it <span style=color:#8be9fd;font-style:italic>$CLIENT2</span> -- curl -I echo-service-2:8080
</span></span></code></pre></div><p><img src=/images/2023-08-12-cilium-mesh-example/7.png alt></p><p>éƒ¨ç½² envoy-lb-listener.yaml ï¼Œè¯¥æ–‡ä»¶å®šä¹‰äº† CiliumClusterwideEnvoyConfigï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>apiVersion</span>: cilium.io/v2
</span></span><span style=display:flex><span><span style=color:#ff79c6>kind</span>: CiliumClusterwideEnvoyConfig
</span></span><span style=display:flex><span><span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>name</span>: envoy-lb-listener
</span></span><span style=display:flex><span><span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>services</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ff79c6>name</span>: echo-service-1
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>namespace</span>: default
</span></span><span style=display:flex><span>    - <span style=color:#ff79c6>name</span>: echo-service-2
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>namespace</span>: default
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>resources</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ff79c6>&#34;@type&#34;: </span>type.googleapis.com/envoy.config.listener.v3.Listener
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>name</span>: envoy-lb-listener
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>filter_chains</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ff79c6>filters</span>:
</span></span><span style=display:flex><span>            - <span style=color:#ff79c6>name</span>: envoy.filters.network.http_connection_manager
</span></span><span style=display:flex><span>              <span style=color:#ff79c6>typed_config</span>:
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>&#34;@type&#34;: </span>type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>stat_prefix</span>: envoy-lb-listener
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>rds</span>:
</span></span><span style=display:flex><span>                  <span style=color:#ff79c6>route_config_name</span>: lb_route
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>use_remote_address</span>: <span style=color:#ff79c6>true</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>skip_xff_append</span>: <span style=color:#ff79c6>true</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>http_filters</span>:
</span></span><span style=display:flex><span>                  - <span style=color:#ff79c6>name</span>: envoy.filters.http.router
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>typed_config</span>:
</span></span><span style=display:flex><span>                      <span style=color:#ff79c6>&#34;@type&#34;: </span>type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
</span></span><span style=display:flex><span>    - <span style=color:#ff79c6>&#34;@type&#34;: </span>type.googleapis.com/envoy.config.route.v3.RouteConfiguration
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>name</span>: lb_route
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>virtual_hosts</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ff79c6>name</span>: <span style=color:#f1fa8c>&#34;lb_route&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>domains</span>: [ <span style=color:#f1fa8c>&#34;*&#34;</span> ]
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>routes</span>:
</span></span><span style=display:flex><span>            - <span style=color:#ff79c6>match</span>:
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>prefix</span>: <span style=color:#f1fa8c>&#34;/&#34;</span>
</span></span><span style=display:flex><span>              <span style=color:#ff79c6>route</span>:
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>weighted_clusters</span>:
</span></span><span style=display:flex><span>                  <span style=color:#ff79c6>clusters</span>:
</span></span><span style=display:flex><span>                    - <span style=color:#ff79c6>name</span>: <span style=color:#f1fa8c>&#34;default/echo-service-1&#34;</span>
</span></span><span style=display:flex><span>                      <span style=color:#ff79c6>weight</span>: <span style=color:#bd93f9>50</span>
</span></span><span style=display:flex><span>                    - <span style=color:#ff79c6>name</span>: <span style=color:#f1fa8c>&#34;default/echo-service-2&#34;</span>
</span></span><span style=display:flex><span>                      <span style=color:#ff79c6>weight</span>: <span style=color:#bd93f9>50</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>retry_policy</span>:
</span></span><span style=display:flex><span>                  <span style=color:#ff79c6>retry_on</span>: 5xx
</span></span><span style=display:flex><span>                  <span style=color:#ff79c6>num_retries</span>: <span style=color:#bd93f9>3</span>
</span></span><span style=display:flex><span>                  <span style=color:#ff79c6>per_try_timeout</span>: 1s
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>regex_rewrite</span>:
</span></span><span style=display:flex><span>                  <span style=color:#ff79c6>pattern</span>:
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>google_re2</span>: { }
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>regex</span>: <span style=color:#f1fa8c>&#34;^/foo.*$&#34;</span>
</span></span><span style=display:flex><span>                  <span style=color:#ff79c6>substitution</span>: <span style=color:#f1fa8c>&#34;/&#34;</span>
</span></span><span style=display:flex><span>    - <span style=color:#ff79c6>&#34;@type&#34;: </span>type.googleapis.com/envoy.config.cluster.v3.Cluster
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>name</span>: <span style=color:#f1fa8c>&#34;default/echo-service-1&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>connect_timeout</span>: 5s
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>lb_policy</span>: ROUND_ROBIN
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>type</span>: EDS
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>outlier_detection</span>:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>split_external_local_origin_errors</span>: <span style=color:#ff79c6>true</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>consecutive_local_origin_failure</span>: <span style=color:#bd93f9>2</span>
</span></span><span style=display:flex><span>    - <span style=color:#ff79c6>&#34;@type&#34;: </span>type.googleapis.com/envoy.config.cluster.v3.Cluster
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>name</span>: <span style=color:#f1fa8c>&#34;default/echo-service-2&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>connect_timeout</span>: 3s
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>lb_policy</span>: ROUND_ROBIN
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>type</span>: EDS
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>outlier_detection</span>:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>split_external_local_origin_errors</span>: <span style=color:#ff79c6>true</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>consecutive_local_origin_failure</span>: <span style=color:#bd93f9>2</span>
</span></span></code></pre></div><p>ä¸Šè¿°é…ç½®ä¸¤ä¸ªåç«¯ echo æœåŠ¡ä¹‹é—´çš„è¯·æ±‚æ¯”ä¾‹ä¸º 50/50ï¼Œå¹¶ä¸”å°†è·¯å¾„ /foo é‡å†™ä¸º /ï¼Œç”±äºè·¯å¾„é‡å†™ï¼Œå¯¹ /foo çš„è¯·æ±‚ç°åœ¨åº”è¯¥ä¼šæˆåŠŸã€‚æˆ‘ä»¬å‘ç°æœåŠ¡é‡å†™æˆåŠŸï¼ŒåŸæœ¬ /foo æ˜¯è¯·æ±‚å“åº” 404ï¼Œé…ç½®ç­–ç•¥åæ˜¯å¯ä»¥æˆåŠŸçš„ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src=/images/2023-08-12-cilium-mesh-example/8.png alt></p><h2 id=é™æµ>é™æµ</h2><p>é’ˆå¯¹ echo-service-1 é…ç½® CiliumClusterwideEnvoyConfig é™æµç­–ç•¥ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>apiVersion</span>: cilium.io/v2
</span></span><span style=display:flex><span><span style=color:#ff79c6>kind</span>: CiliumClusterwideEnvoyConfig
</span></span><span style=display:flex><span><span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>name</span>: envoy-lb-listener
</span></span><span style=display:flex><span><span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>services</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ff79c6>name</span>: echo-service-1
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>namespace</span>: default
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>resources</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ff79c6>&#34;@type&#34;: </span>type.googleapis.com/envoy.config.listener.v3.Listener
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>name</span>: envoy-lb-listener
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>filter_chains</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ff79c6>filters</span>:
</span></span><span style=display:flex><span>            - <span style=color:#ff79c6>name</span>: envoy.filters.network.http_connection_manager
</span></span><span style=display:flex><span>              <span style=color:#ff79c6>typed_config</span>:
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>&#34;@type&#34;: </span>type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>stat_prefix</span>: envoy-ratelimit
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>rds</span>:
</span></span><span style=display:flex><span>                  <span style=color:#ff79c6>route_config_name</span>: lb_route
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>use_remote_address</span>: <span style=color:#ff79c6>true</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>skip_xff_append</span>: <span style=color:#ff79c6>true</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>http_filters</span>:
</span></span><span style=display:flex><span>                - <span style=color:#ff79c6>name</span>: envoy.filters.http.local_ratelimit
</span></span><span style=display:flex><span>                  <span style=color:#ff79c6>typed_config</span>:
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>&#34;@type&#34;: </span>type.googleapis.com/envoy.extensions.filters.http.local_ratelimit.v3.LocalRateLimit
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>stat_prefix</span>: http_local_rate_limiter
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>token_bucket</span>:
</span></span><span style=display:flex><span>                      <span style=color:#ff79c6>max_tokens</span>: <span style=color:#bd93f9>2</span>
</span></span><span style=display:flex><span>                      <span style=color:#ff79c6>tokens_per_fill</span>: <span style=color:#bd93f9>2</span>
</span></span><span style=display:flex><span>                      <span style=color:#ff79c6>fill_interval</span>: 5s
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>filter_enabled</span>:
</span></span><span style=display:flex><span>                      <span style=color:#ff79c6>runtime_key</span>: local_rate_limit_enabled
</span></span><span style=display:flex><span>                      <span style=color:#ff79c6>default_value</span>:
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>numerator</span>: <span style=color:#bd93f9>100</span>
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>denominator</span>: HUNDRED
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>filter_enforced</span>:
</span></span><span style=display:flex><span>                      <span style=color:#ff79c6>runtime_key</span>: local_rate_limit_enforced
</span></span><span style=display:flex><span>                      <span style=color:#ff79c6>default_value</span>:
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>numerator</span>: <span style=color:#bd93f9>100</span>
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>denominator</span>: HUNDRED
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>response_headers_to_add</span>:
</span></span><span style=display:flex><span>                    - <span style=color:#ff79c6>append_action</span>: OVERWRITE_IF_EXISTS_OR_ADD
</span></span><span style=display:flex><span>                      <span style=color:#ff79c6>header</span>:
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>key</span>: x-local-rate-limit
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>value</span>: <span style=color:#f1fa8c>&#39;true&#39;</span>
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>local_rate_limit_per_downstream_connection</span>: <span style=color:#ff79c6>false</span>
</span></span><span style=display:flex><span>                - <span style=color:#ff79c6>name</span>: envoy.filters.http.router
</span></span><span style=display:flex><span>                  <span style=color:#ff79c6>typed_config</span>:
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>&#34;@type&#34;: </span>type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
</span></span><span style=display:flex><span>    - <span style=color:#ff79c6>&#34;@type&#34;: </span>type.googleapis.com/envoy.config.route.v3.RouteConfiguration
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>name</span>: lb_route
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>virtual_hosts</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ff79c6>name</span>: <span style=color:#f1fa8c>&#34;lb_route&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>domains</span>: [ <span style=color:#f1fa8c>&#34;*&#34;</span> ]
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>routes</span>:
</span></span><span style=display:flex><span>            - <span style=color:#ff79c6>match</span>:
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>prefix</span>: <span style=color:#f1fa8c>&#34;/&#34;</span>
</span></span><span style=display:flex><span>              <span style=color:#ff79c6>route</span>:
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>weighted_clusters</span>:
</span></span><span style=display:flex><span>                  <span style=color:#ff79c6>clusters</span>:
</span></span><span style=display:flex><span>                    - <span style=color:#ff79c6>name</span>: <span style=color:#f1fa8c>&#34;default/echo-service-1&#34;</span>
</span></span><span style=display:flex><span>                      <span style=color:#ff79c6>weight</span>: <span style=color:#bd93f9>100</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>retry_policy</span>:
</span></span><span style=display:flex><span>                  <span style=color:#ff79c6>retry_on</span>: 5xx
</span></span><span style=display:flex><span>                  <span style=color:#ff79c6>num_retries</span>: <span style=color:#bd93f9>3</span>
</span></span><span style=display:flex><span>                  <span style=color:#ff79c6>per_try_timeout</span>: 1s
</span></span><span style=display:flex><span>    - <span style=color:#ff79c6>&#34;@type&#34;: </span>type.googleapis.com/envoy.config.cluster.v3.Cluster
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>name</span>: <span style=color:#f1fa8c>&#34;default/echo-service-1&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>connect_timeout</span>: 5s
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>lb_policy</span>: ROUND_ROBIN
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>type</span>: EDS
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>outlier_detection</span>:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>split_external_local_origin_errors</span>: <span style=color:#ff79c6>true</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>consecutive_local_origin_failure</span>: <span style=color:#bd93f9>2</span>
</span></span></code></pre></div><p><img src=/images/2023-08-12-cilium-mesh-example/9.png alt></p><p>æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼Œè§¦å‘é™æµã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>CLIENT2</span><span style=color:#ff79c6>=</span><span style=color:#ff79c6>$(</span>kubectl get pods -l <span style=color:#8be9fd;font-style:italic>name</span><span style=color:#ff79c6>=</span>client2 -o <span style=color:#8be9fd;font-style:italic>jsonpath</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#39;{.items[0].metadata.name}&#39;</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>for</span> i in <span style=color:#ff79c6>{</span>1..5<span style=color:#ff79c6>}</span>; <span style=color:#ff79c6>do</span>  kubectl <span style=color:#8be9fd;font-style:italic>exec</span> -it <span style=color:#8be9fd;font-style:italic>$CLIENT2</span> -- curl -I echo-service-1:8080 | grep -E <span style=color:#f1fa8c>&#34;x-local-rate-limit|429|local_rate_limited&#34;</span>; <span style=color:#ff79c6>done</span>
</span></span></code></pre></div><p><img src=/images/2023-08-12-cilium-mesh-example/10.png alt></p><p><img src=/images/2023-08-12-cilium-mesh-example/11.png alt></p><p>å› ä¸º echo-service-2 æ²¡æœ‰é…ç½®é™æµç­–ç•¥ï¼Œæ‰€ä»¥è¯·æ±‚ echo-service-2 æ²¡æœ‰è§¦å‘é™æµã€‚</p><p><img src=/images/2023-08-12-cilium-mesh-example/12.png alt></p><h2 id=ç†”æ–­>ç†”æ–­</h2><p>éƒ¨ç½² fortio å‹æµ‹å·¥å…·ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>apiVersion</span>: v1
</span></span><span style=display:flex><span><span style=color:#ff79c6>kind</span>: Service
</span></span><span style=display:flex><span><span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>name</span>: fortio
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>app</span>: fortio
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>service</span>: fortio
</span></span><span style=display:flex><span><span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>ports</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ff79c6>port</span>: <span style=color:#bd93f9>8080</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>name</span>: http
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>app</span>: fortio
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#ff79c6>apiVersion</span>: apps/v1
</span></span><span style=display:flex><span><span style=color:#ff79c6>kind</span>: Deployment
</span></span><span style=display:flex><span><span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>name</span>: fortio-deploy
</span></span><span style=display:flex><span><span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>replicas</span>: <span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>app</span>: fortio
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>app</span>: fortio
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ff79c6>name</span>: fortio
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>image</span>: fortio/fortio:latest_release
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>imagePullPolicy</span>: Always
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>ports</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ff79c6>containerPort</span>: <span style=color:#bd93f9>8080</span>
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>name</span>: http-fortio
</span></span><span style=display:flex><span>        - <span style=color:#ff79c6>containerPort</span>: <span style=color:#bd93f9>8079</span>
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>name</span>: grpc-ping
</span></span></code></pre></div><p>ç»™ echo-service-1 é…ç½® CiliumClusterwideEnvoyConfig æˆ–è€… CiliumEnvoyConfig ç†”æ–­ç­–ç•¥ã€‚</p><p><img src=/images/2023-08-12-cilium-mesh-example/13.png alt></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>apiVersion</span>: cilium.io/v2
</span></span><span style=display:flex><span><span style=color:#ff79c6>kind</span>: CiliumEnvoyConfig
</span></span><span style=display:flex><span><span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>name</span>: envoy-circuit-breaker
</span></span><span style=display:flex><span><span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>services</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ff79c6>name</span>: echo-service-1
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>namespace</span>: default
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>resources</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ff79c6>&#34;@type&#34;: </span>type.googleapis.com/envoy.config.listener.v3.Listener
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>name</span>: envoy-lb-listener
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>filter_chains</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ff79c6>filters</span>:
</span></span><span style=display:flex><span>            - <span style=color:#ff79c6>name</span>: envoy.filters.network.http_connection_manager
</span></span><span style=display:flex><span>              <span style=color:#ff79c6>typed_config</span>:
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>&#34;@type&#34;: </span>type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>stat_prefix</span>: envoy-lb-listener
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>rds</span>:
</span></span><span style=display:flex><span>                  <span style=color:#ff79c6>route_config_name</span>: lb_route
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>use_remote_address</span>: <span style=color:#ff79c6>true</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>skip_xff_append</span>: <span style=color:#ff79c6>true</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>http_filters</span>:
</span></span><span style=display:flex><span>                  - <span style=color:#ff79c6>name</span>: envoy.filters.http.router
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>typed_config</span>:
</span></span><span style=display:flex><span>                      <span style=color:#ff79c6>&#34;@type&#34;: </span>type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
</span></span><span style=display:flex><span>    - <span style=color:#ff79c6>&#34;@type&#34;: </span>type.googleapis.com/envoy.config.route.v3.RouteConfiguration
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>name</span>: lb_route
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>virtual_hosts</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ff79c6>name</span>: <span style=color:#f1fa8c>&#34;lb_route&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>domains</span>: [ <span style=color:#f1fa8c>&#34;*&#34;</span> ]
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>routes</span>:
</span></span><span style=display:flex><span>            - <span style=color:#ff79c6>match</span>:
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>prefix</span>: <span style=color:#f1fa8c>&#34;/&#34;</span>
</span></span><span style=display:flex><span>              <span style=color:#ff79c6>route</span>:
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>weighted_clusters</span>:
</span></span><span style=display:flex><span>                  <span style=color:#ff79c6>clusters</span>:
</span></span><span style=display:flex><span>                    - <span style=color:#ff79c6>name</span>: <span style=color:#f1fa8c>&#34;default/echo-service-1&#34;</span>
</span></span><span style=display:flex><span>                      <span style=color:#ff79c6>weight</span>: <span style=color:#bd93f9>100</span>
</span></span><span style=display:flex><span>    - <span style=color:#ff79c6>&#34;@type&#34;: </span>type.googleapis.com/envoy.config.cluster.v3.Cluster
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>name</span>: <span style=color:#f1fa8c>&#34;default/echo-service-1&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>connect_timeout</span>: 5s
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>lb_policy</span>: ROUND_ROBIN
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>type</span>: EDS
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>circuit_breakers</span>:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>thresholds</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ff79c6>priority</span>: <span style=color:#f1fa8c>&#34;DEFAULT&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>max_requests</span>: <span style=color:#bd93f9>2</span>
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>max_pending_requests</span>: <span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>outlier_detection</span>:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>split_external_local_origin_errors</span>: <span style=color:#ff79c6>true</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>consecutive_local_origin_failure</span>: <span style=color:#bd93f9>2</span>
</span></span></code></pre></div><p><img src=/images/2023-08-12-cilium-mesh-example/14.png alt></p><p>ä½¿ç”¨ä¸¤ä¸ªå¹¶å‘è¿æ¥ (-c 2) è°ƒç”¨æœåŠ¡å¹¶å‘é€ 20 ä¸ªè¯·æ±‚ (-n 20)ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl <span style=color:#8be9fd;font-style:italic>exec</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$FORTIO_POD</span><span style=color:#f1fa8c>&#34;</span> -c fortio -- /usr/bin/fortio load -c <span style=color:#bd93f9>2</span> -qps <span style=color:#bd93f9>0</span> -n <span style=color:#bd93f9>20</span> http://echo-service-1:8080 
</span></span></code></pre></div><p>å¦‚ä¸‹æ‰€ç¤ºï¼Œå½“å¹¶å‘è¯·æ±‚ echo-service-1 å‹åŠ›è¾ƒå¤§æ—¶ï¼Œä¼šè§¦å‘ç†”æ–­ç­–ç•¥ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>root@instance-00qqerhq:~/cilium-mesh/strateges# kubectl <span style=color:#8be9fd;font-style:italic>exec</span> <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$FORTIO_POD</span><span style=color:#f1fa8c>&#34;</span> -c fortio -- /usr/bin/fortio load -c <span style=color:#bd93f9>2</span> -qps <span style=color:#bd93f9>0</span> -n <span style=color:#bd93f9>20</span> http://echo-service-1:8080
</span></span><span style=display:flex><span><span style=color:#ff79c6>{</span><span style=color:#f1fa8c>&#34;ts&#34;</span>:1691997950.946896,<span style=color:#f1fa8c>&#34;level&#34;</span>:<span style=color:#f1fa8c>&#34;info&#34;</span>,<span style=color:#f1fa8c>&#34;file&#34;</span>:<span style=color:#f1fa8c>&#34;scli.go&#34;</span>,<span style=color:#f1fa8c>&#34;line&#34;</span>:107,<span style=color:#f1fa8c>&#34;msg&#34;</span>:<span style=color:#f1fa8c>&#34;Starting Î¦Î¿ÏÏ„Î¯Î¿ 1.57.3 h1:kdPlBiws3cFsLcssZxCt2opFmHj14C3yPBokFhMWzmg= go1.20.6 amd64 linux&#34;</span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>Fortio 1.57.3 running at <span style=color:#bd93f9>0</span> queries per second, 4-&gt;4 procs, <span style=color:#ff79c6>for</span> <span style=color:#bd93f9>20</span> calls: http://echo-service-1:8080
</span></span><span style=display:flex><span><span style=color:#ff79c6>{</span><span style=color:#f1fa8c>&#34;ts&#34;</span>:1691997950.947488,<span style=color:#f1fa8c>&#34;level&#34;</span>:<span style=color:#f1fa8c>&#34;info&#34;</span>,<span style=color:#f1fa8c>&#34;file&#34;</span>:<span style=color:#f1fa8c>&#34;httprunner.go&#34;</span>,<span style=color:#f1fa8c>&#34;line&#34;</span>:100,<span style=color:#f1fa8c>&#34;msg&#34;</span>:<span style=color:#f1fa8c>&#34;Starting http test&#34;</span>,<span style=color:#f1fa8c>&#34;run&#34;</span>:<span style=color:#f1fa8c>&#34;0&#34;</span>,<span style=color:#f1fa8c>&#34;url&#34;</span>:<span style=color:#f1fa8c>&#34;http://echo-service-1:8080&#34;</span>,<span style=color:#f1fa8c>&#34;threads&#34;</span>:<span style=color:#f1fa8c>&#34;2&#34;</span>,<span style=color:#f1fa8c>&#34;qps&#34;</span>:<span style=color:#f1fa8c>&#34;-1.0&#34;</span>,<span style=color:#f1fa8c>&#34;warmup&#34;</span>:<span style=color:#f1fa8c>&#34;parallel&#34;</span>,<span style=color:#f1fa8c>&#34;conn-reuse&#34;</span>:<span style=color:#f1fa8c>&#34;&#34;</span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>Starting at max qps with <span style=color:#bd93f9>2</span> thread<span style=color:#ff79c6>(</span>s<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>[</span>gomax 4<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>for</span> exactly <span style=color:#bd93f9>20</span> calls <span style=color:#ff79c6>(</span><span style=color:#bd93f9>10</span> per thread + 0<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>{</span><span style=color:#f1fa8c>&#34;ts&#34;</span>:1691997950.950205,<span style=color:#f1fa8c>&#34;level&#34;</span>:<span style=color:#f1fa8c>&#34;warn&#34;</span>,<span style=color:#f1fa8c>&#34;file&#34;</span>:<span style=color:#f1fa8c>&#34;http_client.go&#34;</span>,<span style=color:#f1fa8c>&#34;line&#34;</span>:1104,<span style=color:#f1fa8c>&#34;msg&#34;</span>:<span style=color:#f1fa8c>&#34;Non ok http code&#34;</span>,<span style=color:#f1fa8c>&#34;code&#34;</span>:<span style=color:#f1fa8c>&#34;503&#34;</span>,<span style=color:#f1fa8c>&#34;status&#34;</span>:<span style=color:#f1fa8c>&#34;HTTP/1.1 503&#34;</span>,<span style=color:#f1fa8c>&#34;thread&#34;</span>:<span style=color:#f1fa8c>&#34;0&#34;</span>,<span style=color:#f1fa8c>&#34;run&#34;</span>:<span style=color:#f1fa8c>&#34;0&#34;</span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>{</span><span style=color:#f1fa8c>&#34;ts&#34;</span>:1691997950.976027,<span style=color:#f1fa8c>&#34;level&#34;</span>:<span style=color:#f1fa8c>&#34;info&#34;</span>,<span style=color:#f1fa8c>&#34;file&#34;</span>:<span style=color:#f1fa8c>&#34;periodic.go&#34;</span>,<span style=color:#f1fa8c>&#34;line&#34;</span>:832,<span style=color:#f1fa8c>&#34;msg&#34;</span>:<span style=color:#f1fa8c>&#34;T001 ended after 27.10868ms : 10 calls. qps=368.8855377687147&#34;</span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>{</span><span style=color:#f1fa8c>&#34;ts&#34;</span>:1691997950.976465,<span style=color:#f1fa8c>&#34;level&#34;</span>:<span style=color:#f1fa8c>&#34;info&#34;</span>,<span style=color:#f1fa8c>&#34;file&#34;</span>:<span style=color:#f1fa8c>&#34;periodic.go&#34;</span>,<span style=color:#f1fa8c>&#34;line&#34;</span>:832,<span style=color:#f1fa8c>&#34;msg&#34;</span>:<span style=color:#f1fa8c>&#34;T000 ended after 27.547964ms : 10 calls. qps=363.0032331971974&#34;</span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>Ended after 27.591205ms : <span style=color:#bd93f9>20</span> calls. <span style=color:#8be9fd;font-style:italic>qps</span><span style=color:#ff79c6>=</span>724.87
</span></span><span style=display:flex><span><span style=color:#ff79c6>{</span><span style=color:#f1fa8c>&#34;ts&#34;</span>:1691997950.976519,<span style=color:#f1fa8c>&#34;level&#34;</span>:<span style=color:#f1fa8c>&#34;info&#34;</span>,<span style=color:#f1fa8c>&#34;file&#34;</span>:<span style=color:#f1fa8c>&#34;periodic.go&#34;</span>,<span style=color:#f1fa8c>&#34;line&#34;</span>:564,<span style=color:#f1fa8c>&#34;msg&#34;</span>:<span style=color:#f1fa8c>&#34;Run ended&#34;</span>,<span style=color:#f1fa8c>&#34;run&#34;</span>:<span style=color:#f1fa8c>&#34;0&#34;</span>,<span style=color:#f1fa8c>&#34;elapsed&#34;</span>:<span style=color:#f1fa8c>&#34;27.591205ms&#34;</span>,<span style=color:#f1fa8c>&#34;calls&#34;</span>:<span style=color:#f1fa8c>&#34;20&#34;</span>,<span style=color:#f1fa8c>&#34;qps&#34;</span>:<span style=color:#f1fa8c>&#34;724.8686673887566&#34;</span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>Aggregated Function Time : count <span style=color:#bd93f9>20</span> avg 0.0027248375 +/- 0.002902 min 0.001064346 max 0.010990329 sum 0.05449675
</span></span><span style=display:flex><span><span style=color:#6272a4># range, mid point, percentile, count</span>
</span></span><span style=display:flex><span>&gt;<span style=color:#ff79c6>=</span> 0.00106435 &lt;<span style=color:#ff79c6>=</span> 0.002 , 0.00153217 , 70.00, <span style=color:#bd93f9>14</span>
</span></span><span style=display:flex><span>&gt; 0.002 &lt;<span style=color:#ff79c6>=</span> 0.003 , 0.0025 , 80.00, <span style=color:#bd93f9>2</span>
</span></span><span style=display:flex><span>&gt; 0.003 &lt;<span style=color:#ff79c6>=</span> 0.004 , 0.0035 , 85.00, <span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span>&gt; 0.006 &lt;<span style=color:#ff79c6>=</span> 0.007 , 0.0065 , 90.00, <span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span>&gt; 0.01 &lt;<span style=color:#ff79c6>=</span> 0.0109903 , 0.0104952 , 100.00, <span style=color:#bd93f9>2</span>
</span></span><span style=display:flex><span><span style=color:#6272a4># target 50% 0.00171211</span>
</span></span><span style=display:flex><span><span style=color:#6272a4># target 75% 0.0025</span>
</span></span><span style=display:flex><span><span style=color:#6272a4># target 90% 0.007</span>
</span></span><span style=display:flex><span><span style=color:#6272a4># target 99% 0.0108913</span>
</span></span><span style=display:flex><span><span style=color:#6272a4># target 99.9% 0.0109804</span>
</span></span><span style=display:flex><span>Error cases : count <span style=color:#bd93f9>1</span> avg 0.001306888 +/- <span style=color:#bd93f9>0</span> min 0.001306888 max 0.001306888 sum 0.001306888
</span></span><span style=display:flex><span><span style=color:#6272a4># range, mid point, percentile, count</span>
</span></span><span style=display:flex><span>&gt;<span style=color:#ff79c6>=</span> 0.00130689 &lt;<span style=color:#ff79c6>=</span> 0.00130689 , 0.00130689 , 100.00, <span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span><span style=color:#6272a4># target 50% 0.00130689</span>
</span></span><span style=display:flex><span><span style=color:#6272a4># target 75% 0.00130689</span>
</span></span><span style=display:flex><span><span style=color:#6272a4># target 90% 0.00130689</span>
</span></span><span style=display:flex><span><span style=color:#6272a4># target 99% 0.00130689</span>
</span></span><span style=display:flex><span><span style=color:#6272a4># target 99.9% 0.00130689</span>
</span></span><span style=display:flex><span><span style=color:#6272a4># Socket and IP used for each connection:</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>0<span style=color:#ff79c6>]</span>   <span style=color:#bd93f9>2</span> socket used, resolved to 10.96.39.34:8080, connection timing : count <span style=color:#bd93f9>2</span> avg 0.0002502065 +/- 6.296e-05 min 0.000187245 max 0.000313168 sum 0.000500413
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>1<span style=color:#ff79c6>]</span>   <span style=color:#bd93f9>1</span> socket used, resolved to 10.96.39.34:8080, connection timing : count <span style=color:#bd93f9>1</span> avg 0.00018792 +/- <span style=color:#bd93f9>0</span> min 0.00018792 max 0.00018792 sum 0.00018792
</span></span><span style=display:flex><span>Connection <span style=color:#8be9fd;font-style:italic>time</span> histogram <span style=color:#ff79c6>(</span>s<span style=color:#ff79c6>)</span> : count <span style=color:#bd93f9>3</span> avg 0.00022944433 +/- 5.92e-05 min 0.000187245 max 0.000313168 sum 0.000688333
</span></span><span style=display:flex><span><span style=color:#6272a4># range, mid point, percentile, count</span>
</span></span><span style=display:flex><span>&gt;<span style=color:#ff79c6>=</span> 0.000187245 &lt;<span style=color:#ff79c6>=</span> 0.000313168 , 0.000250207 , 100.00, <span style=color:#bd93f9>3</span>
</span></span><span style=display:flex><span><span style=color:#6272a4># target 50% 0.000218726</span>
</span></span><span style=display:flex><span><span style=color:#6272a4># target 75% 0.000265947</span>
</span></span><span style=display:flex><span><span style=color:#6272a4># target 90% 0.00029428</span>
</span></span><span style=display:flex><span><span style=color:#6272a4># target 99% 0.000311279</span>
</span></span><span style=display:flex><span><span style=color:#6272a4># target 99.9% 0.000312979</span>
</span></span><span style=display:flex><span>Sockets used: <span style=color:#bd93f9>3</span> <span style=color:#ff79c6>(</span><span style=color:#ff79c6>for</span> perfect keepalive, would be 2<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>Uniform: false, Jitter: false, Catchup allowed: <span style=color:#8be9fd;font-style:italic>true</span>
</span></span><span style=display:flex><span>IP addresses distribution:
</span></span><span style=display:flex><span>10.96.39.34:8080: <span style=color:#bd93f9>3</span>
</span></span><span style=display:flex><span>Code <span style=color:#bd93f9>200</span> : <span style=color:#bd93f9>19</span> <span style=color:#ff79c6>(</span>95.0 %<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>Code <span style=color:#bd93f9>503</span> : <span style=color:#bd93f9>1</span> <span style=color:#ff79c6>(</span>5.0 %<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>Response Header Sizes : count <span style=color:#bd93f9>20</span> avg 370.55 +/- 85.01 min <span style=color:#bd93f9>0</span> max <span style=color:#bd93f9>391</span> sum <span style=color:#bd93f9>7411</span>
</span></span><span style=display:flex><span>Response Body/Total Sizes : count <span style=color:#bd93f9>20</span> avg 2336.75 +/- 480.8 min <span style=color:#bd93f9>241</span> max <span style=color:#bd93f9>2448</span> sum <span style=color:#bd93f9>46735</span>
</span></span><span style=display:flex><span>All <span style=color:#ff79c6>done</span> <span style=color:#bd93f9>20</span> calls <span style=color:#ff79c6>(</span>plus <span style=color:#bd93f9>0</span> warmup<span style=color:#ff79c6>)</span> 2.725 ms avg, 724.9 qps
</span></span><span style=display:flex><span>root@instance-00qqerhq:~/cilium-mesh/strateges#
</span></span></code></pre></div><h2 id=è´Ÿè½½å‡è¡¡>è´Ÿè½½å‡è¡¡</h2><p>é…ç½®è¯·æ±‚å®¢æˆ·ç«¯ CLIENTï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>export</span> <span style=color:#8be9fd;font-style:italic>CLIENT</span><span style=color:#ff79c6>=</span><span style=color:#ff79c6>$(</span>kubectl get pods -l <span style=color:#8be9fd;font-style:italic>name</span><span style=color:#ff79c6>=</span>client -o <span style=color:#8be9fd;font-style:italic>jsonpath</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#39;{.items[0].metadata.name}&#39;</span><span style=color:#ff79c6>)</span>
</span></span></code></pre></div><p>æµ‹è¯•å‘½ä»¤ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ff79c6>for</span> i in <span style=color:#ff79c6>{</span>1..10<span style=color:#ff79c6>}</span>; <span style=color:#ff79c6>do</span>  kubectl <span style=color:#8be9fd;font-style:italic>exec</span> -it <span style=color:#8be9fd;font-style:italic>$CLIENT</span> -- curl  helloworld:5000/hello; <span style=color:#ff79c6>done</span>
</span></span><span style=display:flex><span>kubectl <span style=color:#8be9fd;font-style:italic>exec</span> -it <span style=color:#8be9fd;font-style:italic>$CLIENT</span> -- curl  helloworld:5000/hello
</span></span></code></pre></div><p>éƒ¨ç½² helloworld æµ‹è¯•åº”ç”¨ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f https://github.com/istio/istio/blob/master/samples/helloworld/helloworld.yaml
</span></span></code></pre></div><p>é…ç½® CiliumEnvoyConfig è·¯ç”±ç­–ç•¥ï¼Œéšæœºè®¿é—® helloworld v1 ä¸ v2ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>apiVersion</span>: cilium.io/v2
</span></span><span style=display:flex><span><span style=color:#ff79c6>kind</span>: CiliumEnvoyConfig
</span></span><span style=display:flex><span><span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>name</span>: helloworld-lb
</span></span><span style=display:flex><span><span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>services</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ff79c6>name</span>: helloworld
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>namespace</span>: default
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>resources</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ff79c6>&#34;@type&#34;: </span>type.googleapis.com/envoy.config.listener.v3.Listener
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>name</span>: helloworld-lb-listener
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>filter_chains</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ff79c6>filters</span>:
</span></span><span style=display:flex><span>            - <span style=color:#ff79c6>name</span>: envoy.filters.network.http_connection_manager
</span></span><span style=display:flex><span>              <span style=color:#ff79c6>typed_config</span>:
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>&#34;@type&#34;: </span>type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>stat_prefix</span>: helloworld-lb-listener
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>rds</span>:
</span></span><span style=display:flex><span>                  <span style=color:#ff79c6>route_config_name</span>: helloworld_lb_route
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>use_remote_address</span>: <span style=color:#ff79c6>true</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>skip_xff_append</span>: <span style=color:#ff79c6>true</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>http_filters</span>:
</span></span><span style=display:flex><span>                  - <span style=color:#ff79c6>name</span>: envoy.filters.http.router
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>typed_config</span>:
</span></span><span style=display:flex><span>                      <span style=color:#ff79c6>&#34;@type&#34;: </span>type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
</span></span><span style=display:flex><span>    - <span style=color:#ff79c6>&#34;@type&#34;: </span>type.googleapis.com/envoy.config.route.v3.RouteConfiguration
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>name</span>: helloworld_lb_route
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>virtual_hosts</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ff79c6>name</span>: <span style=color:#f1fa8c>&#34;helloworld_lb_route&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>domains</span>: [ <span style=color:#f1fa8c>&#34;*&#34;</span> ]
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>routes</span>:
</span></span><span style=display:flex><span>            - <span style=color:#ff79c6>match</span>:
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>prefix</span>: <span style=color:#f1fa8c>&#34;/&#34;</span>
</span></span><span style=display:flex><span>              <span style=color:#ff79c6>route</span>:
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>cluster</span>: default/helloworld
</span></span><span style=display:flex><span>    - <span style=color:#ff79c6>&#34;@type&#34;: </span>type.googleapis.com/envoy.config.cluster.v3.Cluster
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>name</span>: <span style=color:#f1fa8c>&#34;default/helloworld&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>connect_timeout</span>: 5s
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>lb_policy</span>: ROUND_ROBIN
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>type</span>: EDS
</span></span></code></pre></div><p><img src=/images/2023-08-12-cilium-mesh-example/18.png alt></p><p><img src=/images/2023-08-12-cilium-mesh-example/19.png alt></p><p>é…ç½®ç­–ç•¥ï¼Œè®¿é—® helloworld çš„è¯·æ±‚ï¼Œv1 å æ¯” 80%ï¼Œv2 å æ¯” 20%ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>apiVersion</span>: cilium.io/v2
</span></span><span style=display:flex><span><span style=color:#ff79c6>kind</span>: CiliumEnvoyConfig
</span></span><span style=display:flex><span><span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>name</span>: helloworld-lb
</span></span><span style=display:flex><span><span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>services</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ff79c6>name</span>: helloworld
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>namespace</span>: default
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>resources</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ff79c6>&#34;@type&#34;: </span>type.googleapis.com/envoy.config.listener.v3.Listener
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>name</span>: helloworld-lb-listener
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>filter_chains</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ff79c6>filters</span>:
</span></span><span style=display:flex><span>            - <span style=color:#ff79c6>name</span>: envoy.filters.network.http_connection_manager
</span></span><span style=display:flex><span>              <span style=color:#ff79c6>typed_config</span>:
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>&#34;@type&#34;: </span>type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>stat_prefix</span>: helloworld-lb-listener
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>rds</span>:
</span></span><span style=display:flex><span>                  <span style=color:#ff79c6>route_config_name</span>: helloworld_lb_route
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>use_remote_address</span>: <span style=color:#ff79c6>true</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>skip_xff_append</span>: <span style=color:#ff79c6>true</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>http_filters</span>:
</span></span><span style=display:flex><span>                  - <span style=color:#ff79c6>name</span>: envoy.filters.http.router
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>typed_config</span>:
</span></span><span style=display:flex><span>                      <span style=color:#ff79c6>&#34;@type&#34;: </span>type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
</span></span><span style=display:flex><span>    - <span style=color:#ff79c6>&#34;@type&#34;: </span>type.googleapis.com/envoy.config.route.v3.RouteConfiguration
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>name</span>: helloworld_lb_route
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>virtual_hosts</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ff79c6>name</span>: <span style=color:#f1fa8c>&#34;helloworld_lb_route&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>domains</span>: [ <span style=color:#f1fa8c>&#34;*&#34;</span> ]
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>routes</span>:
</span></span><span style=display:flex><span>            - <span style=color:#ff79c6>match</span>:
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>prefix</span>: <span style=color:#f1fa8c>&#34;/&#34;</span>
</span></span><span style=display:flex><span>              <span style=color:#ff79c6>route</span>:
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>cluster</span>: default/helloworld
</span></span><span style=display:flex><span>    - <span style=color:#ff79c6>&#34;@type&#34;: </span>type.googleapis.com/envoy.config.cluster.v3.Cluster
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>name</span>: <span style=color:#f1fa8c>&#34;default/helloworld&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>connect_timeout</span>: 5s
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>lb_policy</span>: ROUND_ROBIN
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>type</span>: STATIC
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>load_assignment</span>:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>cluster_name</span>: <span style=color:#f1fa8c>&#34;default/helloworld&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>endpoints</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ff79c6>lb_endpoints</span>:
</span></span><span style=display:flex><span>          - <span style=color:#ff79c6>endpoint</span>:
</span></span><span style=display:flex><span>              <span style=color:#ff79c6>address</span>:
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>socket_address</span>:
</span></span><span style=display:flex><span>                  <span style=color:#ff79c6>address</span>: <span style=color:#bd93f9>10.0.0.55</span>  <span style=color:#6272a4># helloworld v2 pod IP</span>
</span></span><span style=display:flex><span>                  <span style=color:#ff79c6>port_value</span>: <span style=color:#bd93f9>5000</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>load_balancing_weight</span>: <span style=color:#bd93f9>20</span>
</span></span><span style=display:flex><span>          - <span style=color:#ff79c6>endpoint</span>:
</span></span><span style=display:flex><span>              <span style=color:#ff79c6>address</span>:
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>socket_address</span>:
</span></span><span style=display:flex><span>                  <span style=color:#ff79c6>address</span>: <span style=color:#bd93f9>10.0.0.238</span>
</span></span><span style=display:flex><span>                  <span style=color:#ff79c6>port_value</span>: <span style=color:#bd93f9>5000</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>load_balancing_weight</span>: <span style=color:#bd93f9>80</span>  <span style=color:#6272a4># helloworld v1 pod IP</span>
</span></span></code></pre></div><p>åœ¨ä¸Šè¿° <em>CiliumEnvoyConfig</em> é…ç½®æ–‡ä»¶ä¸­ï¼Œ<em>æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯é™æ€ Pod IPï¼Œåªæ˜¯ä½œä¸ºæµ‹è¯•ï¼Œä¸å¤ªæ¨èä½¿ç”¨</em>ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>root@instance-00qqerhq:~/cilium-mesh/strateges# kubectl apply -f cec-envoy-lb-weight-load_assignment.yaml
</span></span><span style=display:flex><span>ciliumenvoyconfig.cilium.io/helloworld-lb configured
</span></span></code></pre></div><p><img src=/images/2023-08-12-cilium-mesh-example/20.png alt></p><p>ä»ä¸Šè¿°æˆªå›¾ä¸­å¯ä»¥å¾—å‡ºï¼Œé…ç½®çš„ CCEC ç­–ç•¥ç”Ÿæ•ˆäº†ï¼Œæ¥è¿‘ 80% çš„è¯·æ±‚å‘é€åˆ° v1ï¼Œ20% çš„è¯·æ±‚å‘é€åˆ° v2ã€‚</p><p>ä¸Šè¿°é…ç½®é™æ€ Pod IP ä¸å¤ªæ¨èï¼Œæˆ‘ä»¬ä½¿ç”¨æŒ‰ç…§æ¯”ä¾‹ 90% çš„è¯·æ±‚å‘é€åˆ° v1ï¼Œ10% çš„è¯·æ±‚å‘é€åˆ° v2 å‰ï¼Œç®€å•äº†è§£ä¸‹è¿°å†…å®¹ã€‚</p><p><em>Envoy å‘ç°æœåŠ¡ (EDS) çš„åå­—éœ€è¦éµå¾ª namespace/service-name:port è§„èŒƒã€‚</em></p><p><em>CiliumClusterwideEnvoyConfig æˆ–è€… CiliumEnvoyConfig ä¸­çš„ BackendServices æŒ‡å®š Kubernetes æœåŠ¡ï¼Œå…¶åç«¯ä½¿ç”¨ EDS è‡ªåŠ¨åŒæ­¥åˆ° Envoyã€‚è¿™äº›æœåŠ¡çš„æµé‡ä¸ä¼šè½¬å‘åˆ° Envoy ä¾¦å¬å™¨ã€‚è¿™å…è®¸ Envoy ä¾¦å¬å™¨å¯¹è¿™äº›åç«¯çš„æµé‡è¿›è¡Œè´Ÿè½½å¹³è¡¡ï¼Œè€Œæ­£å¸¸çš„ Cilium æœåŠ¡è´Ÿè½½å¹³è¡¡åˆ™åŒæ—¶è´Ÿè´£å¹³è¡¡è¿™äº›æœåŠ¡çš„æµé‡ã€‚</em></p><p>æˆ‘ä»¬éœ€è¦ä¸º helloworld-v1 ä¸ helloworld-v2 åˆ†åˆ«å®šä¹‰ service helloworld-v1 ä¸ helloworld-v2ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>apiVersion</span>: v1
</span></span><span style=display:flex><span><span style=color:#ff79c6>kind</span>: Service
</span></span><span style=display:flex><span><span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>name</span>: helloworld
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>app</span>: helloworld
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>service</span>: helloworld
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>version</span>: v1
</span></span><span style=display:flex><span><span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>ports</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ff79c6>port</span>: <span style=color:#bd93f9>5000</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>name</span>: http
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>app</span>: helloworld
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#ff79c6>apiVersion</span>: v1
</span></span><span style=display:flex><span><span style=color:#ff79c6>kind</span>: Service
</span></span><span style=display:flex><span><span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>name</span>: helloworld-v1
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>app</span>: helloworld
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>service</span>: helloworld
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>version</span>: v1
</span></span><span style=display:flex><span><span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>ports</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ff79c6>port</span>: <span style=color:#bd93f9>5000</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>name</span>: http
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>app</span>: helloworld
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>version</span>: v1
</span></span></code></pre></div><p><img src=/images/2023-08-12-cilium-mesh-example/21.png alt></p><p>é…ç½®è·¯ç”±ç­–ç•¥ï¼Œhelloworld 90% æµé‡æŒ‡å‘ v1 ç‰ˆæœ¬ï¼Œ10% æµé‡æŒ‡å‘ v2 ç‰ˆæœ¬ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>apiVersion</span>: cilium.io/v2
</span></span><span style=display:flex><span><span style=color:#ff79c6>kind</span>: CiliumEnvoyConfig
</span></span><span style=display:flex><span><span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>name</span>: envoy-lb-listener
</span></span><span style=display:flex><span><span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>services</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ff79c6>name</span>: helloworld
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>namespace</span>: default
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>backendServices</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ff79c6>name</span>: helloworld-v1
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>namespace</span>: default
</span></span><span style=display:flex><span>    - <span style=color:#ff79c6>name</span>: helloworld-v2
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>namespace</span>: default
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>resources</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ff79c6>&#34;@type&#34;: </span>type.googleapis.com/envoy.config.listener.v3.Listener
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>name</span>: envoy-lb-listener
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>filter_chains</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ff79c6>filters</span>:
</span></span><span style=display:flex><span>            - <span style=color:#ff79c6>name</span>: envoy.filters.network.http_connection_manager
</span></span><span style=display:flex><span>              <span style=color:#ff79c6>typed_config</span>:
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>&#34;@type&#34;: </span>type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>stat_prefix</span>: envoy-lb-listener
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>rds</span>:
</span></span><span style=display:flex><span>                  <span style=color:#ff79c6>route_config_name</span>: lb_route
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>http_filters</span>:
</span></span><span style=display:flex><span>                  - <span style=color:#ff79c6>name</span>: envoy.filters.http.router
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>typed_config</span>:
</span></span><span style=display:flex><span>                      <span style=color:#ff79c6>&#34;@type&#34;: </span>type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
</span></span><span style=display:flex><span>    - <span style=color:#ff79c6>&#34;@type&#34;: </span>type.googleapis.com/envoy.config.route.v3.RouteConfiguration
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>name</span>: lb_route
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>virtual_hosts</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ff79c6>name</span>: <span style=color:#f1fa8c>&#34;lb_route&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>domains</span>: [ <span style=color:#f1fa8c>&#34;*&#34;</span> ]
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>routes</span>:
</span></span><span style=display:flex><span>            - <span style=color:#ff79c6>match</span>:
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>prefix</span>: <span style=color:#f1fa8c>&#34;/&#34;</span>
</span></span><span style=display:flex><span>              <span style=color:#ff79c6>route</span>:
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>weighted_clusters</span>:
</span></span><span style=display:flex><span>                  <span style=color:#ff79c6>clusters</span>:
</span></span><span style=display:flex><span>                    - <span style=color:#ff79c6>name</span>: <span style=color:#f1fa8c>&#34;default/helloworld-v1&#34;</span>
</span></span><span style=display:flex><span>                      <span style=color:#ff79c6>weight</span>: <span style=color:#bd93f9>90</span>
</span></span><span style=display:flex><span>                    - <span style=color:#ff79c6>name</span>: <span style=color:#f1fa8c>&#34;default/helloworld-v2&#34;</span>
</span></span><span style=display:flex><span>                      <span style=color:#ff79c6>weight</span>: <span style=color:#bd93f9>10</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>retry_policy</span>:
</span></span><span style=display:flex><span>                  <span style=color:#ff79c6>retry_on</span>: 5xx
</span></span><span style=display:flex><span>                  <span style=color:#ff79c6>num_retries</span>: <span style=color:#bd93f9>3</span>
</span></span><span style=display:flex><span>                  <span style=color:#ff79c6>per_try_timeout</span>: 1s
</span></span><span style=display:flex><span>    - <span style=color:#ff79c6>&#34;@type&#34;: </span>type.googleapis.com/envoy.config.cluster.v3.Cluster
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>name</span>: <span style=color:#f1fa8c>&#34;default/helloworld-v1&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>connect_timeout</span>: 5s
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>lb_policy</span>: ROUND_ROBIN
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>type</span>: EDS
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>outlier_detection</span>:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>split_external_local_origin_errors</span>: <span style=color:#ff79c6>true</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>consecutive_local_origin_failure</span>: <span style=color:#bd93f9>2</span>
</span></span><span style=display:flex><span>    - <span style=color:#ff79c6>&#34;@type&#34;: </span>type.googleapis.com/envoy.config.cluster.v3.Cluster
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>name</span>: <span style=color:#f1fa8c>&#34;default/helloworld-v2&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>connect_timeout</span>: 3s
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>lb_policy</span>: ROUND_ROBIN
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>type</span>: EDS
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>outlier_detection</span>:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>split_external_local_origin_errors</span>: <span style=color:#ff79c6>true</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>consecutive_local_origin_failure</span>: <span style=color:#bd93f9>2</span>
</span></span></code></pre></div><p>æ‰§è¡Œä»¥ä¸‹æµ‹è¯•å‘½ä»¤ï¼Œæˆ‘ä»¬å‘ç° 90 % çš„æµé‡æŒ‡å‘ v1ï¼Œ10%çš„æµé‡æŒ‡å‘ v2ï¼Œç¬¦åˆé¢„æœŸã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ff79c6>for</span> i in <span style=color:#ff79c6>{</span>1..10<span style=color:#ff79c6>}</span>; <span style=color:#ff79c6>do</span>  kubectl <span style=color:#8be9fd;font-style:italic>exec</span> -it <span style=color:#8be9fd;font-style:italic>$CLIENT</span> -- curl  helloworld:5000/hello; <span style=color:#ff79c6>done</span>
</span></span></code></pre></div><p><img src=/images/2023-08-12-cilium-mesh-example/22.png alt></p><h2 id=metric>Metric</h2><p>ç»™ envoy ä¸‹å‘ Prometheus é…ç½®ï¼Œä½¿å…¶æš´éœ² Metric æŒ‡æ ‡ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>apiVersion</span>: cilium.io/v2
</span></span><span style=display:flex><span><span style=color:#ff79c6>kind</span>: CiliumClusterwideEnvoyConfig
</span></span><span style=display:flex><span><span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>name</span>: envoy-prometheus-metrics-listener
</span></span><span style=display:flex><span><span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>resources</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ff79c6>&#34;@type&#34;: </span>type.googleapis.com/envoy.config.listener.v3.Listener
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>name</span>: envoy-prometheus-metrics-listener
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>address</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>socket_address</span>:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>address</span>: <span style=color:#f1fa8c>&#34;::&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>ipv4_compat</span>: <span style=color:#ff79c6>true</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>port_value</span>: <span style=color:#bd93f9>9090</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>filter_chains</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ff79c6>filters</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ff79c6>name</span>: envoy.filters.network.http_connection_manager
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>typed_config</span>:
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>&#34;@type&#34;: </span>type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>stat_prefix</span>: envoy-prometheus-metrics-listener
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>rds</span>:
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>route_config_name</span>: prometheus_route
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>use_remote_address</span>: <span style=color:#ff79c6>true</span>
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>skip_xff_append</span>: <span style=color:#ff79c6>true</span>
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>http_filters</span>:
</span></span><span style=display:flex><span>          - <span style=color:#ff79c6>name</span>: envoy.filters.http.router
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>typed_config</span>:
</span></span><span style=display:flex><span>              <span style=color:#ff79c6>&#34;@type&#34;: </span>type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
</span></span><span style=display:flex><span>  - <span style=color:#ff79c6>&#34;@type&#34;: </span>type.googleapis.com/envoy.config.route.v3.RouteConfiguration
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>name</span>: prometheus_route
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>virtual_hosts</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ff79c6>name</span>: <span style=color:#f1fa8c>&#34;prometheus_metrics_route&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>domains</span>: [<span style=color:#f1fa8c>&#34;*&#34;</span>]
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>routes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ff79c6>match</span>:
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>path</span>: <span style=color:#f1fa8c>&#34;/metrics&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>route</span>:
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>cluster</span>: <span style=color:#f1fa8c>&#34;envoy-admin&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>prefix_rewrite</span>: <span style=color:#f1fa8c>&#34;/stats/prometheus&#34;</span>
</span></span></code></pre></div><p>æŸ¥çœ‹æŒ‡æ ‡</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>http://xxx/stats/prometheus
</span></span></code></pre></div><p><img src=/images/2023-08-12-cilium-mesh-example/15.png alt></p><h2 id=accesslog>AccessLog</h2><p>Cilium Mesh ä½¿ç”¨çš„ Envoy ä¸æ”¯æŒ accesslogï¼Œå› ä¸º Cilium ä½¿ç”¨çš„ Envoy æ„å»ºä¸­æœªå¯ç”¨è¿™äº› Envoy æ‰©å±•ã€‚å…·ä½“å‚è§<a href=https://github.com/cilium/proxy/blob/main/envoy_build_config/extensions_build_config.bzl#L7-L13>æºç  extensions_build_config</a>ã€‚</p><h2 id=ç°åº¦>ç°åº¦</h2><p>é’ˆå¯¹ echo-service-1 ä¸ echo-service-2 é…ç½® CiliumEnvoyConfig è·¯ç”±ç­–ç•¥ï¼Œå®ç° header ç°åº¦æ•ˆæœã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>apiVersion</span>: cilium.io/v2
</span></span><span style=display:flex><span><span style=color:#ff79c6>kind</span>: CiliumEnvoyConfig
</span></span><span style=display:flex><span><span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>name</span>: envoy-lb-listener
</span></span><span style=display:flex><span><span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>services</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ff79c6>name</span>: echo-service-1
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>namespace</span>: default
</span></span><span style=display:flex><span>    - <span style=color:#ff79c6>name</span>: echo-service-2
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>namespace</span>: default
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>resources</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ff79c6>&#34;@type&#34;: </span>type.googleapis.com/envoy.config.listener.v3.Listener
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>name</span>: envoy-lb-listener
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>filter_chains</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ff79c6>filters</span>:
</span></span><span style=display:flex><span>            - <span style=color:#ff79c6>name</span>: envoy.filters.network.http_connection_manager
</span></span><span style=display:flex><span>              <span style=color:#ff79c6>typed_config</span>:
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>&#34;@type&#34;: </span>type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>stat_prefix</span>: envoy-lb-listener
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>rds</span>:
</span></span><span style=display:flex><span>                  <span style=color:#ff79c6>route_config_name</span>: lb_route
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>use_remote_address</span>: <span style=color:#ff79c6>true</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>skip_xff_append</span>: <span style=color:#ff79c6>true</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>http_filters</span>:
</span></span><span style=display:flex><span>                  - <span style=color:#ff79c6>name</span>: envoy.filters.http.router
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>typed_config</span>:
</span></span><span style=display:flex><span>                      <span style=color:#ff79c6>&#34;@type&#34;: </span>type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
</span></span><span style=display:flex><span>    - <span style=color:#ff79c6>&#34;@type&#34;: </span>type.googleapis.com/envoy.config.route.v3.RouteConfiguration
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>name</span>: lb_route
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>virtual_hosts</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ff79c6>name</span>: <span style=color:#f1fa8c>&#34;lb_route&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>domains</span>: [ <span style=color:#f1fa8c>&#34;*&#34;</span> ]
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>routes</span>:
</span></span><span style=display:flex><span>            - <span style=color:#ff79c6>match</span>:
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>prefix</span>: <span style=color:#f1fa8c>&#34;/&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>headers</span>:
</span></span><span style=display:flex><span>                  - <span style=color:#ff79c6>name</span>: <span style=color:#f1fa8c>&#34;version&#34;</span>
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>exact_match</span>: <span style=color:#f1fa8c>&#34;foo&#34;</span>
</span></span><span style=display:flex><span>              <span style=color:#ff79c6>route</span>:
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>cluster</span>: default/echo-service-1
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>regex_rewrite</span>:
</span></span><span style=display:flex><span>                  <span style=color:#ff79c6>pattern</span>:
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>google_re2</span>: { }
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>regex</span>: <span style=color:#f1fa8c>&#34;^/foo.*$&#34;</span>
</span></span><span style=display:flex><span>                  <span style=color:#ff79c6>substitution</span>: <span style=color:#f1fa8c>&#34;/&#34;</span>
</span></span><span style=display:flex><span>            - <span style=color:#ff79c6>match</span>:
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>prefix</span>: <span style=color:#f1fa8c>&#34;/&#34;</span>
</span></span><span style=display:flex><span>              <span style=color:#ff79c6>route</span>:
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>weighted_clusters</span>:
</span></span><span style=display:flex><span>                  <span style=color:#ff79c6>clusters</span>:
</span></span><span style=display:flex><span>                    - <span style=color:#ff79c6>name</span>: <span style=color:#f1fa8c>&#34;default/echo-service-1&#34;</span>
</span></span><span style=display:flex><span>                      <span style=color:#ff79c6>weight</span>: <span style=color:#bd93f9>50</span>
</span></span><span style=display:flex><span>                    - <span style=color:#ff79c6>name</span>: <span style=color:#f1fa8c>&#34;default/echo-service-2&#34;</span>
</span></span><span style=display:flex><span>                      <span style=color:#ff79c6>weight</span>: <span style=color:#bd93f9>50</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>retry_policy</span>:
</span></span><span style=display:flex><span>                  <span style=color:#ff79c6>retry_on</span>: 5xx
</span></span><span style=display:flex><span>                  <span style=color:#ff79c6>num_retries</span>: <span style=color:#bd93f9>3</span>
</span></span><span style=display:flex><span>                  <span style=color:#ff79c6>per_try_timeout</span>: 1s
</span></span><span style=display:flex><span>    - <span style=color:#ff79c6>&#34;@type&#34;: </span>type.googleapis.com/envoy.config.cluster.v3.Cluster
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>name</span>: <span style=color:#f1fa8c>&#34;default/echo-service-1&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>connect_timeout</span>: 5s
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>lb_policy</span>: ROUND_ROBIN
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>type</span>: EDS
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>outlier_detection</span>:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>split_external_local_origin_errors</span>: <span style=color:#ff79c6>true</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>consecutive_local_origin_failure</span>: <span style=color:#bd93f9>2</span>
</span></span><span style=display:flex><span>    - <span style=color:#ff79c6>&#34;@type&#34;: </span>type.googleapis.com/envoy.config.cluster.v3.Cluster
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>name</span>: <span style=color:#f1fa8c>&#34;default/echo-service-2&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>connect_timeout</span>: 3s
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>lb_policy</span>: ROUND_ROBIN
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>type</span>: EDS
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>outlier_detection</span>:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>split_external_local_origin_errors</span>: <span style=color:#ff79c6>true</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>consecutive_local_origin_failure</span>: <span style=color:#bd93f9>2</span>
</span></span></code></pre></div><p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼šé»˜è®¤è®¿é—® echo-service-1 foo æ¥å£ä¼šæŠ¥ 404 é”™è¯¯ï¼Œä½†æ˜¯å¦‚æœè¯·æ±‚ä¸­æºå¸¦ <code>header version=foo</code>ï¼Œåˆ™ä¼šè¯·æ±‚æˆåŠŸã€‚</p><p><img src=/images/2023-08-12-cilium-mesh-example/16.png alt></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>root@instance-00qqerhq:~/cilium-mesh/strateges# kubectl <span style=color:#8be9fd;font-style:italic>exec</span> -it <span style=color:#8be9fd;font-style:italic>$CLIENT2</span> -- curl -H<span style=color:#f1fa8c>&#34;version:foo&#34;</span> -I echo-service-1:8080/foo
</span></span><span style=display:flex><span>HTTP/1.1 <span style=color:#bd93f9>200</span> OK
</span></span><span style=display:flex><span>x-powered-by: Express
</span></span><span style=display:flex><span>vary: Origin, Accept-Encoding
</span></span><span style=display:flex><span>access-control-allow-credentials: <span style=color:#8be9fd;font-style:italic>true</span>
</span></span><span style=display:flex><span>accept-ranges: bytes
</span></span><span style=display:flex><span>cache-control: public, max-age<span style=color:#ff79c6>=</span><span style=color:#bd93f9>0</span>
</span></span><span style=display:flex><span>last-modified: Wed, <span style=color:#bd93f9>21</span> Sep <span style=color:#bd93f9>2022</span> 10:25:56 GMT
</span></span><span style=display:flex><span>etag: W/<span style=color:#f1fa8c>&#34;809-1835f952f20&#34;</span>
</span></span><span style=display:flex><span>content-type: text/html; <span style=color:#8be9fd;font-style:italic>charset</span><span style=color:#ff79c6>=</span>UTF-8
</span></span><span style=display:flex><span>content-length: <span style=color:#bd93f9>2057</span>
</span></span><span style=display:flex><span>date: Mon, <span style=color:#bd93f9>21</span> Aug <span style=color:#bd93f9>2023</span> 06:26:17 GMT
</span></span><span style=display:flex><span>x-envoy-upstream-service-time: <span style=color:#bd93f9>0</span>
</span></span><span style=display:flex><span>server: envoy
</span></span></code></pre></div><p><img src=/images/2023-08-12-cilium-mesh-example/17.png alt></p><p>è¯´æ˜ header è·¯ç”±ç°åº¦æµ‹è¯•æ˜¯ç”Ÿæ•ˆçš„ã€‚</p><h1 id=æ€»ç»“>æ€»ç»“</h1><p>æœ¬æ–‡æˆ‘å¸¦ä½ éƒ¨ç½²äº† Cilium Meshï¼Œå¹¶é€šè¿‡åŠŸèƒ½ç¤ºä¾‹ï¼Œå¸¦ä½ ä½“éªŒäº† Cilium Meshã€‚æ€»ä¹‹ï¼Œè¿™ç§æ–¹å¼èƒ½å¸¦æ¥ä¸€å®šçš„ä¾¿åˆ©æ€§ï¼Œä½†æ˜¯æµé‡æ²»ç†é…ç½®ä¸»è¦ä¾é äº CiliumEnvoyConfig æˆ–è€… CiliumClusterwideEnvoyConfigï¼Œå¯¹äºä½¿ç”¨è€…è€Œè¨€ä¸å¤ªå‹å¥½ã€‚</p><hr><ul class=pager><li class=previous><a href=/post/2023-06-25-caretta-ebpf/ data-toggle=tooltip data-placement=top title="Caretta åˆ©ç”¨ eBPF å®ç° Kubernetes åº”ç”¨ç½‘ç»œæ‹“æ‰‘å›¾">&larr;
Previous Post</a></li></ul></div><div class="col-lg-2 col-lg-offset-0
visible-lg-block
sidebar-container
catalog-container"><div class=side-catalog><hr class="hidden-sm hidden-xs"><h5><a class=catalog-toggle href=#>CATALOG</a></h5><ul class=catalog-body></ul></div></div><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
sidebar-container"></div></div></div></article><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"><li><a href=mailto:tanjunchen20@gmail.com><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=/img/wechat.jpg><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-weixin fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://github.com/tanjunchen><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="copyright text-muted">Copyright &copy; é™ˆè°­å†› 2023</p></div></div></div></footer><script>function loadAsync(e,t){var s=document,o="script",n=s.createElement(o),i=s.getElementsByTagName(o)[0];n.src=e,t&&n.addEventListener("load",function(e){t(null,e)},!1),i.parentNode.insertBefore(n,i)}</script><script>$("#tag_cloud").length!==0&&loadAsync("/js/jquery.tagcloud.js",function(){$.fn.tagcloud.defaults={color:{start:"#bbbbee",end:"#0085a1"}},$("#tag_cloud a").tagcloud()})</script><script>loadAsync("https://cdn.jsdelivr.net/npm/fastclick@1.0.6/lib/fastclick.min.js",function(){var e=document.querySelector("nav");e&&FastClick.attach(e)})</script><script type=text/javascript>function generateCatalog(e){_containerSelector="div.post-container";var t,n,s,o,i,r=$(_containerSelector),a=r.find("h1,h2,h3,h4,h5,h6");return $(e).html(""),a.each(function(){n=$(this).prop("tagName").toLowerCase(),i="#"+$(this).prop("id"),s=$(this).text(),t=$('<a href="'+i+'" rel="nofollow">'+s+"</a>"),o=$('<li class="'+n+'_nav"></li>').append(t),$(e).append(o)}),!0}generateCatalog(".catalog-body"),$(".catalog-toggle").click(function(e){e.preventDefault(),$(".side-catalog").toggleClass("fold")}),loadAsync("/js/jquery.nav.js",function(){$(".catalog-body").onePageNav({currentClass:"active",changeHash:!1,easing:"swing",filter:"",scrollSpeed:700,scrollOffset:0,scrollThreshold:.2,begin:null,end:null,scrollChange:null,padding:80})})</script></body></html>