<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:site_name" content="漫步远方，心荡神往"><meta property="og:type" content="article"><meta property="og:image" content="https://tanjunchen.github.io/img/home.webp"><meta property="twitter:image" content="https://tanjunchen.github.io/img/home.webp"><meta name=title content="使用 Hubble 实现 Kubernetes 服务可观测性（3）"><meta property="og:title" content="使用 Hubble 实现 Kubernetes 服务可观测性（3）"><meta property="twitter:title" content="使用 Hubble 实现 Kubernetes 服务可观测性（3）"><meta name=description content="Hubble - 使用 eBPF 的 Kubernetes 的网络、服务和安全可观测性。Hubble 则是 Cilium 的一个子项目，专注于提供网络可观察性。Hubble 可以收集和可视化 Cilium 网络的流量信息，帮助用户理解网络流量的模式，检测网络问题，理解应用的行为。Hubble 提供了一个丰富的可视化界面，可以显示网络流量的详细信息，包括源 IP、目标 IP、端口号、协议类型、数据包数量、字节数量等。"><meta property="og:description" content="Hubble - 使用 eBPF 的 Kubernetes 的网络、服务和安全可观测性。Hubble 则是 Cilium 的一个子项目，专注于提供网络可观察性。Hubble 可以收集和可视化 Cilium 网络的流量信息，帮助用户理解网络流量的模式，检测网络问题，理解应用的行为。Hubble 提供了一个丰富的可视化界面，可以显示网络流量的详细信息，包括源 IP、目标 IP、端口号、协议类型、数据包数量、字节数量等。"><meta property="twitter:description" content="Hubble - 使用 eBPF 的 Kubernetes 的网络、服务和安全可观测性。Hubble 则是 Cilium 的一个子项目，专注于提供网络可观察性。Hubble 可以收集和可视化 Cilium 网络的流量信息，帮助用户理解网络流量的模式，检测网络问题，理解应用的行为。Hubble 提供了一个丰富的可视化界面，可以显示网络流量的详细信息，包括源 IP、目标 IP、端口号、协议类型、数据包数量、字节数量等。"><meta property="twitter:card" content="summary"><meta name=keyword content="陈谭军, 互联网, 云原生, 容器, 微服务, Web, PaaS, Istio, Kubernetes, Microservice"><link rel="shortcut icon" href=/img/favicon.ico><title>使用 Hubble 实现 Kubernetes 服务可观测性（3） | 陈谭军的博客 | tanjunchen Blog</title><link rel=canonical href=/post/2023-10-14-cilium-hubble/><link rel=stylesheet href=/css/bootstrap.min.css><link rel=stylesheet href=/css/hugo-theme-cleanwhite.min.css><link rel=stylesheet href=/css/zanshang.css><link rel=stylesheet href=/css/font-awesome.all.min.css><script src=/js/jquery.min.js></script>
<script src=/js/bootstrap.min.js></script>
<script src=/js/hux-blog.min.js></script>
<script src=/js/lazysizes.min.js></script></head><nav class="navbar navbar-default navbar-custom navbar-fixed-top"><div class=container-fluid><div class="navbar-header page-scroll"><button type=button class=navbar-toggle>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span></button>
<a class=navbar-brand href=/>漫步远方，心荡神往</a></div><div id=huxblog_navbar><div class=navbar-collapse><ul class="nav navbar-nav navbar-right"><li><a href=/>All Posts</a></li><li><a href=/categories/technology/>technology</a></li><li><a href=/categories/think/>think</a></li><li><a href=/learning/>LEARNING</a></li><li><a href=/archive/>ARCHIVE</a></li><li><a href=/about/>ABOUT</a></li><li><a href=/search><i class="fa fa-search"></i></a></li></ul></div></div></div></nav><script>var $body=document.body,$toggle=document.querySelector(".navbar-toggle"),$navbar=document.querySelector("#huxblog_navbar"),$collapse=document.querySelector(".navbar-collapse");$toggle.addEventListener("click",handleMagic);function handleMagic(){$navbar.className.indexOf("in")>0?($navbar.className=" ",setTimeout(function(){$navbar.className.indexOf("in")<0&&($collapse.style.height="0px")},400)):($collapse.style.height="auto",$navbar.className+=" in")}</script><style type=text/css>header.intro-header{background-image:url(/img/home.webp)}</style><header class=intro-header><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><div class=tags><a class=tag href=/tags/kubernetes title=kubernetes>kubernetes</a>
<a class=tag href=/tags/hubble title=hubble>hubble</a>
<a class=tag href=/tags/ebpf title=eBPF>eBPF</a>
<a class=tag href=/tags/cilium title=cilium>cilium</a></div><h1>使用 Hubble 实现 Kubernetes 服务可观测性（3）</h1><h2 class=subheading>Hubble 是一个用于云原生工作负载的完全分布式网络和安全可观察性平台。它建立在 Cilium 和 eBPF 之上，以完全透明的方式深入了解服务的通信和行为以及网络基础设施</h2><span class=meta>Posted by
陈谭军
on
Saturday, October 14, 2023
<span id=busuanzi_container_page_pv>|<span id=busuanzi_value_page_pv></span><span>
<span id=/post/2023-10-14-cilium-hubble/ class="leancloud_visitors meta_data_item" data-flag-title><span class=post-meta-item-icon><span class="octicon octicon-eye"></span></span>
<i class="fa fa-eye"></i>
<span class=old-visitors-count style=display:none></span>
<span class=leancloud-visitors-count></span></span>
<script src=https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js></script>
<script>AV.initialize("","")</script><script type=text/javascript>function showTime(e){var n=new AV.Query(e),t=[],s=$(".leancloud_visitors");s.each(function(){t.push($(this).attr("id").trim())}),n.containedIn("url",t),n.find().done(function(e){for(var s,o,i,a,r,c,l=".leancloud-visitors-count",d=".old-visitors-count",n=0;n<e.length;n++)a=e[n],i=a.get("url"),c=a.get("time"),s=document.getElementById(i),$(s).find(l).text(c);for(n=0;n<t.length;n++)i=t[n],s=document.getElementById(i),o=$(s).find(l),o.text()==""&&(r=$(s).find(d).text(),r!=""?o.text(0+parseInt(r)):o.text(0))}).fail(function(e,t){console.log("Error: "+t.code+" "+t.message)})}function addCount(e){var n=$(".leancloud_visitors"),t=n.attr("id").trim(),o=n.attr("data-flag-title").trim(),s=new AV.Query(e);s.equalTo("url",t),s.find({success:function(n){if(n.length>0){var s,i,r,c,l,a=n[0];a.fetchWhenSave(!0),a.increment("time"),a.save(null,{success:function(e){var n=$(document.getElementById(t));n.find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to save Visitor num, with error message: "+t.message)}})}else s=new e,i=new AV.ACL,i.setPublicReadAccess(!0),i.setPublicWriteAccess(!0),s.setACL(i),s.set("title",o),s.set("url",t),c=".old-visitors-count",l=$(document.getElementById(t)),r=l.find(c).text(),r!=""?s.set("time",parseInt(r)+1):s.set("time",1),s.save(null,{success:function(e){var n=$(document.getElementById(t));n.find(".leancloud-visitors-count").text(e.get("time"))},error:function(){console.log("Failed to create")}})},error:function(e){console.log("Error:"+e.code+" "+e.message)}})}$(function(){var e=AV.Object.extend("Counter");$(".leancloud_visitors").length==1?addCount(e):showTime(e)})</script>阅读 </span></span>|<span class=post-date>共 1139 字</span>，阅读约 <span class=more-meta>3 分钟</span></span></div></div></div></div></header><article><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
post-container"><h1 id=介绍>介绍</h1><p>Hubble - 使用 eBPF 的 Kubernetes 的网络、服务和安全可观测性。Hubble 则是 Cilium 的一个子项目，专注于提供网络可观察性。Hubble 可以收集和可视化 Cilium 网络的流量信息，帮助用户理解网络流量的模式，检测网络问题，理解应用的行为。Hubble 提供了一个丰富的可视化界面，可以显示网络流量的详细信息，包括源 IP、目标 IP、端口号、协议类型、数据包数量、字节数量等。</p><p>Hubble 是一个用于云原生工作负载的完全分布式网络和安全可观察性平台。它建立在 Cilium 和 eBPF 之上，以完全透明的方式深入了解服务的通信和行为以及网络基础设施。Hubble 通常可以解决下述问题，如下所示：</p><ul><li>服务依赖关系和通信 Map<ul><li>哪些服务正在相互通信？多久一次？服务依赖关系图是什么样子的？</li><li>正在进行哪些 HTTP 调用？</li></ul></li><li>监控和告警<ul><li>是否有网络通信故障？为什么通信失败？是 DNS 吗？是应用程序问题还是网络问题？是4层（TCP）还是7层（HTTP）的通信中断？</li><li>哪些服务在过去5分钟内遇到 DNS 解析问题？哪些服务最近经历了 TCP 连接中断或连接超时？未应答 TCP SYN 请求的速率是多少？</li></ul></li><li>应用程序监控<ul><li>特定服务或所有集群的 5xx 或 4xx HTTP 响应代码的速率是多少？</li><li>HTTP 请求和响应之间的第 95 个百分比和第 99 个百分比的延迟是多少？哪些服务表现最差？两个服务之间的延迟是多少？</li></ul></li><li>安全可观察性<ul><li>由于网络策略，哪些服务的连接被阻止？从集群外部访问了哪些服务？哪些服务解析了特定的DNS名称？</li></ul></li></ul><h1 id=架构>架构</h1><p>官方地址，参见 <a href=https://github.com/cilium/hubble>https://github.com/cilium/hubble</a>。使用 eBPF 实现 Kubernetes 网络、服务、安全等可观测性。
架构图如下所示：</p><p><img src=/images/2023-10-14-cilium-hubble/1.png alt></p><p>Hubble 是 Cilium 的一个组件，其核心功能主要包括：</p><ul><li>实时网络流量监控： Hubble 可以提供对容器网络流量的实时监控和分析，让用户能够了解容器之间的通信模式、流量和流向等信息。</li><li>网络可视化： 它能够以可视化的方式展现容器之间的网络拓扑，使用户能够更直观地理解整个容器网络的结构和连接方式。</li><li>安全审计： Hubble 可以帮助进行网络流量的审计和分析，有助于发现异常行为或潜在的安全威胁，并提供相应的数据支持进行故障排除或安全加固。</li><li>服务发现和定位： 它可以帮助发现容器之间的服务，并提供这些服务的定位信息，有助于在容器化环境中进行服务间通信和定位。</li></ul><p>总的来说，Hubble 作为 Cilium 的一部分，提供了强大的网络可见性和安全性功能，有助于理解、监控和保护容器化环境中的网络通信。</p><h1 id=示例>示例</h1><p>服务拓扑图如下所示：
<img src=/images/2023-10-14-cilium-hubble/2.png alt></p><p>指标和监控提供了系统状态，示例如下所示：</p><p>网络：
<img src=/images/2023-10-14-cilium-hubble/3.png alt></p><p>可观测性：
<img src=/images/2023-10-14-cilium-hubble/4.png alt></p><p>HTTP Request/Response Rate & Latency：
<img src=/images/2023-10-14-cilium-hubble/5.png alt></p><p>DNS Request/Response Monitoring：
<img src=/images/2023-10-14-cilium-hubble/6.png alt></p><h1 id=安装>安装</h1><p>安装 Cilium 参考示例如下所示：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>helm repo add cilium https://helm.cilium.io/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>helm install cilium cilium/cilium --version 1.14.0 <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --namespace kube-system <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --set <span style=color:#8be9fd;font-style:italic>kubeProxyReplacement</span><span style=color:#ff79c6>=</span>strict <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --set-string extraConfig.enable-envoy-config<span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>true</span>  <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>	<span style=color:#6272a4># k8sServiceHost 表示 k8s apiServer 地址</span>
</span></span><span style=display:flex><span>    --set <span style=color:#8be9fd;font-style:italic>k8sServiceHost</span><span style=color:#ff79c6>=</span>xxx  <span style=color:#f1fa8c>\ </span>
</span></span><span style=display:flex><span>    --set <span style=color:#8be9fd;font-style:italic>k8sServicePort</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>6443</span>  <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --set envoy.enabled<span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>true</span>  <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --set hubble.relay.enabled<span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>true</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --set hubble.ui.enabled<span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>false</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --set prometheus.enabled<span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>true</span>  <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --set operator.prometheus.enabled<span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>true</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>	<span style=color:#6272a4># 镜像仓库地址</span>
</span></span><span style=display:flex><span>    --set image.repository<span style=color:#ff79c6>=</span>repo/cilium  <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --set image.tag<span style=color:#ff79c6>=</span>v1.14.0 <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --set image.useDigest<span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>false</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>	<span style=color:#6272a4># 镜像仓库地址</span>
</span></span><span style=display:flex><span>    --set operator.image.repository<span style=color:#ff79c6>=</span>repo/operator <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --set operator.image.tag<span style=color:#ff79c6>=</span>v1.14.0 <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --set operator.image.useDigest<span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>false</span>   <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>	<span style=color:#6272a4># 镜像仓库地址</span>
</span></span><span style=display:flex><span>    --set envoy.image.repository<span style=color:#ff79c6>=</span>repo/cilium-envoy  <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --set envoy.image.tag<span style=color:#ff79c6>=</span>v1.25.9   <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --set envoy.image.useDigest<span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>false</span> <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>	<span style=color:#6272a4># 镜像仓库地址</span>
</span></span><span style=display:flex><span>    --set hubble.relay.image.repository<span style=color:#ff79c6>=</span>repo/hubble-relay  <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --set hubble.relay.image.tag<span style=color:#ff79c6>=</span>v1.14.0  <span style=color:#f1fa8c>\
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c></span>    --set hubble.relay.image.useDigest<span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>false</span>
</span></span></code></pre></div><h1 id=参考>参考</h1><ol><li><a href=https://github.com/cilium/hubble>https://github.com/cilium/hubble</a></li><li><a href=https://docs.cilium.io/en/stable/contributing/development/hubble/#hubble-contributing>https://docs.cilium.io/en/stable/contributing/development/hubble/#hubble-contributing</a></li></ol><hr><ul class=pager><li class=previous><a href=/post/2023-10-05-ebpf-coroot/ data-toggle=tooltip data-placement=top title="使用 coroot 实现 Kubernetes 服务可观测性（2）">&larr;
Previous Post</a></li></ul></div><div class="col-lg-2 col-lg-offset-0
visible-lg-block
sidebar-container
catalog-container"><div class=side-catalog><hr class="hidden-sm hidden-xs"><h5><a class=catalog-toggle href=#>CATALOG</a></h5><ul class=catalog-body></ul></div></div><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
sidebar-container"></div></div></div></article><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"><li><a href=mailto:tanjunchen20@gmail.com><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=/img/wechat.jpg><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-weixin fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://github.com/tanjunchen><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="copyright text-muted">Copyright &copy; 陈谭军 2023</p></div></div></div></footer><script>function loadAsync(e,t){var s=document,o="script",n=s.createElement(o),i=s.getElementsByTagName(o)[0];n.src=e,t&&n.addEventListener("load",function(e){t(null,e)},!1),i.parentNode.insertBefore(n,i)}</script><script>$("#tag_cloud").length!==0&&loadAsync("/js/jquery.tagcloud.js",function(){$.fn.tagcloud.defaults={color:{start:"#bbbbee",end:"#0085a1"}},$("#tag_cloud a").tagcloud()})</script><script>loadAsync("https://cdn.jsdelivr.net/npm/fastclick@1.0.6/lib/fastclick.min.js",function(){var e=document.querySelector("nav");e&&FastClick.attach(e)})</script><script type=text/javascript>function generateCatalog(e){_containerSelector="div.post-container";var t,n,s,o,i,r=$(_containerSelector),a=r.find("h1,h2,h3,h4,h5,h6");return $(e).html(""),a.each(function(){n=$(this).prop("tagName").toLowerCase(),i="#"+$(this).prop("id"),s=$(this).text(),t=$('<a href="'+i+'" rel="nofollow">'+s+"</a>"),o=$('<li class="'+n+'_nav"></li>').append(t),$(e).append(o)}),!0}generateCatalog(".catalog-body"),$(".catalog-toggle").click(function(e){e.preventDefault(),$(".side-catalog").toggleClass("fold")}),loadAsync("/js/jquery.nav.js",function(){$(".catalog-body").onePageNav({currentClass:"active",changeHash:!1,easing:"swing",filter:"",scrollSpeed:700,scrollOffset:0,scrollThreshold:.2,begin:null,end:null,scrollChange:null,padding:80})})</script></body></html>